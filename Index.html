 <!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembayaran Kas E21-25 - Login & Dashboard</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* CSS untuk Tampilan 3D Gelap Elegan Neon (Global) */
        :root {
            --color-bg: #0d1117; 
            --color-card: #161b22; 
            --color-neon: #00ffff; 
            --color-text: #c9d1d9; 
            --color-shadow: rgba(0, 0, 0, 0.9); 
            --glow-intensity: 0 0 8px var(--color-neon); 
            --glow-intensity-strong: 0 0 10px var(--color-neon), 0 0 30px var(--color-neon); 
            --color-green-neon: #33ff99; 
            --color-red-neon: #ff3333; 
            --color-yellow: #ffcc00; 
            --color-blue: #00b3b3; 
            --color-income: #33ff99; 
            --color-expense: #ff3333; 
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            perspective: 2000px; 
            overflow-y: auto;
            transition: background-color 0.5s;
        }
        
        /* Efek Grid Estetik Latar Belakang */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(0deg, var(--color-bg) 0%, transparent 10%), repeating-linear-gradient(90deg, transparent 0, transparent 39px, rgba(255, 255, 255, 0.02) 40px), repeating-linear-gradient(180deg, transparent 0, transparent 39px, rgba(255, 255, 255, 0.02) 40px);
            opacity: 0.4;
            z-index: -1;
        }

        /* Tombol Kembali Mengambang 3D */
        #floatingBackBtn {
            position: fixed; 
            bottom: 10px; 
            left: 10px; 
            width: 30px;
            height: 30px;
            background-color: #10151c; 
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 
                0 4px 8px rgba(0, 0, 0, 0.5), 
                0 0 15px rgba(0, 255, 255, 0.5); 
            border: 2px solid var(--color-neon);
            z-index: 100;
            transition: all 0.3s ease-in-out;
            animation: blinkingNeon 1.5s infinite alternate;
        }

        #floatingBackBtn i {
            font-size: 1.5em;
            color: var(--color-neon);
            text-shadow: 0 0 10px var(--color-neon);
            transition: all 0.3s;
        }

        /* KEYFRAMES BARU: Efek Berkedip Neon */
        @keyframes blinkingNeon {
            0% {
                box-shadow: 
                    0 4px 8px rgba(0, 0, 0, 0.5), 
                    0 0 5px var(--color-neon); 
                opacity: 0.9;
            }
            50% {
                box-shadow: 
                    0 4px 15px rgba(0, 0, 0, 0.7), 
                    0 0 25px var(--color-neon), 
                    0 0 50px rgba(0, 255, 255, 0.2); 
                opacity: 1;
            }
            100% {
                 box-shadow: 
                    0 4px 8px rgba(0, 0, 0, 0.5), 
                    0 0 5px var(--color-neon); 
                opacity: 0.9;
            }
        }
        
        #floatingBackBtn:hover {
            transform: scale(1.1) rotate(-1deg);
            box-shadow: 
                0 6px 15px rgba(0, 0, 0, 0.7),
                0 0 25px var(--color-neon);
        }

        .hide-back-button #floatingBackBtn {
            display: none;
        }


        /* Container Login/Register */
        .container {
            width: 90%;
            max-width: 280px; 
            background: var(--color-card);
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 
                0 8px 25px var(--color-shadow), 
                var(--glow-intensity); 
            border: 1px solid rgba(0, 255, 255, 0.2); 
            transform: rotateY(-0.5deg) rotateX(0.3deg) scale(1); 
            transition: transform 0.4s ease-in-out, box-shadow 0.4s;
            z-index: 10;
        }
        
        /* --- CSS LOADING PAGE BARU --- */
        #loadingPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--color-bg); 
            display: flex; 
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
        }
        
        .loader {
            display: none; 
        }
        
        /* Animasi Ikon Dompet (Bergerak dari dalam ke depan) */
        .initial-loader-icon { 
            font-size: 3em;
            color: var(--color-green-neon);
            text-shadow: 0 0 15px var(--color-green-neon);
            margin-bottom: 20px;
            animation: moveWallet 2s ease-in-out infinite alternate; 
        }
        
        @keyframes moveWallet {
            0% { 
                transform: scale(0.5) translateY(20px) rotateY(0deg); 
                opacity: 0.7;
            }
            100% { 
                transform: scale(1.2) translateY(-20px) rotateY(10deg); 
                opacity: 1;
            }
        }
        
        /* Teks Megah dan Animasi */
        .initial-loader-text { 
            font-family: Georgia, 'Times New Roman', Times, serif; 
            color: var(--color-neon); 
            font-size: 2.2em; 
            font-weight: bold;
            letter-spacing: 2px;
            text-shadow: var(--glow-intensity), 0 0 15px var(--color-neon); 
            margin-top: 10px;
            
            /* Animasi Fade-in dan Scale-up */
            animation: textReveal 1.5s ease-out infinite alternate;
        }

        /* Keyframes untuk Animasi Teks */
        @keyframes textReveal {
            0% { 
                opacity: 0;
                transform: scale(0.9);
            }
            100% { 
                opacity: 1;
                transform: scale(1.05);
            }
        }
        
        /* CSS Lainnya Dibiarkan Sama */
        
        .error-message {
            color: var(--color-red-neon);
            background: #2a0a0a;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid var(--color-red-neon);
            box-shadow: 0 0 10px rgba(255, 51, 51, 0.3);
        }

        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: var(--color-neon);
            text-shadow: 0 0 3px rgba(0, 255, 255, 0.3);
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 5px;
            background-color: var(--color-bg);
            color: var(--color-text);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            transition: all 0.3s;
            box-sizing: border-box; 
        }
        .form-group input:focus {
            border-color: var(--color-neon);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5), inset 0 0 5px rgba(0, 255, 255, 0.2);
            outline: none;
        }

        .btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        #loginBtn {
            background: linear-gradient(90deg, #00b3b3, var(--color-neon));
            color: var(--color-bg);
            border: 1px solid var(--color-neon);
        }
        #loginBtn:hover {
            box-shadow: 0 0 20px var(--color-neon), 0 0 30px var(--color-neon);
            transform: translateY(-2px);
        }
        
        #registerToggleBtn, #loginToggleBtn {
            background-color: #333;
            color: var(--color-text);
            border: 1px solid #555;
            font-size: 0.9em;
        }
        #registerToggleBtn:hover, #loginToggleBtn:hover {
            background-color: #444;
        }
        
        #submitRegisterBtn {
            background-color: var(--color-green-neon);
            color: var(--color-bg);
        }
        #submitRegisterBtn:hover {
            box-shadow: 0 0 20px var(--color-green-neon);
            transform: translateY(-2px);
        }
        
        /* Dashboard & Umum (Max-width 600px) */
        #dashboardPage, #profilePage, #paymentPage, #qrPage, #danaPage, #transferPage, #cashPage, #dataWargaPage, #myDataPage, #reportPage, #detailReportPage { 
            display: none; 
            width: 85%;
            max-width: 500px; 
            background: var(--color-card);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 8px 15px var(--color-shadow), var(--glow-intensity); 
            border: 1px solid rgba(0, 255, 255, 0.2);
            flex-direction: column;
            gap: 20px;
            overflow-x: auto; 
        }
        
        .top-bar {
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .top-bar h1 {
            font-size: 1.5em;
            color: var(--color-neon);
            text-shadow: var(--glow-intensity);
            margin: 0 0 5px 0;
        }
        #digitalClock, #paymentClock, #profileClock, #dataWargaClock, #myDataClock, #reportClock, #detailReportClock { 
            font-size: 1.2em; 
            color: #999; 
            font-weight: bold;
            letter-spacing: 1px;
        }

        .welcome-message {
            background: #1e3c3c;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border-left: 5px solid var(--color-green-neon);
            margin-bottom: 20px;
        }
        .welcome-message strong {
            color: var(--color-green-neon);
        }

        .balance-card {
            background: linear-gradient(145deg, #1f2733, #161b22);
            padding: 25px; 
            border-radius: 12px; 
            text-align: center;
            border: 1px solid #333;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.05);
            margin-bottom: 20px;
        }
        .balance-card h3 {
            margin-top: 0;
            color: #eee;
            text-transform: uppercase;
            font-size: 1em; 
            letter-spacing: 1.5px;
        }
        .balance-amount {
            font-size: 2.8em; 
            color: var(--color-green-neon);
            text-shadow: 0 0 15px var(--color-green-neon), 0 0 25px rgba(51, 255, 153, 0.5); 
            margin: 10px 0 20px 0; 
            font-weight: bold;
        }
        .detail-btn {
            background-color: #3a4b63;
            color: #fff;
            padding: 10px 20px; 
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        .detail-btn:hover {
            background-color: #4a5b73;
        }

        /* Menu Grid (Diubah ke 2 kolom) */
        .menu-wrapper {
            display: flex;
            flex-direction: column;
            gap: 15px; 
        }
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
        }
        
        .menu-item {
            background: #1f2733;
            padding: 15px 10px; 
            border-radius: 10px; 
            text-align: center;
            text-decoration: none;
            color: var(--color-text);
            transition: all 0.2s ease-out; 
            border: 1px solid #333;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: flex; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .menu-item i {
            font-size: 1.5em; 
            margin-bottom: 5px; 
            color: var(--color-neon);
            text-shadow: var(--glow-intensity);
        }
        .menu-item span {
            display: block;
            font-size: 0.9em; 
            font-weight: 500;
        }
        
        /* EFEK HOVER: Glow lebih kuat dan naik */
        .menu-item:hover {
            background: #253040;
            transform: translateY(-5px); 
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.7), 
                var(--glow-intensity-strong); 
            border-color: var(--color-neon);  
        }

        /* EFEK ACTIVE: Tenggelam dan menyala terang saat ditekan */
        .menu-item:active {
            transform: translateY(0); 
            background: #003333;      
            box-shadow: 
                0 2px 5px rgba(0, 0, 0, 0.5), 
                0 0 25px var(--color-neon); 
            border-color: var(--color-neon);
        }

        
        /* Marquee */
        .marquee-container {
            overflow: hidden;
            background: #1a1a1a;
            padding: 15px 0; 
            border-radius: 10px; 
            border: 1px dashed #333;
            margin-top: 20px; 
        }
        .marquee-text {
            display: inline-block;
            white-space: nowrap;
            animation: marquee 15s linear infinite;
            color: #ffcc00;
            font-size: 1.1em; 
            font-weight: bold;
            padding-left: 100%; 
        }
        @keyframes marquee {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }

        .dashboard-footer {
            text-align: center;
            font-size: 0.7em;
            color: #555;
            margin-top: 15px;
        }
        
        /* Data Warga Table Style */
        .data-table-container {
            padding: 10px;
            background: #1c232e;
            border-radius: 8px;
            overflow-x: auto; 
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            min-width: 550px; 
        }
        
        /* Tabel Data Saya */
        #myDataPage .data-table {
            min-width: 350px; 
            margin-bottom: 15px;
        }
        /* Style untuk menyembunyikan baris */
        .hidden-row {
            display: none;
        }


        .data-table th, .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        #myDataPage .data-table th, #myDataPage .data-table td {
            text-align: center;
        }

        .data-table th {
            background-color: #253040;
            color: var(--color-neon);
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }
        
        .data-table tr:hover {
            background-color: #253040;
        }

        /* Status Styling */
        .status-green { color: var(--color-green-neon); font-weight: bold; }
        .status-red { color: var(--color-red-neon); font-weight: bold; }
        .status-yellow { color: var(--color-yellow); font-weight: bold; }
        .status-grey { color: #555; font-style: italic; }
        
        /* Tombol Sembunyi/Tampilkan */
        #toggleTableBtn {
            background-color: #3a4b63;
            color: #fff;
            padding: 10px 20px; 
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
            margin-bottom: 15px;
        }
        
        /* BAR CHART CSS (DIPERTAHANKAN JIKA DIGUNAKAN DI TEMPAT LAIN, TAPI DIHAPUS DARI MYDATAPAGE) */
        .chart-container {
            background: #1c232e;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #333;
        }
        .chart-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .chart-label {
            width: 120px;
            font-weight: bold;
            text-align: right;
            padding-right: 10px;
        }
        .chart-bar-wrapper {
            flex-grow: 1;
            height: 20px;
            background: #253040;
            border-radius: 3px;
            position: relative;
        }
        .chart-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 1s ease-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 5px;
            font-weight: bold;
            font-size: 0.8em;
            color: var(--color-text);
            text-shadow: 0 0 2px black;
        }
        .bar-red { background-color: var(--color-red-neon); }
        .bar-green { background-color: var(--color-green-neon); }
        
        /* Payment Page */
        .info-box {
            background: linear-gradient(135deg, #184b4d, #14354c); 
            border: 1px solid rgba(51, 255, 153, 0.4); 
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }
        .info-box p { margin: 5px 0; font-size: 1em; color: var(--color-text); }
        .info-box strong.fee-amount {
            color: var(--color-green-neon); 
            font-size: 1.1em;
            text-shadow: 0 0 5px var(--color-green-neon);
        }
        .info-box strong.arrears-amount { 
            color: var(--color-red-neon); 
            font-size: 1.1em;
            text-shadow: 0 0 5px var(--color-red-neon);
            font-weight: bold;
        }
        .arrears-note { 
            font-size: 0.75em;
            color: #ffcc00; 
            margin-top: 5px;
            font-style: italic;
        }
        
        .payment-user-info {
            background: var(--color-card);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 25px;
            text-align: left;
            border-left: 5px solid var(--color-green-neon);
            box-shadow: 0 0 10px rgba(51, 255, 153, 0.3);
        }
        .payment-user-info p {
            margin: 3px 0;
            font-size: 0.9em;
        }
        .payment-user-info strong {
            color: #fff;
        }
        
        .payment-input-group h3 {
            font-size: 1.2em;
            color: #fff;
            margin-bottom: 10px;
            border-left: 4px solid var(--color-neon);
            padding-left: 10px;
        }
        .payment-input-container {
            position: relative;
        }
        .payment-input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 5px;
            background-color: var(--color-bg);
            color: var(--color-green-neon);
            font-size: 1.5em;
            text-align: center;
            box-shadow: 0 0 10px rgba(51, 255, 153, 0.2);
            box-sizing: border-box;
            font-weight: bold;
        }
        .min-payment-note {
            font-size: 0.8em;
            color: #999;
            margin-top: 5px;
            text-align: center;
        }
        
        /* Allocation Details */
        .allocation-details {
            margin-top: 20px;
            padding: 15px;
            background: #1c232e;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .allocation-details h3 {
            margin: 0 0 10px 0;
            font-size: 1em;
            color: var(--color-neon);
        }
        .allocation-message {
            padding: 10px;
            background: #2a0a0a;
            color: var(--color-red-neon);
            border: 1px solid var(--color-red-neon);
            border-radius: 5px;
            font-size: 0.9em;
            text-align: center;
        }
        .allocation-message.success {
            background: #0a2a1a;
            color: var(--color-green-neon);
            border: 1px solid var(--color-green-neon);
            text-align: left;
        }
        .allocation-message.success ul {
            list-style: disc inside;
            padding-left: 0;
            margin: 5px 0 0 15px;
            font-size: 0.95em;
        }
        .allocation-message.success li {
            margin-bottom: 3px;
        }

        /* Payment Methods */
        .method-group h3 {
            font-size: 1.2em;
            color: #fff;
            margin-bottom: 10px;
            border-left: 4px solid var(--color-neon);
            padding-left: 10px;
        }
        .method-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .method-button {
            background: #1f2733;
            padding: 15px 10px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #333;
            font-size: 0.9em;
            /* PENYESUAIAN: Membuat ikon dan teks terlihat lebih baik */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
        }
        .method-button i {
            display: block;
            font-size: 1.5em;
            margin-bottom: 5px;
            color: #777;
        }
        .method-button:hover {
            background: #253040;
            border-color: var(--color-neon);
        }
        .method-button.selected {
            background: #0d2828;
            border: 2px solid var(--color-neon);
            box-shadow: var(--glow-intensity);
        }
        .method-button.selected i {
            color: var(--color-neon);
        }

        #payNowBtn {
            background: linear-gradient(90deg, var(--color-green-neon), #00ff00);
            color: var(--color-bg);
            border: 1px solid var(--color-green-neon);
        }
        #payNowBtn:disabled {
            background: #333;
            color: #777;
            cursor: not-allowed;
            box-shadow: none;
            border: 1px solid #555;
        }

        /* Profile Page */
        .profile-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .profile-card {
            background: #1f2733;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            width: 100%;
            border: 1px solid rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
        .profile-icon-wrapper i {
            font-size: 4em;
            color: var(--color-neon);
            text-shadow: var(--glow-intensity);
            margin-bottom: 15px;
        }
        .profile-data h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #fff;
            font-size: 1.3em;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #222;
            font-size: 0.9em;
        }
        .data-label {
            color: #aaa;
        }
        .data-value {
            font-weight: bold;
            color: var(--color-text);
        }
        .status-active {
            color: var(--color-green-neon);
            text-shadow: 0 0 5px rgba(51, 255, 153, 0.5);
        }
        .status-inactive {
            color: var(--color-red-neon);
            text-shadow: 0 0 5px rgba(255, 51, 51, 0.5);
        }

        /* Detail Pages (QR, DANA, TRANSFER, CASH) */
        .page-content {
            text-align: center;
            padding: 20px 0;
        }
        .page-content h2 {
            color: var(--color-neon);
            font-size: 1.3em;
            margin-bottom: 15px;
        }
        .page-content p {
            font-size: 0.95em;
            line-height: 1.4;
            margin-bottom: 15px;
        }
        .admin-info {
            background: #1c232e;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--color-green-neon);
            margin: 20px 0;
            font-size: 1em;
            text-align: left;
        }
        .admin-info strong {
            display: block;
            font-size: 1.2em;
            color: var(--color-green-neon);
            margin-bottom: 5px;
        }
        
        /* --- QRIS Page Style BARU (REVISI) --- */

        .qr-container {
            background: linear-gradient(135deg, #1c232e, #10151c);
            padding: 25px;
            border-radius: 15px;
            border: 3px solid var(--color-neon);
            box-shadow: 
                0 0 20px rgba(0, 255, 255, 0.5), 
                0 0 50px rgba(0, 255, 255, 0.1); 
            margin: 20px auto;
            max-width: 300px;
            transform: perspective(1000px) rotateY(0deg) rotateX(0deg); 
            transition: all 0.5s ease-in-out;
            text-align: left; /* REVISI: Agar info warga di atas QR center */
        }

        .qr-title {
            color: var(--color-neon);
            font-size: 1.5em;
            text-shadow: 0 0 10px var(--color-neon);
            margin-bottom: 10px;
            text-align: center;
        }

        .qr-info-user { /* BARU: Info user di atas QR */
            background: #0d2828;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--color-green-neon);
            margin-bottom: 15px;
            box-shadow: 0 0 10px rgba(51, 255, 153, 0.3);
            text-align: left;
        }
        .qr-info-user p { margin: 3px 0; font-size: 0.9em; color: #aaa; }
        .qr-info-user strong { color: #fff; }


        .qr-info-box-new {
            background: #161b22; /* Diubah agar nominal lebih menonjol */
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--color-neon);
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
            text-align: center;
        }

        .qr-info-box-new p {
            margin: 3px 0;
            font-size: 0.9em;
            color: #aaa;
        }
        .qr-info-box-new strong.qr-amount {
            color: var(--color-green-neon);
            font-size: 1.8em; /* REVISI: Ukuran lebih besar */
            font-weight: bold;
            text-shadow: 0 0 5px var(--color-green-neon);
        }

        /* KODE QR */
        .qr-code-wrapper {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); 
            display: inline-block;
            border: 3px solid #000;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }

        .qr-code-wrapper img {
            width: 90%; 
            height: auto;
            display: block;
            margin: auto;
        }

        /* Tombol di Halaman QR */
        #downloadQRBtn {
            background-color: #3a4b63;
            color: #fff;
            margin-top: 15px;
            padding: 10px;
            font-size: 0.9em;
        }
        #downloadQRBtn:hover {
             background-color: #4a5b73;
        }
        
        #confirmPaymentQR {
            background: linear-gradient(90deg, #33ff99, #00ff00);
            color: var(--color-bg);
            border: 1px solid #33ff99;
            margin-top: 15px;
        }

        #confirmPaymentQR:hover {
            box-shadow: 0 0 20px #33ff99, 0 0 30px #33ff99;
        }
        
        .qr-confirmation-note {
             font-size: 0.8em; 
             color: #999; 
             margin-top: 10px;
             text-align: center;
        }

        /* Penyesuaian tombol lihat semua/singkat */
        #toggleTableBtn {
            margin-top: 0; 
            margin-bottom: 15px;
        }
        
        /* --- REPORT PAGE (BARU) --- */
        .report-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .report-card {
            background: linear-gradient(135deg, #1f2733, #161b22);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        
        .report-card h3 {
            margin-top: 0;
            font-size: 1.1em;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 5px;
        }
        
        .income-card { 
            border-left: 5px solid var(--color-income);
            box-shadow: 0 0 15px rgba(51, 255, 153, 0.3); 
        }
        .expense-card {
            border-left: 5px solid var(--color-expense);
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.3);
        }
        .net-card {
             border-left: 5px solid var(--color-neon);
             box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
             margin-bottom: 20px;
        }

        .report-amount {
            font-size: 1.8em;
            font-weight: bold;
            margin: 5px 0;
        }
        .report-income { color: var(--color-income); text-shadow: 0 0 5px rgba(51, 255, 153, 0.5); }
        .report-expense { color: var(--color-expense); text-shadow: 0 0 5px rgba(255, 51, 51, 0.5); }
        .report-net { color: var(--color-neon); text-shadow: 0 0 5px rgba(0, 255, 255, 0.5); }
        
        /* Bar Chart Report */
        .bar-chart-report {
            margin-top: 15px;
            padding: 15px;
            background: #1c232e;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .bar-chart-report h3 {
            margin-bottom: 15px;
            color: var(--color-yellow);
        }

        .bar-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .month-bar-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }

        .month-label-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #999;
            margin-bottom: 2px;
        }

        .month-label {
            font-weight: bold;
            color: var(--color-text);
            width: 50px;
        }

        .bar-container {
            display: flex;
            width: 100%;
            height: 20px;
            background-color: #253040;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        
        .bar-income {
            height: 100%;
            background-color: var(--color-income);
            transition: width 1s ease-out;
            position: absolute;
            left: 0;
            z-index: 2;
        }

        .bar-expense {
            height: 100%;
            background-color: var(--color-expense);
            transition: width 1s ease-out;
            position: absolute;
            right: 0;
            z-index: 1;
        }

        .bar-data-label {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 3;
            font-size: 0.7em;
            color: var(--color-bg);
            font-weight: bold;
            padding: 0 5px;
            opacity: 0.8;
            text-shadow: 0 0 1px black;
        }
        
        .bar-data-income {
            left: 0;
        }
        
        .bar-data-expense {
            right: 0;
        }

        .report-summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            margin-top: 20px;
        }
        .report-summary-table th, .report-summary-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        .report-summary-table th {
            background-color: #253040;
            color: var(--color-neon);
        }
        .report-summary-table tr:hover {
            background-color: #253040;
            cursor: pointer;
        }

        /* Detail Report Page */
        #detailReportPage h2 {
            margin-bottom: 5px;
            color: var(--color-yellow);
        }
        
        #detailReportPage .data-table {
            min-width: 400px; 
            margin-top: 15px;
        }
        
        .detail-income { color: var(--color-income); }
        .detail-expense { color: var(--color-expense); }
        
    </style>
</head>
<body onload="initializeApp()">
    <div id="loadingPage">
        <i class="fas fa-wallet initial-loader-icon"></i> 
        <div class="loader"></div> 
        <p class="initial-loader-text">Gang Kita</p>
    </div>
    
    <div id="floatingBackBtn" onclick="goBack()">
        <i class="fas fa-arrow-left"></i>
    </div>

    <div class="container" style="display: none;"> 
        <div id="loginPage">
            <h2>üí∞ Pembayaran Kas E21-25</h2>
            
            <p id="loginError" class="error-message" style="display: none;">‚ùå Password atau ID Salah!</p>

            <div class="form-group">
                <label for="loginId">ID Warga / Blok</label>
                <input type="text" id="loginId" placeholder="Contoh: Admin atau E21/01" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="Masukkan password rahasia" required>
            </div>
            
            <button class="btn" id="loginBtn">‚ú® MASUK DASHBOARD</button>
            <button class="btn" id="registerToggleBtn">‚úçÔ∏è BELUM PUNYA AKUN? DAFTAR</button>
        </div>

        <div id="registerPage" style="display: none;">
            <h2>üìù Formulir Pendaftaran Warga</h2>
            
            <div class="form-group">
                <label for="regNama">Nama Lengkap</label>
                <input type="text" id="regNama" placeholder="Contoh: Budi Santoso" required>
            </div>
            <div class="form-group">
                <label for="regBlokNo">Blok / No Rumah</label>
                <input type="text" id="regBlokNo" placeholder="Contoh: E21-25" required>
            </div>
            <div class="form-group">
                <label for="regId">ID Warga (Username)</label>
                <input type="text" id="regId" placeholder="Contoh: Top1" required>
            </div>
            <div class="form-group">
                <label for="regPassword">Password</label>
                <input type="password" id="regPassword" placeholder="Buat password unik (min. 4 karakter)" minlength="4" required>
            </div>
            
            <button class="btn" id="submitRegisterBtn">üü¢ KIRIM DATA KE ADMIN VIA WHATSAPP</button>
            
            <button class="btn" id="loginToggleBtn">‚¨ÖÔ∏è KEMBALI KE LOGIN</button>
            
        </div>
    </div>
    
    <div id="dashboardPage" style="display: none;">
        
        <div class="top-bar">
            <h1>üíµ Kas Gang E21-25</h1>
            <div id="digitalClock">--:--:--</div>
        </div>

        <div class="dashboard-content">
            
            <div class="balance-card">
                <h3>SALDO KAS TERKINI</h3>
                <div class="balance-amount">Rp 1.000.000</div>
                <button class="detail-btn" onclick="alert('Simulasi: Menampilkan detail histori saldo.');">Lihat Detail</button>
            </div>

            <div class="welcome-message">
                üëã Selamat Datang, <strong class="user-name" id="dashboardUserName">PENGGUNA</strong>!
            </div>

            <div class="menu-wrapper">
                
                <div class="menu-grid">
                    <a href="#" class="menu-item" onclick="showPaymentPage()"> 
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Bayar Kas</span>
                    </a>
                    
                    <a href="#" class="menu-item" onclick="showPage('profile')"> 
                        <i class="fas fa-user-circle"></i>
                        <span>Profil Saya</span> 
                    </a>
                    
                    <a href="#" class="menu-item" onclick="showPage('datawarga')"> 
                        <i class="fas fa-users"></i>
                        <span>Data Warga</span>
                    </a>
                    
                    <a href="#" class="menu-item" onclick="showPage('myData')"> 
                        <i class="fas fa-table"></i> 
                        <span>Data Saya</span> 
                    </a>
                    
                    <a href="#" class="menu-item" onclick="showPage('report')">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>Laporan Keuangan</span>
                    </a>
                    
                    <a href="#" class="menu-item" onclick="showPage('login')">
                        <i class="fas fa-door-open"></i>
                        <span>Logout</span>
                    </a>
                </div>
                
            </div>
            
            <div class="marquee-container">
                <div class="marquee-text">üí∞ Bayar Kas Tepat Waktu adalah Bentuk Kepedulian Terbaik Kita! - Jangan Tunda Sampai Ditagih. üöÄ</div>
            </div>
            
            <p class="dashboard-footer">¬© 2026 Kas Warga Gang E21-25. Dari kita untuk kita</p>

        </div>
    </div>
    
    <div id="myDataPage" style="display: none;">
        <div class="top-bar">
            <h1>üìä Data Iuran Saya</h1>
            <div id="myDataClock">--:--:--</div>
        </div>
        
        <div class="data-table-container">
            <h3>Rekapitulasi Iuran (Simulasi)</h3>
            <p style="text-align: center;">Nama: <strong id="myDataName">Nama User</strong> | Blok/No: <strong id="myDataBlock">E21-XX</strong></p>

            <hr style="border-color: #333; margin-top: 20px;">

            <button id="toggleTableBtn" onclick="toggleMonthlyTable()">
                <i class="fas fa-eye"></i> Lihat Semua Detail Bulanan
            </button>
            
            <div id="monthlyTableContainer" style="display: block;"> 
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Bulan</th>
                            <th>2025 (Kekurangan)</th>
                            <th>2026 (Lunas/Lebih Bayar)</th>
                        </tr>
                    </thead>
                    <tbody id="myDataTableBody">
                        </tbody>
                </table>
            </div>
            
            <div id="mySummaryContainer" style="margin-top: 15px; padding: 10px; background: #1f2733; border-radius: 5px; text-align: left; border-left: 5px solid var(--color-neon);">
                </div>
            
            <button class="btn" onclick="showPaymentPage()" style="margin-top: 15px;">
                üí∏ BAYAR KAS SEKARANG
            </button>
            
        </div>
    </div>
    
    <div id="dataWargaPage" style="display: none;">
        <div class="top-bar">
            <h1>üë• Data Iuran Warga</h1>
            <div id="dataWargaClock">--:--:--</div>
        </div>
        
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Blok/No.</th>
                        <th>Nama Warga</th>
                        <th>Tunggakan 2025 (Bln)</th>
                        <th>Iuran 2026 (Bln)</th>
                    </tr>
                </thead>
                <tbody id="residentsTableBody">
                    </tbody>
            </table>
        </div>
        
        <p style="font-size: 0.8em; color: #777; text-align: center; margin-top: 15px;">
            <span class="status-red">Merah:</span> Tunggakan | 
            <span class="status-green">Hijau:</span> Lunas/Lebih Bayar |
            <span class="status-yellow">Kuning:</span> Belum Bayar
        </p>

    </div>
    
    <div id="paymentPage" style="display: none;">
        <div class="top-bar">
            <h1>üíµ Kas Gang E21-25</h1>
            <div id="paymentClock">--:--:--</div>
        </div>
        
        <div class="payment-content">
            
            <div class="payment-user-info">
                <p>Nama: <strong id="paymentUserName">NAMA Warga</strong></p>
                <p>Blok/No: <strong id="paymentUserBlock">E21-XX</strong></p>
            </div>
            
            <div class="info-box">
                <p>(Iuran per bulan: <strong class="fee-amount">Rp <span id="monthlyFee">25.000</span></strong>)</p>
                <p>Tunggakan 2025: <strong class="arrears-amount">Rp <span id="arrearsAmount">75.000</span></strong></p>
                <p class="arrears-note" id="arrearsNote" style="display: none;">‚ö†Ô∏è Anda masih memiliki tunggakan! Harap bayar minimum Rp <span id="minPaymentAlert">75.000</span>.</p>
            </div>
            
            <div class="payment-input-group">
                <h3>MASUKKAN JUMLAH PEMBAYARAN (RP)</h3>
                <div class="payment-input-container">
                    <input type="number" id="paymentAmount" class="payment-input" value="25000" min="25000" oninput="updateAllocationDetail()">
                </div>
                <p class="min-payment-note">
                    *Minimum bayar: **Rp <span id="minPaymentDisplay">75.000</span>** (Mencakup Tunggakan 2025 dan/atau 1 Bulan Iuran 2026)
                </p>
            </div>
            
            <div class="allocation-details">
                <h3>üìù DETAIL ALOKASI PELUNASAN</h3>
                <div id="allocationMessage" class="allocation-message">
                    NOMINAL KURANG! (Min. Rp 75.000)
                    <br><small>Masukkan nominal yang cukup untuk melunasi Tunggakan 2025.</small>
                </div>
                <p style="font-size: 0.7em; color: #555; text-align: center; margin-top: -15px;">
                    *Nominal akan dialokasikan ke tunggakan 2025 terlebih dahulu.
                </p>
            </div>
            
            <div class="method-group">
                <h3>üí≥ PILIH METODE PEMBAYARAN</h3>
                <div class="method-grid">
                    <div class="method-button" data-method="qr" onclick="selectPaymentMethod('qr')">
                        <i class="fas fa-qrcode"></i> QRIS
                    </div>
                    <div class="method-button" data-method="dana" onclick="selectPaymentMethod('dana')">
                        <i class="fas fa-wallet"></i> VA DANA
                    </div>
                    <div class="method-button" data-method="transfer" onclick="selectPaymentMethod('transfer')">
                        <i class="fas fa-building-columns"></i> Transfer Bank
                    </div>
                    <div class="method-button" data-method="cash" onclick="selectPaymentMethod('cash')">
                        <i class="fas fa-money-bill-transfer"></i> Tunai (Ke Bendahara)
                    </div>
                </div>
            </div>
            
            <button class="btn" id="payNowBtn" onclick="goToPaymentDetails()" disabled>
                BAYAR SEKARANG <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <div id="profilePage" style="display: none;">
        
        <div class="top-bar">
            <h1>üë§ Profil Warga</h1>
            <div id="profileClock">--:--:--</div>
        </div>
        
        <div class="profile-content">
            
            <div class="profile-card">
                
                <div class="profile-icon-wrapper">
                    <i class="fas fa-user-circle"></i> 
                </div>

                <div class="profile-data">
                    <h3 id="profileNama">NAMA LENGKAP PENGGUNA</h3>
                    
                    <div class="data-row">
                        <span class="data-label">ID Warga</span>
                        <span class="data-value" id="profileId">ID001</span>
                    </div>
                    
                    <div class="data-row">
                        <span class="data-label">Blok / No. Rumah</span>
                        <span class="data-value" id="profileBlokNo">E21-05</span>
                    </div>
                    
                    <div class="data-row">
                        <span class="data-label">Status Akun</span>
                        <span class="data-value status-active" id="profileStatus">AKTIF</span>
                    </div>

                </div>

            </div>
            
            </div>
        
    </div>

    <div id="qrPage" style="display: none;">
        <div class="top-bar"><h1>QRIS Payment</h1></div>
        
        <div class="page-content">
            
            <div class="qr-container">
                <h2 class="qr-title">SCAN QRIS - KAS WARGA</h2>
                
                <div class="qr-info-user">
                    <p>Nama: <strong id="qrUserName">NAMA Warga</strong></p>
                    <p>Blok/No: <strong id="qrUserBlock">E21-XX</strong></p>
                </div>

                <div class="qr-info-box-new">
                    <p>TOTAL NOMINAL PEMBAYARAN:</p>
                    <strong class="qr-amount">Rp <span id="qrAmount">0</span></strong>
                </div>
                
                <div class="qr-code-wrapper">
                    <img id="qrcode.jpg" src="https://via.placeholder.com/250/FFFFFF/000000?text=QRIS+SIMULASI" alt="QRIS Code">
                </div>
                
                <p style="margin-top: 15px; font-size: 0.85em; color: var(--color-yellow);">
                    **PENTING:** Pastikan Anda memasukkan nominal **Rp <span id="qrAmountDisplayNew">0</span>** (sesuai di atas) di aplikasi Anda.
                </p>
                
                <button class="btn" id="downloadQRBtn" onclick="downloadQrisImage()">
                    ‚¨áÔ∏è UNDUH GAMBAR QRIS
                </button>
            </div>
            
            <button class="btn" id="confirmPaymentQR" onclick="confirmPaymentViaWhatsapp()">
                ‚úÖ KONFIRMASI BAYAR VIA WHATSAPP
            </button>

            <p class="qr-confirmation-note">
                Setelah transfer sukses, klik tombol di atas untuk **mengirim bukti konfirmasi** ke Bendahara.
            </p>
            
        </div>
    </div>
    
    
    <div id="danaPage" style="display: none;">
        <div class="top-bar"><h1>VA DANA Payment</h1></div>
        <div class="page-content">
            <h2>Pembayaran via Virtual Account DANA</h2>
            <p>Mohon transfer sejumlah **Rp <span id="danaAmount">0</span>** ke Virtual Account berikut:</p>
            <div class="admin-info">
                <strong>VA DANA: 8599XXXXXXXXX</strong><br>
                A.N. Bendahara Kas Warga
            </div>
            <p style="margin-top: 15px;">**PENTING:** Pastikan jumlah transfer Anda sesuai agar pembayaran tercatat otomatis.</p>
            <button class="btn" id="finishPaymentDana" onclick="simulatePaymentCompletion()">‚úÖ Selesai Bayar & Konfirmasi</button>
        </div>
    </div>

    <div id="transferPage" style="display: none;">
        <div class="top-bar"><h1>Transfer Bank</h1></div>
        <div class="page-content">
            <h2>Pembayaran via Transfer Bank</h2>
            <p>Mohon transfer sejumlah **Rp <span id="transferAmount">0</span>** ke rekening Bank BCA berikut:</p>
            <div class="admin-info">
                <strong>BCA: 1234567890</strong><br>
                A.N. Bendahara Kas Warga
            </div>
            <p style="margin-top: 15px;">Setelah transfer, **konfirmasi** pembayaran Anda ke Bendahara agar segera diverifikasi.</p>
            <button class="btn" id="finishPaymentTransfer" onclick="simulatePaymentCompletion()">‚úÖ Selesai Bayar & Konfirmasi</button>
        </div>
    </div>

    <div id="cashPage" style="display: none;">
        <div class="top-bar"><h1>Pembayaran Tunai</h1></div>
        <div class="page-content">
            <h2>Serahkan Tunai ke Bendahara</h2>
            <p>Silakan serahkan uang tunai sebesar **Rp <span id="cashAmount">0</span>** kepada Bendahara Kas Warga.</p>
            <div class="admin-info">
                <strong>Nama Bendahara: CHANDRA</strong><br>
                Blok/No: E25-09
            </div>
            <p style="margin-top: 15px;">Pembayaran akan dicatat setelah diterima dan diverifikasi oleh Bendahara.</p>
            <button class="btn" id="finishPaymentCash" onclick="simulatePaymentCompletion()">‚úÖ Selesai Bayar & Konfirmasi</button>
        </div>
    </div>
    
    <div id="reportPage" style="display: none;">
        <div class="top-bar">
            <h1>üìë Laporan Keuangan 2026</h1>
            <div id="reportClock">--:--:--</div>
        </div>
        
        <div class="report-grid">
            
            <div class="report-card income-card">
                <h3>TOTAL PEMASUKAN</h3>
                <div class="report-amount report-income" id="totalIncome">Rp 0</div>
            </div>
            
            <div class="report-card expense-card">
                <h3>TOTAL PENGELUARAN</h3>
                <div class="report-amount report-expense" id="totalExpense">Rp 0</div>
            </div>
            
            <div class="report-card net-card" style="display: none;"> 
                <h3>SALDO BERSIH (P/K)</h3>
                <div class="report-amount report-net" id="netBalance">Rp 0</div>
            </div>
            
        </div>
        
        <div class="bar-chart-report" style="display: none;"> 
            <h3>PERBANDINGAN BULANAN (Simulasi)</h3>
            <div class="bar-wrapper" id="monthlyBarChart">
                </div>
        </div>
        
        <div class="data-table-container">
             <h3 style="color: var(--color-neon); margin-bottom: 10px;">Rincian Pengeluaran Tahun Berjalan</h3> 
            <table class="report-summary-table data-table">
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Keterangan</th>
                        <th>Nominal (Rp)</th>
                    </tr>
                </thead>
                <tbody id="reportSummaryTableBody">
                    </tbody>
            </table>
        </div>
    </div>
    
    <div id="detailReportPage" style="display: none;"> 
        <div class="top-bar">
            <h1>üìë Rincian Laporan</h1>
            <div id="detailReportClock">--:--:--</div>
        </div>
        
        <h2 id="detailReportMonth">Rincian Bulan ...</h2>
        <p style="font-size: 0.9em; color: #aaa;">Daftar transaksi Pemasukan dan Pengeluaran.</p>

        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Keterangan</th>
                        <th>Jenis</th>
                        <th>Nominal (Rp)</th>
                    </tr>
                </thead>
                <tbody id="detailReportTableBody">
                    </tbody>
            </table>
        </div>
        
    </div>

    <script>
        // --- KONFIGURASI SIMULASI ---
        const WHATSAPP_NUMBER = '6285781257570'; 
        const INITIAL_LOADING_TIME = 2500; 
        
        // DATA KEUANGAN SIMULASI
        const MONTHLY_FEE = 25000;
        
        // FUNGSI UTILITY
        const formatRp = (amount) => `Rp ${amount.toLocaleString('id-ID')}`;
        const formatNumber = (amount) => amount.toLocaleString('id-ID');

        // --- DATA BULANAN SIMULASI ---
        // Contoh data bulanan untuk USER ROHMAN (ID: rohman)
        const ROHMAN_FINANCE_DATA = {
            id: 'rohman',
            block: 'E21-51',
            monthlyData: [
                // 2025 (1: Belum Lunas, 0: Lunas)
                { year: 2025, month: 'Jan', status: 0 },
                { year: 2025, month: 'Feb', status: 0 },
                { year: 2025, month: 'Mar', status: 0 },
                { year: 2025, month: 'Apr', status: 1 }, // Tunggakan April
                { year: 2025, month: 'Mei', status: 1 }, // Tunggakan Mei
                { year: 2025, month: 'Jun', status: 1 }, // Tunggakan Juni
                { year: 2025, month: 'Jul', status: 0 },
                { year: 2025, month: 'Agu', status: 0 },
                { year: 2025, month: 'Sep', status: 0 },
                { year: 2025, month: 'Okt', status: 0 },
                { year: 2025, month: 'Nov', status: 0 },
                { year: 2025, month: 'Des', status: 0 },
                // 2026 (1: Sudah Bayar/Deposit, 0: Belum Bayar)
                { year: 2026, month: 'Jan', status: 1 }, 
                { year: 2026, month: 'Feb', status: 0 },
                { year: 2026, month: 'Mar', status: 0 },
                { year: 2026, month: 'Apr', status: 0 },
                { year: 2026, month: 'Mei', status: 0 },
                { year: 2026, month: 'Jun', status: 0 },
                { year: 2026, month: 'Jul', status: 0 },
                { year: 2026, month: 'Agu', status: 0 },
                { year: 2026, month: 'Sep', status: 0 },
                { year: 2026, month: 'Okt', status: 0 },
                { year: 2026, month: 'Nov', status: 0 },
                { year: 2026, month: 'Des', status: 0 }
            ]
        };
        
        // FUNGSI UNTUK MENGHITUNG ULANG DARI DATA ROHMAN
        function recalculateRohmanData(data) {
            // Tunggakan 2025 dihitung dari status === 1 (Belum Lunas)
            const arrears2025Count = data.monthlyData.filter(m => m.year === 2025 && m.status === 1).length;
            // Iuran 2026 dihitung dari status === 1 (Sudah Bayar/Lunas)
            const paid2026Count = data.monthlyData.filter(m => m.year === 2026 && m.status === 1).length;
            const arrearsMonths = data.monthlyData.filter(m => m.year === 2025 && m.status === 1).map(m => m.month);

            const arrearsAmount = arrears2025Count * MONTHLY_FEE;
            const paidAmount = paid2026Count * MONTHLY_FEE;
            
            return {
                arrears2025Count,
                paid2026Count,
                arrearsAmount,
                paidAmount,
                arrearsMonths
            };
        }
        
        let rohmanStatus = recalculateRohmanData(ROHMAN_FINANCE_DATA); 
        let ARREARS_AMOUNT = rohmanStatus.arrearsAmount;
        let MIN_PAYMENT = ARREARS_AMOUNT > 0 ? ARREARS_AMOUNT : MONTHLY_FEE;


        // DAFTAR AKUN SIMULASI
        const USERS = {
            'admin': { pass: '123456', name: 'Admin E21-25', block: 'ADMIN', status: 'Aktif' }, 
            'rohman': { pass: '2151', name: 'ROHMAN', block: 'E21-51', status: 'Aktif' }, 
            'e2125': { pass: 'blok01', name: 'BUDI', block: 'E21-01', status: 'Aktif' },
            'e2102': { pass: 'blok02', name: 'ANI', block: 'E21-02', status: 'Aktif' },
            'e2103': { pass: 'blok03', name: 'JOKO', block: 'E21-03', status: 'Aktif' },
            'e2104': { pass: 'blok04', name: 'SARI', block: 'E21-04', status: 'Nonaktif' }, 
            'e2105': { pass: 'blok05', name: 'TONO', block: 'E21-05', status: 'Aktif' },
        };
        
        // DATA SIMULASI WARGA (50 ENTRI) - disesuaikan agar Rohman sesuai dengan data di atas
        const RESIDENTS_DATA = [
            // Data Rohman diambil dari rohmanStatus
            { block: 'E21-51', name: 'Rohman', arrears2025: rohmanStatus.arrears2025Count, paid2026: rohmanStatus.paid2026Count }, 
            { block: 'E21-38', name: 'Novri', arrears2025: 0, paid2026: 0 }, 
            { block: 'E21-02', name: 'Ani Sutanto', arrears2025: 2, paid2026: 0 },
            { block: 'E21-03', name: 'Joko Prabowo', arrears2025: 0, paid2026: 12 }, 
            { block: 'E21-04', name: 'Sari Dewi', arrears2025: 5, paid2026: 0 },
            { block: 'E21-05', name: 'Tono Wijaya', arrears2025: 0, paid2026: 6 },
            { block: 'E22-10', name: 'Candra', arrears2025: 12, paid2026: 0 }, 
            { block: 'E22-11', name: 'Dewi Karti', arrears2025: 0, paid2026: 2 },
            { block: 'E22-12', name: 'Eko Purnomo', arrears2025: 1, paid2026: 0 },
            { block: 'E22-13', name: 'Fina Aulia', arrears2025: 0, paid2026: 4 },
            { block: 'E23-20', name: 'Gatot Subroto', arrears2025: 0, paid2026: 0 },
            { block: 'E23-21', name: 'Hesti', arrears2025: 3, paid2026: 0 },
            { block: 'E23-22', name: 'Iwan Reks', arrears2025: 0, paid2026: 1 },
            { block: 'E23-23', name: 'Jaja Miharja', arrears2025: 0, paid2026: 8 },
            { block: 'E24-30', name: 'Kiki Amalia', arrears2025: 4, paid2026: 1 },
            { block: 'E24-31', name: 'Lia Fitria', arrears2025: 0, paid2026: 0 },
            { block: 'E24-32', name: 'Maman', arrears2025: 10, paid2026: 0 },
            { block: 'E24-33', name: 'Nina Zulaika', arrears2025: 0, paid2026: 12 },
            { block: 'E25-40', name: 'Oscar', arrears2025: 0, paid2026: 5 },
            { block: 'E25-41', name: 'Puji Santika', arrears2025: 2, paid2026: 0 },
            { block: 'E25-42', name: 'Qirana', arrears2025: 0, paid2026: 1 },
            { block: 'E25-43', name: 'Risma', arrears2025: 0, paid2026: 0 },
            { block: 'E25-44', name: 'Samsul', arrears2025: 6, paid2026: 0 },
            { block: 'E25-45', name: 'Tina', arrears2025: 0, paid2026: 3 },
            { block: 'E25-46', name: 'Umar', arrears2025: 1, paid2026: 1 },
            { block: 'E25-47', name: 'Vina', arrears2025: 0, paid2026: 10 },
            { block: 'E25-48', name: 'Wawan', arrears2025: 0, paid2026: 0 },
            { block: 'E25-49', name: 'Xena', arrears2025: 8, paid2026: 0 },
            { block: 'E25-50', name: 'Yanto', arrears2025: 0, paid2026: 2 },
            { block: 'E25-52', name: 'Zahra', arrears2025: 0, paid2026: 1 },
            { block: 'E25-53', name: 'Andre', arrears2025: 0, paid2026: 0 },
            { block: 'E25-54', name: 'Beni', arrears2025: 7, paid2026: 0 },
            { block: 'E25-55', name: 'Citra', arrears2025: 0, paid2026: 4 },
            { block: 'E25-56', name: 'Dodo', arrears2025: 0, paid2026: 0 },
            { block: 'E25-57', name: 'Erma', arrears2025: 11, paid2026: 0 },
            { block: 'E25-58', name: 'Fahmi', arrears2025: 0, paid2026: 1 },
            { block: 'E25-59', name: 'Gita', arrears2025: 0, paid2026: 9 },
            { block: 'E25-60', name: 'Hadi', arrears2025: 5, paid2026: 0 },
            { block: 'E25-61', name: 'Indah', arrears2025: 0, paid2026: 12 },
            { block: 'E25-62', name: 'Jaya', arrears2025: 0, paid2026: 6 },
            { block: 'E25-63', name: 'Kania', arrears2025: 9, paid2026: 0 },
            { block: 'E25-64', name: 'Lukman', arrears2025: 0, paid2026: 0 },
            { block: 'E25-65', name: 'Maya', arrears2025: 3, paid2026: 0 },
            { block: 'E25-66', name: 'Novi', arrears2025: 0, paid2026: 1 },
            { block: 'E25-67', name: 'Oki', arrears2025: 0, paid2026: 5 },
            { block: 'E25-68', name: 'Putri', arrears2025: 1, paid2026: 0 },
            { block: 'E25-69', name: 'Riko', arrears2025: 0, paid2026: 1 },
            { block: 'E25-70', name: 'Sinta', arrears2025: 0, paid2026: 0 },
            { block: 'E25-71', name: 'Taufik', arrears2025: 4, paid2026: 0 },
            { block: 'E25-72', name: 'Umi', arrears2025: 0, paid2026: 2 },
        ];
        
        // --- DATA LAPORAN KEUANGAN SIMULASI (2026) ---
        const MONTHLY_REPORTS = [
            { 
                month: 'Januari 2026', 
                income: 1800000, 
                expense: 350000, 
                details: [
                    { date: '05 Jan', desc: 'Iuran Kas Jan-Mar (Budi)', type: 'Pemasukan', amount: 75000 },
                    { date: '10 Jan', desc: 'Pembelian bola lampu pos', type: 'Pengeluaran', amount: 150000 },
                    { date: '15 Jan', desc: 'Iuran Kas 12 bulan (Joko)', type: 'Pemasukan', amount: 300000 },
                    { date: '20 Jan', desc: 'Perbaikan pompa air umum', type: 'Pengeluaran', amount: 200000 },
                    { date: '28 Jan', desc: 'Pemasukan Iuran Lain', type: 'Pemasukan', amount: 1425000 },
                ]
            },
            { 
                month: 'Februari 2026', 
                income: 250000, 
                expense: 100000,
                details: [
                    { date: '01 Feb', desc: 'Pembelian cat pagar pos', type: 'Pengeluaran', amount: 100000 },
                    { date: '15 Feb', desc: 'Pemasukan Iuran', type: 'Pemasukan', amount: 250000 },
                ]
            },
            { 
                month: 'Maret 2026', 
                income: 450000, 
                expense: 500000,
                details: [
                    { date: '05 Mar', desc: 'Pemasukan Iuran', type: 'Pemasukan', amount: 450000 },
                    { date: '12 Mar', desc: 'Perawatan rumput lapangan', type: 'Pengeluaran', amount: 500000 },
                ]
            },
            { 
                month: 'April 2026', 
                income: 150000, 
                expense: 0,
                details: [
                    { date: '10 Apr', desc: 'Iuran Kas', type: 'Pemasukan', amount: 150000 },
                ]
            },
             { 
                month: 'Mei 2026', 
                income: 0, 
                expense: 0,
                details: []
            },
            { 
                month: 'Juni 2026', 
                income: 0, 
                expense: 0,
                details: []
            },
             { 
                month: 'Juli 2026', 
                income: 0, 
                expense: 0,
                details: []
            },
            { 
                month: 'Agustus 2026', 
                income: 0, 
                expense: 0,
                details: []
            },
            { 
                month: 'September 2026', 
                income: 0, 
                expense: 0,
                details: []
            },
            { 
                month: 'Oktober 2026', 
                income: 0, 
                expense: 0,
                details: []
            },
            { 
                month: 'November 2026', 
                income: 0, 
                expense: 0,
                details: []
            },
            { 
                month: 'Desember 2026', 
                income: 0, 
                expense: 0,
                details: []
            },
        ];

        let loggedInUser = null; 
        let selectedMethod = null; 
        
        let navigationHistory = []; 
        
        // Ambil elemen penting (agar JS tidak error saat mencari elemen)
        const loadingPage = document.getElementById('loadingPage');
        const container = document.querySelector('.container');
        const loginPage = document.getElementById('loginPage');
        const registerPage = document.getElementById('registerPage');
        const dashboardPage = document.getElementById('dashboardPage');
        const paymentPage = document.getElementById('paymentPage');
        const profilePage = document.getElementById('profilePage');
        const dataWargaPage = document.getElementById('dataWargaPage'); 
        const myDataPage = document.getElementById('myDataPage'); 
        const reportPage = document.getElementById('reportPage'); 
        const detailReportPage = document.getElementById('detailReportPage'); 
        const paymentAmountInput = document.getElementById('paymentAmount');
        const allocationMessage = document.getElementById('allocationMessage');
        const payNowBtn = document.getElementById('payNowBtn');
        const residentsTableBody = document.getElementById('residentsTableBody'); 
        const myDataTableBody = document.getElementById('myDataTableBody'); 


        // --- FUNGSI UTAMA START APLIKASI ---
        function initializeApp() {
            loadingPage.style.display = 'flex'; 
            document.body.classList.add('hide-back-button');

            navigationHistory.push('loading'); 

            // Update MIN_PAYMENT awal
            updateMinPayment();

            setTimeout(() => {
                navigationHistory.pop();
                showPage('login', false); 
                generateResidentsTable(); 
            }, INITIAL_LOADING_TIME);
            
            updateClock();
        }

        function updateMinPayment() {
            // Hanya berlaku untuk user 'rohman' sebagai simulasi user logged in
            if (loggedInUser && loggedInUser.id === 'rohman') {
                rohmanStatus = recalculateRohmanData(ROHMAN_FINANCE_DATA);
                ARREARS_AMOUNT = rohmanStatus.arrearsAmount;
                MIN_PAYMENT = ARREARS_AMOUNT > 0 ? ARREARS_AMOUNT : MONTHLY_FEE;
            } else {
                // Default data jika bukan 'rohman' (atau jika belum login)
                // Menggunakan data rohman untuk simulasi (agar chart di dataWarga terisi)
                rohmanStatus = recalculateRohmanData(ROHMAN_FINANCE_DATA); 
                ARREARS_AMOUNT = rohmanStatus.arrearsAmount; 
                MIN_PAYMENT = ARREARS_AMOUNT > 0 ? ARREARS_AMOUNT : MONTHLY_FEE;
            }
            
            // Perbarui data RESIDENTS_DATA untuk rohman
            const rohmanIndex = RESIDENTS_DATA.findIndex(r => r.block === 'E21-51');
            if (rohmanIndex !== -1) {
                RESIDENTS_DATA[rohmanIndex].arrears2025 = rohmanStatus.arrears2025Count;
                RESIDENTS_DATA[rohmanIndex].paid2026 = rohmanStatus.paid2026Count;
            }
            
            // Perbarui tabel warga setelah update data rohman
            generateResidentsTable();
        }
        
        // --- FUNGSI JAM DIGITAL ---
        function updateClock() {
            const now = new Date();
            let hours = now.getHours();
            let minutes = now.getMinutes();
            let seconds = now.getSeconds();

            hours = hours < 10 ? '0' + hours : hours;
            minutes = minutes < 10 ? '0' + minutes : minutes;
            seconds = seconds < 10 ? '0' + seconds : seconds;

            const timeString = `${hours}:${minutes}:${seconds}`;
            
            const clockElements = document.querySelectorAll('#digitalClock, #profileClock, #paymentClock, #dataWargaClock, #myDataClock, #reportClock, #detailReportClock'); 
            clockElements.forEach(el => el.textContent = timeString);
        }
        setInterval(updateClock, 1000); 
        
        // --- FUNGSI GENERATE TABEL WARGA ---
        function generateResidentsTable() {
            residentsTableBody.innerHTML = ''; 
            
            RESIDENTS_DATA.sort((a, b) => {
                if (a.arrears2025 !== b.arrears2025) {
                    return b.arrears2025 - a.arrears2025;
                }
                return a.block.localeCompare(b.block);
            });

            RESIDENTS_DATA.forEach(resident => {
                const row = residentsTableBody.insertRow();
                
                let status2025;
                if (resident.arrears2025 > 0) {
                    status2025 = `<span class="status-red">${resident.arrears2025} Bln</span>`;
                } else {
                    status2025 = `<span class="status-green">Lunas</span>`;
                }
                
                let status2026;
                if (resident.paid2026 > 0) {
                    status2026 = `<span class="status-green">${resident.paid2026} Bln</span>`;
                } else if (resident.arrears2025 === 0) {
                    status2026 = `<span class="status-yellow">Belum Bayar</span>`;
                } else {
                    status2026 = `<span class="status-grey">Tunggakan Dulu</span>`;
                }


                row.innerHTML = `
                    <td>${resident.block}</td>
                    <td>${resident.name}</td>
                    <td style="text-align: center;">${status2025}</td>
                    <td style="text-align: center;">${status2026}</td>
                `;
            });
        }

        // --- FUNGSI GENERATE TABEL DATA SAYA (REVISI) ---
        function generateMyDataTable() {
            if (!loggedInUser || loggedInUser.id !== 'rohman') return; 
            
            // 1. Update info nama/blok
            document.getElementById('myDataName').textContent = loggedInUser.name;
            document.getElementById('myDataBlock').textContent = loggedInUser.block;

            // 2. Generate detail bulanan
            myDataTableBody.innerHTML = '';
            
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];

            months.forEach((month, index) => {
                const data2025 = ROHMAN_FINANCE_DATA.monthlyData.find(m => m.month === month && m.year === 2025);
                const data2026 = ROHMAN_FINANCE_DATA.monthlyData.find(m => m.month === month && m.year === 2026);

                const status2025 = data2025 && data2025.status === 0 
                    ? `<span class="status-green">Lunas</span>` 
                    : `<span class="status-red">Kekurangan</span>`;
                
                const status2026 = data2026 && data2026.status === 1 
                    ? `<span class="status-green">Lunas</span>` 
                    : `<span class="status-yellow">Belum Bayar</span>`;

                const row = myDataTableBody.insertRow();
                row.innerHTML = `
                    <td>${month}</td>
                    <td>${status2025}</td>
                    <td>${status2026}</td>
                `;
                
                // LOGIKA BARU UNTUK TAMPILAN SEBAGIAN (HANYA 3 BARIS PERTAMA)
                if (index > 2) { 
                     row.classList.add('hidden-row');
                }
            });

            // 3. Update Ringkasan dan Tombol Toggle
            const { arrears2025Count, paid2026Count, arrearsAmount, paidAmount, arrearsMonths } = rohmanStatus;
            
            // Hitung sisa iuran 2026 (Total 12 bulan)
            const remaining2026 = 12 - paid2026Count;
            const remaining2026Amount = remaining2026 * MONTHLY_FEE;
            
            // Konten Ringkasan Total
            document.getElementById('mySummaryContainer').innerHTML = `
                <p style="margin: 0; font-size: 1em;">
                    <strong>Total Kekurangan 2025:</strong> 
                    <span class="status-red" style="float: right;">${formatRp(arrearsAmount)} (${arrears2025Count} bln)</span>
                </p>
                <p style="margin: 5px 0 0 0; font-size: 1em;">
                    <strong>Iuran 2026 Lunas/Lebih Bayar:</strong> 
                    <span class="status-green" style="float: right;">${formatRp(paidAmount)} (${paid2026Count} bln)</span>
                </p>
                <p style="margin: 5px 0 0 0; font-size: 0.9em; border-top: 1px solid #2d3846; padding-top: 5px;">
                    **Sisa Iuran 2026 (Belum Lunas):** <span class="status-yellow" style="float: right;">${formatRp(remaining2026Amount)} (${remaining2026} bln)</span>
                </p>
            `;


            // Update Tombol Toggle
            const arrearsText = arrears2025Count > 0 ? `(${arrears2025Count} Bln Kekurangan)` : '';
            const paidText = paid2026Count > 0 ? `(+${paid2026Count} Bln Lunas)` : '';
            
            document.getElementById('toggleTableBtn').innerHTML = `<i class="fas fa-eye"></i> Lihat Semua Detail Bulanan ${arrearsText} ${paidText}`;
            
        }

        // --- FUNGSI TOGGLE TABEL BULANAN (REVISI) ---
        function toggleMonthlyTable() {
            const hiddenRows = document.querySelectorAll('#myDataTableBody .hidden-row');
            const toggleBtn = document.getElementById('toggleTableBtn');
            const { arrears2025Count, paid2026Count } = recalculateRohmanData(ROHMAN_FINANCE_DATA);
            
            const arrearsText = arrears2025Count > 0 ? `(${arrears2025Count} Bln Kekurangan)` : '';
            const paidText = paid2026Count > 0 ? `(+${paid2026Count} Bln Lunas)` : '';
            
            const isVisible = hiddenRows.length > 0 && hiddenRows[0].style.display !== 'none'; 

            if (isVisible) {
                // Jika sedang terlihat, sembunyikan
                hiddenRows.forEach(row => row.style.display = 'none');
                toggleBtn.innerHTML = `<i class="fas fa-eye"></i> Lihat Semua Detail Bulanan ${arrearsText} ${paidText}`;
            } else {
                // Jika sedang tersembunyi, tampilkan
                hiddenRows.forEach(row => row.style.display = 'table-row');
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Lihat Singkat (3 Bulan Teratas)';
            }
        }
        
        
        // --- FUNGSI NAVIGASI RIWAYAT DAN TAMPILKAN HALAMAN ---
        
        function goBack() {
            if (navigationHistory.length > 1) {
                navigationHistory.pop(); 
                const previousPage = navigationHistory[navigationHistory.length - 1]; 
                showPage(previousPage, false); 
            } else {
                showPage('login', false);
            }
        }
        
        function checkFloatingButton(currentPage) {
            const body = document.body;
            const pagesToHideButton = ['login', 'register', 'dashboard', 'loading']; 
            
            if (pagesToHideButton.includes(currentPage)) {
                body.classList.add('hide-back-button');
            } else {
                body.classList.remove('hide-back-button');
            }
        }
        
        function showPage(pageToShow, addToHistory = true) {
            // Sembunyikan semua halaman utama
            document.querySelectorAll('#loginPage, #registerPage, #dashboardPage, #profilePage, #paymentPage, #qrPage, #danaPage, #transferPage, #cashPage, #dataWargaPage, #myDataPage, #reportPage, #detailReportPage').forEach(el => {
                el.classList.remove('active');
                el.style.display = 'none';
            });
            
            container.style.display = 'none';
            loadingPage.style.display = 'none'; 
            document.body.style.backgroundColor = 'var(--color-bg)';

            // Logika Riwayat Navigasi
            if (addToHistory) {
                if (navigationHistory[navigationHistory.length - 1] !== pageToShow) {
                    navigationHistory.push(pageToShow);
                }
            }
            
            checkFloatingButton(pageToShow);
            
            if (pageToShow === 'login') {
                loginPage.classList.add('active');
                loginPage.style.display = 'block';
                container.style.display = 'block';
                // Jika logout
                if (loggedInUser) loggedInUser = null; 
            } else if (pageToShow === 'register') {
                registerPage.classList.add('active');
                registerPage.style.display = 'block';
                container.style.display = 'block';
            } else if (pageToShow === 'dashboard') {
                dashboardPage.style.display = 'flex'; 
            } else if (pageToShow === 'profile') { 
                if (loggedInUser) {
                    document.getElementById('profileNama').textContent = loggedInUser.name.toUpperCase();
                    document.getElementById('profileId').textContent = loggedInUser.id.toUpperCase();
                    document.getElementById('profileBlokNo').textContent = loggedInUser.block.toUpperCase();
                    document.getElementById('profileStatus').textContent = loggedInUser.status.toUpperCase();
                    document.getElementById('profileStatus').className = 'data-value ' + 
                        (loggedInUser.status.toLowerCase() === 'aktif' ? 'status-active' : 'status-inactive');
                }
                profilePage.style.display = 'flex'; 
            } else if (pageToShow === 'payment') {
                if (loggedInUser) {
                    document.getElementById('paymentUserName').textContent = loggedInUser.name.toUpperCase();
                    document.getElementById('paymentUserBlock').textContent = loggedInUser.block.toUpperCase();
                }
                updateMinPayment(); 
                paymentPage.style.display = 'flex';
                selectPaymentMethod(null);
                updatePaymentInfoDisplay();
                updateAllocationDetail();
            } else if (pageToShow === 'datawarga') { 
                 generateResidentsTable(); 
                 dataWargaPage.style.display = 'flex';
            } else if (pageToShow === 'myData') { 
                 if (!loggedInUser || loggedInUser.id !== 'rohman') {
                    alert('Simulasi: Hanya user "rohman" yang dapat melihat data ini. Log in sebagai rohman (pass: 2151).');
                    showPage('dashboard');
                    return;
                 }
                 updateMinPayment(); 
                 generateMyDataTable();
                 myDataPage.style.display = 'flex';
                 const rows = document.querySelectorAll('#myDataTableBody .hidden-row');
                 rows.forEach(row => row.style.display = 'none');
            } else if (pageToShow === 'report') { 
                 generateReportPage();
                 reportPage.style.display = 'flex';
            } else if (pageToShow === 'detailReport') { 
                 detailReportPage.style.display = 'flex';
            } else if (pageToShow === 'qr') {
                // UPDATE INFO USER DI HALAMAN QR
                if (loggedInUser) {
                    document.getElementById('qrUserName').textContent = loggedInUser.name.toUpperCase();
                    document.getElementById('qrUserBlock').textContent = loggedInUser.block.toUpperCase();
                }
                qrPage.style.display = 'flex';
            } else if (pageToShow === 'dana') {
                danaPage.style.display = 'flex';
            } else if (pageToShow === 'transfer') {
                transferPage.style.display = 'flex';
            } else if (pageToShow === 'cash') {
                cashPage.style.display = 'flex';
            } else if (pageToShow === 'loading') {
                loadingPage.style.display = 'flex';
            }
            updateClock();
        }
        
        // --- FUNGSI BARU: UPDATE INFO TUNGGAKAN DI HALAMAN PEMBAYARAN ---
        function updatePaymentInfoDisplay() {
            document.getElementById('monthlyFee').textContent = MONTHLY_FEE.toLocaleString('id-ID');
            document.getElementById('arrearsAmount').textContent = ARREARS_AMOUNT.toLocaleString('id-ID');
            document.getElementById('minPaymentDisplay').textContent = MIN_PAYMENT.toLocaleString('id-ID');
            document.getElementById('minPaymentAlert').textContent = MIN_PAYMENT.toLocaleString('id-ID');
            
            const arrearsNote = document.getElementById('arrearsNote');
            if (ARREARS_AMOUNT > 0) {
                arrearsNote.style.display = 'block';
            } else {
                arrearsNote.style.display = 'none';
            }

            paymentAmountInput.min = MONTHLY_FEE; 
            if (parseInt(paymentAmountInput.value) < MIN_PAYMENT) {
                 paymentAmountInput.value = MIN_PAYMENT; 
            }
           
        }

        // --- FUNGSI LOGIC PEMBAYARAN ---
        
        function showPaymentPage() {
            // Reset input saat masuk ke halaman pembayaran
            updateMinPayment();
            paymentAmountInput.value = MIN_PAYMENT;
            showPage('payment');
        }

        function updateAllocationDetail() {
            const amount = parseInt(paymentAmountInput.value) || 0;
            const arrears = ARREARS_AMOUNT;

            payNowBtn.disabled = !selectedMethod || (amount < MIN_PAYMENT);
            paymentAmountInput.style.color = amount < MIN_PAYMENT ? 'var(--color-red-neon)' : 'var(--color-green-neon)';


            if (amount < MIN_PAYMENT) {
                allocationMessage.className = 'allocation-message';
                allocationMessage.innerHTML = `
                    NOMINAL KURANG! (Min. Rp ${MIN_PAYMENT.toLocaleString('id-ID')})
                    <br><small>Masukkan nominal yang cukup untuk melunasi Tunggakan dan/atau 1 bulan iuran.</small>
                `;
            } else {
                let amountToAllocate = amount;
                let remainingArrears = arrears;
                let paidArrears = 0;
                let excess = 0;
                
                // 1. Alokasikan ke Tunggakan 2025
                if (remainingArrears > 0) {
                    const paymentForArrears = Math.min(amountToAllocate, remainingArrears);
                    paidArrears = paymentForArrears;
                    remainingArrears -= paymentForArrears;
                    amountToAllocate -= paymentForArrears;
                }
                
                // 2. Sisanya masuk ke Excess (Iuran 2026/Lunas/Lebih Bayar)
                excess = amountToAllocate;

                allocationMessage.className = 'allocation-message success';
                
                let message = `
                    **Alokasi Pembayaran:**
                    <ul>
                        ${arrears > 0 ? `<li>Pelunasan Kekurangan 2025: **Rp ${paidArrears.toLocaleString('id-ID')}**</li>` : ''}
                `;
                
                if (remainingArrears > 0) {
                    message += `<li>Sisa Kekurangan 2025: **Rp ${remainingArrears.toLocaleString('id-ID')}**</li>`;
                }
                
                if (excess > 0) {
                    const nextMonthsPaid = Math.floor(excess / MONTHLY_FEE);
                    const remainingInAdvance = excess % MONTHLY_FEE;
                    
                    if (arrears === 0 && nextMonthsPaid === 0) {
                         message += `<li>Pembayaran Iuran Bulan Ini: **Rp ${amount.toLocaleString('id-ID')}**</li>`;
                    } else if (nextMonthsPaid > 0) {
                        message += `
                            <li>Iuran 2026 (Lunas/Lebih Bayar): **Rp ${(nextMonthsPaid * MONTHLY_FEE).toLocaleString('id-ID')}** (${nextMonthsPaid} bulan)</li>
                        `;
                    }
                    
                    if(remainingInAdvance > 0) {
                         message += `<li>*Sisa Saldo Lebih: Rp ${remainingInAdvance.toLocaleString('id-ID')}*</li>`;
                    }
                }
                
                if (arrears === 0 && excess === 0 && amount === MONTHLY_FEE) {
                     message += `<li>Pembayaran Iuran Bulan Ini: **Rp ${MONTHLY_FEE.toLocaleString('id-ID')}**</li>`;
                }
                
                message += `</ul>`;
                allocationMessage.innerHTML = message;
            }
        }
        
        function selectPaymentMethod(method) {
            selectedMethod = method;
            const amount = parseInt(paymentAmountInput.value) || 0;
            payNowBtn.disabled = !method || (amount < MIN_PAYMENT); 
            
            document.querySelectorAll('.method-button').forEach(button => {
                if (button.getAttribute('data-method') === method) {
                    button.classList.add('selected');
                } else {
                    button.classList.remove('selected');
                }
            });
        }
        
        function goToPaymentDetails() {
            if (!selectedMethod) {
                alert("Harap pilih salah satu Metode Pembayaran terlebih dahulu!");
                return;
            }
            
            const finalAmount = parseInt(paymentAmountInput.value) || 0;
            
            // Simpan nominal pembayaran di local storage untuk simulasi
            localStorage.setItem('simulatedPaymentAmount', finalAmount);

            document.getElementById(`${selectedMethod}Amount`).textContent = finalAmount.toLocaleString('id-ID');
            
            // TAMBAHAN UNTUK QRIS BARU
            if (selectedMethod === 'qr') {
                document.getElementById('qrAmountDisplayNew').textContent = finalAmount.toLocaleString('id-ID');
            }

            showPage(selectedMethod);
        }
        
        // --- FUNGSI BARU: SIMULASI PENYELESAIAN PEMBAYARAN & UPDATE DATA ---
        function simulatePaymentCompletion() {
            const amountPaid = parseInt(localStorage.getItem('simulatedPaymentAmount')) || 0;
            if (amountPaid === 0) {
                 alert('Error: Jumlah pembayaran tidak ditemukan.');
                 showPage('dashboard');
                 return;
            }

            if (loggedInUser && loggedInUser.id === 'rohman') {
                let amountToAllocate = amountPaid;
                const monthlyData = ROHMAN_FINANCE_DATA.monthlyData;
                
                // 1. Lunasi Tunggakan 2025 (status 1 -> 0)
                for (let i = 0; i < 12 && amountToAllocate >= MONTHLY_FEE; i++) {
                    const monthData = monthlyData.find(m => m.year === 2025 && m.status === 1)?.month;
                    const index = monthlyData.findIndex(m => m.year === 2025 && m.month === monthData);

                    if (index !== -1 && monthlyData[index].status === 1) {
                        monthlyData[index].status = 0;
                        amountToAllocate -= MONTHLY_FEE;
                    }
                }
                
                // 2. Bayar Iuran 2026 (status 0 -> 1)
                for (let i = 0; i < 12 && amountToAllocate >= MONTHLY_FEE; i++) {
                    const monthData = monthlyData.find(m => m.year === 2026 && m.status === 0)?.month;
                    const index = monthlyData.findIndex(m => m.year === 2026 && m.month === monthData);
                    
                    if (index !== -1 && monthlyData[index].status === 0) {
                        monthlyData[index].status = 1;
                        amountToAllocate -= MONTHLY_FEE;
                    }
                }
                
                // 3. Update Status Global (data saya dan data warga)
                updateMinPayment(); 
                
                alert(`‚úÖ Pembayaran ${formatRp(amountPaid)} Berhasil Dikonfirmasi (Simulasi). Data iuran Anda telah diperbarui menjadi LUNAS/KURANGI TUNGGAKAN.`);
                
            } else {
                alert(`‚úÖ Pembayaran ${formatRp(amountPaid)} Berhasil Dikonfirmasi (Simulasi).`);
            }
            
            // Hapus data pembayaran simulasi
            localStorage.removeItem('simulatedPaymentAmount');
            
            // Redirect ke dashboard
            showPage('dashboard'); 
        }
        
        // --- FUNGSI KONFIRMASI PEMBAYARAN VIA WHATSAPP (REVISI) ---
        function confirmPaymentViaWhatsapp() {
            const amountPaid = parseInt(localStorage.getItem('simulatedPaymentAmount')) || 0;
            
            if (amountPaid === 0) {
                 alert('Error: Jumlah pembayaran tidak ditemukan. Kembali ke halaman pembayaran.');
                 showPage('payment');
                 return;
            }
            
            const userName = loggedInUser ? loggedInUser.name.toUpperCase() : 'Warga';
            const userBlock = loggedInUser ? loggedInUser.block.toUpperCase() : 'E21-XX';
            const formattedAmount = formatRp(amountPaid);
            
            const message = `*KONFIRMASI PEMBAYARAN KAS QRIS*\n\n` +
                            `Nama: ${userName}\n` +
                            `Blok/No: ${userBlock}\n` +
                            `Jumlah Transfer (QRIS): ${formattedAmount}\n\n` +
                            `‚úÖ Saya telah melakukan scan QRIS dan transfer sebesar ${formattedAmount}. Mohon segera diverifikasi. Terima kasih!`;
            
            const text = encodeURIComponent(message);
            const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${text}`;
            
            // Buka tab WhatsApp
            window.open(url, '_blank');
            
            // Setelah konfirmasi via WA, anggap transaksi selesai (simulasi)
            setTimeout(() => {
                simulatePaymentCompletion();
            }, 100); 
        }

        // --- FUNGSI BARU: UNDUH QRIS (DIREVISI UNTUK qrcode.jpg) ---
        function downloadQrisImage() {
            // Mengambil elemen dengan ID 'qrcode.jpg'
            const qrisImg = document.getElementById('qrcode.jpg');
            const amount = parseInt(localStorage.getItem('simulatedPaymentAmount')) || 0;
            const userName = loggedInUser ? loggedInUser.name : 'Warga';
            
            if (qrisImg.src.includes('placeholder')) {
                alert("Simulasi: Tidak ada file QRIS asli. Ini adalah gambar placeholder.");
            }
            
            // Membuat link unduhan temporer
            const link = document.createElement('a');
            link.href = qrisImg.src;
            // Nama file unduhan diatur ke .jpg
            link.download = `QRIS_KasWarga_${userName}_${amount.toLocaleString('id-ID')}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // --- FUNGSI LAPORAN (TELAH DIREVISI) ---
        function generateReportPage() {
            let totalIncome = 0;
            let totalExpense = 0;
            const expenseDetails = []; 

            MONTHLY_REPORTS.forEach(report => {
                totalIncome += report.income;
                totalExpense += report.expense;
                
                report.details.forEach(detail => {
                    if (detail.type === 'Pengeluaran') {
                        expenseDetails.push(detail);
                    }
                });
            });
            
            expenseDetails.sort((a, b) => {
                const dateA = new Date(a.date.replace(/(\d{2}) ([A-Za-z]{3})/, '$2 $1') + ' 2026'); 
                const dateB = new Date(b.date.replace(/(\d{2}) ([A-Za-z]{3})/, '$2 $1') + ' 2026');
                return dateB - dateA; 
            });

            document.getElementById('totalIncome').textContent = formatRp(totalIncome);
            document.getElementById('totalExpense').textContent = formatRp(totalExpense);
            
            const reportSummaryTableBody = document.getElementById('reportSummaryTableBody');
            reportSummaryTableBody.innerHTML = '';
            
            if (expenseDetails.length === 0) {
                reportSummaryTableBody.innerHTML = `
                    <tr><td colspan="3" style="text-align: center; color: #777;">Belum ada Rincian Pengeluaran yang tercatat.</td></tr>
                `;
            } else {
                expenseDetails.forEach(detail => {
                    const row = reportSummaryTableBody.insertRow();
                    
                    row.innerHTML = `
                        <td>${detail.date}</td>
                        <td>${detail.desc}</td>
                        <td class="status-red" style="text-align: right;">${formatRp(detail.amount)}</td>
                    `;
                    row.onclick = null; 
                });
            }
        }
        
        // --- FUNGSI DETAIL LAPORAN DINONAKTIFKAN ---
        function showDetailReport(index) {
            console.log('Fungsi detail laporan dinonaktifkan.');
            alert('Fitur rincian per bulan dinonaktifkan, semua rincian pengeluaran ditampilkan di halaman utama laporan.');
        }

        // --- EVENT LISTENERS ---
        document.getElementById('registerToggleBtn').addEventListener('click', () => showPage('register'));
        document.getElementById('loginToggleBtn').addEventListener('click', () => showPage('login'));
        
        document.getElementById('loginBtn').addEventListener('click', () => {
            const loginIdInput = document.getElementById('loginId');
            const loginPassInput = document.getElementById('loginPassword');
            const loginErrorMsg = document.getElementById('loginError');

            const enteredId = loginIdInput.value.trim().toLowerCase();
            const enteredPass = loginPassInput.value.trim();
            const user = USERS[enteredId];

            if (user && user.pass === enteredPass) {
                loggedInUser = { id: enteredId, name: user.name, block: user.block, status: user.status }; 
                loginErrorMsg.style.display = 'none';
                
                document.getElementById('dashboardUserName').textContent = loggedInUser.name.toUpperCase();
                
                updateMinPayment(); 

                container.style.display = 'none';
                showPage('dashboard');
                
            } else {
                loginErrorMsg.textContent = '‚ùå ID atau Password Salah! ';
                loginErrorMsg.style.display = 'block';
            }
        });
        
        document.getElementById('submitRegisterBtn').addEventListener('click', () => {
             const passwordLength = document.getElementById('regPassword').value.trim().length;
            
            if (document.getElementById('regNama').value && document.getElementById('regBlokNo').value && document.getElementById('regId').value && document.getElementById('regPassword').value) {
                if (passwordLength >= 4) { 
                    
                    const message = `*PERMINTAAN AKUN KAS WARGA BARU*\n\n` +
                                    `Nama Lengkap: ${document.getElementById('regNama').value}\n` +
                                    `Blok/No Rumah: ${document.getElementById('regBlokNo').value}\n` +
                                    `ID yang Diharapkan: ${document.getElementById('regId').value}\n` +
                                    `Password Awal: ${document.getElementById('regPassword').value}\n\n` +
                                    `Mohon untuk diverifikasi dan diaktifkan. Terima kasih.`;
                    
                    const text = encodeURIComponent(message);
                    const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${text}`;
                    
                    window.open(url, '_blank');
                    
                    setTimeout(() => {
                        showPage('login');
                        document.getElementById('loginError').textContent = '‚úÖ Data Pendaftaran Berhasil Dikirim via WhatsApp. Tunggu Konfirmasi Admin!';
                        document.getElementById('loginError').style.display = 'block';
                        document.getElementById('regNama').value = '';
                        document.getElementById('regBlokNo').value = '';
                        document.getElementById('regId').value = '';
                        document.getElementById('regPassword').value = '';
                    }, 100);
                } else {
                    alert('‚ö†Ô∏è Password minimal harus 4 karakter. Harap buat password yang lebih panjang.');
                }
            } else {
                alert('‚ö†Ô∏è Harap lengkapi semua kolom pendaftaran sebelum mengirim data ke Admin.');
            }
        });
        
        if (paymentAmountInput) {
             paymentAmountInput.addEventListener('input', updateAllocationDetail);
        }

    </script>
</body>
</html>
