<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kas - Dashboard dan Pembayaran | Neumorphism</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ====================================================== */
        /* 1. ANIMASI KEYFRAMES */
        /* ====================================================== */
        @keyframes neon-pulse {
            0% { box-shadow: var(--inset-shadow), 0 0 10px var(--saldo-shadow); }
            50% { box-shadow: var(--inset-shadow), 0 0 18px var(--saldo-shadow), 0 0 40px var(--neon-color-pulse); }
            100% { box-shadow: var(--inset-shadow), 0 0 10px var(--saldo-shadow); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes text-reveal {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        /* ====================================================== */
        /* 2. VARIABEL WARNA (DARK & LIGHT MODE) */
        /* ====================================================== */
        :root {
            --bg-main: #f0f4f8; 
            --card-bg: #e5e9ef; 
            --text-main: #2c3e50; 
            --neon-color-header: #00A878;
            --neon-color-menu: var(--neon-color-header); 
            --saldo-shadow: #00A878; 
            --neon-color-pulse: rgba(0, 168, 120, 0.6);
            --running-text-bg: #c0392b; 
            --shadow-light: rgba(255, 255, 255, 0.7);
            --shadow-dark: rgba(174, 174, 192, 0.4);
            --soft-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            --inset-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
            /* Warna khusus untuk blok peringatan */
            --warning-bg-light: #fbe6e6;
            --warning-text-light: #c0392b;
            --success-bg-light: #e6fbe6;
            --success-text-light: #00A878;

            /* Warna Tombol 3D (Flat-ish) */
            --button-main: #2ecc71; /* Hijau */
            --button-shadow: #27ae60; 
            --button-text: white;
            --button-hover: #37d37a; 

            --download-button: #3498db; /* Biru */
            --download-shadow: #2980b9; 
            --copy-button: #9b59b6; /* Ungu untuk Copy */
            --copy-shadow: #8e44ad; 
            --delete-button: #e74c3c;
            --delete-shadow: #c0392b;

            /* Warna Loading */
            --loading-bg: #f0f4f8; 
            --loading-text: #2c3e50;
            
            /* Warna Status */
            --status-active-bg: #00A878;
            --status-active-text: white;
        }

        body.dark-mode {
            --bg-main: #1e1e1e; 
            --card-bg: #2b2b2b; 
            --text-main: #f0f0f0; 
            --neon-color-header: #FFD700; 
            --neon-color-menu: var(--neon-color-header); 
            --saldo-shadow: #FFD700;
            --neon-color-pulse: rgba(255, 215, 0, 0.6);
            --running-text-bg: #800000; 
            --shadow-light: rgba(50, 50, 50, 0.3);
            --shadow-dark: rgba(0, 0, 0, 0.8);
            --soft-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
            --inset-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            /* Warna khusus untuk blok peringatan DARK MODE */
            --warning-bg-dark: #4d2323;
            --warning-text-dark: #ff8585;
            --success-bg-dark: #234d23;
            --success-text-dark: #90ee90;

             /* Warna Tombol 3D DARK MODE*/
            --button-main: #00A878; /* Hijau */
            --button-shadow: #008f65; 
            --button-text: #1e1e1e;
            --button-hover: #00bf8a; 

            --download-button: #5dade2; /* Biru */
            --download-shadow: #3f83b2; 
            --copy-button: #c39bd3; /* Ungu muda untuk Copy */
            --copy-shadow: #9e7cb2; 

            /* Warna Loading DARK MODE */
            --loading-bg: #1e1e1e; 
            --loading-text: #f0f0f0;
            
            /* Warna Status DARK MODE */
            --status-active-bg: #FFD700;
            --status-active-text: #1e1e1e;
        }

        /* ====================================================== */
        /* 3. GAYA DASAR & CONTAINER DASHBOARD (FONT RINGKAS) */
        /* ====================================================== */
        body {
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-main);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            /* Transisi untuk perpindahan halaman yang halus */
            transition: background-color 0.4s ease-in-out, color 0.4s ease-in-out; 
            font-size: 0.9em; 
            overflow-x: hidden; /* Mencegah scroll horizontal */
        }
        
        /* GAYA UNTUK SEMUA CONTAINER HALAMAN */
        .main-dashboard, .login-page, .registration-page, .payment-page, .my-profile-page, .notification-page, .invoice-page, .data-warga-page, .report-page {
            transition: opacity 0.4s ease-in-out; /* Transisi untuk fade-in/out */
        }


        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px 25px; 
        }
        
        .top-controls { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
        }
        
        .right-actions {
            display: flex;
            gap: 8px; 
        }
        
        .dashboard-header .welcome-user { 
            font-size: 1.5em; 
            font-weight: 700; 
            display: block; 
        }
        .dashboard-header p { 
            margin: 0; 
            opacity: 0.7; 
            font-size: 0.8em; 
        }

        .saldo-card {
            background-color: var(--card-bg); 
            padding: 25px; 
            border-radius: 18px; 
            text-align: center;
            box-shadow: var(--soft-shadow); 
            margin-bottom: 25px; 
            border: 1px solid var(--neon-color-header);
            animation: neon-pulse 3s infinite alternate;
        }
        .saldo-card h2 { 
            margin: 0 0 8px 0; 
            font-weight: 500; 
            color: var(--neon-color-header); 
            font-size: 1em; 
        }
        .saldo-amount { 
            font-size: 2.0em; 
            font-weight: 800; 
            color: var(--text-main); 
        }
        
        .menu-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); 
            gap: 15px; 
        }
        .menu-item {
            background-color: var(--card-bg); 
            padding: 15px 8px; 
            border-radius: 12px; 
            text-decoration: none; 
            color: var(--text-main); 
            font-size: 0.8em; 
            font-weight: 500;
            box-shadow: var(--soft-shadow);
            /* Modifikasi: Transisi lebih halus untuk neumorphism */
            transition: all 0.3s ease-in-out; 
            text-align: center;
            position: relative; /* Untuk Badge */
        }
        /* Modifikasi: Efek menyala saat di klik/aktif */
        .menu-item:active { 
            box-shadow: var(--inset-shadow), 0 0 10px var(--neon-color-menu); 
            transform: scale(0.95); 
        }
        .menu-icon { 
            font-size: 2.2em; 
            display: block; 
            margin-bottom: 3px; 
            /* Transisi untuk ikon */
            transition: color 0.3s ease-in-out;
        }
        
        /* GAYA BADGE NOTIFIKASI */
        .badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #e74c3c; 
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7em;
            font-weight: 700;
            line-height: 1;
        }

        .action-button {
            background-color: var(--bg-main); 
            border: none; 
            color: var(--text-main);
            padding: 7px 12px; 
            border-radius: 20px; 
            font-size: 0.8em; 
            font-weight: 600; 
            box-shadow: var(--soft-shadow);
        }
        
        .running-text { 
            margin-top: 30px; 
            font-size: 0.8em; 
        }
        
        /* ====================================================== */
        /* 4. GAYA LOGIN/REGISTRASI (PROFESIONAL & CENTERED) */
        /* ====================================================== */
        .login-page, .registration-page { 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; /* Posisi di tengah layar */
            /* Tambahkan agar terlihat saat transisi fade-in/out */
            opacity: 1;
        }
        .login-card {
            background-color: var(--card-bg); 
            padding: 30px 40px; /* Padding dan ukuran diperbesar */
            border-radius: 18px; 
            width: 350px; /* Ukuran container login diperbesar */
            max-width: 90%; 
            box-shadow: var(--soft-shadow);
            text-align: center;
        }
        .login-card h1 {
            font-size: 1.8em; /* Font header diperbesar */
            margin-bottom: 20px;
            color: var(--neon-color-header);
        }
        .login-input { 
            width: 100%;
            padding: 12px 15px; 
            margin-bottom: 15px;
            border-radius: 10px;
            border: none;
            box-shadow: var(--inset-shadow); /* Input dengan efek neumorphism inset */
            background-color: var(--bg-main);
            color: var(--text-main);
            font-size: 1.0em; 
            box-sizing: border-box;
            transition: box-shadow 0.3s;
        }
        .login-input:focus {
             outline: none;
             box-shadow: inset 1px 1px 3px var(--shadow-dark), inset -1px -1px 3px var(--shadow-light), 0 0 5px rgba(0, 168, 120, 0.5);
        }
        .login-button { 
            padding: 12px; 
            font-size: 1.0em; 
            margin-top: 15px; 
        }

        /* ====================================================== */
        /* 5. GAYA HALAMAN PEMBAYARAN (STEP 1, 2, 3, 4, 5) */
        /* ====================================================== */
        
        .payment-page, .my-profile-page, .notification-page, .invoice-page, .report-page { 
            padding-top: 15px; 
        }
        .section-title {
            font-size: 1.2em; 
        }
        .payment-card, .profile-card, .warga-card {
            background-color: var(--card-bg);
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: var(--soft-shadow);
            margin-bottom: 20px;
        }
        
        /* Input Nominal */
        .payment-input-group label {
            font-size: 0.9em; 
        }
        .payment-input { 
            width: 100%;
            padding: 10px; 
            font-size: 1.1em; 
            box-sizing: border-box; 
        }

        /* --- TOMBOL LANJUT PEMBAYARAN 3D (STEP 1) --- */
        .continue-button {
            padding: 14px 25px;
            font-size: 1.0em;
            margin-top: 25px; 
            border: none;
            border-radius: 10px;
            font-weight: 700;
            color: var(--button-text);
            background-color: var(--button-main);
            box-shadow: 0 5px 0 var(--button-shadow); /* Efek 3D */
            transition: all 0.1s ease-in-out;
            cursor: pointer;
            width: 100%;
        }

        .continue-button:active:not(:disabled) {
            transform: translateY(5px);
            box-shadow: 0 0 0 var(--button-shadow);
        }

        .continue-button:hover:not(:disabled) {
            background-color: var(--button-hover);
        }

        .continue-button:disabled {
            background-color: #bdc3c7;
            box-shadow: 0 5px 0 #95a5a6;
            cursor: not-allowed;
            color: #7f8c8d;
        }
        
        .user-info p { 
            font-size: 0.85em; 
        }
        
        /* --- BLOK PERINGATAN --- */
        .tunggakan-container {
            margin-top: 15px;
        }

        .tunggakan-info {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85em; 
            font-weight: 500;
            line-height: 1.4;
        }

        /* Gaya Khusus untuk Tunggakan */
        .tunggakan-warning-style { 
            background-color: var(--warning-bg-light); 
            color: var(--warning-text-light); 
            border: 1px solid var(--warning-text-light);
        }
        body.dark-mode .tunggakan-warning-style {
            background-color: var(--warning-bg-dark); 
            color: var(--warning-text-dark); 
            border: 1px solid var(--warning-text-dark);
        }
        
        /* Gaya Khusus untuk Lunas */
        .tunggakan-lunas-style { 
            background-color: var(--success-bg-light); 
            color: var(--success-text-light); 
            border: 1px solid var(--success-text-light);
        }
        body.dark-mode .tunggakan-lunas-style { 
            background-color: var(--success-bg-dark); 
            color: var(--success-text-dark); 
            border: 1px solid var(--success-text-dark);
        }

        /* --- TABEL RINCIAN (Payment & Profile) --- */
        .payment-detail-table, .profile-detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85em;
        }
        .payment-detail-table th, .payment-detail-table td, 
        .profile-detail-table th, .profile-detail-table td {
            padding: 8px 0;
            text-align: left;
            border-bottom: 1px dotted rgba(150, 150, 150, 0.1);
        }
        .payment-detail-table th, .profile-detail-table th {
            font-weight: 500;
            width: 65%; 
        }
        .payment-detail-table td, .profile-detail-table td {
            text-align: right;
            font-weight: 600;
        }
        .table-row-total th, .payment-detail-table .table-row-total td, 
        .profile-detail-table .table-row-total th, .profile-detail-table .table-row-total td { 
            border-top: 2px solid var(--neon-color-header);
            border-bottom: none;
            font-size: 1.0em;
            font-weight: 700 !important;
            color: var(--neon-color-header);
            padding-top: 10px;
        }
        
        /* --- TABEL RIWAYAT BULANAN DI DATA SAYA & LAPORAN --- */
        .payment-history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.8em;
            text-align: center;
        }
        .payment-history-table th, .payment-history-table td {
            padding: 8px 5px;
            border: 1px solid rgba(150, 150, 150, 0.1);
        }
        .payment-history-table th {
            background-color: var(--bg-main);
            font-weight: 600;
            color: var(--neon-color-header);
            border-top: 2px solid var(--neon-color-header);
        }
        .payment-history-table td.status-paid {
            color: var(--success-text-light);
            font-weight: 700;
        }
        .payment-history-table td.status-unpaid {
            color: var(--warning-text-light);
            font-weight: 700;
        }
         body.dark-mode .payment-history-table td.status-paid {
            color: var(--success-text-dark);
        }
        body.dark-mode .payment-history-table td.status-unpaid {
            color: var(--warning-text-dark);
        }
        
        /* --- GRID 2x2 TOMBOL --- */
        .method-selection {
            display: grid;
            gap: 15px;
            margin-top: 15px;
            grid-template-columns: repeat(2, 1fr); 
        }
        @media (max-width: 600px) {
            .method-selection {
                grid-template-columns: 1fr; 
            }
        }
        
        .method-item {
            /* Perubahan: Tambahkan cursor pointer agar terasa bisa diklik */
            cursor: pointer; 
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            min-height: 80px; 
            padding: 15px; 
            border-radius: 12px; 
            background-color: var(--bg-main); 
            font-weight: 600;
            box-shadow: var(--soft-shadow);
            /* Transisi lebih halus */
            transition: all 0.3s ease-in-out; 
            text-align: center;
            font-size: 0.9em;
        }
        /* Perubahan: Styling active/click untuk semua metode */
        .method-item:active { 
            box-shadow: var(--inset-shadow); 
            transform: scale(0.95); 
        }
        .method-item.selected { 
            box-shadow: var(--inset-shadow); 
            border: 2px solid var(--neon-color-header); 
            transform: scale(0.98); 
            background-color: var(--card-bg);
        }
        .method-item span:first-child {
            font-size: 2.0em; 
            margin-bottom: 5px;
        }

        /* --- TOMBOL STEP 3 & 4 (PROFESIONAL & ELEGAN) --- */
        .pro-button {
            padding: 12px 20px;
            font-size: 0.95em;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            color: white;
            transition: all 0.2s;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px; /* Jarak antar tombol */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .transfer-details {
            background-color: var(--bg-main);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--inset-shadow);
            margin-top: 15px;
        }
        .transfer-details p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        .account-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--card-bg);
            padding: 8px 10px;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 10px;
        }
        .copy-button {
            background-color: var(--copy-button);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 3px 0 var(--copy-shadow);
            transition: all 0.1s;
            font-size: 0.8em;
        }
        .copy-button:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 var(--copy-shadow);
        }

        /* Tombol Unduh QR (Biru) */
        #downloadQRButton {
            background-color: var(--download-button);
            box-shadow: 0 4px 0 var(--download-shadow);
        }
        #downloadQRButton:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 var(--download-shadow);
        }

        /* Tombol Konfirmasi WA (Hijau WA) */
        #confirmWAButton, #confirmTransferWAButton, #confirmEwalletCash { /* Ditambah #confirmEwalletCash */
            background-color: #25D366;
            box-shadow: 0 4px 0 #1eac53;
            color: #1e1e1e; 
        }
        body.dark-mode #confirmWAButton, body.dark-mode #confirmTransferWAButton, body.dark-mode #confirmEwalletCash {
             color: white; 
        }
        #confirmWAButton:active, #confirmTransferWAButton:active, #confirmEwalletCash:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #1eac53;
        }
        
        /* GAYA KHUSUS GAMBAR QRIS */
        .qris-image {
            width: 80%; 
            max-width: 300px; 
            height: auto;
            border-radius: 10px;
            box-shadow: var(--soft-shadow);
            border: 5px solid var(--card-bg); 
        }


        /* ====================================================== */
        /* 6. FAB (Floating Action Button) - TOMBOL KEMBALI */
        /* ====================================================== */
        .fab-back-button {
            position: fixed;
            bottom: 30px; 
            right: 30px; 
            z-index: 1000;
            width: 45px; 
            height: 45px;
            padding: 0;
            border-radius: 50%;
            background-color: var(--neon-color-header); 
            color: white; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); 
            border: none;
            font-size: 1.5em; 
            line-height: 45px;
            text-align: center;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        .fab-back-button:hover {
            background-color: #008f65; 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5); 
            transform: scale(1.05);
        }
        
        /* ====================================================== */
        /* 7. GAYA HALAMAN DATA WARGA BARU */
        /* ====================================================== */
        .data-warga-page {
            padding-top: 15px;
        }
        .warga-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--soft-shadow);
            margin-bottom: 20px;
        }
        .warga-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85em;
        }
        .warga-table th, .warga-table td {
            padding: 10px 5px;
            text-align: center;
            border-bottom: 1px solid rgba(150, 150, 150, 0.15);
        }
        .warga-table th {
            font-weight: 700;
            background-color: var(--bg-main);
            color: var(--neon-color-header);
            border-top: 2px solid var(--neon-color-header);
        }
        .warga-table tbody tr:nth-child(even) {
            background-color: var(--bg-main);
        }
        .warga-table td {
             font-weight: 500;
        }
        .warga-table .name-col {
             text-align: left;
             font-weight: 600;
        }
        .warga-table .status-ok {
            color: var(--success-text-light);
            font-weight: 700;
        }
        body.dark-mode .warga-table .status-ok {
            color: var(--success-text-dark);
        }
        .warga-table .status-warning {
            color: var(--warning-text-light);
            font-weight: 700;
        }
        body.dark-mode .warga-table .status-warning {
            color: var(--warning-text-dark);
        }

        .toggle-button-container {
            text-align: center;
            margin-top: 15px;
        }
        .toggle-table-button {
             background-color: var(--card-bg); 
             color: var(--text-main);
             padding: 10px 20px;
             border: none;
             border-radius: 20px;
             box-shadow: var(--soft-shadow);
             font-weight: 600;
             cursor: pointer;
             transition: all 0.3s;
        }
        .toggle-table-button:active {
            box-shadow: var(--inset-shadow); 
            transform: scale(0.98);
        }

        @media (max-width: 600px) {
            .warga-table th, .warga-table td {
                padding: 8px 3px;
                font-size: 0.75em;
            }
        }
        
        /* GAYA KHUSUS KARTU PROFIL (Tegak) */
        .profile-info-card {
            display: flex;
            align-items: center;
            gap: 20px;
            background-color: var(--bg-main);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--inset-shadow);
            margin-bottom: 20px;
            border-left: 5px solid var(--neon-color-header);
        }
        .profile-icon {
            font-size: 3em;
            color: var(--neon-color-header);
        }
        .profile-details p {
            margin: 0 0 5px 0;
            line-height: 1.3;
        }
        .profile-details strong {
            font-weight: 700;
        }
        .status-badge {
            display: inline-block;
            background-color: var(--status-active-bg);
            color: var(--status-active-text);
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 10px;
        }
        /* ====================================================== */
        /* 8. GAYA LOADING PAGE (SPLASH SCREEN) */
        /* ====================================================== */
        #loadingPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--loading-bg);
            color: var(--loading-text);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-in-out;
            text-align: center;
        }
        
        #loadingPage.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .wallet-icon {
            font-size: 5em;
            margin-bottom: 15px;
            animation: bounce 0.8s infinite alternate;
            color: var(--neon-color-header);
        }

        .loading-text-container {
            overflow: hidden;
            height: 1.5em; /* Sesuaikan dengan font size .loading-text */
        }

        .loading-text {
            font-size: 1.5em;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--text-main);
            /* Animasi teks dari dalam keluar */
            animation: text-reveal 1.5s ease-out forwards;
        }

    </style>
</head>
<body class="dark-mode">

    <div id="loadingPage">
        <span class="wallet-icon"> üè° </span>
        <div class="loading-text-container">
            <span class="loading-text">Kas Gang Kita</span>
        </div>
        <p style="margin-top: 20px; font-weight: 500; opacity: 0.7;">Memuat Aplikasi...</p>
    </div>


    <div class="main-dashboard" id="mainDashboard" style="display: none; opacity: 0;">
        <div class="container">
            <div class="top-controls">
                <div class="dashboard-header">
                    <span class="welcome-user" id="welcomeUserText">Selamat Datang, Rohman! üëã</span>
                    <p>Aplikasi Pembayaran Kas Gang E21-25</p>
 
              
                </div>
                <div class="right-actions">
                    <button class="action-button" id="themeToggle" onclick="toggleMode()">üåôMode Gelap</button>
                    <a href="#" class="action-button logout" onclick="showLoginPage()">üö™ Log Out</a>
                </div>
            </div>
            
            <div class="saldo-card">
                <h2>üí∞ Saldo Kas terkini üî•</h2>
                <div class="saldo-amount">Rp 2.290.200</div>
                <p style="opacity: 0.7; font-weight: 500; font-size: 0.7em;">Data per 08 November 2025</p>
            </div>

            <div class="menu-grid">
                </div>
            
            <div class="running-text">
                <marquee behavior="scroll" direction="left" scrollamount="6">
                    üö® &nbsp;&nbsp;&nbsp; Segera lunasi pembayaran kas! &nbsp;&nbsp;&nbsp; Pembayaran kas terdiri dari: Kas Gang, Kas RT, dan BSK (Bantuan Sosial Kematian). &nbsp;&nbsp;&nbsp; Pembayaran di buka per tgl 01 sampai dengan 08 2026 &nbsp;&nbsp;&nbsp; üö®
                </marquee>
            </div>
        </div>
    </div> 
    
    <div class="payment-page" id="paymentPage" style="display: none; opacity: 0;">
        
        <button class="fab-back-button" id="fabBackButton" onclick="handleFabClick()" style="display: none;">
            ‚Üê 
        </button>
        
        <div class="container">
            <h1 class="section-title">üíµ Pembayaran Kas Gang E21-25</h1>
            
            <div class="payment-card" id="paymentStep1">
                <h3 class="section-title" style="margin-top: 0;">1. Rincian Tagihan & Nominal</h3>
                
                <div class="summary-group">
                    <div class="user-info">
                        <p>Nama: <strong><span id="paymentUserName"></span></strong></p>
                        <p>Blok/No: <strong><span id="paymentUserBlock"></span></strong></p>
                        <p>Iuran Bulanan: <strong><span id="paymentUserRate"></span></strong></p>
                    </div>
                    
                    <div class="tunggakan-container">
                        <div class="tunggakan-info" id="tunggakanInfo"></div>
                    </div>
                    
                </div>
                
                <div class="payment-input-group" style="margin-top: 15px;">
                    <label for="nominalInput" class="input-label" style="font-weight: 600; display: block; margin-bottom: 5px;">Masukkan Jumlah Pembayaran (Minimal: <span id="minPaymentText"></span>)</label>
                    <input type="number" id="nominalInput" class="payment-input" 
                        placeholder="Contoh: 50000" oninput="calculatePayment()" required>
                </div>
                
                <table class="payment-detail-table">
                    <thead>
                        <tr>
                            <th colspan="2" style="text-align: center; border-bottom: 2px solid var(--text-main); font-weight: 600; padding-bottom: 10px;">Detail Alokasi Pembayaran</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th>Alokasi Pelunasan Tunggakan 2025:</th>
                            <td id="tunggakanPaid">Rp 0</td>
                        </tr>
                        <tr>
                            <th>Total Bulan Iuran Dibayar:</th>
                            <td id="paidMonths">0 Bulan</td>
                        </tr>
                        <tr>
                            <th>Periode Pembayaran Iuran 2026:</th>
                            <td id="paymentPeriod"> - </td>
                        </tr>
                        <tr class="table-row-total">
                            <th>TOTAL TAGIHAN AKHIR:</th>
                            <td id="totalPayment">Rp 0</td>
                        </tr>
                    </tbody>
                </table>
                
                <button class="continue-button" id="continueButton" onclick="showPaymentPage(2)" disabled>
                    Lanjut ke Metode Pembayaran
                </button>
            </div>
            
            <div class="payment-card" id="paymentStep2" style="display: none;">
                <h3 class="section-title" style="margin-top: 0;">2. Pilih Metode Pembayaran</h3>
                
                <table class="payment-detail-table" style="margin-bottom: 20px;">
                    <tbody>
                        <tr class="table-row-total">
                            <th>Jumlah Tagihan Akhir:</th>
                            <td id="finalTotalDisplay">Rp 0</td>
                        </tr>
                        <tr>
                            <th>Rincian Pembayaran:</th>
                            <td id="finalPaidSummary" style="font-weight: 500;"> - </td>
                        </tr>
                    </tbody>
                </table>

                <p style="margin-top: 5px; font-weight: 500; font-size: 0.9em;">Silakan pilih metode pembayaran yang diinginkan:</p>
                <div class="method-selection" id="methodSelection">
                    <div class="method-item" data-method="transfer" onclick="showPaymentFlow('transfer')">
                        <span>üí≥</span> Transfer Bank
                    </div>
                    <div class="method-item" data-method="qris" onclick="showPaymentFlow('qris')">
                        <span>üì±</span> QRIS
                    </div>
                    <div class="method-item" data-method="cash" onclick="showPaymentFlow('cash')">
                        <span>üíµ</span> Bayar Tunai
                    </div>
                    <div class="method-item" data-method="ewallet" onclick="showPaymentFlow('ewallet')">
                        <span> üî∑ </span> VA DANA
                    </div>
                </div>
                
                </div>
            
            <div class="payment-card" id="paymentStep3" style="display: none;">
                <h3 class="section-title" style="margin-top: 0;">3. Pembayaran via QRIS</h3>
                
                <div class="user-info">
                    <p>Nama Warga: <strong><span id="qrUserName"></span></strong></p>
                    <p>Blok/No Rumah: <strong><span id="qrUserBlock"></span></strong></p>
                </div>

                <table class="payment-detail-table" style="margin-bottom: 20px;">
                    <tbody>
                        <tr class="table-row-total">
                            <th>TOTAL YANG AKAN DIBAYAR:</th>
                            <td id="qrTotalDisplay">Rp 0</td>
                        </tr>
                        <tr>
                            <th>Rincian Pembayaran:</th>
                            <td id="qrPaidSummary" style="font-weight: 500;"> - </td>
                        </tr>
                    </tbody>
                </table>
                
                <div style="text-align: center; margin: 30px 0;">
                    <img src="qrcode.jpg" alt="QRIS Standard Pembayaran Nasional" class="qris-image" id="qrisImageDisplay">
                    <p style="margin-top: 15px; font-weight: 600; color: var(--text-main); font-size: 0.9em;">SCAN QRIS DI ATAS UNTUK MELAKUKAN PEMBAYARAN</p>
                </div>
                
                <button class="pro-button" id="downloadQRButton" onclick="downloadQR()">
                    ‚¨áÔ∏è Unduh Gambar QR (Wajib)
                </button>
                
                <p style="text-align: center; margin-top: 15px; margin-bottom: 15px; font-size: 0.75em; color: var(--running-text-bg);">
                    Penting: Lampirkan bukti pembayaran ke Admin untuk verifikasi cepat.
                </p>

                <button class="pro-button" id="confirmWAButton" onclick="simulatePaymentConfirmation('QRIS')">
                    <span style="font-size: 1.1em; vertical-align: middle;">üì®</span> Upload Bukti & Konfirmasi (WhatsApp Admin)
                </button>
            </div>
            
            <div class="payment-card" id="paymentStep4" style="display: none;">
                <h3 class="section-title" style="margin-top: 0;">4. Pembayaran via Transfer Bank</h3>
                
                <div class="user-info">
                    <p>Nama Warga: <strong><span id="transferUserName"></span></strong></p>
                    <p>Blok/No Rumah: <strong><span id="transferUserBlock"></span></strong></p>
                </div>

                <table class="payment-detail-table" style="margin-bottom: 20px;">
                    <tbody>
                        <tr class="table-row-total">
                            <th>TOTAL YANG HARUS DITRANSFER:</th>
                            <td id="transferTotalDisplay">Rp 0</td>
                        </tr>
                        <tr>
                            <th>Rincian Pembayaran:</th>
                            <td id="transferPaidSummary" style="font-weight: 500;"> - </td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="transfer-details">
                    <p style="font-weight: 700;">TRANSFER KE REKENING KAS GANG:</p>
                    <p>Bank: üè¶ BCA</p>
                    <p>Atas Nama: Candra Purbaya </p>
                    <div class="account-line">
                        <span id="accountNumberDisplay">8730508591</span>
                        <button class="copy-button" onclick="copyText('8730508591')">
                            üìã Salin
                        </button>
                    </div>
                </div>
                
                <p style="text-align: center; margin-top: 25px; margin-bottom: 15px; font-size: 0.75em; color: var(--running-text-bg);">
                    Setelah transfer, mohon konfirmasi ke Admin dengan melampirkan bukti.
                </p>

                <button class="pro-button" id="confirmTransferWAButton" onclick="simulatePaymentConfirmation('Transfer Bank')">
                    <span style="font-size: 1.1em; vertical-align: middle;">üì®</span> Kirim Bukti Transfer & Konfirmasi (WhatsApp Admin)
                </button>
            </div>
            
            <div class="payment-card" id="paymentStep5" style="display: none;">
                <h3 class="section-title" style="margin-top: 0;">5. Konfirmasi Pembayaran <span id="paymentTypeHeader">Tunai/E-Wallet</span></h3>
                
                <div class="user-info">
                    <p>Nama Warga: <strong><span id="otherUserName"></span></strong></p>
                    <p>Blok/No Rumah: <strong><span id="otherUserBlock"></span></strong></p>
                </div>

                <table class="payment-detail-table" style="margin-bottom: 20px;">
                    <tbody>
                        <tr class="table-row-total">
                            <th>TOTAL YANG DIBAYAR:</th>
                            <td id="otherTotalDisplay">Rp 0</td>
                        </tr>
                        <tr>
                            <th>Rincian Pembayaran:</th>
                            <td id="otherPaidSummary" style="font-weight: 500;"> - </td>
                        </tr>
                    </tbody>
                </table>

                <p style="font-weight: 500;">Instruksi Pembayaran:</p>
                <div class="transfer-details">
                    <p id="otherInstructionText" style="font-weight: 400; line-height: 1.5;">
                        Silakan siapkan pembayaran Anda dan hubungi Bendahara Kas untuk penyerahan dana secara langsung.
                    </p>
                     <div id="danaDetails" style="display: none; margin-top: 15px;">
                         <p>E-Wallet: üî∑ DANA</p>
                         <p>Atas Nama: Candra Purbaya</p>
                         <div class="account-line">
                            <span id="danaNumberDisplay">08111435512</span>
                            <button class="copy-button" onclick="copyText('08111435512')">
                                üìã Salin
                            </button>
                        </div>
                    </div>
                </div>
                
                <p style="text-align: center; margin-top: 25px; margin-bottom: 15px; font-size: 0.75em; color: var(--running-text-bg);">
                    Klik tombol di bawah setelah pembayaran diserahkan.
                </p>
                
                <button class="pro-button" id="confirmEwalletCash" onclick="simulatePaymentConfirmation(document.getElementById('paymentTypeHeader').textContent)">
                    <span style="font-size: 1.1em; vertical-align: middle;"> üì®</span> Konfirmasi Pembayaran Selesai (WhatsApp Admin)
                </button>
            </div>
            
        </div>
    </div>
    
    <div class="my-profile-page" id="myProfilePage" style="display: none; opacity: 0;">
        <button class="fab-back-button" id="fabBackProfileButton" onclick="hideMyProfilePage()">
            ‚Üê 
        </button>
        <div class="container">
            <h1 class="section-title">üë§ Data Riwayat Pembayaran Saya</h1>
            
            <div class="profile-card">
                 <div class="profile-info-card" id="myProfileCard">
                    <span class="profile-icon">üè°</span>
                    <div class="profile-details">
                        <p style="font-size: 1.2em; font-weight: 700;">
                            <span id="profileUserName"></span> 
                            <span class="status-badge">Aktif</span>
                        </p>
                        <p style="font-size: 0.9em;">Blok/No: <strong><span id="profileUserBlock"></span></strong></p>
                        <p style="font-size: 0.8em; opacity: 0.8;">Iuran Bulanan: <strong><span id="profileUserRate"></span></strong></p>
                    </div>
                </div>
                <h3 style="font-size: 1.0em; margin-top: 0; border-bottom: 1px solid var(--text-main); padding-bottom: 5px;">Rincian Pembayaran Kas Periode 2025-2026</h3>

                <table class="payment-history-table">
                    <thead>
                        <tr>
                            <th>Bulan</th>
                            <th>Periode 2025</th>
                            <th>Periode 2026</th>
                        </tr>
                    </thead>
                    <tbody id="paymentHistoryBody">
                        </tbody>
                </table>
                
                <h3 style="font-size: 1.0em; margin-top: 25px; border-bottom: 1px solid var(--text-main); padding-bottom: 5px;">Ringkasan Total Tagihan</h3>
                <table class="profile-detail-table">
                    <tbody>
                        <tr>
                            <th>Total Tunggakan 2025:</th>
                            <td id="profileArrearsTotal">Rp 0</td>
                        </tr>
                         <tr>
                            <th>Sisa Pembayaran 2026:</th>
                            <td id="profileUnpaid2026Total">Rp 0</td>
                        </tr>
                        <tr class="table-row-total">
                            <th>Subtotal Tagihan Total:</th>
                            <td id="profileSubtotalTotal">Rp 0</td>
                        </tr>
                    </tbody>
                </table>
                
                <button class="continue-button" style="margin-top: 30px;" onclick="showPaymentPage(1)">
                    Bayar Sekarang
                </button>

            </div>
        </div>
    </div>
    
    <div class="my-profile-page" id="notificationPage" style="display: none; opacity: 0;">
        <button class="fab-back-button" id="fabBackNotifButton" onclick="handleFabClick()">
            ‚Üê 
        </button>
        <div class="container">
            <h1 class="section-title">üîî Riwayat Notifikasi</h1>
            
            <div class="profile-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px;">
                    <p style="font-size: 0.85em; opacity: 0.8; margin: 0;">Daftar aktivitas pembayaran warga. (Maksimal 20 terbaru)</p>
                    <button class="action-button" onclick="clearNotifications()" style="font-size: 0.75em; padding: 5px 10px; box-shadow: 0 3px 0 var(--delete-shadow); background-color: var(--delete-button); color: white;">
                        üóëÔ∏è Hapus Semua
                    </button>
                 </div>
                 
                 <div id="notificationsList">
                    </div>
                 
            </div>
        </div>
    </div>


    <div class="data-warga-page" id="dataWargaPage" style="display: none; opacity: 0;">
        <button class="fab-back-button" id="fabBackWargaButton" onclick="hideDataWargaPage()" style="display: none;">
            ‚Üê 
        </button>
        <div class="container">
            <h1 class="section-title">üèò Data Kas Gang E21-25 preode 2025-2026   </h1>
            
            <div class="warga-card">
                <p style="font-size: 0.85em; opacity: 0.8;"> Tunggakan 2025 wajib di lunasi dulu. bagi yan mempunyai tunggakan maka, pembayar 2026 akan di alokasikan untuk tunggakan 2025 </p>
                
                <table class="warga-table">
                    <thead>
                        <tr>
                            <th class="name-col" style="width: 40%;">Nama Warga</th>
                            <th style="width: 20%;">Blok/No</th>
                            <th style="width: 20%;">Tunggakan 2025</th>
                            <th style="width: 20%;">Iuran 2026</th>
                        </tr>
                    </thead>
                    <tbody id="wargaTableBody">
                        </tbody>
                </table>
                
                <div class="toggle-button-container">
                    <button class="toggle-table-button" id="toggleWargaButton" onclick="toggleWargaTable()">
                        Tampilkan 10 Data Warga Lainnya
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="my-profile-page" id="invoicePage" style="display: none; opacity: 0;">
        <button class="fab-back-button" id="fabBackInvoiceButton" onclick="handleFabClick()">
            ‚Üê 
        </button>
        <div class="container">
            <h1 class="section-title">üìÑ Daftar Invoice Pembayaran</h1>
            
            <div id="invoiceListWrapper">
                <p style="font-size: 0.85em; opacity: 0.8; margin-bottom: 15px;">Klik invoice untuk melihat detail. Invoice tersimpan otomatis.</p>
                <div id="invoiceListContainer">
                    </div>
            </div>
            
            <div id="singleInvoiceDisplay" class="profile-card" style="display: none;">
                 <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div class="user-info" >
                         <p style="font-size: 1.1em;">Invoice ID: <strong><span id="invoiceID"></span></strong></p>
                         <p style="font-size: 1.1em;">Tgl. Transaksi: <strong><span id="invoiceDate"></span></strong></p>
                    </div>
                    <button id="deleteInvoiceButton" class="action-button" style="background-color: var(--delete-button); color: white; box-shadow: 0 3px 0 var(--delete-shadow); font-size: 0.75em;" onclick="deleteSingleInvoice(selectedInvoice.invoiceID)">
                        üóëÔ∏è Hapus Invoice
                    </button>
                 </div>
                
                <h3 style="font-size: 1.0em; margin-top: 0; border-bottom: 1px solid var(--text-main); padding-bottom: 5px;">Rincian Pembayaran</h3>

                <table class="payment-detail-table">
                    <tbody>
                        <tr>
                            <th>Warga / Blok No:</th>
                            <td id="invoiceUserNameBlock"></td>
                        </tr>
                        <tr>
                            <th>Metode Pembayaran:</th>
                            <td id="invoiceMethod"></td>
                        </tr>
                        <tr>
                            <th>Alokasi Pembayaran:</th>
                            <td id="invoiceAllocation"></td>
                        </tr>
                         <tr class="table-row-total">
                            <th>TOTAL DIBAYAR:</th>
                            <td id="invoiceTotal"></td>
                        </tr>
                    </tbody>
                </table>

                <p style="font-size: 0.8em; opacity: 0.8; margin-top: 20px; text-align: center;">
                    *Ini adalah bukti sah pembayaran Kas Gang E21-25. Simpan sebagai arsip.
                </p>
                
                <div style="margin-top: 40px; text-align: right; padding-right: 20px; font-size: 0.9em;">
                    <p style="margin-bottom: 50px;">Hormat Kami,</p>
                    <p style="border-top: 1px solid var(--text-main); display: inline-block; padding: 0 5px;">
                        Candra Purbaya (Bendahara)
                    </p>
                </div>
            </div>
            </div>
    </div>

    <div class="my-profile-page" id="reportPage" style="display: none; opacity: 0;">
        <button class="fab-back-button" id="fabBackReportButton" onclick="hideReportPage()">
            ‚Üê 
        </button>
        <div class="container">
            <h1 class="section-title">üìä Laporan Keuangan Kas (Des 2025)</h1>
            
            <div class="profile-card">
                
                <div style="display: flex; justify-content: space-around; gap: 10px; margin-bottom: 25px;">
                    <div style="text-align: center; flex: 1; padding: 15px 5px; border-radius: 12px; box-shadow: var(--inset-shadow); background-color: var(--bg-main);">
                        <h3 style="margin: 0 0 5px; font-size: 0.9em; font-weight: 500; color: var(--neon-color-header);">PEMASUKAN KAS</h3>
                        <strong style="font-size: 1.4em; color: var(--neon-color-header);" id="totalIncome"
                        >Rp 250.000</strong>
                    </div>
                    <div style="text-align: center; flex: 1; padding: 15px 5px; border-radius: 12px; box-shadow: var(--inset-shadow); background-color: var(--bg-main);">
                        <h3 style="margin: 0 0 5px; font-size: 0.9em; font-weight: 500; color: var(--running-text-bg);">PENGELUARAN KAS</h3>
                        <strong style="font-size: 1.4em; color: var(--running-text-bg);" id="totalExpense"
                        >Rp 959.800</strong>
                    </div>
                </div>
                
                <h3 style="font-size: 1.0em; margin-top: 0; border-bottom: 1px solid var(--text-main); padding-bottom: 5px;">Rincian Pengeluaran</h3>
                
                <table class="payment-history-table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Tanggal</th>
                            <th style="width: 55%;">Keterangan</th>
                            <th style="width: 20%;">Nominal</th>
                        </tr>
                    </thead>
                    <tbody id="expenseTableBody">
                        <tr>
                            <td>01/12/25</td>
                            <td style="text-align: left;">Pembelian lampu jalan 2 pcs</td>
                            <td class="status-unpaid">Rp 60.000</td>
                        </tr>
                        <tr>
                            <td>05/12/25</td>
                            <td style="text-align: left;">Biaya Konsumsi Rapat Bulanan</td>
                            <td class="status-unpaid">Rp 150.000</td>
                        </tr>
                        <tr>
                            <td>07/12/25</td>
                            <td style="text-align: left;">Biaya perbaikan gerbang gang</td>
                            <td class="status-unpaid">Rp 2.759.800</td>
                        </tr>
                        </tbody>
                </table>
                
                 </div>
        </div>
    </div>


    <div class="login-page" id="loginPage" style="display: none; opacity: 0;">
        <div class="login-card">
            <h1>Kas Warga Login</h1>
            <form id="loginForm">
                <input type="text" id="usernameInput" class="login-input" placeholder="ID Pengguna" required>
                <input type="password" id="passwordInput" class="login-input" placeholder="Kata Sandi" required>
                <div id="loginMessage" style="margin: 10px 0; font-weight: 500; display: none; font-size: 0.8em;"></div>
                <button type="submit" class="continue-button login-button">Masuk ke Dashboard</button>
                <p style="font-size: 0.8em; margin-top: 15px; opacity: 0.8;">
                    Belum punya akun? <a href="#" onclick="showRegistrationPage()" style="color: var(--neon-color-header); text-decoration: none; font-weight: 600;">Daftar Sekarang</a>
                </p>
            </form>
        </div>
    </div>
    
    <div class="registration-page" id="registrationPage" style="display: none; opacity: 0;">
        <div class="login-card">
            <h1>Registrasi Akun</h1>
            <form id="registrationForm">
                <input type="text" id="regNama" class="login-input" placeholder="Nama Lengkap" required>
                <input type="text" id="regBlokNo" class="login-input" placeholder="Blok/No Rumah (Cth: E23/01)" required>
                <input type="text" id="regIdUser" class="login-input" placeholder="ID Pengguna (Custom)" required>
                <input type="password" id="regPassword" class="login-input" placeholder="Kata Sandi (Min 6 Karakter)" required>
                <p style="margin: 10px 0 15px; font-size: 0.8em; opacity: 0.8;">
                    Registrasi akan dikonfirmasi Admin.
                </p>
                <button type="button" class="pro-button" id="regWaButton" style="background-color: #25D366; box-shadow: 0 4px 0 #1eac53; color: white; margin-top: 0;" onclick="registerViaWhatsApp()">
                    Daftar via WhatsApp (Rekomendasi)
                </button>
                <button type="button" class="continue-button" style="background-color: #95a5a6; box-shadow: 0 5px 0 #7f8c8d; margin-top: 8px;" onclick="backToLogin()">
                    ‚Üê Kembali ke Login
                </button>
            </form>
        </div>
    </div>

    <script>
        // ======================================================
        // 1. DATA WARGA DAN PENGGUNA (GABUNGAN)
        // ======================================================

        // Variabel Global dan Data User
        const MONTHS = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const ADMIN_WA_NUMBER = '6287837644379'; 
        const CURRENT_YEAR = 2025; 
        const NEXT_YEAR = 2026;   
        const TOTAL_MONTHS_YEAR = 12;
        
        // Data DANA (BARU)
        const DANA_ACCOUNT = {
            number: '08111435512',
            name: 'Candra Purbaya'
        };


        // Data Warga LENGKAP (20 data) - Sekarang juga menampung info login
        const allUsersAndWarga = [
            // Data Warga dengan Akun Login (username, password, dan isAccount: true)
            // Rohman: Lunas 2025 (0 arrears), Bayar 0 bulan 2026
            { id: 1, name: 'Rohman', block: 'E21/51', rate: 25000, 
            arrears2025: 0, 
            paid2026: 0,
            username: 'rohman', 
            password: '2151',
            isAccount: true, invoices: [] }, 
            
            { id: 1, 
            name: 'Nana rusmana', block: 'E21/51', rate: 25000, 
            arrears2025: 0, 
            paid2026: 0,
            username: 'nana', 
            password: '2149',
            isAccount: true, invoices: [] }, 


  {
    "id": 2,
    "name": "NOVRY",
    "block": "E21-38",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "novry",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 3,
    "name": "FATHUR",
    "block": "E21-39",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "fathur",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 4,
    "name": "HANIF",
    "block": "E21-41",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "hanif",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 5,
    "name": "EKA ADI",
    "block": "E21-42",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "ekaadi",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 6,
    "name": "LARASATI",
    "block": "E21-43",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "larasati",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 7,
    "name": "RAHMAN",
    "block": "E21-46",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "rahman",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 8,
    "name": "RAKEL",
    "block": "E21-47",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "rakel",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 9,
    "name": "HENDRA",
    "block": "E21-48",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "hendra",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 10,
    "name": "AJI",
    "block": "E21-57",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "aji",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 11,
    "name": "VIKO",
    "block": "E21-53",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "viko",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 12,
    "name": "HENDRI",
    "block": "E21-55",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "hendri",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 13,
    "name": "RIYANDI",
    "block": "E21-56",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "riyandi",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 14,
    "name": "ANGGA",
    "block": "E21-60",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "angga",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 15,
    "name": "IWAN",
    "block": "E21-61",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "iwan",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 16,
    "name": "MARIO",
    "block": "E21-65",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "mario",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 17,
    "name": "KOKO",
    "block": "E21-66",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "koko",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 18,
    "name": "RICO",
    "block": "E21-67",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "rico",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 19,
    "name": "IRWAN",
    "block": "E21-68",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "irwan",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 20,
    "name": "TORO",
    "block": "E21-69",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "toro",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 21,
    "name": "TOPAN",
    "block": "E21-79",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "topan",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 22,
    "name": "HERI",
    "block": "E21-71",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "heri",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 23,
    "name": "BAYU ADE",
    "block": "E21-72",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "bayuade",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 24,
    "name": "FIRLY",
    "block": "E21-73",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "firly",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 25,
    "name": "KRISNA",
    "block": "E25-03",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "krisna",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 26,
    "name": "DENY",
    "block": "E25-08",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "deny",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 27,
    "name": "CHANDRA",
    "block": "E25-09",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "chandra",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 28,
    "name": "ALFIAN",
    "block": "E25-10",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "alfian",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 29,
    "name": "TEDI",
    "block": "E25-11",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "tedi",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 30,
    "name": "DERI",
    "block": "E25-15",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "deri",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 31,
    "name": "PAULUS",
    "block": "E25-18",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "paulus",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 32,
    "name": "DEDE DWI",
    "block": "E25-19",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "dededwi",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 33,
    "name": "ANANG",
    "block": "E25-20",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "anang",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 34,
    "name": "PARULIAN",
    "block": "E25-21",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "parulian",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 35,
    "name": "BAYU NUR",
    "block": "E25-22",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "bayunur",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 36,
    "name": "WALUYO",
    "block": "E25-23",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "waluyo",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 37,
    "name": "HADI",
    "block": "E25-27",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "hadi",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 38,
    "name": "Pakdeh Agung",
    "block": "E25-28",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "pakdehagung",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 39,
    "name": "BUDI ALMAWAN",
    "block": "E25-30",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "budialmawan",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 40,
    "name": "BAGUS",
    "block": "E25-31",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "bagus",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 41,
    "name": "ASEP",
    "block": "E25-32",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "asep",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 42,
    "name": "DEDE GUNAWAN",
    "block": "E25-33",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "dedegunawan", // USER NAME
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 43,
    "name": "KARDAN",
    "block": "E25-35",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "kardan",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 44,
    "name": "RENDY",
    "block": "E25-36",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "rendy",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  },
  {
    "id": 45,
    "name": "VERA",
    "block": "E25-37",
    "rate": 25000,
    "arrears2025": 0,
    "paid2026": 0,
    "username": "vera",
    "password": "0000",
    "isAccount": true,
    "invoices": []
  }


        ];
        
        // Data untuk Tabel Warga (menggunakan nama allWargaData agar fungsi renderWargaTable() tidak perlu diubah)
        const allWargaData = allUsersAndWarga; 

        // User yang login default (Rohman, ID 1)
        let currentUser = allUsersAndWarga[0];
        let selectedMethod = null;
        let finalPaymentSummary = {}; 
        // currentStep = 8 untuk Halaman Notifikasi, 9: InvoicePage, 10: ReportPage
        let currentStep = 0; // 0: Dashboard, 1: Step1, 2: Step2, 3: Step3 (QRIS), 4: Step4 (Transfer), 5: Step5 (Tunai/E-Wallet), 6: DataWarga, 7: MyProfile, 8: NotificationPage, 9: InvoicePage, 10: ReportPage
        let isTableExpanded = false; // Status untuk tabel Data Warga
        let selectedInvoice = null; // Menyimpan invoice yang sedang dilihat
        
        // Variabel Notifikasi Global
        const NOTIFICATION_KEY = 'kasWargaNotifications';

        // --- GET ELEMENT DOM ---
        const body = document.body;
        const themeToggle = document.getElementById('themeToggle');
        const dashboard = document.getElementById('mainDashboard');
        const loginPage = document.getElementById('loginPage');
        const registrationPage = document.getElementById('registrationPage');
        const paymentPage = document.getElementById('paymentPage');
        const dataWargaPage = document.getElementById('dataWargaPage'); 
        const myProfilePage = document.getElementById('myProfilePage'); 
        // Notifikasi DOM
        const notificationPage = document.getElementById('notificationPage');
        const fabBackNotifButton = document.getElementById('fabBackNotifButton'); 
        const notificationsList = document.getElementById('notificationsList');
        // Invoice DOM
        const invoicePage = document.getElementById('invoicePage');
        const fabBackInvoiceButton = document.getElementById('fabBackInvoiceButton');
        const invoiceListContainer = document.getElementById('invoiceListContainer'); // Kontainer baru untuk daftar invoice
        const singleInvoiceDisplay = document.getElementById('singleInvoiceDisplay'); // Kontainer untuk detail satu invoice
        const invoiceListWrapper = document.getElementById('invoiceListWrapper'); // Wrapper untuk daftar invoice
        // Laporan DOM
        const reportPage = document.getElementById('reportPage');
        const fabBackReportButton = document.getElementById('fabBackReportButton');
        
        // Loading Page DOM
        const loadingPage = document.getElementById('loadingPage');

        // Elemen-elemen yang sudah ada
        const paymentStep1 = document.getElementById('paymentStep1');
        const paymentStep2 = document.getElementById('paymentStep2');
        const paymentStep3 = document.getElementById('paymentStep3');
        const paymentStep4 = document.getElementById('paymentStep4'); 
        const paymentStep5 = document.getElementById('paymentStep5'); 
        const welcomeUserText = document.getElementById('welcomeUserText');
        const loginForm = document.getElementById('loginForm');
        const nominalInput = document.getElementById('nominalInput');
        const paymentUserName = document.getElementById('paymentUserName');
        const paymentUserBlock = document.getElementById('paymentUserBlock');
        const paymentUserRate = document.getElementById('paymentUserRate');
        const tunggakanInfo = document.getElementById('tunggakanInfo');
        const tunggakanPaid = document.getElementById('tunggakanPaid');
        const paidMonths = document.getElementById('paidMonths');
        const paymentPeriod = document.getElementById('paymentPeriod');
        const totalPayment = document.getElementById('totalPayment');
        const minPaymentText = document.getElementById('minPaymentText');
        const continueButton = document.getElementById('continueButton'); 
        const finalTotalDisplay = document.getElementById('finalTotalDisplay');
        const finalPaidSummary = document.getElementById('finalPaidSummary');
        const fabBackButton = document.getElementById('fabBackButton');
        const fabBackWargaButton = document.getElementById('fabBackWargaButton'); 
        const fabBackProfileButton = document.getElementById('fabBackProfileButton');
        // Step 3 (QRIS) DOM
        const qrUserName = document.getElementById('qrUserName');
        const qrUserBlock = document.getElementById('qrUserBlock');
        const qrTotalDisplay = document.getElementById('qrTotalDisplay');
        const qrPaidSummary = document.getElementById('qrPaidSummary');
        // Step 4 (Transfer) DOM
        const transferUserName = document.getElementById('transferUserName');
        const transferUserBlock = document.getElementById('transferUserBlock');
        const transferTotalDisplay = document.getElementById('transferTotalDisplay');
        const transferPaidSummary = document.getElementById('transferPaidSummary');
        // Step 5 (Other) DOM
        const paymentTypeHeader = document.getElementById('paymentTypeHeader');
        const otherUserName = document.getElementById('otherUserName');
        const otherUserBlock = document.getElementById('otherUserBlock');
        const otherTotalDisplay = document.getElementById('otherTotalDisplay');
        const otherPaidSummary = document.getElementById('otherPaidSummary');
        const otherInstructionText = document.getElementById('otherInstructionText');
        const danaDetails = document.getElementById('danaDetails'); // Kontainer DANA baru
        // Data Warga DOM
        const wargaTableBody = document.getElementById('wargaTableBody');
        const toggleWargaButton = document.getElementById('toggleWargaButton');
        // My Profile DOM - Riwayat (Lama)
        const profileUserName = document.getElementById('profileUserName');
        const profileUserBlock = document.getElementById('profileUserBlock');
        const profileUserRate = document.getElementById('profileUserRate');
        const paymentHistoryBody = document.getElementById('paymentHistoryBody');
        const profileArrearsTotal = document.getElementById('profileArrearsTotal');
        const profileUnpaid2026Total = document.getElementById('profileUnpaid2026Total');
        const profileSubtotalTotal = document.getElementById('profileSubtotalTotal');
        // Single Invoice DOM
        const invoiceID = document.getElementById('invoiceID');
        const invoiceDate = document.getElementById('invoiceDate');
        const invoiceUserNameBlock = document.getElementById('invoiceUserNameBlock');
        const invoiceMethod = document.getElementById('invoiceMethod');
        const invoiceAllocation = document.getElementById('invoiceAllocation');
        const invoiceTotal = document.getElementById('invoiceTotal');
        // Elemen tombol hapus invoice
        const deleteInvoiceButton = document.getElementById('deleteInvoiceButton');


        // ======================================================
        // 2. FUNGSI NOTIFIKASI
        // ======================================================

        function getNotifications() {
            const data = localStorage.getItem(NOTIFICATION_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveNotifications(notifications) {
            localStorage.setItem(NOTIFICATION_KEY, JSON.stringify(notifications));
            // Panggil renderMenu setiap kali notifikasi diubah untuk memperbarui badge
            if (currentUser) { 
                renderMenu(); 
            }
        }

        function addNotification(type, message, targetUserId = 'all') {
            // Perubahan: Hanya notifikasi 'payment' yang akan disimpan
            if (type !== 'payment') {
                return; 
            }
            
            // Perubahan: Notifikasi hanya dikirim ke user yang login (ID) atau 'all' jika targetnya 'all'
            // if (targetUserId !== 'all' && targetUserId !== currentUser.id) {
            //     return;
            // }

            const notifications = getNotifications();
            const newNotif = {
                id: Date.now(),
                type: type, // 'payment'
                message: message,
                read: false,
                timestamp: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                target: targetUserId 
            };
            notifications.unshift(newNotif); 
            saveNotifications(notifications);
        }
        
        // FUNGSI BARU: Hapus Semua Notifikasi
        function clearNotifications() {
            if (confirm('Apakah Anda yakin ingin menghapus SEMUA notifikasi? Tindakan ini tidak dapat dibatalkan.')) {
                // Filter notifikasi yang TIDAK ditujukan untuk user yang sedang login ('all' atau ID user)
                const notifications = getNotifications().filter(n => n.target !== currentUser.id && n.target !== 'all');
                
                // Jika hasil filternya 0, hapus seluruh local storage untuk notifikasi
                if (notifications.length === 0) {
                     localStorage.removeItem(NOTIFICATION_KEY);
                } else {
                     saveNotifications(notifications); 
                }
                
                renderNotifications(); 
                renderMenu(); 
            }
        }

        function markNotificationsAsRead() {
            const notifications = getNotifications();
            let changed = false;
            
            // Filter notifikasi yang ditujukan untuk 'all' atau ID user saat ini
            notifications.forEach(n => {
                if (!n.read && (n.target === 'all' || n.target === currentUser.id)) {
                    n.read = true;
                    changed = true;
                }
            });
            
            if (changed) {
                saveNotifications(notifications);
            }
        }
        
        // FUNGSI DIPERBARUI: Merender daftar notifikasi ke HTML
        function renderNotifications() {
            const notifications = getNotifications();
            let html = '';
            
            // Filter notifikasi yang relevan untuk user ini
            const relevantNotifs = notifications.filter(n => 
                (n.target === 'all' || n.target === currentUser.id) && n.type === 'payment'
            );

            if (relevantNotifs.length === 0) {
                html = `<p style="text-align: center; margin: 30px 0; opacity: 0.6;">Tidak ada riwayat notifikasi pembayaran saat ini.</p>`;
            } else {
                relevantNotifs.slice(0, 20).forEach(n => { // Batasi 20 notifikasi terbaru
                    const icon = n.type === 'payment' ? 'üí∏' : 'üí°'; // Hanya akan ada 'payment'
                    const color = n.type === 'payment' ? 'var(--neon-color-header)' : '#3498db';
                    const readStyle = n.read ? 'opacity: 0.7; background-color: transparent;' : 'font-weight: 600; background-color: var(--bg-main); box-shadow: var(--inset-shadow);';

                    html += `
                        <div style="padding: 10px; border-bottom: 1px dotted var(--shadow-dark); margin-bottom: 8px; font-size: 0.9em; display: flex; align-items: flex-start; gap: 10px; border-radius: 8px; ${readStyle}">
                            <span style="font-size: 1.2em; color: ${color};">${icon}</span>
                            <div style="flex-grow: 1;">
                                <p style="margin: 0; line-height: 1.4; font-weight: inherit;">${n.message}</p>
                                <p style="margin: 3px 0 0; font-size: 0.75em; opacity: 0.7; font-weight: 500;">${n.timestamp}</p>
                            </div>
                        </div>
                    `;
                });
            }
            notificationsList.innerHTML = html;
        }

        // FUNGSI DIPERBARUI: Menampilkan halaman Notifikasi yang baru
        function showNotificationsPage() {
            if (!currentUser) {
                showLoginPage();
                return;
            }
            
            // Sembunyikan semua halaman lain
            transitionToPage(notificationPage, 8); 

            // Mark and Render
            setTimeout(() => {
                markNotificationsAsRead();
                renderNotifications();
            }, 500);
        }
        
        // FUNGSI BARU: Menyembunyikan halaman Notifikasi
        function hideNotificationPage() {
            notificationPage.style.opacity = 0;
            setTimeout(() => {
                notificationPage.style.display = 'none';
                fabBackNotifButton.style.display = 'none';
                dashboard.style.display = 'block';
                // Transisi dashboard
                setTimeout(() => { dashboard.style.opacity = 1; }, 50);
                currentStep = 0;
                renderMenu(); 
            }, 400); // Sesuai dengan transisi
        }


        // ======================================================
        // 3. FUNGSI UTILITY & UI
        // ======================================================
        
        // FUNGSI BARU: Sembunyikan semua halaman (dengan transisi)
        function hideAllPages() {
             const pages = [dashboard, loginPage, registrationPage, paymentPage, dataWargaPage, myProfilePage, notificationPage, invoicePage, reportPage];
             pages.forEach(page => {
                 page.style.opacity = 0;
                 // Sembunyikan FAB
                 fabBackButton.style.display = 'none';
                 fabBackWargaButton.style.display = 'none'; 
                 fabBackProfileButton.style.display = 'none'; 
                 fabBackNotifButton.style.display = 'none'; 
                 fabBackInvoiceButton.style.display = 'none';
                 fabBackReportButton.style.display = 'none';
             });
             // Set display: none setelah transisi singkat
             setTimeout(() => {
                 pages.forEach(page => { page.style.display = 'none'; });
             }, 300); // Sedikit lebih pendek dari transisi
        }


        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        }
        
        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Berhasil menyalin ke clipboard!');
            }).catch(err => {
                console.error('Gagal menyalin: ', err);
            });
        }
        
        function updateUserData(newData) {
             // Cari indeks currentUser dalam array global
            const userIndex = allUsersAndWarga.findIndex(u => u.id === currentUser.id);
            
            if (userIndex !== -1) {
                // Perbarui data di array global
                allUsersAndWarga[userIndex] = { ...allUsersAndWarga[userIndex], ...newData };
                // Perbarui data currentUser lokal
                currentUser = allUsersAndWarga[userIndex];
                
                // Opsional: Render ulang dashboard/profile jika diperlukan
                if (currentStep === 7) {
                    renderPaymentHistory(); 
                }
                if (currentStep === 6) {
                    renderWargaTable();
                }
            } else {
                console.error("Gagal menemukan user dalam array global.");
            }
        }


        // --- FUNGSI TAMPILAN DAN NAVIGASI ---
        function updateMode(isDarkMode) {
            if (isDarkMode) {
                body.classList.add('dark-mode');
                themeToggle.innerHTML = 'üåô Mode Gelap';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark-mode');
                themeToggle.innerHTML = '‚òÄÔ∏è Mode Terang';
                localStorage.setItem('theme', 'light');
            }
        }
        
        function toggleMode() {
            const isDarkMode = body.classList.contains('dark-mode');
            updateMode(!isDarkMode);
        }
        
        function renderMenu() {
            const menuGrid = document.querySelector('.menu-grid');
            if (!menuGrid || !currentUser) return;
            
            // Hitung Notifikasi Belum Dibaca
            const notifications = getNotifications();
            // FILTER NOTIFIKASI yang hanya ditujukan ke user ini (ID) atau 'all'
            const unreadCount = notifications.filter(n => 
                !n.read && (n.target === 'all' || n.target === currentUser.id)
            ).length;
            
            // Dapatkan HTML menu item Notifikasi
            let notificationMenuItem = `
                <a href="#" class="menu-item" onclick="showNotificationsPage()">
                    <span class="menu-icon">üîî</span>
                    <strong>Notifikasi</strong>
                    ${unreadCount > 0 ? `<span class="badge">${unreadCount}</span>` : ''}
                </a>
            `;
            
            // Hitung jumlah invoice yang ada
            const totalInvoices = currentUser.invoices ? currentUser.invoices.length : 0;
            let invoiceBadge = totalInvoices > 0 ? `<span class="badge" style="background-color: #3498db;">${totalInvoices}</span>` : '';


            // Buat ulang semua menu item
            const menuHtml = `
                <a href="#" class="menu-item" onclick="showPaymentPage(1)">
                    <span class="menu-icon">üí∏</span>
                    <strong>Bayar Kas</strong>
                </a>
                <a href="#" class="menu-item" onclick="showMyProfilePage()">
                    <span class="menu-icon">üë§</span>
                    <strong>Data Saya</strong>
                </a>
                <a href="#" class="menu-item" onclick="showDataWargaPage()">
                    <span class="menu-icon">üèòÔ∏è</span>
                    <strong>Data Warga</strong>
                </a>
                <a href="#" class="menu-item" onclick="showReportPage()">
                    <span class="menu-icon">üìä</span>
                    <strong>Laporan</strong>
                </a>
                ${notificationMenuItem}
                <a href="#" class="menu-item" onclick="showInvoicePage()">
                    <span class="menu-icon">üìÑ</span>
                    <strong>Invoice Pembayaran</strong>
                    ${invoiceBadge}
                </a>
            `;
            
            menuGrid.innerHTML = menuHtml;
        }

        // FUNGSI BARU: Transisi untuk menampilkan halaman
        function transitionToPage(pageElement, step) {
             hideAllPages();
             setTimeout(() => {
                pageElement.style.display = (pageElement === loginPage || pageElement === registrationPage) ? 'flex' : 'block';
                // Tambahkan Opacity untuk Transisi
                setTimeout(() => { 
                    pageElement.style.opacity = 1; 
                }, 50); // Jeda singkat
                
                currentStep = step;
                
                // Atur FAB
                const fabMap = {
                    1: fabBackButton, 2: fabBackButton, 3: fabBackButton, 4: fabBackButton, 5: fabBackButton, 
                    6: fabBackWargaButton, 7: fabBackProfileButton, 8: fabBackNotifButton, 9: fabBackInvoiceButton, 10: fabBackReportButton
                };
                if (fabMap[step]) {
                    fabMap[step].style.display = 'block';
                }

             }, 350); // Jeda setelah semua halaman di-hide
        }


        function showLoginPage() {
            transitionToPage(loginPage, 0);
            themeToggle.style.display = 'none';
            currentUser = null;
        }
        
        function hideLoginPage(name) {
            // Sembunyikan semua dan tampilkan dashboard
            transitionToPage(dashboard, 0);
            
            welcomeUserText.textContent = `Selamat Datang, ${name}! üëã`;
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') { updateMode(false); } else { updateMode(true); }
            themeToggle.style.display = 'inline-block';
            
            // Panggil renderMenu di sini untuk menampilkan menu dengan badge notifikasi
            renderMenu(); 
        }

        function showRegistrationPage() {
            transitionToPage(registrationPage, 0);
            document.getElementById('registrationForm').reset(); 
        }
        
        function backToLogin() {
             // Langsung tampilkan login tanpa hideAllPages karena sudah di-hideAllPages
            registrationPage.style.opacity = 0;
            setTimeout(() => {
                registrationPage.style.display = 'none';
                loginPage.style.display = 'flex';
                setTimeout(() => { loginPage.style.opacity = 1; }, 50);
            }, 300);
        }
        
        function registerViaWhatsApp() {
            const nama = document.getElementById('regNama').value.trim();
            const blokNo = document.getElementById('regBlokNo').value.trim();
            const idUser = document.getElementById('regIdUser').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            
            const message = `Halo Admin, saya ingin mendaftar akun Kas Gang E21-25. Berikut detail pendaftaran saya:%0A%0A*Nama:* ${nama || 'Belum diisi'}%0A*Blok/No:* ${blokNo || 'Belum diisi'}%0A*ID Pengguna:* ${idUser || 'Belum diisi'}%0A*Password:* ${password || 'Belum diisi'}%0A%0AMohon diproses, terima kasih.`;
            
            const waUrl = `https://wa.me/${ADMIN_WA_NUMBER}?text=${message}`;
            window.open(waUrl, '_blank');
        }

        // --- FUNGSI NAVIGASI FAB ---
        function handleFabClick() {
            if (currentStep === 10) { // Dari Halaman Laporan
                hideReportPage();
            } else if (currentStep === 9) { // Dari Halaman Invoice
                // Jika sedang melihat detail, kembali ke daftar invoice
                if (selectedInvoice && singleInvoiceDisplay.style.display === 'block') {
                    // Cek jika tombol back ditekan dari detail invoice
                    renderInvoiceList();
                    selectedInvoice = null;
                    // Perbarui judul halaman ke Daftar Invoice
                    document.querySelector('#invoicePage .section-title').textContent = 'üìÑ Daftar Invoice Pembayaran';
                } else {
                    hideInvoicePage();
                }
            } else if (currentStep === 8) { // Dari Halaman Notifikasi
                hideNotificationPage();
            } else if (currentStep === 7) { // Dari Halaman Profile
                hideMyProfilePage();
            } else if (currentStep === 6) { // Dari Halaman Data Warga
                 hideDataWargaPage();
            } else if (currentStep === 5) { // Dari Step 5 kembali ke Step 2
                showPaymentPage(2);
            } else if (currentStep === 4) { // Dari Step 4 kembali ke Step 2
                showPaymentPage(2);
            } else if (currentStep === 3) { // Dari Step 3 kembali ke Step 2
                showPaymentPage(2);
            } else if (currentStep === 2) { // Dari Step 2 kembali ke Step 1
                showPaymentPage(1);
            } else if (currentStep === 1) { // Dari Step 1 kembali ke Dashboard
                hidePaymentPage();
            }
        }
        
        // --- FUNGSI HALAMAN DATA SAYA ---
        function showMyProfilePage() {
             if (!currentUser) {
                showLoginPage();
                return;
            }

            transitionToPage(myProfilePage, 7);
            renderPaymentHistory(); // Render tabel riwayat
        }
        
        function hideMyProfilePage() {
             myProfilePage.style.opacity = 0;
             setTimeout(() => {
                myProfilePage.style.display = 'none';
                fabBackProfileButton.style.display = 'none';
                dashboard.style.display = 'block';
                 // Transisi dashboard
                setTimeout(() => { dashboard.style.opacity = 1; }, 50);
                currentStep = 0;
                renderMenu(); // Perbarui menu setelah kembali ke dashboard
            }, 400);
        }

        function renderPaymentHistory() {
            // Mengisi data user di kartu profil
            profileUserName.textContent = currentUser.name;
            profileUserBlock.textContent = currentUser.block;
            profileUserRate.textContent = formatRupiah(currentUser.rate);
            
            let html = '';
            
            // Hitung status Lunas 2025 (12 - arrears)
            const paid2025Months = TOTAL_MONTHS_YEAR - currentUser.arrears2025;
            const paid2026Months = currentUser.paid2026;      // Bulan yang sudah dibayar di 2026
            
            for (let i = 0; i < TOTAL_MONTHS_YEAR; i++) {
                const monthName = MONTHS[i];
                
                // Status 2025
                let status2025Text = '';
                let status2025Class = '';
                // Menghitung status 2025: Jika indeks bulan (i) kurang dari total bulan yang sudah dibayar (paid2025Months), maka LUNAS.
                if (i < paid2025Months) {
                    status2025Text = 'LUNAS';
                    status2025Class = 'status-paid';
                } else {
                    status2025Text = 'BELUM LUNAS';
                    status2025Class = 'status-unpaid';
                }
                
                // Status 2026
                let status2026Text = '';
                let status2026Class = '';
                // Menghitung status 2026: Jika indeks bulan (i) kurang dari total bulan yang sudah dibayar di 2026 (paid2026Months), maka LUNAS.
                if (i < paid2026Months) {
                    status2026Text = 'SUDAH LUNAS';
                    status2026Class = 'status-paid';
                } else {
                    status2026Text = 'BELUM LUNAS';
                    status2026Class = 'status-unpaid';
                }
                
                html += `
                    <tr>
                        <td>${monthName}</td>
                        <td class="${status2025Class}">${status2025Text}</td>
                        <td class="${status2026Class}">${status2026Text}</td>
                    </tr>
                `;
            }
            
            paymentHistoryBody.innerHTML = html;
            
            // Subtotal Calculation
            const totalUnpaid2025Months = currentUser.arrears2025;
            // Pastikan total bulan yang belum dibayar di 2026 tidak negatif 
            const totalUnpaid2026Months = Math.max(0, TOTAL_MONTHS_YEAR - currentUser.paid2026);
            
            const totalArrearsRupiah = totalUnpaid2025Months * currentUser.rate;
            const totalUnpaid2026Rupiah = totalUnpaid2026Months * currentUser.rate; 
            const subtotalRupiah = totalArrearsRupiah + totalUnpaid2026Rupiah;

            profileArrearsTotal.textContent = `${totalUnpaid2025Months} bln (${formatRupiah(totalArrearsRupiah)})`;
            profileUnpaid2026Total.textContent = `${totalUnpaid2026Months} bln (${formatRupiah(totalUnpaid2026Rupiah)})`;
            profileSubtotalTotal.textContent = formatRupiah(subtotalRupiah);
        }

        
        // --- FUNGSI HALAMAN DATA WARGA ---
        function showDataWargaPage() {
             if (!currentUser) {
                showLoginPage();
                return;
            }

            transitionToPage(dataWargaPage, 6);
            // Pastikan isTableExpanded diset ke false saat pertama kali masuk
            isTableExpanded = false; 
            renderWargaTable();
        }
        
        function hideDataWargaPage() {
            dataWargaPage.style.opacity = 0;
            setTimeout(() => {
                dataWargaPage.style.display = 'none';
                fabBackWargaButton.style.display = 'none';
                dashboard.style.display = 'block';
                // Transisi dashboard
                setTimeout(() => { dashboard.style.opacity = 1; }, 50);
                currentStep = 0;
                renderMenu(); // Perbarui menu setelah kembali ke dashboard
            }, 400);
        }

        function renderWargaTable() {
            let html = '';
            // Tentukan data yang akan ditampilkan (10 atau semua)
            const displayLimit = isTableExpanded ? allWargaData.length : 10;
            const dataToDisplay = allWargaData.slice(0, displayLimit);

            dataToDisplay.forEach((warga, index) => {
                // Status Tunggakan 2025 (Arrears)
                const arrearsText = warga.arrears2025 > 0 
                    ? `<span class="status-warning">${warga.arrears2025} bln</span>` 
                    : `<span class="status-ok">LUNAS</span>`;
                
                // Status Iuran 2026 (Paid 2026)
                let paid2026Text;
                if (warga.paid2026 >= 12) {
                     // Jika sudah bayar 12 bulan (sepenuhnya) atau lebih untuk 2026
                     paid2026Text = `<span class="status-ok">LUNAS ${NEXT_YEAR}</span>`;
                } else if (warga.paid2026 > 0) {
                     // Jika sudah bayar sebagian
                     paid2026Text = `${warga.paid2026} bln`;
                } else {
                     // Jika 0 bulan (belum bayar sama sekali)
                     paid2026Text = `0 bln`; 
                }
                
                // Tambahkan kelas untuk baris tersembunyi
                const isHiddenRow = index >= 10 && !isTableExpanded;
                const rowClass = isHiddenRow ? 'hidden-row' : '';

                html += `
                    <tr class="${rowClass}">
                        <td class="name-col">${warga.name}</td>
                        <td>${warga.block}</td>
                        <td>${arrearsText}</td>
                        <td>${paid2026Text}</td>
                    </tr>
                `;
            });

            wargaTableBody.innerHTML = html;
            
            // Perbarui tombol
            if (allWargaData.length > 10) {
                toggleWargaButton.style.display = 'block';
                if (isTableExpanded) {
                    toggleWargaButton.textContent = 'Sembunyikan Sisa Data Warga';
                } else {
                    toggleWargaButton.textContent = `Tampilkan ${allWargaData.length - 10} Data Warga Lainnya`;
                }
            } else {
                toggleWargaButton.style.display = 'none';
            }
            
            // Menambah style untuk menyembunyikan (walaupun kelas hidden-row sudah ada di tr, ini untuk memastikan)
            const hiddenRows = document.querySelectorAll('.hidden-row');
            hiddenRows.forEach(row => {
                if (isTableExpanded) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function toggleWargaTable() {
            isTableExpanded = !isTableExpanded;
            renderWargaTable();
        }
        
        // --- FUNGSI HALAMAN INVOICE PEMBAYARAN BARU ---
        
        function renderInvoiceList() {
             // Sembunyikan detail invoice, tampilkan daftar invoice
            singleInvoiceDisplay.style.display = 'none';
            invoiceListWrapper.style.display = 'block';
            selectedInvoice = null; // Reset invoice yang sedang dilihat
            
            const invoices = currentUser.invoices || [];
            const listContainer = document.getElementById('invoiceListContainer');
            let html = '';
            
            if (invoices.length === 0) {
                 html = `<p style="text-align: center; margin: 30px 0; opacity: 0.6;">Anda belum memiliki riwayat Invoice Pembayaran saat ini.</p>`;
            } else {
                invoices.sort((a, b) => b.id - a.id); // Urutkan terbaru
                
                invoices.forEach(inv => {
                    html += `
                        <div class="profile-card" style="margin-bottom: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                             <div onclick="showSingleInvoice('${inv.invoiceID}')" style="cursor: pointer; flex-grow: 1;">
                                <p style="font-size: 1.0em; margin-bottom: 5px;"><strong>${inv.invoiceID}</strong> (${inv.method})</p>
                                <div style="display: flex; justify-content: space-between; font-size: 0.9em; opacity: 0.9;">
                                    <span>Tgl: ${inv.date}</span>
                                    <strong>${formatRupiah(inv.total)}</strong>
                                </div>
                                <p style="font-size: 0.8em; opacity: 0.7; margin: 5px 0 0;">Alokasi: ${inv.allocation}</p>
                            </div>
                            <button class="action-button" style="background-color: var(--delete-button); color: white; box-shadow: 0 3px 0 var(--delete-shadow); font-size: 0.7em; padding: 6px 10px; margin-left: 10px;" onclick="deleteSingleInvoice('${inv.invoiceID}')">
                                üóëÔ∏è Hapus
                            </button>
                        </div>
                    `;
                });
            }
            listContainer.innerHTML = html;
        }

        function showSingleInvoice(invoiceID) {
            const invoice = (currentUser.invoices || []).find(inv => inv.invoiceID === invoiceID);
            
            if (!invoice) return;
            
            selectedInvoice = invoice;
            invoiceListWrapper.style.display = 'none';
            singleInvoiceDisplay.style.display = 'block';
            
            document.getElementById('invoiceID').textContent = invoice.invoiceID;
            document.getElementById('invoiceDate').textContent = invoice.date;
            document.getElementById('invoiceUserNameBlock').textContent = `${currentUser.name} (${currentUser.block})`;
            document.getElementById('invoiceMethod').textContent = invoice.method;
            document.getElementById('invoiceAllocation').textContent = invoice.allocation;
            document.getElementById('invoiceTotal').textContent = formatRupiah(invoice.total);
            
             // Ganti judul halaman menjadi "Detail Invoice"
             document.querySelector('#invoicePage .section-title').textContent = 'üìÑ Detail Bukti Pembayaran';
        }
        
        function deleteSingleInvoice(invoiceID) {
            if (confirm(`Apakah Anda yakin ingin menghapus Invoice ID: ${invoiceID}? Tindakan ini tidak akan mengembalikan data pembayaran Anda.`)) {
                
                // Hapus dari currentUser.invoices
                const initialCount = currentUser.invoices.length;
                currentUser.invoices = currentUser.invoices.filter(inv => inv.invoiceID !== invoiceID);
                
                if (currentUser.invoices.length < initialCount) {
                    // Simpan perubahan ke array global
                    const userIndex = allUsersAndWarga.findIndex(u => u.id === currentUser.id);
                    if (userIndex !== -1) {
                        allUsersAndWarga[userIndex].invoices = currentUser.invoices;
                    }
                    
                    // Reset selectedInvoice dan render ulang
                    selectedInvoice = null;
                    renderInvoiceList();
                    // Perbarui badge menu
                    renderMenu(); 
                    
                    // Kembali ke daftar invoice setelah menghapus
                    if (document.getElementById('singleInvoiceDisplay').style.display === 'block') {
                        document.getElementById('singleInvoiceDisplay').style.display = 'none';
                        document.getElementById('invoiceListWrapper').style.display = 'block';
                        document.querySelector('#invoicePage .section-title').textContent = 'üìÑ Daftar Invoice Pembayaran';
                    }
                    
                } else {
                    console.error('Gagal menghapus invoice.');
                }
            }
        }


        function showInvoicePage() {
            if (!currentUser) {
                showLoginPage();
                return;
            }
            
            transitionToPage(invoicePage, 9);
             // Ganti judul halaman menjadi "Daftar Invoice"
             document.querySelector('#invoicePage .section-title').textContent = 'üìÑ Daftar Invoice Pembayaran';

            // Tampilkan daftar invoice
            setTimeout(renderInvoiceList, 400);
        }

        function hideInvoicePage() {
            invoicePage.style.opacity = 0;
             setTimeout(() => {
                invoicePage.style.display = 'none';
                fabBackInvoiceButton.style.display = 'none';
                dashboard.style.display = 'block';
                // Transisi dashboard
                setTimeout(() => { dashboard.style.opacity = 1; }, 50);
                currentStep = 0;
                renderMenu(); 
            }, 400);
        }

        // --- FUNGSI HALAMAN LAPORAN BARU ---
        function showReportPage() {
            if (!currentUser) {
                showLoginPage();
                return;
            }
            
            transitionToPage(reportPage, 10);
            
            // Logika simulasi (total saldo saat ini 2.290.200)
            // Laporan sudah disimulasikan di HTML
        }

        function hideReportPage() {
            reportPage.style.opacity = 0;
             setTimeout(() => {
                reportPage.style.display = 'none';
                fabBackReportButton.style.display = 'none';
                dashboard.style.display = 'block';
                // Transisi dashboard
                setTimeout(() => { dashboard.style.opacity = 1; }, 50);
                currentStep = 0;
                renderMenu(); 
            }, 400);
        }

        // --- FUNGSI UTAMA UNTUK MENAMPILKAN STEP PEMBAYARAN ---
        function showPaymentPage(step = 1) {
            if (!currentUser) {
                showLoginPage();
                return;
            }

            transitionToPage(paymentPage, step);
            
            // Reset views
            paymentStep1.style.display = 'none';
            paymentStep2.style.display = 'none';
            paymentStep3.style.display = 'none';
            paymentStep4.style.display = 'none'; 
            paymentStep5.style.display = 'none'; 
            
            fabBackButton.style.display = (step > 0 && step <= 5) ? 'block' : 'none'; 

            // Tampilkan Step yang diminta
            setTimeout(() => {
                if (step === 1) {
                    if (paymentStep1.style.display !== 'block') {
                        paymentUserName.textContent = currentUser.name;
                        paymentUserBlock.textContent = currentUser.block;
                        paymentUserRate.textContent = formatRupiah(currentUser.rate);
                        
                        const arrearsMonths2025 = currentUser.arrears2025;
                        const totalArrearsRupiah = arrearsMonths2025 * currentUser.rate;
                        
                        let tunggakanMessage = '';
                        // Hitung total bulan yang belum dibayar di 2026
                        const unpaid2026Months = TOTAL_MONTHS_YEAR - currentUser.paid2026;
                        
                        if (arrearsMonths2025 > 0) {
                            tunggakanInfo.classList.add('tunggakan-warning-style');
                            tunggakanInfo.classList.remove('tunggakan-lunas-style');
                            tunggakanMessage = `‚ö†Ô∏è PERHATIAN: Anda memiliki ${arrearsMonths2025} bulan** tunggakan ${CURRENT_YEAR} (${formatRupiah(totalArrearsRupiah)}). Pembayaran akan dialokasikan untuk melunasi tunggakan tahun ${CURRENT_YEAR} terlebih dahulu.`;
                        } else {
                            // Cek apakah ada tunggakan 2026 (yaitu belum lunas 12 bulan)
                            if (unpaid2026Months > 0) {
                                tunggakanInfo.classList.add('tunggakan-lunas-style');
                                tunggakanInfo.classList.remove('tunggakan-warning-style');
                                tunggakanMessage = `‚úÖ LUNAS ${CURRENT_YEAR}: Anda lunas hingga Desember ${CURRENT_YEAR}. Pembayaran berikutnya dialokasikan untuk iuran mulai ${MONTHS[currentUser.paid2026 % 12]} ${NEXT_YEAR}.`;
                            } else {
                                tunggakanInfo.classList.add('tunggakan-lunas-style');
                                tunggakanInfo.classList.remove('tunggakan-warning-style');
                                tunggakanMessage = `üéâ LUNAS TOTAL: Anda lunas hingga akhir tahun ${NEXT_YEAR}. Terima kasih!`;
                            }
                        }
                        tunggakanInfo.innerHTML = tunggakanMessage;

                        const minPayment = currentUser.rate; 
                        nominalInput.value = nominalInput.value || minPayment; 
                        minPaymentText.textContent = formatRupiah(minPayment);
                        calculatePayment();
                    }
                    
                    paymentStep1.style.display = 'block';

                } else if (step === 2) {
                    if (continueButton.disabled && finalPaymentSummary.total === 0) {
                        showPaymentPage(1);
                        return;
                    }
                    
                    paymentStep2.style.display = 'block';
                    
                    finalTotalDisplay.textContent = formatRupiah(finalPaymentSummary.total);
                    
                    let summaryText = '';
                    if (finalPaymentSummary.paidArrears > 0) {
                        summaryText += `Pelunasan Tunggakan ${CURRENT_YEAR} (${finalPaymentSummary.paidMonths2025} bln)`;
                    }
                    if (finalPaymentSummary.paidMonths2026 > 0) {
                         if (summaryText) summaryText += ' + ';
                         summaryText += `Iuran ${NEXT_YEAR} (${finalPaymentSummary.paidMonths2026} bln)`;
                    }
                    finalPaidSummary.textContent = summaryText || 'Tidak ada alokasi pembayaran.';
                    
                    document.querySelectorAll('.method-item').forEach(el => el.classList.remove('selected'));

                } else if (step === 3) { // QRIS
                    paymentStep3.style.display = 'block';
                    qrUserName.textContent = currentUser.name;
                    qrUserBlock.textContent = currentUser.block;
                    qrTotalDisplay.textContent = formatRupiah(finalPaymentSummary.total);
                    qrPaidSummary.textContent = getSummaryText();
                    
                } else if (step === 4) { // Transfer Bank
                    paymentStep4.style.display = 'block';
                    transferUserName.textContent = currentUser.name;
                    transferUserBlock.textContent = currentUser.block;
                    transferTotalDisplay.textContent = formatRupiah(finalPaymentSummary.total);
                    transferPaidSummary.textContent = getSummaryText();
                } else if (step === 5) { // Tunai/E-Wallet (Baru)
                    
                    if (finalPaymentSummary.total === 0) {
                        showPaymentPage(1);
                        return;
                    }
                    
                    paymentStep5.style.display = 'block';
                    
                    const method = selectedMethod === 'cash' ? 'Tunai' : 'E-Wallet (DANA)';
                    
                    paymentTypeHeader.textContent = method;
                    otherUserName.textContent = currentUser.name;
                    otherUserBlock.textContent = currentUser.block;
                    otherTotalDisplay.textContent = formatRupiah(finalPaymentSummary.total);
                    otherPaidSummary.textContent = getSummaryText();
                    
                    // Logika Instruksi dan Detail Dana
                    if (selectedMethod === 'cash') {
                         otherInstructionText.innerHTML = `Mohon hubungi Bendahara atau datnag secara langsung ke blok E25-09 untuk penyerahan dana sebesar ${formatRupiah(finalPaymentSummary.total)}.`;
                         danaDetails.style.display = 'none';
                    } else if (selectedMethod === 'ewallet') {
                         otherInstructionText.innerHTML = `Silakan transfer sejumlah **${formatRupiah(finalPaymentSummary.total)}** ke nomor E-Wallet (DANA) di bawah ini.`;
                         danaDetails.style.display = 'block';
                    }
                }
            }, 400); // Tunggu sebentar setelah transisi halaman
        }

        function hidePaymentPage() {
            paymentPage.style.opacity = 0;
            setTimeout(() => {
                paymentPage.style.display = 'none';
                fabBackButton.style.display = 'none'; 
                dashboard.style.display = 'block';
                 // Transisi dashboard
                setTimeout(() => { dashboard.style.opacity = 1; }, 50);
                currentStep = 0;
                renderMenu(); // Perbarui menu setelah kembali ke dashboard
            }, 400);
        }
        
        // FUNGSI BARU: Untuk mengaktifkan tampilan metode pembayaran yang dipilih
        function showPaymentFlow(method) {
             selectedMethod = method;
             document.querySelectorAll('.method-item').forEach(el => el.classList.remove('selected'));
             document.querySelector(`.method-item[data-method="${method}"]`).classList.add('selected');

             if (method === 'qris') {
                 showPaymentPage(3);
             } else if (method === 'transfer') {
                 showPaymentPage(4);
             } else if (method === 'cash' || method === 'ewallet') {
                 showPaymentPage(5);
             }
         }


        function calculatePayment() {
            let inputAmount = parseInt(nominalInput.value) || 0;
            const rate = currentUser.rate;
            let totalArrears2025 = currentUser.arrears2025 * rate; 
            
            let paidArrears2025 = 0;
            let paidMonths2025Count = 0;
            let amountForIuran2026 = 0;
            let paidMonths2026Count = 0;
            let totalBilled = 0;
            let periodText = ' - ';
            
            let currentRemainingInput = inputAmount;

            // 1. Prioritaskan Tunggakan 2025
            if (totalArrears2025 > 0) {
                if (currentRemainingInput >= totalArrears2025) {
                    paidArrears2025 = totalArrears2025;
                    currentRemainingInput -= totalArrears2025;
                    paidMonths2025Count = currentUser.arrears2025;
                } else {
                    // Hanya bayar bulan yang utuh
                    paidArrears2025 = currentRemainingInput - (currentRemainingInput % rate);
                    paidMonths2025Count = Math.floor(paidArrears2025 / rate);
                    currentRemainingInput = currentRemainingInput % rate; // Sisa uang kurang dari 1 bulan iuran
                }
            }
            
            totalBilled += paidArrears2025;

            // 2. Hitung Iuran Bulanan 2026
            amountForIuran2026 = currentRemainingInput;
            if (amountForIuran2026 > 0) {
                // Total bulan yang belum dibayar di 2026 (maksimal 12)
                const remainingMonths2026 = TOTAL_MONTHS_YEAR - currentUser.paid2026;
                
                // Berapa bulan iuran 2026 yang bisa dibayar dengan sisa uang?
                let monthsToPay2026 = Math.floor(amountForIuran2026 / rate);
                
                // Batasi pembayaran maksimal sampai sisa bulan 2026 yang belum lunas
                paidMonths2026Count = Math.min(monthsToPay2026, remainingMonths2026);
                
                // Hitung jumlah rupiah yang dialokasikan untuk 2026
                const iuran2026Calculated = paidMonths2026Count * rate;
                totalBilled += iuran2026Calculated;
                
                if (paidMonths2026Count > 0) {
                    // Logika penentuan periode pembayaran untuk Iuran 2026 (Januari 2026 + X bulan)
                    const totalPaidMonthsBefore = currentUser.paid2026;
                    
                    // Hitung bulan/tahun awal pembayaran 2026 ini
                    const startMonthIndex = totalPaidMonthsBefore % 12; 
                    const startYearOffset = Math.floor(totalPaidMonthsBefore / 12);
                    const startYear = NEXT_YEAR + startYearOffset;
                    const startMonth = MONTHS[startMonthIndex];

                    const totalPaidMonthsAfter = totalPaidMonthsBefore + paidMonths2026Count;

                    // Hitung bulan/tahun berakhir (karena totalPaidMonthsAfter sudah menjadi jumlah bulan, dikurangi 1 untuk mendapatkan indeks bulan terakhir)
                    const endMonthIndex = (totalPaidMonthsAfter - 1) % 12;
                    const endYearOffset = Math.floor((totalPaidMonthsAfter - 1) / 12);
                    const endYear = NEXT_YEAR + endYearOffset;
                    const endMonth = MONTHS[endMonthIndex];
                    
                    if (paidMonths2026Count === 1) {
                        periodText = `${startMonth} ${startYear}`;
                    } else {
                        periodText = `${startMonth} ${startYear} s/d ${endMonth} ${endYear}`;
                    }
                }
            }
            
            // 3. Update Tampilan
            tunggakanPaid.textContent = formatRupiah(paidArrears2025);
            const totalPaidMonths = paidMonths2025Count + paidMonths2026Count;
            paidMonths.textContent = `${totalPaidMonths} Bulan (${paidMonths2025Count} di ${CURRENT_YEAR}, ${paidMonths2026Count} di ${NEXT_YEAR})`;
            paymentPeriod.textContent = periodText;
            totalPayment.textContent = formatRupiah(totalBilled);
            
            // 4. Update Button State
            const minPaymentRequired = rate;
            if (totalBilled >= minPaymentRequired && totalBilled > 0) {
                continueButton.disabled = false;
                nominalInput.style.borderColor = '#00A878';
            } else {
                continueButton.disabled = true;
                 if (inputAmount > 0) {
                     nominalInput.style.borderColor = '#FFD700';
                 } else {
                     nominalInput.style.borderColor = 'transparent';
                 }
            }
            
            // 5. Simpan Summary
            finalPaymentSummary = {
                total: totalBilled,
                paidArrears: paidArrears2025,
                paidMonthsCount: totalPaidMonths,
                periodText: periodText,
                paidMonths2025: paidMonths2025Count,
                paidMonths2026: paidMonths2026Count,
                arrearsStartMonths: currentUser.arrears2025,
                paid2026StartMonths: currentUser.paid2026
            };
        }
        
        function getSummaryText() {
            let summaryText = '';
            if (finalPaymentSummary.paidArrears > 0) {
                summaryText += `Pelunasan Tunggakan ${CURRENT_YEAR} (${finalPaymentSummary.paidMonths2025} bln)`;
            }
            if (finalPaymentSummary.paidMonths2026 > 0) {
                 if (summaryText) summaryText += ' + ';
                 summaryText += `Iuran ${NEXT_YEAR} (${finalPaymentSummary.paidMonths2026} bln)`;
            }
            return summaryText || 'Tidak ada alokasi pembayaran.';
        }

        // FUNGSI BARU: Untuk membuat objek invoice
        function createInvoice(methodType) {
            const date = new Date();
            // Inisialisasi jika null
            if (!currentUser.invoices) currentUser.invoices = []; 
            const invoiceCount = currentUser.invoices.length + 1;
            
            // Buat Invoice ID (Cth: INV-1-202512-01)
            const invoiceID = `INV-${currentUser.id}-${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}-${invoiceCount.toString().padStart(2, '0')}`;
            
            const allocationText = getSummaryText();
            
            const newInvoice = {
                id: Date.now(),
                invoiceID: invoiceID,
                date: date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }),
                total: finalPaymentSummary.total,
                method: methodType,
                allocation: allocationText
            };
            
            // Tambahkan ke array invoices di currentUser
            currentUser.invoices.push(newInvoice);
            
            // Simpan perubahan ke array global (Sudah dilakukan di updateUserData)
            // updateUserData tidak dipanggil, jadi harus panggil secara manual:
            const userIndex = allUsersAndWarga.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                allUsersAndWarga[userIndex].invoices = currentUser.invoices;
            }
            
        }
        
        // --- FUNGSI KONFIRMASI PEMBAYARAN (SIMULASI UPDATE DATA) ---
        function simulatePaymentConfirmation(methodType) {
            
            if (finalPaymentSummary.total === 0) {
                 alert('Error: Tidak ada transaksi yang diproses. Nominal pembayaran Rp 0.'); 
                 return;
            }

            // 1. BUAT INVOICE SEBELUM UPDATE DATA
            createInvoice(methodType);
            
            // 2. Kirim Pesan WA (DIBUKA DI TAB BARU)
            const total = formatRupiah(finalPaymentSummary.total);
            const summary = getSummaryText();
            const waMessage = `Halo Admin, saya *${currentUser.name}* (${currentUser.block}) telah melakukan pembayaran Kas sebesar *${total}* (${summary}) via **${methodType}**.%0A%0AMohon bantuannya untuk verifikasi pembayaran, saya akan mengirimkan bukti transfer/screenshot bayar/konfirmasi penyerahan dana.%0A%0ATerima kasih.`;
            const waUrl = `https://wa.me/${ADMIN_WA_NUMBER}?text=${waMessage}`;
            window.open(waUrl, '_blank');
            
            
            // 3. SIMULASI UPDATE DATA PENGGUNA (Backend Update) - Otomatis Lunas
            
            // Hitung sisa tunggakan 2025
            const newArrears2025 = Math.max(0, currentUser.arrears2025 - finalPaymentSummary.paidMonths2025);
            
            // Hitung total paid 2026 yang baru (maksimal 12 bulan)
            const newPaid2026 = Math.min(TOTAL_MONTHS_YEAR, currentUser.paid2026 + finalPaymentSummary.paidMonths2026);
            
            // Buat objek data baru
            const newData = {
                arrears2025: newArrears2025,
                paid2026: newPaid2026
            };
            
            updateUserData(newData); // Update data currentUser dan array global
            
            // 4. Tambahkan Notifikasi Pembayaran Berhasil (kepada user yang bersangkutan)
            const paymentNotifMessage = `Pembayaran Kas sebesar ${total} (${summary}) via ${methodType} telah berhasil dikonfirmasi. Bukti pembayaran dapat dilihat di halaman Invoice.`;
            // Perubahan: Hanya kirim ke ID user yang bersangkutan
            addNotification('payment', paymentNotifMessage, currentUser.id); 
            
            // 5. Kembali ke Dashboard
            hidePaymentPage();
            
            // 6. Reset input nominal agar pembayaran baru dimulai dari nol
            nominalInput.value = '';
            calculatePayment(); // Reset summary
        }

        // --- FUNGSI STEP 3 (QRIS) ---
        function downloadQR() {
            alert('Simulasi: Gambar QR Code telah berhasil diunduh ke perangkat Anda.');
        }

        // --- FUNGSI LOGIN/REGISTRASI ---
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const inputUsername = document.getElementById('usernameInput').value.trim().toLowerCase();
            const inputPassword = document.getElementById('passwordInput').value.trim();
            
            // Cari pengguna di array tunggal
            const user = allUsersAndWarga.find(u => u.username === inputUsername && u.password === inputPassword);
            
            const loginMessage = document.getElementById('loginMessage');
            
            loginMessage.style.display = 'block';
            
            if (user) {
                currentUser = user;
                loginMessage.style.color = '#00C49A';
                loginMessage.innerHTML = `Login Berhasil! Selamat datang, **${user.name}**.`;
                
                // Jeda 1 detik sebelum masuk dashboard
                setTimeout(() => { hideLoginPage(user.name); }, 1000);
            } else {
                loginMessage.style.color = '#FF4444';
                loginMessage.innerHTML = 'Username atau Kata Sandi salah. Silakan coba lagi.';
            }
        });

        // ======================================================
        // 10. INISIALISASI & SPLASH SCREEN LOGIC
        // ======================================================

        function initializeApp() {
             // Terapkan tema
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') { updateMode(false); } else { updateMode(true); }

            // Tampilkan splash screen, kemudian beralih ke login
            setTimeout(() => {
                loadingPage.classList.add('hidden');
                
                // Setelah transisi loading page selesai
                setTimeout(() => {
                    loadingPage.style.display = 'none';
                    // Tampilkan Login Page dengan transisi
                    showLoginPage(); 
                    
                    // Inisialisasi tampilan tabel data warga dan menu
                    if (currentUser) {
                         renderWargaTable(); 
                         renderMenu();
                    }
                    
                }, 500); // Sesuai dengan transisi opacity loadingPage
                
            }, 2000); // Jeda 2 detik sebelum transisi dimulai
        }
        
        // Panggil inisialisasi aplikasi saat DOM siap
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>

</html>
