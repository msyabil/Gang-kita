<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kas - Dashboard dan Pembayaran | Neumorphism</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ====================================================== */
        /* 1. ANIMASI KEYFRAMES */
        /* ====================================================== */
        @keyframes neon-pulse {
            0% { box-shadow: var(--inset-shadow), 0 0 10px var(--saldo-shadow); }
            50% { box-shadow: var(--inset-shadow), 0 0 18px var(--saldo-shadow), 0 0 40px var(--neon-color-pulse); }
            100% { box-shadow: var(--inset-shadow), 0 0 10px var(--saldo-shadow); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes text-reveal {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        /* ====================================================== */
        /* 2. VARIABEL WARNA (DARK & LIGHT MODE) */
        /* ====================================================== */
        :root {
            --bg-main: #f0f4f8; 
            --card-bg: #e5e9ef; 
            --text-main: #2c3e50; 
            --neon-color-header: #00A878;
            --neon-color-menu: var(--neon-color-header); 
            --saldo-shadow: #00A878; 
            --neon-color-pulse: rgba(0, 168, 120, 0.6);
            --running-text-bg: #c0392b; 
            --shadow-light: rgba(255, 255, 255, 0.7);
            --shadow-dark: rgba(174, 174, 192, 0.4);
            --soft-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            --inset-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
            /* Warna khusus untuk blok peringatan */
            --warning-bg-light: #fbe6e6;
            --warning-text-light: #c0392b;
            --success-bg-light: #e6fbe6;
            --success-text-light: #00A878;

            /* Warna Tombol 3D (Flat-ish) */
            --button-main: #2ecc71; /* Hijau */
            --button-shadow: #27ae60; 
            --button-text: white;
            --button-hover: #37d37a; 

            --download-button: #3498db; /* Biru */
            --download-shadow: #2980b9; 
            --copy-button: #9b59b6; /* Ungu untuk Copy */
            --copy-shadow: #8e44ad; 
            --delete-button: #e74c3c;
            --delete-shadow: #c0392b;

            /* Warna Loading */
            --loading-bg: #f0f4f8; 
            --loading-text: #2c3e50;
            
            /* Warna Status */
            --status-active-bg: #00A878;
            --status-active-text: white;
        }

        body.dark-mode {
            --bg-main: #1e1e1e; 
            --card-bg: #2b2b2b; 
            --text-main: #f0f0f0; 
            --neon-color-header: #FFD700; 
            --neon-color-menu: var(--neon-color-header); 
            --saldo-shadow: #FFD700;
            --neon-color-pulse: rgba(255, 215, 0, 0.6);
            --running-text-bg: #800000; 
            --shadow-light: rgba(50, 50, 50, 0.3);
            --shadow-dark: rgba(0, 0, 0, 0.8);
            --soft-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
            --inset-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            /* Warna khusus untuk blok peringatan DARK MODE */
            --warning-bg-dark: #4d2323;
            --warning-text-dark: #ff8585;
            --success-bg-dark: #234d23;
            --success-text-dark: #90ee90;

             /* Warna Tombol 3D DARK MODE*/
            --button-main: #00A878; /* Hijau */
            --button-shadow: #008f65; 
            --button-text: #1e1e1e;
            --button-hover: #00bf8a; 

            --download-button: #5dade2; /* Biru */
            --download-shadow: #3f83b2; 
            --copy-button: #c39bd3; /* Ungu muda untuk Copy */
            --copy-shadow: #9e7cb2; 

            /* Warna Loading DARK MODE */
            --loading-bg: #1e1e1e; 
            --loading-text: #f0f0f0;
            
            /* Warna Status DARK MODE */
            --status-active-bg: #FFD700;
            --status-active-text: #1e1e1e;
        }

        /* ====================================================== */
        /* 3. GAYA DASAR & CONTAINER DASHBOARD (FONT RINGKAS) */
        /* ====================================================== */
        body {
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-main);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            /* Transisi untuk perpindahan halaman yang halus */
            transition: background-color 0.4s ease-in-out, color 0.4s ease-in-out; 
            font-size: 0.9em; 
            overflow-x: hidden; /* Mencegah scroll horizontal */
        }
        
        /* GAYA UNTUK SEMUA CONTAINER HALAMAN */
        .main-dashboard, .login-page, .registration-page, .payment-page, .my-profile-page, .notification-page, .invoice-page, .data-warga-page, .report-page {
            transition: opacity 0.4s ease-in-out; /* Transisi untuk fade-in/out */
        }


        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px 25px; 
        }
        
        .top-controls { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
        }
        
        .right-actions {
            display: flex;
            gap: 8px; 
        }
        
        .dashboard-header .welcome-user { 
            font-size: 1.5em; 
            font-weight: 700; 
            display: block; 
        }
        .dashboard-header p { 
            margin: 0; 
            opacity: 0.7; 
            font-size: 0.8em; 
        }

        .saldo-card {
            background-color: var(--card-bg); 
            padding: 25px; 
            border-radius: 18px; 
            text-align: center;
            box-shadow: var(--soft-shadow); 
            margin-bottom: 25px; 
            border: 1px solid var(--neon-color-header);
            animation: neon-pulse 3s infinite alternate;
        }
        .saldo-card h2 { 
            margin: 0 0 8px 0; 
            font-weight: 500; 
            color: var(--neon-color-header); 
            font-size: 1em; 
        }
        .saldo-amount { 
            font-size: 2.0em; 
            font-weight: 800; 
            color: var(--text-main); 
        }
        
        .menu-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); 
            gap: 15px; 
        }
        .menu-item {
            background-color: var(--card-bg); 
            padding: 15px 8px; 
            border-radius: 12px; 
            text-decoration: none; 
            color: var(--text-main); 
            font-size: 0.8em; 
            font-weight: 500;
            box-shadow: var(--soft-shadow);
            /* Modifikasi: Transisi lebih halus untuk neumorphism */
            transition: all 0.3s ease-in-out; 
            text-align: center;
            position: relative; /* Untuk Badge */
        }
        /* Modifikasi: Efek menyala saat di klik/aktif */
        .menu-item:active { 
            box-shadow: var(--inset-shadow), 0 0 10px var(--neon-color-menu); 
            transform: scale(0.95); 
        }
        .menu-icon { 
            font-size: 2.2em; 
            display: block; 
            margin-bottom: 3px; 
            /* Transisi untuk ikon */
            transition: color 0.3s ease-in-out;
        }
        
        /* GAYA BADGE NOTIFIKASI */
        .badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #e74c3c; 
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7em;
            font-weight: 700;
            line-height: 1;
        }

        .action-button {
            background-color: var(--bg-main); 
            border: none; 
            color: var(--text-main);
            padding: 7px 12px; 
            border-radius: 20px; 
            font-size: 0.8em; 
            font-weight: 600; 
            box-shadow: var(--soft-shadow);
        }
        
        .running-text { 
            margin-top: 30px; 
            font-size: 0.8em; 
        }
        
        /* ====================================================== */
        /* 4. GAYA LOGIN/REGISTRASI (PROFESIONAL & CENTERED) */
        /* ====================================================== */
        .login-page, .registration-page { 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; /* Posisi di tengah layar */
            /* Tambahkan agar terlihat saat transisi fade-in/out */
            opacity: 1;
        }
        .login-card {
            background-color: var(--card-bg); 
            padding: 30px 40px; /* Padding dan ukuran diperbesar */
            border-radius: 18px; 
            width: 350px; /* Ukuran container login diperbesar */
            max-width: 90%; 
            box-shadow: var(--soft-shadow);
            text-align: center;
        }
        .login-card h1 {
            font-size: 1.8em; /* Font header diperbesar */
            margin-bottom: 20px;
            color: var(--neon-color-header);
        }
        .login-input { 
            width: 100%;
            padding: 12px 15px; 
            margin-bottom: 15px;
            border-radius: 10px;
            border: none;
            box-shadow: var(--inset-shadow); /* Input dengan efek neumorphism inset */
            background-color: var(--bg-main);
            color: var(--text-main);
            font-size: 1.0em; 
            box-sizing: border-box;
            transition: box-shadow 0.3s;
        }
        .login-input:focus {
             outline: none;
             box-shadow: inset 1px 1px 3px var(--shadow-dark), inset -1px -1px 3px var(--shadow-light), 0 0 5px rgba(0, 168, 120, 0.5);
        }
        .login-button { 
            padding: 12px; 
            font-size: 1.0em; 
            margin-top: 15px; 
        }

        /* ====================================================== */
        /* 5. GAYA HALAMAN PEMBAYARAN (STEP 1, 2, 3, 4, 5) */
        /* ====================================================== */
        
        .payment-page, .my-profile-page, .notification-page, .invoice-page, .report-page { 
            padding-top: 15px; 
        }
        .section-title {
            font-size: 1.2em; 
        }
        .payment-card, .profile-card, .warga-card {
            background-color: var(--card-bg);
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: var(--soft-shadow);
            margin-bottom: 20px;
        }
        
        /* Input Nominal */
        .payment-input-group label {
            font-size: 0.9em; 
        }
        .payment-input { 
            width: 100%;
            padding: 10px; 
            font-size: 1.1em; 
            box-sizing: border-box; 
        }

        /* --- TOMBOL LANJUT PEMBAYARAN 3D (STEP 1) --- */
        .continue-button {
            padding: 14px 25px;
            font-size: 1.0em;
            margin-top: 25px; 
            border: none;
            border-radius: 10px;
            font-weight: 700;
            color: var(--button-text);
            background-color: var(--button-main);
            box-shadow: 0 5px 0 var(--button-shadow); /* Efek 3D */
            transition: all 0.1s ease-in-out;
            cursor: pointer;
            width: 100%;
        }

        .continue-button:active:not(:disabled) {
            transform: translateY(5px);
            box-shadow: 0 0 0 var(--button-shadow);
        }

        .continue-button:hover:not(:disabled) {
            background-color: var(--button-hover);
        }

        .continue-button:disabled {
            background-color: #bdc3c7;
            box-shadow: 0 5px 0 #95a5a6;
            cursor: not-allowed;
            color: #7f8c8d;
        }
        
        .user-info p { 
            font-size: 0.85em; 
        }
        
        /* --- BLOK PERINGATAN --- */
        .tunggakan-container {
            margin-top: 15px;
        }

        .tunggakan-info {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85em; 
            font-weight: 500;
            line-height: 1.4;
        }

        /* Gaya Khusus untuk Tunggakan */
        .tunggakan-warning-style { 
            background-color: var(--warning-bg-light); 
            color: var(--warning-text-light); 
            border: 1px solid var(--warning-text-light);
        }
        body.dark-mode .tunggakan-warning-style {
            background-color: var(--warning-bg-dark); 
            color: var(--warning-text-dark); 
            border: 1px solid var(--warning-text-dark);
        }
        
        /* Gaya Khusus untuk Lunas */
        .tunggakan-lunas-style { 
            background-color: var(--success-bg-light); 
            color: var(--success-text-light); 
            border: 1px solid var(--success-text-light);
        }
        body.dark-mode .tunggakan-lunas-style { 
            background-color: var(--success-bg-dark); 
            color: var(--success-text-dark); 
            border: 1px solid var(--success-text-dark);
        }

        /* --- TABEL RINCIAN (Payment & Profile) --- */
        .payment-detail-table, .profile-detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85em;
        }
        .payment-detail-table th, .payment-detail-table td, 
        .profile-detail-table th, .profile-detail-table td {
            padding: 8px 0;
            text-align: left;
            border-bottom: 1px dotted rgba(150, 150, 150, 0.1);
        }
        .payment-detail-table th, .profile-detail-table th {
            font-weight: 500;
            width: 65%; 
        }
        .payment-detail-table td, .profile-detail-table td {
            text-align: right;
            font-weight: 600;
        }
        .table-row-total th, .payment-detail-table .table-row-total td, 
        .profile-detail-table .table-row-total th, .profile-detail-table .table-row-total td { 
            border-top: 2px solid var(--neon-color-header);
            border-bottom: none;
            font-size: 1.0em;
            font-weight: 700 !important;
            color: var(--neon-color-header);
            padding-top: 10px;
        }
        
        /* --- TABEL RIWAYAT BULANAN DI DATA SAYA & LAPORAN --- */
        .payment-history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.8em;
            text-align: center;
        }
        .payment-history-table th, .payment-history-table td {
            padding: 8px 5px;
            border: 1px solid rgba(150, 150, 150, 0.1);
        }
        .payment-history-table th {
            background-color: var(--bg-main);
            font-weight: 600;
            color: var(--neon-color-header);
            border-top: 2px solid var(--neon-color-header);
        }
        .payment-history-table td.status-paid {
            color: var(--success-text-light);
            font-weight: 700;
        }
        .payment-history-table td.status-unpaid {
            color: var(--warning-text-light);
            font-weight: 700;
        }
         body.dark-mode .payment-history-table td.status-paid {
            color: var(--success-text-dark);
        }
        body.dark-mode .payment-history-table td.status-unpaid {
            color: var(--warning-text-dark);
        }
        
        /* --- GRID 2x2 TOMBOL --- */
        .method-selection {
            display: grid;
            gap: 15px;
            margin-top: 15px;
            grid-template-columns: repeat(2, 1fr); 
        }
        @media (max-width: 600px) {
            .method-selection {
                grid-template-columns: 1fr; 
            }
        }
        
        .method-item {
            /* Perubahan: Tambahkan cursor pointer agar terasa bisa diklik */
            cursor: pointer; 
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            min-height: 80px; 
            padding: 15px; 
            border-radius: 12px; 
            background-color: var(--bg-main); 
            font-weight: 600;
            box-shadow: var(--soft-shadow);
            /* Transisi lebih halus */
            transition: all 0.3s ease-in-out; 
            text-align: center;
            font-size: 0.9em;
        }
        /* Perubahan: Styling active/click untuk semua metode */
        .method-item:active { 
            box-shadow: var(--inset-shadow); 
            transform: scale(0.95); 
        }
        .method-item.selected { 
            box-shadow: var(--inset-shadow); 
            border: 2px solid var(--neon-color-header); 
            transform: scale(0.98); 
            background-color: var(--card-bg);
        }
        .method-item span:first-child {
            font-size: 2.0em; 
            margin-bottom: 5px;
        }

        /* --- TOMBOL STEP 3 & 4 (PROFESIONAL & ELEGAN) --- */
        .pro-button {
            padding: 12px 20px;
            font-size: 0.95em;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            color: white;
            transition: all 0.2s;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px; /* Jarak antar tombol */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .transfer-details {
            background-color: var(--bg-main);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--inset-shadow);
            margin-top: 15px;
        }
        .transfer-details p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        .account-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--card-bg);
            padding: 8px 10px;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 10px;
        }
        .copy-button {
            background-color: var(--copy-button);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 3px 0 var(--copy-shadow);
            transition: all 0.1s;
            font-size: 0.8em;
        }
        .copy-button:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 var(--copy-shadow);
        }

        /* Tombol Unduh QR (Biru) */
        #downloadQRButton {
            background-color: var(--download-button);
            box-shadow: 0 4px 0 var(--download-shadow);
        }
        #downloadQRButton:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 var(--download-shadow);
        }

        /* Tombol Konfirmasi WA (Hijau WA) */
        #confirmWAButton, #confirmTransferWAButton, #confirmEwalletCash { /* Ditambah #confirmEwalletCash */
            background-color: #25D366;
            box-shadow: 0 4px 0 #1eac53;
            color: #1e1e1e; 
        }
        body.dark-mode #confirmWAButton, body.dark-mode #confirmTransferWAButton, body.dark-mode #confirmEwalletCash {
             color: white; 
        }
        #confirmWAButton:active, #confirmTransferWAButton:active, #confirmEwalletCash:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #1eac53;
        }
        
        /* GAYA KHUSUS GAMBAR QRIS */
        .qris-image {
            width: 80%; 
            max-width: 300px; 
            height: auto;
            border-radius: 10px;
            box-shadow: var(--soft-shadow);
            border: 5px solid var(--card-bg); 
        }


        /* ====================================================== */
        /* 6. FAB (Floating Action Button) - TOMBOL KEMBALI */
        /* ====================================================== */
        .fab-back-button {
            position: fixed;
            bottom: 30px; 
            right: 30px; 
            z-index: 1000;
            width: 45px; 
            height: 45px;
            padding: 0;
            border-radius: 50%;
            background-color: var(--neon-color-header); 
            color: white; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); 
            border: none;
            font-size: 1.5em; 
            line-height: 45px;
            text-align: center;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        .fab-back-button:hover {
            background-color: #008f65; 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5); 
            transform: scale(1.05);
        }
        
        /* ====================================================== */
        /* 7. GAYA HALAMAN DATA WARGA BARU */
        /* ====================================================== */
        .data-warga-page {
            padding-top: 15px;
        }
        .warga-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--soft-shadow);
            margin-bottom: 20px;
        }
        .warga-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85em;
        }
        .warga-table th, .warga-table td {
            padding: 10px 5px;
            text-align: center;
            border-bottom: 1px solid rgba(150, 150, 150, 0.15);
        }
        .warga-table th {
            font-weight: 700;
            background-color: var(--bg-main);
            color: var(--neon-color-header);
            border-top: 2px solid var(--neon-color-header);
        }
        .warga-table tbody tr:nth-child(even) {
            background-color: var(--bg-main);
        }
        .warga-table td {
             font-weight: 500;
        }
        .warga-table .name-col {
             text-align: left;
             font-weight: 600;
        }
        .warga-table .status-ok {
            color: var(--success-text-light);
            font-weight: 700;
        }
        body.dark-mode .warga-table .status-ok {
            color: var(--success-text-dark);
        }
        .warga-table .status-warning {
            color: var(--warning-text-light);
            font-weight: 700;
        }
        body.dark-mode .warga-table .status-warning {
            color: var(--warning-text-dark);
        }

        .toggle-button-container {
            text-align: center;
            margin-top: 15px;
        }
        .toggle-table-button {
             background-color: var(--card-bg); 
             color: var(--text-main);
             padding: 10px 20px;
             border: none;
             border-radius: 20px;
             box-shadow: var(--soft-shadow);
             font-weight: 600;
             cursor: pointer;
             transition: all 0.3s;
        }
        .toggle-table-button:active {
            box-shadow: var(--inset-shadow); 
            transform: scale(0.98);
        }

        @media (max-width: 600px) {
            .warga-table th, .warga-table td {
                padding: 8px 3px;
                font-size: 0.75em;
            }
        }
        
        /* GAYA KHUSUS KARTU PROFIL (Tegak) */
        .profile-info-card {
            display: flex;
            align-items: center;
            gap: 20px;
            background-color: var(--bg-main);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--inset-shadow);
            margin-bottom: 20px;
            border-left: 5px solid var(--neon-color-header);
        }
        .profile-icon {
            font-size: 3em;
            color: var(--neon-color-header);
        }
        .profile-details p {
            margin: 0 0 5px 0;
            line-height: 1.3;
        }
        .profile-details strong {
            font-weight: 700;
        }
        .status-badge {
            display: inline-block;
            background-color: var(--status-active-bg);
            color: var(--status-active-text);
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 10px;
        }
        /* ====================================================== */
        /* 8. GAYA LOADING PAGE (SPLASH SCREEN) */
        /* ====================================================== */
        #loadingPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--loading-bg);
            color: var(--loading-text);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-in-out;
            text-align: center;
        }
        
        #loadingPage.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .wallet-icon {
            font-size: 5em;
            margin-bottom: 15px;
            animation: bounce 0.8s infinite alternate;
            color: var(--neon-color-header);
        }

        /* --- PERBAIKAN CSS LOADING TEXT CONTAINER --- */
        .loading-text-container {
            overflow: hidden;
            /* Hapus atau atur tinggi ke 'auto' agar teks penuh muncul */
            height: auto; 
        }
        /* ------------------------------------------ */

        .loading-text {
            font-size: 1.5em;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--text-main);
            /* Animasi teks dari dalam keluar */
            animation: text-reveal 1.5s ease-out forwards;
        }
        
        /* ====================================================== */
        /* 9. PERBAIKAN RUNNING TEXT */
        /* ====================================================== */
        .running-text marquee {
            /* Pastikan marquee tidak berhenti saat tidak aktif */
            display: block;
            width: 100%;
        }
 

    </style>
</head>
<body class="dark-mode">
<button id="fabBackAdminButton" class="fab back-button" onclick="handleFabClick()">
    <i class="fas fa-arrow-left"></i>
</button>
<div id="adminPage" class="page" style="display: none; opacity: 0;">
    <h2 class="section-title">üëë Kontrol Admin</h2>
    
    <button class="action-button" onclick="addNewWargaFromAdmin()" style="background-color: var(--ok-button); margin-bottom: 15px;">
        ‚ûï Tambah Warga Baru
    </button>
    
    <div id="adminTableWrapper" class="profile-card" style="padding: 15px;">
        <h3>Daftar & Edit Data Warga</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nama</th>
                        <th>Blok</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="adminWargaTableBody">
                    </tbody>
            </table>
        </div>
    </div>
    
    </div>

<button id="fabBackAdminButton" class="fab-back-button" onclick="handleFabClick()" style="display: none;">
    &larr; Kembali
</button>
<div id="modalEditUser" class="modal" onclick="if(event.target === this) hideEditUserModal()" style="display: none; opacity: 0;">
    <div class="modal-content">
        <span class="close-button" onclick="hideEditUserModal()">&times;</span>
        <h3 id="modalEditUserTitle">Edit Data Warga</h3>
<div style="margin-top: 25px; text-align: center;">
    <button class="action-button" onclick="showEditReportModal()" style="background-color: #f39c12; color: white; box-shadow: 0 3px 0 #d35400; font-size: 0.9em; padding: 10px 15px;">
        ‚úçÔ∏è Edit Konten Halaman Laporan
    </button>
</div>
 

        
        <form onsubmit="event.preventDefault(); saveEditedUser()">
            <input type="hidden" id="editUserId">
            
            <fieldset>
                <legend>Data Dasar & Iuran</legend>
                <label for="editUserName">Nama Lengkap:</label>
                <input type="text" id="editUserName" required>
                
                <label for="editUserBlock">Blok/Nomor:</label>
                <input type="text" id="editUserBlock" required>
                
                <label for="editUserRate">Rate Iuran (Rp):</label>
                <input type="number" id="editUserRate" required>
            </fieldset>

            <fieldset style="margin-top: 15px;">
                <legend>Status Pembayaran (TAHUNAN)</legend>
                <label for="editArrears2025">Tunggakan (Bulan - Tahun 2025):</label>
                <input type="number" id="editArrears2025" min="0" required>
                
                <label for="editPaid2026">Bulan Lunas (Bulan - Tahun 2026):</label>
                <input type="number" id="editPaid2026" min="0" max="12" required>
            </fieldset>
            
            <fieldset style="margin-top: 15px;">
                <legend>Data Login</legend>
                <label for="editUserUsername">Username:</label>
                <input type="text" id="editUserUsername" required>
                
                <label for="editUserPassword">Password:</label>
                <input type="text" id="editUserPassword" required>
            </fieldset>
            
            <button type="submit" class="action-button" style="background-color: var(--ok-button); margin-top: 15px;">
                üíæ Simpan Perubahan
            </button>
        </form>
    </div>
</div>



<div id="modalAdminInvoice" class="modal" onclick="if(event.target === this) hideAdminInvoiceModal()" style="display: none; opacity: 0;">
    <div class="modal-content" style="max-width: 90%; width: 800px;">
        <span class="close-button" onclick="hideAdminInvoiceModal()">&times;</span>
        <h3>üìÑ Kelola Semua Invoice Warga</h3>
        
        <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
            <div class="table-container">
                 <table>
                    <thead>
                        <tr>
                            <th>ID Invoice</th>
                            <th>Warga</th>
                            <th>Tanggal</th>
                            <th>Total</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="adminInvoiceListBody">
                        </tbody>
                </table>
            </div>
        </div>
        
        <hr>
        
        <h4>‚ûï Tambah Invoice Manual</h4>
        <form id="addInvoiceForm" onsubmit="event.preventDefault(); addAdminInvoiceManual(document.getElementById('addInvoiceID').value, document.getElementById('addInvoiceUserID').value, document.getElementById('addInvoiceTotal').value, document.getElementById('addInvoiceMethod').value, document.getElementById('addInvoiceAllocation').value)">
            <label for="addInvoiceID">ID Invoice (Contoh: INV-999):</label>
            <input type="text" id="addInvoiceID" required>
            
            <label for="addInvoiceUserID">ID Warga (Angka):</label>
            <input type="number" id="addInvoiceUserID" min="1" required>
            
            <label for="addInvoiceTotal">Total Pembayaran (Rp):</label>
            <input type="number" id="addInvoiceTotal" min="1" required>
            
            <label for="addInvoiceMethod">Metode Pembayaran:</label>
            <input type="text" id="addInvoiceMethod" required>

            <label for="addInvoiceAllocation">Alokasi (Contoh: Lunas 2025):</label>
            <input type="text" id="addInvoiceAllocation" required>
            
            <button type="submit" class="action-button" style="background-color: var(--ok-button); margin-top: 15px;">
                ‚úÖ Tambahkan Invoice
            </button>
            <p style="font-size: 0.8em; color: #f39c12; margin-top: 10px;">*PENTING: Setelah menambah invoice, Anda harus mengedit status tunggakan warga secara manual di menu "Edit Data Warga".</p>
        </form>
    </div>
</div>


<div id="modalEditUser" class="modal" style="display: none;">
    <div class="modal-content">
        <h3 id="modalEditUserTitle">Edit Data Warga</h3>
        <span class="close-button" onclick="hideEditUserModal()">&times;</span>

        <form onsubmit="event.preventDefault(); saveEditedUser();">
            <input type="hidden" id="editUserId">

            <label for="editUserName">Nama Lengkap</label>
            <input type="text" id="editUserName" required>

            <label for="editUserBlock">Blok/Nomor</label>
            <input type="text" id="editUserBlock" required>
            
            <label for="editUserRate">Iuran Bulanan (Rp)</label>
            <input type="number" id="editUserRate" required>

            <label for="editArrears2025">Tunggakan 2025 (Bulan)</label>
            <input type="number" id="editArrears2025" min="0" max="12" required>

            <label for="editPaid2026">Iuran Dibayar 2026 (Bulan)</label>
            <input type="number" id="editPaid2026" min="0" max="12" required>
            
            <label for="editUserUsername">Username Login</label>
            <input type="text" id="editUserUsername" required>

            <label for="editUserPassword">Password Login</label>
            <input type="text" id="editUserPassword" required>

            <button type="submit" class="main-button" style="margin-top: 15px;">Simpan Perubahan</button>
        </form>
    </div>
</div>



    <div id="loadingPage">
        <span class="wallet-icon"> üè° </span>
        <div class="loading-text-container">
            <span class="loading-text">Kas Gang Kita</span>
        </div>
        <p style="margin-top: 20px; font-weight: 500; opacity: 0.7;">Memuat Aplikasi...</p>
    </div>


    <div class="main-dashboard" id="mainDashboard" style="display: none; opacity: 0;">
        <div class="container">
            <div class="top-controls">
                <div class="dashboard-header">
                    <span class="welcome-user" id="welcomeUserText">Selamat Datang, Rohman! üëã</span>
                    <p>Aplikasi Pembayaran Kas Gang E21-25</p>
 
              
                </div>
                <div class="right-actions">
                    <button class="action-button" id="themeToggle" onclick="toggleMode()">üåôMode Gelap</button>
                    <a href="#" class="action-button logout" onclick="showLoginPage()">üö™ Log Out</a>
                </div>
            </div>
            
            <div class="saldo-card">
                <h2>üí∞ Saldo Kas terkini üî•</h2>
                <div class="saldo-amount">Rp 2.290.200</div>
                <p style="opacity: 0.7; font-weight: 500; font-size: 0.7em;">Data per 08 November 2025</p>
            </div>

            <div class="menu-grid">
                </div>
            
            <div class="running-text">
                <marquee behavior="scroll" direction="left" scrollamount="6">
                    üö® &nbsp;&nbsp;&nbsp; Segera lunasi pembayaran kas! &nbsp;&nbsp;&nbsp; Pembayaran kas terdiri dari: Kas Gang, Kas RT, dan BSK (Bantuan Sosial Kematian). &nbsp;&nbsp;&nbsp; Pembayaran di buka per tgl 01 sampai dengan 08 2026 &nbsp;&nbsp;&nbsp; üö®
                </marquee>
            </div>
        </div>
    </div> 
    
    <div class="payment-page" id="paymentPage" style="display: none; opacity: 0;">
        
        <button class="fab-back-button" id="fabBackButton" onclick="handleFabClick()" style="display: none;">
            ‚Üê 
        </button>
        
        <div class="container">
            <h1 class="section-title">üíµ Pembayaran Kas Gang E21-25</h1>
            
            <div class="payment-card" id="paymentStep1">
                <h3 class="section-title" style="margin-top: 0;">1. Rincian Tagihan & Nominal</h3>
                
                <div class="summary-group">
                    <div class="user-info">
                        <p>Nama: <strong><span id="paymentUserName"></span></strong></p>
                        <p>Blok/No: <strong><span id="paymentUserBlock"></span></strong></p>
                        <p>Iuran Bulanan: <strong><span id="paymentUserRate"></span></strong></p>
                    </div>
                    
                    <div class="tunggakan-container">
                        <div class="tunggakan-info" id="tunggakanInfo"></div>
                    </div>
                    
                </div>
                
                <div class="payment-input-group" style="margin-top: 15px;">
                    <label for="nominalInput" class="input-label" style="font-weight: 600; display: block; margin-bottom: 5px;">Masukkan Jumlah Pembayaran (Minimal: <span id="minPaymentText"></span>)</label>
                    <input type="number" id="nominalInput" class="payment-input" 
                        placeholder="Contoh: 50000" oninput="calculatePayment()" required>
                </div>
                
                <table class="payment-detail-table">
                    <thead>
                        <tr>
                            <th colspan="2" style="text-align: center; border-bottom: 2px solid var(--text-main); font-weight: 600; padding-bottom: 10px;">Detail Alokasi Pembayaran</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th>Alokasi Pelunasan Tunggakan 2025:</th>
                            <td id="tunggakanPaid">Rp 0</td>
                        </tr>
                        <tr>
                            <th>Total Bulan Iuran Dibayar:</th>
                            <td id="paidMonths">0 Bulan</td>
                        </tr>
                        <tr>
                            <th>Periode Pembayaran Iuran 2026:</th>
                            <td id="paymentPeriod"> - </td>
                        </tr>
                        <tr class="table-row-total">
                            <th>TOTAL TAGIHAN AKHIR:</th>
                            <td id="totalPayment">Rp 0</td>
                        </tr>
                    </tbody>
                </table>
                
                <button class="continue-button" id="continueButton" onclick="showPaymentPage(2)" disabled>
                    Lanjut ke Metode Pembayaran
                </button>
            </div>
            
            <div class="payment-card" id="paymentStep2" style="display: none;">
                <h3 class="section-title" style="margin-top: 0;">2. Pilih Metode Pembayaran</h3>
                
                <table class="payment-detail-table" style="margin-bottom: 20px;">
                    <tbody>
                        <tr class="table-row-total">
                            <th>Jumlah Tagihan Akhir:</th>
                            <td id="finalTotalDisplay">Rp 0</td>
                        </tr>
                        <tr>
                            <th>Rincian Pembayaran:</th>
                            <td id="finalPaidSummary" style="font-weight: 500;"> - </td>
                        </tr>
                    </tbody>
                </table>

                <p style="margin-top: 5px; font-weight: 500; font-size: 0.9em;">Silakan pilih metode pembayaran yang diinginkan:</p>
                <div class="method-selection" id="methodSelection">
                    <div class="method-item" data-method="transfer" onclick="showPaymentFlow('transfer')">
                        <span>üí≥</span> Transfer Bank
</div>
                    <div class="method-item" data-method="qris" onclick="showPaymentFlow('qris')">
                        <span>&#x23F9;;</span> QRIS
                    </div>

                    <div class="method-item" data-method="cash" onclick="showPaymentFlow('cash')">
                        <span>üíµ</span> Bayar Tunai
                    </div>
                    <div class="method-item" data-method="ewallet" onclick="showPaymentFlow('ewallet')">
                        <span> üî∑ </span> VA DANA
                    </div>
                </div>
                
                </div>
            
            <div class="payment-card" id="paymentStep3" style="display: none;">
                <h3 class="section-title" style="margin-top: 0;">3. Pembayaran via QRIS</h3>
                
                <div class="user-info">
                    <p>Nama Warga: <strong><span id="qrUserName"></span></strong></p>
                    <p>Blok/No Rumah: <strong><span id="qrUserBlock"></span></strong></p>
                </div>

                <table class="payment-detail-table" style="margin-bottom: 20px;">
                    <tbody>
                        <tr class="table-row-total">
                            <th>TOTAL YANG AKAN DIBAYAR:</th>
                            <td id="qrTotalDisplay">Rp 0</td>
                        </tr>
                        <tr>
                            <th>Rincian Pembayaran:</th>
                            <td id="qrPaidSummary" style="font-weight: 500;"> - </td>
                        </tr>
                    </tbody>
                </table>
                
                <div style="text-align: center; margin: 30px 0;">
                    <img src="qrcode.jpg" alt="QRIS Standard Pembayaran Nasional" class="qris-image" id="qrisImageDisplay">
                    <p style="margin-top: 15px; font-weight: 600; color: var(--text-main); font-size: 0.9em;">SCAN QRIS DI ATAS UNTUK MELAKUKAN PEMBAYARAN</p>
                </div>
                
                <button class="pro-button" id="downloadQRButton" onclick="downloadQR()">
                    ‚¨áÔ∏è Unduh Gambar QR (Wajib)
                </button>
                
                <p style="text-align: center; margin-top: 15px; margin-bottom: 15px; font-size: 0.75em; color: var(--running-text-bg);">
                    Penting: Lampirkan bukti pembayaran ke Admin untuk verifikasi cepat.
                </p>

                <button class="pro-button" id="confirmWAButton" onclick="simulatePaymentConfirmation('QRIS')">
                    <span style="font-size: 1.1em; vertical-align: middle;">üì®</span> Upload Bukti & Konfirmasi 
                </button>
            </div>
            
            <div class="payment-card" id="paymentStep4" style="display: none;">
                <h3 class="section-title" style="margin-top: 0;">4. Pembayaran via Transfer Bank</h3>
                
                <div class="user-info">
                    <p>Nama Warga: <strong><span id="transferUserName"></span></strong></p>
                    <p>Blok/No Rumah: <strong><span id="transferUserBlock"></span></strong></p>
                </div>

                <table class="payment-detail-table" style="margin-bottom: 20px;">
                    <tbody>
                        <tr class="table-row-total">
                            <th>TOTAL YANG HARUS DITRANSFER:</th>
                            <td id="transferTotalDisplay">Rp 0</td>
                        </tr>
                        <tr>
                            <th>Rincian Pembayaran:</th>
                            <td id="transferPaidSummary" style="font-weight: 500;"> - </td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="transfer-details">
                    <p style="font-weight: 700;">TRANSFER KE REKENING KAS GANG:</p>
                    <p>Bank: üè¶ BCA</p>
                    <p>Atas Nama: Candra Purbaya </p>
                    <div class="account-line">
                        <span id="accountNumberDisplay">8730508591</span>
                        <button class="copy-button" onclick="copyText('8730508591')">
                            üìã Salin
                        </button>
                    </div>
                </div>
                
                <p style="text-align: center; margin-top: 25px; margin-bottom: 15px; font-size: 0.75em; color: var(--running-text-bg);">
                    Setelah transfer, mohon konfirmasi ke Admin dengan melampirkan bukti.
                </p>

                <button class="pro-button" id="confirmTransferWAButton" onclick="simulatePaymentConfirmation('Transfer Bank')">
                    <span style="font-size: 1.1em; vertical-align: middle;">üì®</span> Kirim Bukti Transfer & Konfirmasi 
                </button>
            </div>
            
            <div class="payment-card" id="paymentStep5" style="display: none;">
                <h3 class="section-title" style="margin-top: 0;">5. Konfirmasi Pembayaran <span id="paymentTypeHeader">Tunai/E-Wallet</span></h3>
                
                <div class="user-info">
                    <p>Nama Warga: <strong><span id="otherUserName"></span></strong></p>
                    <p>Blok/No Rumah: <strong><span id="otherUserBlock"></span></strong></p>
                </div>

                <table class="payment-detail-table" style="margin-bottom: 20px;">
                    <tbody>
                        <tr class="table-row-total">
                            <th>TOTAL YANG DIBAYAR:</th>
                            <td id="otherTotalDisplay">Rp 0</td>
                        </tr>
                        <tr>
                            <th>Rincian Pembayaran:</th>
                            <td id="otherPaidSummary" style="font-weight: 500;"> - </td>
                        </tr>
                    </tbody>
                </table>

                <p style="font-weight: 500;">Instruksi Pembayaran:</p>
                <div class="transfer-details">
                    <p id="otherInstructionText" style="font-weight: 400; line-height: 1.5;">
                        Silakan siapkan pembayaran Anda dan hubungi Bendahara Kas untuk penyerahan dana secara langsung.
                    </p>
                     <div id="danaDetails" style="display: none; margin-top: 15px;">
                         <p>E-Wallet: üî∑ DANA</p>
                         <p>Atas Nama: Candra Purbaya</p>
                         <div class="account-line">
                            <span id="danaNumberDisplay">08111435512</span>
                            <button class="copy-button" onclick="copyText('08111435512')">
                                üìã Salin
                            </button>
                        </div>
                    </div>
                </div>
                
                <p style="text-align: center; margin-top: 25px; margin-bottom: 15px; font-size: 0.75em; color: var(--running-text-bg);">
                    Klik tombol di bawah setelah pembayaran diserahkan.
                </p>
                
                <button class="pro-button" id="confirmEwalletCash" onclick="simulatePaymentConfirmation(document.getElementById('paymentTypeHeader').textContent)">
                    <span style="font-size: 1.1em; vertical-align: middle;"> üì®</span> komfirmasi & Kirim bukti pembayaran
                </button>
            </div>
            
        </div>
    </div>
    
<div class="my-profile-page" id="myProfilePage" style="display: none; opacity: 0;">
    <button class="fab-back-button" id="fabBackProfileButton" onclick="hideMyProfilePage()">
        ‚Üê
    </button>
    <div class="container">
        <h1 class="section-title">üë§ Data Riwayat Pembayaran Saya</h1>

        <div class="profile-card">
            <div class="profile-info-card" id="myProfileCard">
                <span class="profile-icon">üè°</span>
                <div class="profile-details">
                    <p style="font-size: 1.2em; font-weight: 700;">
                        <span id="profileUserName"></span>
                        <span class="status-badge">Aktif</span>
                    </p>
                    <p style="font-size: 0.9em;">Blok/No: <strong><span id="profileUserBlock"></span></strong></p>
                    <p style="font-size: 0.8em; opacity: 0.8;">Iuran Bulanan: <strong><span id="profileUserRate"></span></strong></p>
                </div>
            </div>

            <h3 style="font-size: 1.0em; margin-top: 25px; border-bottom: 1px solid var(--text-main); padding-bottom: 5px;">
                Rincian Pembayaran Kas Periode <span id="year2025Display"></span>
            </h3>
            <h4 style="font-size: 0.8em; margin-top: 0; border-bottom: 1px solid var(--text-main); padding-bottom: 5px;">
                *Agustus 2025 Status: 
                <strong style="color: #00A878;">Gratis (Free)</strong> 
                dan tidak dihitung dalam total tunggakan.
            </h4>
            
            <button id="toggle2025Button" 
                    onclick="togglePaymentHistory(2025)" 
                    class="action-button toggle-button" 
                    style="width: 100%; margin-top: 10px; margin-bottom: 10px; display: none;">
                </button>

            <table class="payment-history-table" id="paymentHistoryTable2025">
                <thead>
                    <tr>
                        <th>Bulan</th>
                        <th>Status Pembayaran</th>
                    </tr>
                </thead>
                <tbody id="paymentHistoryBody2025">
                    </tbody>
            </table>

            <h3 style="font-size: 1.0em; margin-top: 25px; border-bottom: 1px solid var(--text-main); padding-bottom: 5px;">
                Rincian Pembayaran Kas Periode <span id="year2026Display"></span>
            </h3>
            
            <button id="toggle2026Button" 
                    onclick="togglePaymentHistory(2026)" 
                    class="action-button toggle-button" 
                    style="width: 100%; margin-top: 10px; margin-bottom: 10px; display: none;">
                </button>

            <table class="payment-history-table" id="paymentHistoryTable2026">
                <thead>
                    <tr>
                        <th>Bulan</th>
                        <th>Status Pembayaran</th>
                    </tr>
                </thead>
                <tbody id="paymentHistoryBody2026">
                    </tbody>
            </table>

            <h3 style="font-size: 1.0em; margin-top: 25px; border-bottom: 1px solid var(--text-main); padding-bottom: 5px;">Ringkasan Total Tagihan</h3>
            <table class="profile-detail-table">
                <tbody>
                    <tr>
                        <th>Total Tunggakan <span id="summaryYear2025"></span>:</th>
                        <td id="profileArrearsTotal">Rp 0</td>
                    </tr>
                    <tr>
                        <th>Sisa Pembayaran <span id="summaryYear2026"></span>:</th>
                        <td id="profileUnpaid2026Total">Rp 0</td>
                    </tr>
                    <tr class="table-row-total">
                        <th>Subtotal Tagihan Total:</th>
                        <td id="profileSubtotalTotal">Rp 0</td>
                    </tr>
                </tbody>
            </table>

            <button class="continue-button" style="margin-top: 30px;" onclick="showPaymentPage(1)">
                Bayar Sekarang
            </button>
        </div>
    </div>
</div>



    <div class="my-profile-page" id="notificationPage" style="display: none; opacity: 0;">
        <button class="fab-back-button" id="fabBackNotifButton" onclick="handleFabClick()">
            ‚Üê 
        </button>
        <div class="container">
            <h1 class="section-title">üîî Riwayat Notifikasi</h1>
            
            <div class="profile-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px;">
                    <p style="font-size: 0.85em; opacity: 0.8; margin: 0;">Daftar aktivitas pembayaran warga. (Maksimal 20 terbaru)</p>
                    <button class="action-button" onclick="clearNotifications()" style="font-size: 0.75em; padding: 5px 10px; box-shadow: 0 3px 0 var(--delete-shadow); background-color: var(--delete-button); color: white;">
                        üóëÔ∏è Hapus Semua
                    </button>
                 </div>
                 
                 <div id="notificationsList">
                    </div>
                 
            </div>
        </div>
    </div>


    <div class="data-warga-page" id="dataWargaPage" style="display: none; opacity: 0;">
        <button class="fab-back-button" id="fabBackWargaButton" onclick="hideDataWargaPage()" style="display: none;">
            ‚Üê 
        </button>
        <div class="container">
            <h1 class="section-title">üèò Data Kas Gang E21-25 preode 2025-2026   </h1>
            
            <div class="warga-card">
                <p style="font-size: 0.85em; opacity: 0.8;"> Tunggakan 2025 wajib di lunasi dulu. bagi yan mempunyai tunggakan maka, pembayar 2026 akan di alokasikan untuk tunggakan 2025 </p>
                
                <table class="warga-table">
                    <thead>
                        <tr>
                            <th class="name-col" style="width: 40%;">Nama Warga</th>
                            <th style="width: 20%;">Blok/No</th>
                            <th style="width: 20%;">Tunggakan 2025</th>
                            <th style="width: 20%;">Iuran 2026</th>
                        </tr>
                    </thead>
                    <tbody id="wargaTableBody">
                        </tbody>
                </table>
                
                <div class="toggle-button-container">
                    <button class="toggle-table-button" id="toggleWargaButton" onclick="toggleWargaTable()">
                        Tampilkan 10 Data Warga Lainnya
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="my-profile-page" id="invoicePage" style="display: none; opacity: 0;">
        <button class="fab-back-button" id="fabBackInvoiceButton" onclick="handleFabClick()">
            ‚Üê 
        </button>
        <div class="container">
            <h1 class="section-title">üìÑ Daftar Invoice Pembayaran</h1>
            
            <div id="invoiceListWrapper">
                <p style="font-size: 0.85em; opacity: 0.8; margin-bottom: 15px;">Klik invoice untuk melihat detail. Invoice tersimpan otomatis.</p>
                <div id="invoiceListContainer">
                    </div>
            </div>
            
            <div id="singleInvoiceDisplay" class="profile-card" style="display: none;">
                 <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div class="user-info" >
                         <p style="font-size: 1.1em;">Invoice ID: <strong><span id="invoiceID"></span></strong></p>
                         <p style="font-size: 1.1em;">Tgl. Transaksi: <strong><span id="invoiceDate"></span></strong></p>
                    </div>
                    <button id="deleteInvoiceButton" class="action-button" style="background-color: var(--delete-button); color: white; box-shadow: 0 3px 0 var(--delete-shadow); font-size: 0.75em;" onclick="deleteSingleInvoice(selectedInvoice.invoiceID)">
                        üóëÔ∏è Hapus Invoice
                    </button>
                 </div>
                
                <h3 style="font-size: 1.0em; margin-top: 0; border-bottom: 1px solid var(--text-main); padding-bottom: 5px;">Rincian Pembayaran</h3>

                <table class="payment-detail-table">
                    <tbody>
                        <tr>
                            <th>Warga / Blok No:</th>
                            <td id="invoiceUserNameBlock"></td>
                        </tr>
                        <tr>
                            <th>Metode Pembayaran:</th>
                            <td id="invoiceMethod"></td>
                        </tr>
                        <tr>
                            <th>Alokasi Pembayaran:</th>
                            <td id="invoiceAllocation"></td>
                        </tr>
                         <tr class="table-row-total">
                            <th>TOTAL DIBAYAR:</th>
                            <td id="invoiceTotal"></td>
                        </tr>
                    </tbody>
                </table>

                <p style="font-size: 0.8em; opacity: 0.8; margin-top: 20px; text-align: center;">
                    *Ini adalah bukti sah pembayaran Kas Gang E21-25. Simpan sebagai arsip.
                </p>
                
                <div style="margin-top: 40px; text-align: right; padding-right: 20px; font-size: 0.9em;">
                    <p style="margin-bottom: 50px;">Hormat Kami,</p>
                    <p style="border-top: 1px solid var(--text-main); display: inline-block; padding: 0 5px;">
                        Candra Purbaya (Bendahara)
                    </p>
                </div>
            </div>
            </div>
    </div>

    <div class="my-profile-page" id="reportPage" style="display: none; opacity: 0;">
        <button class="fab-back-button" id="fabBackReportButton" onclick="handleFabClick()">
            ‚Üê 
        </button>
        <div class="container">
            <h1 class="section-title">üìä Laporan Keuangan Kas (Des 2025)</h1>
            
            <div class="profile-card">
                 <div id="reportContentDisplay" style="margin-bottom: 25px;">
                     <p style="text-align: center; opacity: 0.7;">Memuat laporan...</p>
                </div>


                <div style="display: flex; justify-content: space-around; gap: 10px; margin-bottom: 25px;">
                    <div style="text-align: center; flex: 1; padding: 15px 5px; border-radius: 12px; box-shadow: var(--inset-shadow); background-color: var(--bg-main);">
                        <h3 style="margin: 0 0 5px; font-size: 0.9em; font-weight: 500; color: var(--neon-color-header);">PEMASUKAN KAS</h3>
                        <strong style="font-size: 1.4em; color: var(--neon-color-header);" id="totalIncome"
                        >Rp 0</strong>
                    </div>
                    <div style="text-align: center; flex: 1; padding: 15px 5px; border-radius: 12px; box-shadow: var(--inset-shadow); background-color: var(--bg-main);">
                        <h3 style="margin: 0 0 5px; font-size: 0.9em; font-weight: 500; color: var(--running-text-bg);">PENGELUARAN KAS</h3>
                        <strong style="font-size: 1.4em; color: var(--running-text-bg);" id="totalExpense"
                        >Rp 0</strong>
                    </div>
                </div>
         
               <h3 style="font-size: 1.0em; margin-top: 0; border-bottom: 1px solid var(--text-main); padding-bottom: 5px;">Rincian Pengeluaran</h3>
                
                <table class="payment-history-table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Tanggal</th>
                            <th style="width: 55%;">Keterangan</th>
                            <th style="width: 20%;">Nominal</th>
                        </tr>
                    </thead>
                    <tbody id="expenseTableBody">
  
  
                        <tr>
                           <td>01/12/25</td>
                            <td style="text-align: left;">.......</td>
                            <td class="status-unpaid">Rp 0</td>
                        </tr>
                        <tr> 
                            <td>05/12/25</td>
                            <td style="text-align: left;">.....</td>
                            <td class="status-unpaid">Rp 00</td>
                        </tr>
                        <tr>
                            <td>07/12/25</td>
                            <td style="text-align: left;">....</td>
                            <td class="status-unpaid">Rp 00</td>
                        </tr>
                        </tbody>
                </table>
                
                 </div>
        </div>
    </div>
<div id="modalEditReport" class="modal" onclick="if(event.target === this) hideEditReportModal()" style="display: none; opacity: 0;">
    <div class="modal-content" style="max-width: 90%; width: 600px;">
        <span class="close-button" onclick="hideEditReportModal()">&times;</span>
        <h3>‚úçÔ∏è Edit Konten Halaman Laporan</h3>
        
        <p style="font-size: 0.85em; opacity: 0.8;">Anda dapat mengedit konten laporan. Gunakan format Markdown sederhana (misalnya, `### Judul` untuk judul bagian, `- Item` untuk daftar).</p>
        
        <form onsubmit="event.preventDefault(); saveEditedReport()">
            <label for="editReportTextarea" style="display: block; margin-bottom: 5px;">Konten Laporan:</label>
            <textarea id="editReportTextarea" rows="15" style="width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid var(--shadow-dark); border-radius: 8px; background-color: var(--input-bg); color: var(--text-color);"></textarea>
            
            <button type="submit" class="action-button" style="background-color: var(--ok-button); margin-top: 15px;">
                üíæ Simpan Konten Laporan
            </button>
        </form>
    </div>
</div>


    <div class="login-page" id="loginPage" style="display: none; opacity: 0;">
        <div class="login-card">
            <h1>LOGIN KAS GANG</h1>
            <form id="loginForm">
                <input type="text" id="usernameInput" class="login-input" placeholder="ID Pengguna" required>
                <input type="password" id="passwordInput" class="login-input" placeholder="Kata Sandi" required>
                <div id="loginMessage" style="margin: 10px 0; font-weight: 500; display: none; font-size: 0.8em;"></div>
                <button type="submit" class="continue-button login-button">Masuk ke Dashboard</button>
                <p style="font-size: 0.8em; margin-top: 15px; opacity: 0.8;">
                    Belum punya akun? <a href="#" onclick="showRegistrationPage()" style="color: var(--neon-color-header); text-decoration: none; font-weight: 600;">Daftar Sekarang</a>
                </p>
            </form>
        </div>
    </div>
    
    <div class="registration-page" id="registrationPage" style="display: none; opacity: 0;">
        <div class="login-card">
            <h1>Registrasi Akun</h1>
            <form id="registrationForm">
                <input type="text" id="regNama" class="login-input" placeholder="Nama Lengkap" required>
                <input type="text" id="regBlokNo" class="login-input" placeholder="Blok/No Rumah (Cth: E21-25)" required>
                <input type="text" id="regIdUser" class="login-input" placeholder="ID Pengguna (Custom)" required>
                <input type="password" id="regPassword" class="login-input" placeholder="Kata Sandi (Min 6 Karakter)" required>
                <p style="margin: 10px 0 15px; font-size: 0.8em; opacity: 0.8;">
                    Registrasi akan dikonfirmasi Admin.
                </p>
                <button type="button" class="pro-button" id="regWaButton" style="background-color: #25D366; box-shadow: 0 4px 0 #1eac53; color: white; margin-top: 0;" onclick="registerViaWhatsApp()">
                    Daftar via WhatsApp (Rekomendasi)
                </button>
                <button type="button" class="continue-button" style="background-color: #95a5a6; box-shadow: 0 5px 0 #7f8c8d; margin-top: 8px;" onclick="backToLogin()">
                    ‚Üê Kembali ke Login
                </button>
            </form>
        </div>
    </div>

<script>
// ======================================================
// 1. DATA WARGA DAN PENGGUNA (GABUNGAN)
// ======================================================

// Variabel Global dan Data User

const MONTHS = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", 
"September", "Oktober", "November", "Desember"];
 
const ADMIN_WA_NUMBER = '6287837644379'; 
const CURRENT_YEAR = 2025; 
const NEXT_YEAR = 2026;   
const TOTAL_MONTHS_YEAR= 11; 

const USERS_STORAGE_KEY = 'kasWargaUsersData'; // Kunci untuk data warga/pembayaran di localStorage
const REPORT_STORAGE_KEY = 'kasWargaReportContent'; // <<< PERBAIKAN: Kunci untuk Konten Laporan

// Data DANA
const DANA_ACCOUNT = {
    number: '08111435512',
    name: 'Candra Purbaya'
};


// Data Awal Warga LENGKAP (50 data, termasuk Admin) - FORMAT BARU
// CATATAN: Perubahan pada data STATIS (name, block, rate, username, password, isAdmin) 
// di array ini AKAN MENIMPA data di localStorage saat inisialisasi.
const initialUsersAndWarga = [
    // BARU: Akun Admin
    { 
    id: 0, 
    name: 'Admin RT', 
    block: 'ADM/00', 
    rate: 0, 
    arrears2025: 0, 
    paid2026: 0, 
    username: 'admin', 
    password: '1111',
    isAccount: true, 
    isAdmin: true, 
    invoices: [] 
    }, 
    
    // --- DATA ANGGOTA SIMULASI ---
            { 
            id: 4, 
            name: 'Novry', 
            block: 'E21-38', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'novry', 
            password: '2138', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 5, 
            name: 'Fathur', 
            block: 'E21-39', 
            rate: 25000, 
            arrears2025: 2, 
            paid2026: 0, 
            username: 'fathur', 
            password: '2139', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 6, 
            name: 'Hanif', 
            block: 'E21-41', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'hanif', 
            password: '2141', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 7, 
            name: 'Eka Adi', 
            block: 'E21-42', 
            rate: 25000, 
            arrears2025: 0, 
            paid2026: 0, 
            username: 'eka adi', 
            password: '2142', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 8, 
            name: 'Larasati', 
            block: 'E21-43', 
            rate: 25000, 
            arrears2025: 2, 
            paid2026: 0, 
            username: 'larasati', 
            password: '2143', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 9, 
            name: 'Rahman', 
            block: 'E21-46', 
            rate: 25000, 
            arrears2025: 0, 
            paid2026: 0, 
            username: 'rahman', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 10, 
            name: 'Rakel', 
            block: 'E21-47', 
            rate: 25000, 
            arrears2025: 0, 
            paid2026: 1, 
            username: 'rakel', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 11, 
            name: 'Hendra', 
            block: 'E21-48', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'hendra', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 12, 
            name: 'Nana Rusmana', 
            block: 'E21-49', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'nana', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 13, 
            name: 'Aji', 
            block: 'E21-50', 
            rate: 25000, 
            arrears2025: 2, 
            paid2026: 0, 
            username: 'aji', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 1, 
            name: 'Rohman', 
            block: 'E21-51', 
           rate: 25000, 
          arrears2025: 0, 
            paid2026: 1, 
            username: 'rohman', 
            password: '2151',
            isAccount: true, 
            invoices: [] 
            },
            
            
            { 
            id: 14, 
            name: 'Darmadi', 
            block: 'E21-52', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'darmadi', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 15, 
            name: 'Viko', 
            block: 'E21-53', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'viko', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 16, 
            name: 'Hendri', 
            block: 'E21-55', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'hendri', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 17, 
            name: 'Riyandi', 
            block: 'E21-56', 
            rate: 25000, 
            arrears2025: 2, 
            paid2026: 0, 
            username: 'riyandi', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 18, 
            name: 'Angga', 
            block: 'E21-60', 
            rate: 25000, 
            arrears2025: 0, 
            paid2026: 0, 
            username: 'angga', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 19, 
            name: 'Iwan', 
            block: 'E21-61', 
            rate: 25000, 
            arrears2025: 2, 
            paid2026: 0, 
            username: 'iwan', 
            password: '123456', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 20, 
            name: 'Mario', 
            block: 'E21-65', 
            rate: 25000, 
            arrears2025: 0, 
            paid2026: 0, 
            username: 'mario', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 21, 
            name: 'Koko', 
            block: 'E21-66', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'koko', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 22, 
            name: 'Rico', 
            block: 'E21-67', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'rico', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 23, 
            name: 'Irwan', 
            block: 'E21-68', 
            rate: 25000, 
            arrears2025: 4, 
            paid2026: 0, 
            username: 'irwan', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 24, 
            name: 'Toro', 
            block: 'E21-69', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'toro', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 25, 
            name: 'Topan', 
            block: 'E21-79', 
            rate: 25000, 
            arrears2025: 3, 
            paid2026: 0, 
            username: 'topan', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 26, 
            name: 'Heri', 
            block: 'E21-71', 
            rate: 25000, 
            arrears2025: 4, 
            paid2026: 0, 
            username: 'heri', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 27, 
            name: 'Bayu Ade', 
            block: 'E21-72', 
            rate: 25000, 
            arrears2025: 6, 
            paid2026: 0, 
            username: 'bayu ade', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 28, 
            name: 'Firly', 
            block: 'E21-73', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'firly', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            
    //        blok E25
            { 
            id: 29, 
            name: 'Krisna', 
            block: 'E25-03', 
            rate: 25000, 
            arrears2025: 8, 
            paid2026: 0, 
            username: 'krisna', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 30, 
            name: 'Deny', 
            block: 'E25-08', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'deny', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 31, 
            name: 'Chandra', 
            block: 'E25-09', 
            rate: 25000, 
            arrears2025: 0, 
            paid2026: 0, 
            username: 'chandra', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 32, 
            name: 'Alfian', 
            block: 'E25-10', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'alfian', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 33, 
            name: 'Tedi', 
            block: 'E25-11', 
            rate: 15000, 
            arrears2025: 0, 
            paid2026: 0, 
            username: 'tedi', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 34, 
            name: 'Deri', 
            block: 'E25-15', 
            rate: 25000, 
            arrears2025: 0, 
            paid2026: 1, 
            username: 'deri', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 35, 
            name: 'Paulus', 
            block: 'E25-18', 
            rate: 25000, 
            arrears2025: 0, 
            paid2026: 0, 
            username: 'paulus', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 36, 
            name: 'Dede Dwi', 
            block: 'E25-19', 
            rate: 25000, 
            arrears2025: 4, 
            paid2026: 0, 
            username: 'dede dwi', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 37, 
            name: 'Anang', 
            block: 'E25-20', 
            rate: 25000, 
            arrears2025: 10, 
            paid2026: 0, 
            username: 'anang', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 38, 
            name: 'Parulian', 
            block: 'E25-21', 
            rate: 25000, 
            arrears2025: 6, 
            paid2026: 0, 
            username: 'parulian', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 39, 
            name: 'Bayu Nur faizin', 
            block: 'E25-22', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'bayu', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 40, 
            name: 'Waluyo', 
            block: 'E25-23', 
            rate: 25000, 
            arrears2025: 10, 
            paid2026: 0, 
            username: 'waluyo', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 41, 
            name: 'Hadi', 
            block: 'E25-27', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'hadi', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 42, 
            name: 'Pakdeh Agung', 
            block: 'E25-28', 
            rate: 25000, 
            arrears2025: 0, 
            paid2026: 0, 
            username: 'pakdeh agung', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 43, 
            name: 'Budi Almawan', 
            block: 'E25-30', 
            rate: 25000, 
            arrears2025: 2, 
            paid2026: 0, 
            username: 'budi almawan', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 44, 
            name: 'Bagus', 
            block: 'E25-31', 
            rate: 25000, 
            arrears2025: 5, 
            paid2026: 0, 
            username: 'bagus', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 45, 
            name: 'Asep', 
            block: 'E25-32', 
            rate: 25000, 
            arrears2025: 0, 
            paid2026: 0, 
            username: 'asep', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 46, 
            name: 'Dede Gunawan', 
            block: 'E25-33', 
            rate: 25000, 
            arrears2025: 1, 
            paid2026: 0, 
            username: 'dede gunawan', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 47, 
            name: 'Kardan', 
            block: 'E25-35', 
            rate: 25000, 
            arrears2025: 2, 
            paid2026: 0, 
            username: 'kardan', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 48, 
            name: 'Rendy', 
            block: 'E25-36', 
            rate: 25000, 
            arrears2025: 0, 
            paid2026: 0, 
            username: 'rendy', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            },
            { 
            id: 49, 
            name: 'Vera', 
            block: 'E25-37', 
            rate: 25000, 
            arrears2025: 0, 
            paid2026: 0, 
            username: 'vera', 
            password: '0000', 
            isAccount: true, 
            invoices: [] 
            }

     // --- DATA ANGGOTA BARU TAMBAHAN (46 Warga) ---
     // (Isi data simulasi Anda di sini jika ada)
];

// Data Warga kini diambil dari localStorage atau diinisialisasi
let allUsersAndWarga = []; 
let allWargaData = []; 

// User yang login 
let currentUser = null; 
let selectedMethod = null;
let finalPaymentSummary = {}; 
let currentStep = 0; 
let isTableExpanded = false; 
let selectedInvoice = null; 
// Variabel baru untuk status toggle
let is2025Expanded = false;
let is2026Expanded = false;


// Variabel Notifikasi Global
const NOTIFICATION_KEY = 'kasWargaNotifications';

// --- GET ELEMENT DOM ---
const body = document.body;
const themeToggle = document.getElementById('themeToggle');
const dashboard = document.getElementById('mainDashboard');
const loginPage = document.getElementById('loginPage');
const registrationPage = document.getElementById('registrationPage');
const paymentPage = document.getElementById('paymentPage');
const dataWargaPage = document.getElementById('dataWargaPage'); 
const myProfilePage = document.getElementById('myProfilePage'); 
const notificationPage = document.getElementById('notificationPage');
const fabBackNotifButton = document.getElementById('fabBackNotifButton'); 
const notificationsList = document.getElementById('notificationsList');
const invoicePage = document.getElementById('invoicePage');
const fabBackInvoiceButton = document.getElementById('fabBackInvoiceButton');
const invoiceListContainer = document.getElementById('invoiceListContainer'); 
const singleInvoiceDisplay = document.getElementById('singleInvoiceDisplay'); 
const invoiceListWrapper = document.getElementById('invoiceListWrapper'); 
const reportPage = document.getElementById('reportPage');
const fabBackReportButton = document.getElementById('fabBackReportButton');
const loadingPage = document.getElementById('loadingPage');

// Elemen Admin Control
const adminPage = document.getElementById('adminPage'); 
const fabBackAdminButton = document.getElementById('fabBackAdminButton');
const adminWargaTableBody = document.getElementById('adminWargaTableBody');
const adminTableWrapper = document.getElementById('adminTableWrapper'); 
const modalEditUser = document.getElementById('modalEditUser');
const modalEditReport = document.getElementById('modalEditReport'); // BARU: Modal Edit Laporan

// BARU: Elemen Admin Invoice Control
const modalAdminInvoice = document.getElementById('modalAdminInvoice');
const adminInvoiceListBody = document.getElementById('adminInvoiceListBody');

// Elemen Form Payment
const nominalInput = document.getElementById('nominalInput');

// ======================================================
// 1.5 FUNGSI DATA STORAGE (LOKAL) & CRUD PERMANEN
// ======================================================

/**
 * Mengambil data pengguna dari localStorage atau menginisialisasi dari initialUsersAndWarga.
 * Melakukan sinkronisasi: Data statis (nama, rate, dll) diperbarui dari kode sumber, 
 * sementara data dinamis (arrears, paid2026, invoices) dipertahankan dari localStorage.
 * * !!! PERUBAHAN: Data Dinamis (arrears2025, paid2026, invoices) kini JUGA di-update dari
 * initialUsersAndWarga untuk memungkinkan editing manual via code.
 */
function getSavedUsersData() {
    const storedData = localStorage.getItem(USERS_STORAGE_KEY);
    let currentData = storedData ? JSON.parse(storedData) : [];
    
    const currentDataMap = new Map(currentData.map(user => [user.id, user]));
    let updatedData = [...currentData]; 

    // Sinkronisasi data awal (dari kode JS) dengan data tersimpan (localStorage)
    initialUsersAndWarga.forEach(initialUser => {
        const storedUser = currentDataMap.get(initialUser.id);
        
        if (!storedUser) {
            // Jika ID belum ada di localStorage, tambahkan data awal lengkap
            updatedData.push(initialUser);
        } else {
            // Update SEMUA info (Statis & Dinamis) dari initialUser untuk menimpa localStorage
            // INI ADALAH PERUBAHAN UTAMA
            Object.assign(storedUser, {
                name: initialUser.name,
                block: initialUser.block,
                rate: initialUser.rate,
                username: initialUser.username,
                password: initialUser.password,
                isAccount: initialUser.isAccount,
                isAdmin: initialUser.isAdmin || false,
                
                // BARIS BARU: DATA DINAMIS KINI DI-UPDATE DARI KODE SUMBER
                arrears2025: initialUser.arrears2025, 
                paid2026: initialUser.paid2026,
                invoices: initialUser.invoices || []
            });
            
            const index = updatedData.findIndex(u => u.id === initialUser.id);
            if (index !== -1) {
                updatedData[index] = storedUser;
            }
        }
    });

    // Filter data yang mungkin dihapus dari initialUsersAndWarga
    const initialIds = new Set(initialUsersAndWarga.map(u => u.id));
    updatedData = updatedData.filter(user => initialIds.has(user.id));

    updatedData.sort((a, b) => a.id - b.id);
    
    saveUsersData(updatedData);
    
    return updatedData;
}
// ... sisa kode tidak berubah


function saveUsersData(users) {
    const dataToSave = users.map(user => ({
        id: user.id,
        name: user.name,
        block: user.block,
        rate: user.rate,
        arrears2025: user.arrears2025,
        paid2026: user.paid2026,
        username: user.username,
        password: user.password,
        isAccount: user.isAccount,
        isAdmin: user.isAdmin || false,
        invoices: user.invoices || [] 
    }));
    localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(dataToSave));
}

function deleteWargaData(userId) {
    if (userId === 0) {
        alert("Tidak dapat menghapus akun Admin utama.");
        return;
    }
    if (!confirm(`Apakah Anda yakin ingin menghapus data warga ID ${userId}? Semua riwayat pembayaran dan login akan hilang.`)) {
        return;
    }

    const initialLength = allUsersAndWarga.length;
    
    allUsersAndWarga = allUsersAndWarga.filter(user => user.id !== userId);
    
    if (allUsersAndWarga.length < initialLength) {
        saveUsersData(allUsersAndWarga); 
        // Filter admin dari data warga untuk tampilan publik
        allWargaData = allUsersAndWarga.filter(u => u.id !== 0); 
        
        alert(`Data warga ID ${userId} berhasil dihapus.`);
        
        if (currentStep === 11) { // Jika di halaman Admin
            renderAdminWargaTable();
        } else if (currentStep === 6) { // Jika di halaman Data Warga
            renderWargaTable();
        }
        
    } else {
        alert(`Gagal menghapus: Warga dengan ID ${userId} tidak ditemukan.`);
    }
}

function addNewWarga(name, block, rate, username, password) {
    if (!name || !block || !rate || !username || !password) {
        alert("Semua kolom (Nama, Blok, Rate, Username, Password) harus diisi.");
        return;
    }

    const maxId = allUsersAndWarga.reduce((max, user) => Math.max(max, user.id), 0);
    const newId = maxId + 1;

    const newWarga = {
        id: newId,
        name: name,
        block: block,
        rate: parseInt(rate), 
        arrears2025: 0, 
        paid2026: 0,    
        username: username.toLowerCase(),
        password: password,
        isAccount: true,
        isAdmin: false,
        invoices: []
    };

    allUsersAndWarga.push(newWarga);
    
    saveUsersData(allUsersAndWarga);
    allWargaData = allUsersAndWarga.filter(u => u.id !== 0); 

    alert(`Warga baru (${name}, ID: ${newId}) berhasil ditambahkan!`);
    
    return newWarga;
}

// ======================================================
// 2. FUNGSI NOTIFIKASI
// ======================================================

function getNotifications() {
    const data = localStorage.getItem(NOTIFICATION_KEY);
    return data ? JSON.parse(data) : [];
}

function saveNotifications(notifications) {
    const limitedNotifications = notifications.slice(0, 50);
    localStorage.setItem(NOTIFICATION_KEY, JSON.stringify(limitedNotifications));
    if (currentUser) { 
        renderMenu(); 
    }
}

function addNotification(type, message, targetUserId = 'all') {
    if (type !== 'payment') {
        return; 
    }
    
    const notifications = getNotifications();
    const newNotif = {
        id: Date.now(),
        type: type, 
        message: message,
        read: false,
        timestamp: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) + ' ' + new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'short' }),
        target: targetUserId 
    };
    notifications.unshift(newNotif); 
    saveNotifications(notifications);
}

function clearNotifications() {
    if (confirm('Apakah Anda yakin ingin menghapus SEMUA notifikasi yang relevan dengan akun Anda? Tindakan ini tidak dapat dibatalkan.')) {
        
        const notifications = getNotifications().filter(n => 
            n.target !== 'all' && n.target !== currentUser.id
        );
        
        saveNotifications(notifications); 
        
        renderNotifications(); 
        renderMenu(); 
    }
}

function markNotificationsAsRead() {
    const notifications = getNotifications();
    let changed = false;
    
    notifications.forEach(n => {
        if (!n.read && (n.target === 'all' || n.target === currentUser.id)) {
            n.read = true;
            changed = true;
        }
    });
    
    if (changed) {
        saveNotifications(notifications);
    }
}

function renderNotifications() {
    const notifications = getNotifications();
    let html = '';
    
    const relevantNotifs = notifications.filter(n => 
        (n.target === 'all' || n.target === currentUser.id) && n.type === 'payment'
    );

    if (relevantNotifs.length === 0) {
        html = `<p style="text-align: center; margin: 30px 0; opacity: 0.6;">Tidak ada riwayat notifikasi pembayaran saat ini.</p>`;
    } else {
        relevantNotifs.slice(0, 20).forEach(n => { 
            const icon = n.type === 'payment' ? 'üí∏' : 'üí°'; 
            const color = n.type === 'payment' ? 'var(--neon-color-header)' : '#3498db';
            const readStyle = n.read ? 
                              'opacity: 0.7; background-color: transparent;' : 
                              `font-weight: 600; background-color: var(--card-bg); box-shadow: var(--soft-shadow);`;


            html += `
                <div style="padding: 10px; border-bottom: 1px dotted var(--shadow-dark); margin-bottom: 8px; font-size: 0.9em; display: flex; align-items: flex-start; gap: 10px; border-radius: 8px; ${readStyle}">
                    <span style="font-size: 1.2em; color: ${color};">${icon}</span>
                    <div style="flex-grow: 1;">
                        <p style="margin: 0; line-height: 1.4; font-weight: inherit;">${n.message}</p>
                        <p style="margin: 3px 0 0; font-size: 0.75em; opacity: 0.7; font-weight: 500;">${n.timestamp}</p>
                    </div>
                </div>
            `;
        });
    }
    notificationsList.innerHTML = html;
}

function showNotificationsPage() {
    if (!currentUser) {
        showLoginPage();
        return;
    }
    
    transitionToPage(notificationPage, 8); 

    setTimeout(() => {
        markNotificationsAsRead();
        renderNotifications();
    }, 500);
}

function hideNotificationPage() {
    notificationPage.style.opacity = 0;
    setTimeout(() => {
        notificationPage.style.display = 'none';
        fabBackNotifButton.style.display = 'none';
        dashboard.style.display = 'block';
        setTimeout(() => { dashboard.style.opacity = 1; }, 50);
        currentStep = 0;
        renderMenu(); 
    }, 400); 
}


// ======================================================
// 3. FUNGSI UTILITY & UI
// ======================================================

function hideAllPages() {
     // Tambahkan adminPage, modalEditUser, modalAdminInvoice
     const pages = [dashboard, loginPage, registrationPage, paymentPage, dataWargaPage, myProfilePage, notificationPage, invoicePage, reportPage, adminPage];
     pages.forEach(page => {
         page.style.opacity = 0;
         // Sembunyikan FAB
         fabBackButton.style.display = 'none';
         fabBackWargaButton.style.display = 'none'; 
         fabBackProfileButton.style.display = 'none'; 
         fabBackNotifButton.style.display = 'none'; 
         fabBackInvoiceButton.style.display = 'none';
         fabBackReportButton.style.display = 'none';
         fabBackAdminButton.style.display = 'none'; 
     });
     setTimeout(() => {
         pages.forEach(page => { page.style.display = 'none'; });
         modalEditUser.style.display = 'none'; 
         modalAdminInvoice.style.display = 'none'; 
         modalEditReport.style.display = 'none'; // Tambahkan modalEditReport
     }, 300); 
}


function formatRupiah(number) {
    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
}

function copyText(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Berhasil menyalin ke clipboard!');
    }).catch(err => {
        console.error('Gagal menyalin: ', err);
    });
}

function updateUserData(newData) {
     // Cari indeks currentUser dalam array global
    const userIndex = allUsersAndWarga.findIndex(u => u.id === currentUser.id);
    
    if (userIndex !== -1) {
        // Perbarui data di array global
        allUsersAndWarga[userIndex] = { ...allUsersAndWarga[userIndex], ...newData };
        // Perbarui data currentUser lokal
        currentUser = allUsersAndWarga[userIndex];
        
        // Simpan data global yang baru ke localStorage
        saveUsersData(allUsersAndWarga);
    } else {
        console.error("Gagal menemukan user dalam array global.");
    }
}
// --- FUNGSI HALAMAN LAPORAN BARU ---
function renderReportContent() {
    const content = getReportContent();
    const reportDisplay = document.getElementById('reportContentDisplay');
    
    let htmlContent = '';
    let currentSection = '';
    let summaryTitle = '';
    let details = [];
    let finalBalance = '';
    let footerNote = '';
    
    // 1. Mengurai konten teks
    content.split('\n').forEach(line => {
        line = line.trim();
        
        if (line.startsWith('### üìä')) {
            // Judul Utama
            summaryTitle = line.substring(6).trim();
        } else if (line.startsWith('#### üí∞ Pemasukan')) {
            currentSection = 'Pemasukan';
        } else if (line.startsWith('#### üí∏ Pengeluaran')) {
            currentSection = 'Pengeluaran';
        } else if (line.startsWith('#### üü¢ Saldo Akhir')) {
            currentSection = 'Saldo';
        } else if (line.startsWith('- ') && currentSection) {
            // Data list (e.g., - Total Iuran diterima: [Nominal])
            const parts = line.substring(2).split(':');
            if (parts.length >= 2) {
                const label = parts[0].trim();
                const value = parts.slice(1).join(':').trim(); // Mengambil sisa string sebagai nilai
                details.push({ section: currentSection, label: label, value: value });
            }
        } else if (line.startsWith('**Total Kas Saat Ini:')) {
            // Saldo Akhir
            finalBalance = line.replace('**', '').replace('**', '').split(':')[1].trim();
        } else if (line.startsWith('*Catatan:')) {
            // Catatan Kaki
            footerNote = line.replace('*', '').replace('*', '');
        } else if (line.length > 0 && !summaryTitle) {
            // Paragraf Ringkasan Awal
            summaryTitle = summaryTitle || line;
        }
    });

    // 2. Membangun Struktur HTML Tabel

    // Kontainer Utama
    htmlContent += `<div style="margin-bottom: 20px;">`;
    htmlContent += `<h4 style="text-align: center; color: var(--neon-color-header); margin-bottom: 5px;">${summaryTitle}</h4>`;
    htmlContent += `<p style="text-align: center; font-size: 0.9em; opacity: 0.8; margin-bottom: 20px;">${details.find(d => d.section === '').value || ''}</p>`;
    htmlContent += `</div>`;


    // --- Pemasukan dan Pengeluaran ---
    const renderTable = (section, icon, color) => {
        const sectionDetails = details.filter(d => d.section === section);
        if (sectionDetails.length === 0) return '';
        
        let tableHtml = `<div class="profile-card" style="margin-bottom: 15px; border-left: 5px solid ${color}; padding: 15px;">`;
        tableHtml += `<h5 style="color: ${color}; margin-top: 0; display: flex; align-items: center; gap: 8px;">${icon} ${section}</h5>`;
        tableHtml += `<table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">`;
        
        sectionDetails.forEach(item => {
            tableHtml += `
                <tr>
                    <td style="padding: 5px 0; border-bottom: 1px dotted var(--shadow-dark);">${item.label}</td>
                    <td style="padding: 5px 0; text-align: right; font-weight: 600; border-bottom: 1px dotted var(--shadow-dark); color: ${color};">${item.value}</td>
                </tr>
            `;
        });
        
        tableHtml += `</table></div>`;
        return tableHtml;
    };
    
    htmlContent += renderTable('Pemasukan', 'üí∞', '#00A878'); // Hijau
    htmlContent += renderTable('Pengeluaran', 'üí∏', '#FF4444'); // Merah
    
    // --- Saldo Akhir ---
    if (finalBalance) {
        htmlContent += `
            <div class="profile-card" style="margin-top: 20px; padding: 15px; background-color: var(--neon-bg); border: 2px solid var(--neon-color-header);">
                <h5 style="margin: 0; color: var(--text-color);">Total Kas Saat Ini</h5>
                <p style="font-size: 1.5em; font-weight: 800; color: var(--neon-color-header); margin: 5px 0 0;">${finalBalance}</p>
            </div>
        `;
    }
    
    // Catatan Kaki
    if (footerNote) {
        htmlContent += `<p style="font-size: 0.8em; opacity: 0.7; margin-top: 20px; text-align: center;">${footerNote}</p>`;
    }

    reportDisplay.innerHTML = htmlContent;
}


function saveReportContent(content) {
    localStorage.setItem(REPORT_STORAGE_KEY, content);
}

function renderReportContent() {
    const content = getReportContent();
    const reportDisplay = document.getElementById('reportContentDisplay');
    
    // Sederhana: Ganti markdown dasar ke HTML (Heading & Paragraf)
    let htmlContent = content.split('\n').map(line => {
        if (line.startsWith('### ')) {
            return `<h4>${line.substring(4).trim()}</h4>`;
        } else if (line.startsWith('#### ')) {
             return `<h5>${line.substring(5).trim()}</h5>`;
        } else if (line.startsWith('- ')) {
            return `<li>${line.substring(2).trim()}</li>`;
        } else if (line.trim().length > 0) {
            return `<p>${line.trim()}</p>`;
        }
        return '';
    }).join('');

    reportDisplay.innerHTML = `<ul style="list-style: none; padding: 0;">${htmlContent}</ul>`;
}

function showReportPage() {
    if (!currentUser) {
        showLoginPage();
        return;
    }
    
    transitionToPage(reportPage, 10);
    renderReportContent(); // Panggil fungsi render baru
}


// --- FUNGSI TAMPILAN DAN NAVIGASI ---
function updateMode(isDarkMode) {
    if (isDarkMode) {
        body.classList.add('dark-mode');
        themeToggle.innerHTML = 'üåô Mode Gelap';
        localStorage.setItem('theme', 'dark');
    } else {
        body.classList.remove('dark-mode');
        themeToggle.innerHTML = '‚òÄÔ∏è Mode Terang';
        localStorage.setItem('theme', 'light');
    }
}

function toggleMode() {
    const isDarkMode = body.classList.contains('dark-mode');
    updateMode(!isDarkMode);
}

function renderMenu() {
    const menuGrid = document.querySelector('.menu-grid');
    if (!menuGrid || !currentUser) return;
    
    const notifications = getNotifications();
    const unreadCount = notifications.filter(n => 
        !n.read && (n.target === 'all' || n.target === currentUser.id)
    ).length;
    
    let notificationMenuItem = `
        <a href="#" class="menu-item" onclick="showNotificationsPage()">
            <span class="menu-icon">üîî</span>
            <strong>Notifikasi</strong>
            ${unreadCount > 0 ? `<span class="badge">${unreadCount}</span>` : ''}
        </a>
    `;
    
    const latestUser = allUsersAndWarga.find(u => u.id === currentUser.id);
    const totalInvoices = latestUser && latestUser.invoices ? latestUser.invoices.length : 0;
    let invoiceBadge = totalInvoices > 0 ? `<span class="badge" style="background-color: #3498db;">${totalInvoices}</span>` : '';

    // Menu Admin
    let adminMenu = '';
    if (currentUser.isAdmin) {
        adminMenu = `
            <a href="#" class="menu-item admin-link" onclick="showAdminPage()">
                <span class="menu-icon">üëë</span>
                <strong>Kontrol Admin</strong>
            </a>
        `;
    }

    const menuHtml = `
        ${adminMenu} 
        <a href="#" class="menu-item" onclick="showPaymentPage(1)">
            <span class="menu-icon">üí∏</span>
            <strong>Bayar Kas</strong>
        </a>
        <a href="#" class="menu-item" onclick="showMyProfilePage()">
            <span class="menu-icon">üë§</span>
            <strong>Data Saya</strong>
        </a>
        <a href="#" class="menu-item" onclick="showDataWargaPage()">
            <span class="menu-icon">üèòÔ∏è</span>
            <strong>Data Warga</strong>
        </a>
        <a href="#" class="menu-item" onclick="showReportPage()">
            <span class="menu-icon">üìä</span>
            <strong>Laporan</strong>
        </a>
        ${notificationMenuItem}
        <a href="#" class="menu-item" onclick="showInvoicePage()">
            <span class="menu-icon">üìÑ</span>
            <strong>Invoice Pembayaran</strong>
            ${invoiceBadge}
        </a>
    `;
    
    menuGrid.innerHTML = menuHtml;
}

function transitionToPage(pageElement, step) {
     hideAllPages();
     setTimeout(() => {
        pageElement.style.display = (pageElement === loginPage || pageElement === registrationPage) ? 'flex' : 'block';
        setTimeout(() => { 
            pageElement.style.opacity = 1; 
        }, 50); 
        
        currentStep = step;
        
        const fabMap = {
            1: fabBackButton, 2: fabBackButton, 3: fabBackButton, 4: fabBackButton, 5: fabBackButton, 
            6: fabBackWargaButton, 7: fabBackProfileButton, 8: fabBackNotifButton, 9: fabBackInvoiceButton, 10: fabBackReportButton,
            11: fabBackAdminButton 
        };
        if (fabMap[step]) {
            fabMap[step].style.display = 'block';
        }

     }, 350); 
}


function showLoginPage() {
    transitionToPage(loginPage, 0);
    themeToggle.style.display = 'none';
    currentUser = null; 
    document.getElementById('usernameInput').value = '';
    document.getElementById('passwordInput').value = '';
    document.getElementById('loginMessage').style.display = 'none';
}

function hideLoginPage(name) {
    transitionToPage(dashboard, 0);
    
    welcomeUserText.textContent = `Selamat Datang, ${name}! üëã`;
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') { updateMode(false); } else { updateMode(true); }
    themeToggle.style.display = 'inline-block';
    
    renderMenu(); 
}

function showRegistrationPage() {
    transitionToPage(registrationPage, 0);
    document.getElementById('registrationForm').reset(); 
}

function backToLogin() {
    registrationPage.style.opacity = 0;
    setTimeout(() => {
        registrationPage.style.display = 'none';
        loginPage.style.display = 'flex';
        setTimeout(() => { loginPage.style.opacity = 1; }, 50);
    }, 300);
}

function registerViaWhatsApp() {
    const nama = document.getElementById('regNama').value.trim();
    const blokNo = document.getElementById('regBlokNo').value.trim();
    const idUser = document.getElementById('regIdUser').value.trim();
    const password = document.getElementById('regPassword').value.trim();
    
    const message = `Halo Admin, saya ingin mendaftar akun Kas Gang E21-25. Berikut detail pendaftaran saya:%0A%0A*Nama:* ${nama || 'Belum diisi'}%0A*Blok/No:* ${blokNo || 'Belum diisi'}%0A*ID Pengguna:* ${idUser || 'Belum diisi'}%0A*Password:* ${password || 'Belum diisi'}%0A%0AMohon diproses, terima kasih.`;
    
    const waUrl = `https://wa.me/${ADMIN_WA_NUMBER}?text=${message}`;
    window.open(waUrl, '_blank');
}

// --- FUNGSI NAVIGASI FAB ---
function handleFabClick() {
    if (currentStep === 11) { 
        hideAdminPage(); 
    } else if (currentStep === 10) { 
        hideReportPage();
    } else if (currentStep === 9) { 
        if (selectedInvoice && singleInvoiceDisplay.style.display === 'block') {
            renderInvoiceList();
            selectedInvoice = null;
            document.querySelector('#invoicePage .section-title').textContent = 'üìÑ Daftar Invoice Pembayaran';
        } else {
            hideInvoicePage();
        }
    } else if (currentStep === 8) { 
        hideNotificationPage();
    } else if (currentStep === 7) { 
        hideMyProfilePage();
    } else if (currentStep === 6) { 
         hideDataWargaPage();
    } else if (currentStep === 5 || currentStep === 4 || currentStep === 3) { 
        showPaymentPage(2);
    } else if (currentStep === 2) { 
        showPaymentPage(1);
    } else if (currentStep === 1) { 
        hidePaymentPage();
    }
}

// --- 
 

// ... kode di atas tidak berubah ...

// --- FUNGSI HALAMAN DATA SAYA ---
// --- FUNGSI HALAMAN DATA SAYA ---
function showMyProfilePage() {
     // Pastikan ini adalah pengecekan pertama.
     if (!currentUser) {
        showLoginPage();
        return;
    }

    // 1. AMBIL DATA TERBARU DARI ARRAY GLOBAL SEBELUM MERENDER
    // Ini penting agar tunggakan yang baru dibayar ter-update
    const latestUser = allUsersAndWarga.find(u => u.id === currentUser.id);
    if(latestUser) currentUser = latestUser;
    
    // Set status default saat masuk halaman (Hanya tampilkan 2 bulan pertama)
    is2025Expanded = false;
    is2026Expanded = false;
    
    // 2. Transisi Halaman ke ID myProfilePage (step 7)
    // Pastikan ID 'myProfilePage' sudah benar di HTML Anda
    transitionToPage(myProfilePage, 7); 
    
    // 3. Panggil fungsi rendering data setelah transisi
    // Diberi delay agar data dimuat setelah transisi selesai (opsional)
    setTimeout(renderPaymentHistory, 350); 
}
// --- FUNGSI NAVIGASI FAB ---

// ... fungsi handleFabClick() sudah ada

// --- FUNGSI HALAMAN DATA SAYA ---

// ... fungsi showMyProfilePage() sudah ada

function hideMyProfilePage() {
     myProfilePage.style.opacity = 0;
     setTimeout(() => {
        myProfilePage.style.display = 'none';
        
        // PASTIKAN TOMBOL KEMBALI HILANG
        fabBackProfileButton.style.display = 'none'; 
        
        // PASTIKAN DASHBOARD MUNCUL
        dashboard.style.display = 'block';
        setTimeout(() => { 
            dashboard.style.opacity = 1; 
        }, 50);
        
        // RESET STATUS
        currentStep = 0;
        
        // RENDER ULANG MENU (untuk memastikan notif badge terupdate)
        renderMenu(); 
    }, 400);
}

// ...

function renderPaymentHistory() {
    profileUserName.textContent = currentUser.name;
    profileUserBlock.textContent = currentUser.block;
    profileUserRate.textContent = formatRupiah(currentUser.rate);
    
    // Update tahun di judul ringkasan (Memerlukan ID summaryYear2025 & summaryYear2026)
    document.getElementById('year2025Display').textContent = CURRENT_YEAR;
    document.getElementById('year2026Display').textContent = NEXT_YEAR;
    document.getElementById('summaryYear2025').textContent = CURRENT_YEAR;
    document.getElementById('summaryYear2026').textContent = NEXT_YEAR;
    
    let html2025 = '';
    let html2026 = '';
    
    // Re-fetch data terbaru dari array global
    const latestUser = allUsersAndWarga.find(u => u.id === currentUser.id);
    if(!latestUser) return;
    currentUser = latestUser;
    
    const paid2025Months = TOTAL_MONTHS_YEAR - currentUser.arrears2025;
    const paid2026Months = currentUser.paid2026;      
    
    // Inisialisasi variabel perhitungan tagihan
    let totalUnpaid2025Months = 0;
    
    // --- RENDER 2025 ---
    // Logika ini yang harus diubah dari 2 menjadi nilai yang lebih kecil
    const displayLimit2025 = is2025Expanded ? TOTAL_MONTHS_YEAR : 2; 
    const historyTable2025 = document.getElementById('paymentHistoryTable2025'); // Ambil elemen tabel
    
    for (let i = 0; i < TOTAL_MONTHS_YEAR; i++) {
        const monthName = MONTHS[i];
        let status2025Text = '';
        let status2025Class = '';
        
        // Aturan Khusus: Agustus 2025 (Indeks 7) adalah FREE
        if (i === 7) { 
            status2025Text = 'FREE';
            status2025Class = 'status-ok';
        } else if (i < paid2025Months) {
            status2025Text = 'LUNAS';
            status2025Class = 'status-paid';
        } else {
            status2025Text = 'BELUM LUNAS';
            status2025Class = 'status-unpaid';
            
            // HANYA HITUNG JIKA BUKAN AGUSTUS (i !== 7)
            if (i !== 7) {
                 totalUnpaid2025Months++;
            }
        }

        const isHiddenRow = i >= displayLimit2025;
        // Tambahkan style display:none jika baris harus disembunyikan
        const rowStyle = isHiddenRow ? 'display: none;' : '';
        
        html2025 += `
            <tr style="${rowStyle}">
                <td>${monthName}</td>
                <td class="${status2025Class}">${status2025Text}</td>
            </tr>
        `;
    }
    document.getElementById('paymentHistoryBody2025').innerHTML = html2025;
    
    // Tampilkan/Sembunyikan Tabel secara keseluruhan jika perlu
    // historyTable2025.style.display = 'table'; // Tabel harus selalu 'table' jika data ada

    
    // --- TOGGLE BUTTON 2025 ---
    const toggle2025Button = document.getElementById('toggle2025Button');
    if (TOTAL_MONTHS_YEAR > 2) {
        toggle2025Button.style.display = 'block';
        toggle2025Button.textContent = is2025Expanded 
            ? 'Sembunyikan' 
            : `Tampilkan ${TOTAL_MONTHS_YEAR - 2} Bulan Lainnya`;
    } else {
        toggle2025Button.style.display = 'none';
    }
 

    // --- RENDER 2026 ---
    const displayLimit2026 = is2026Expanded ? TOTAL_MONTHS_YEAR : 2;
    const historyTable2026 = document.getElementById('paymentHistoryTable2026'); // Ambil elemen tabel
    
    for (let i = 0; i < TOTAL_MONTHS_YEAR; i++) {
        const monthName = MONTHS[i];
        
        let status2026Text = '';
        let status2026Class = '';
        if (i < paid2026Months) {
            status2026Text = 'SUDAH LUNAS';
            status2026Class = 'status-paid';
        } else {
            status2026Text = 'BELUM LUNAS';
            status2026Class = 'status-unpaid';
        }
        
        const isHiddenRow = i >= displayLimit2026;
        // Tambahkan style display:none jika baris harus disembunyikan
        const rowStyle = isHiddenRow ? 'display: none;' : '';


        html2026 += `
            <tr style="${rowStyle}">
                <td>${monthName}</td>
                <td class="${status2026Class}">${status2026Text}</td>
            </tr>
        `;
    }
    document.getElementById('paymentHistoryBody2026').innerHTML = html2026;
    
    // Tampilkan/Sembunyikan Tabel secara keseluruhan jika perlu
    // historyTable2026.style.display = 'table'; // Tabel harus selalu 'table' jika data ada
    
     // --- TOGGLE BUTTON 2026 ---
    const toggle2026Button = document.getElementById('toggle2026Button');
    if (TOTAL_MONTHS_YEAR > 2) {
        toggle2026Button.style.display = 'block';
        toggle2026Button.textContent = is2026Expanded 
            ? 'Sembunyikan' 
            : `Tampilkan ${TOTAL_MONTHS_YEAR - 2} Bulan Lainnya`;
    } else {
        toggle2026Button.style.display = 'none';
    }
    
    // --- PERHITUNGAN ULANG TOTAL TAGIHAN ---
    const totalUnpaid2026Months = Math.max(0, TOTAL_MONTHS_YEAR - currentUser.paid2026);
    
    const totalArrearsRupiah = totalUnpaid2025Months * currentUser.rate;
    const totalUnpaid2026Rupiah = totalUnpaid2026Months * currentUser.rate; 
    const subtotalRupiah = totalArrearsRupiah + totalUnpaid2026Rupiah;

    profileArrearsTotal.textContent = `${totalUnpaid2025Months} bln (${formatRupiah(totalArrearsRupiah)})`;
    profileUnpaid2026Total.textContent = `${totalUnpaid2026Months} bln (${formatRupiah(totalUnpaid2026Rupiah)})`;
    profileSubtotalTotal.textContent = formatRupiah(subtotalRupiah);
}

// ... kode di bawah tidak berubah ...



function toggleTable(tableId) {
        var table = document.getElementById(tableId);
        if (table.style.display === "none") {
            table.style.display = "table"; // atau "block" jika itu bukan tabel
        } else {
            table.style.display = "none";
        }
    }





// --- FUNGSI HALAMAN DATA WARGA ---
function showDataWargaPage() {
     if (!currentUser) {
        showLoginPage();
        return;
    }

    transitionToPage(dataWargaPage, 6);
    isTableExpanded = false; 
    // Ambil data warga, tidak termasuk Admin (id 0)
    allWargaData = allUsersAndWarga.filter(u => u.id !== 0); 
    renderWargaTable();
}

function hideDataWargaPage() {
    dataWargaPage.style.opacity = 0;
    setTimeout(() => {
        dataWargaPage.style.display = 'none';
        fabBackWargaButton.style.display = 'none';
        dashboard.style.display = 'block';
        setTimeout(() => { dashboard.style.opacity = 1; }, 50);
        currentStep = 0;
        renderMenu(); 
    }, 400);
}

function renderWargaTable() {
    let html = '';
    const dataWithoutAdmin = allWargaData; 
    const displayLimit = isTableExpanded ? dataWithoutAdmin.length : 10;
    const dataToDisplay = dataWithoutAdmin.slice(0, displayLimit);

    dataToDisplay.forEach((warga, index) => {
        const arrearsText = warga.arrears2025 > 0 
            ? `<span class="status-warning">${warga.arrears2025} bln</span>` 
            : `<span class="status-ok">LUNAS</span>`;
        
        let paid2026Text;
        if (warga.paid2026 >= 12) {
             paid2026Text = `<span class="status-ok">LUNAS ${NEXT_YEAR}</span>`;
        } else if (warga.paid2026 > 0) {
             paid2026Text = `${warga.paid2026} bln`;
        } else {
             paid2026Text = `0 bln`; 
        }
        
        const isHiddenRow = index >= 10 && !isTableExpanded;
        const rowClass = isHiddenRow ? 'hidden-row' : '';

        html += `
            <tr class="${rowClass}">
                <td class="name-col">${warga.name}</td>
                <td>${warga.block}</td>
                <td>${arrearsText}</td>
                <td>${paid2026Text}</td>
            </tr>
        `;
    });

    wargaTableBody.innerHTML = html;
    
    if (dataWithoutAdmin.length > 10) {
        toggleWargaButton.style.display = 'block';
        if (isTableExpanded) {
            toggleWargaButton.textContent = 'Sembunyikan Sisa Data Warga';
        } else {
            toggleWargaButton.textContent = `Tampilkan ${dataWithoutAdmin.length - 10} Data Warga Lainnya`;
        }
    } else {
        toggleWargaButton.style.display = 'none';
    }
    
    const hiddenRows = document.querySelectorAll('.hidden-row');
    hiddenRows.forEach(row => {
        if (isTableExpanded) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function toggleWargaTable() {
    isTableExpanded = !isTableExpanded;
    renderWargaTable();
}

// --- FUNGSI HALAMAN INVOICE PEMBAYARAN ---

function renderInvoiceList() {
    singleInvoiceDisplay.style.display = 'none';
    invoiceListWrapper.style.display = 'block';
    selectedInvoice = null; 
    
    const latestUser = allUsersAndWarga.find(u => u.id === currentUser.id);
    const invoices = latestUser ? latestUser.invoices || [] : [];
    
    const listContainer = document.getElementById('invoiceListContainer');
    let html = '';
    
    if (invoices.length === 0) {
         html = `<p style="text-align: center; margin: 30px 0; opacity: 0.6;">Anda belum memiliki riwayat Invoice Pembayaran saat ini.</p>`;
    } else {
        invoices.sort((a, b) => b.id - a.id); 
        
        invoices.forEach(inv => {
            html += `
                <div class="profile-card" style="margin-bottom: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                     <div onclick="showSingleInvoice('${inv.invoiceID}')" style="cursor: pointer; flex-grow: 1;">
                        <p style="font-size: 1.0em; margin-bottom: 5px;"><strong>${inv.invoiceID}</strong> (${inv.method})</p>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9em; opacity: 0.9;">
                            <span>Tgl: ${inv.date}</span>
                            <strong>${formatRupiah(inv.total)}</strong>
                        </div>
                        <p style="font-size: 0.8em; opacity: 0.7; margin: 5px 0 0;">Alokasi: ${inv.allocation}</p>
                    </div>
                    <button class="action-button" style="background-color: var(--delete-button); color: white; box-shadow: 0 3px 0 var(--delete-shadow); font-size: 0.7em; padding: 6px 10px; margin-left: 10px;" onclick="deleteSingleInvoice('${inv.invoiceID}')">
                        üóëÔ∏è Hapus
                    </button>
                </div>
            `;
        });
    }
    listContainer.innerHTML = html;
}

function showSingleInvoice(invoiceID) {
    const latestUser = allUsersAndWarga.find(u => u.id === currentUser.id);
    const invoice = (latestUser.invoices || []).find(inv => inv.invoiceID === invoiceID);
    
    if (!invoice) return;
    
    selectedInvoice = invoice;
    invoiceListWrapper.style.display = 'none';
    singleInvoiceDisplay.style.display = 'block';
    
    document.getElementById('invoiceID').textContent = invoice.invoiceID;
    document.getElementById('invoiceDate').textContent = invoice.date;
    document.getElementById('invoiceUserNameBlock').textContent = `${currentUser.name} (${currentUser.block})`;
    document.getElementById('invoiceMethod').textContent = invoice.method;
    document.getElementById('invoiceAllocation').textContent = invoice.allocation;
    document.getElementById('invoiceTotal').textContent = formatRupiah(invoice.total);
    
     document.querySelector('#invoicePage .section-title').textContent = 'üìÑ Detail Bukti Pembayaran';
}

function deleteSingleInvoice(invoiceID) {
    if (confirm(`Apakah Anda yakin ingin menghapus Invoice ID: ${invoiceID}? Tindakan ini tidak akan mengembalikan data pembayaran Anda.`)) {
        
        const userIndex = allUsersAndWarga.findIndex(u => u.id === currentUser.id);
        if (userIndex === -1) {
            console.error('User not found for deletion.');
            return;
        }
        
        const initialCount = allUsersAndWarga[userIndex].invoices.length;
        allUsersAndWarga[userIndex].invoices = allUsersAndWarga[userIndex].invoices.filter(inv => inv.invoiceID !== invoiceID);
        
        if (allUsersAndWarga[userIndex].invoices.length < initialCount) {
            currentUser = allUsersAndWarga[userIndex]; 
            saveUsersData(allUsersAndWarga); 
            
            selectedInvoice = null;
            renderInvoiceList();
            renderMenu(); 
            
            if (document.getElementById('singleInvoiceDisplay').style.display === 'block') {
                document.getElementById('singleInvoiceDisplay').style.display = 'none';
                document.getElementById('invoiceListWrapper').style.display = 'block';
                document.querySelector('#invoicePage .section-title').textContent = 'üìÑ Daftar Invoice Pembayaran';
            }
            
        } else {
            console.error('Gagal menghapus invoice.');
        }
    }
}


function showInvoicePage() {
    if (!currentUser) {
        showLoginPage();
        return;
    }
    
    transitionToPage(invoicePage, 9);
     document.querySelector('#invoicePage .section-title').textContent = 'üìÑ Daftar Invoice Pembayaran';

    setTimeout(renderInvoiceList, 400);
}

function hideInvoicePage() {
    invoicePage.style.opacity = 0;
     setTimeout(() => {
        invoicePage.style.display = 'none';
        fabBackInvoiceButton.style.display = 'none';
        dashboard.style.display = 'block';
        setTimeout(() => { dashboard.style.opacity = 1; }, 50);
        currentStep = 0;
        renderMenu(); 
    }, 400);
}

// --- FUNGSI HALAMAN LAPORAN BARU ---
// Fungsi showReportPage sudah didefinisikan di atas (setelah updateUserData)
function hideReportPage() {
    reportPage.style.opacity = 0;
     setTimeout(() => {
        reportPage.style.display = 'none';
        fabBackReportButton.style.display = 'none';
        dashboard.style.display = 'block';
        setTimeout(() => { dashboard.style.opacity = 1; }, 50);
        currentStep = 0;
        renderMenu(); 
    }, 400);
}
 
// --- FUNGSI TOGGLE BARU ---
function togglePaymentHistory(year) {
    if (year === 2025) {
        is2025Expanded = !is2025Expanded;
    } else if (year === 2026) {
        is2026Expanded = !is2026Expanded;
    }
    renderPaymentHistory(); 
}

// 4. FUNGSI ADMIN KONTROL (WARGA & INVOICE)
// ======================================================

function showAdminPage() {
     if (!currentUser || !currentUser.isAdmin) {
        alert('Akses Ditolak: Anda bukan administrator.');
        showLoginPage();
        return;
    }
    transitionToPage(adminPage, 11);
    // Pastikan data terbaru diambil sebelum merender
    allUsersAndWarga = getSavedUsersData(); 
    renderAdminWargaTable();
}

function hideAdminPage() {
    modalEditUser.style.opacity = 0; 
    modalAdminInvoice.style.opacity = 0; 
    modalEditReport.style.opacity = 0; // Tambahkan modalEditReport
    setTimeout(() => {
        modalEditUser.style.display = 'none';
        modalAdminInvoice.style.display = 'none';
        modalEditReport.style.display = 'none';
        adminPage.style.display = 'none';
        fabBackAdminButton.style.display = 'none';
        dashboard.style.display = 'block';
        setTimeout(() => { dashboard.style.opacity = 1; }, 50);
        currentStep = 0;
        renderMenu(); 
    }, 400);
}
// --- FUNGSI MODAL LAPORAN ADMIN ---

function showEditReportModal() {
    // Ambil konten saat ini
    const currentContent = getReportContent();
    document.getElementById('editReportTextarea').value = currentContent;
    
    modalEditReport.style.display = 'flex';
    setTimeout(() => { modalEditReport.style.opacity = 1; }, 50);
}

function hideEditReportModal() {
    modalEditReport.style.opacity = 0;
    setTimeout(() => { modalEditReport.style.display = 'none'; }, 300);
}

function saveEditedReport() {
    const newContent = document.getElementById('editReportTextarea').value;
    
    saveReportContent(newContent);
    
    alert('Laporan berhasil diperbarui!');
    
    hideEditReportModal();
    
    // Perbarui tampilan laporan jika Admin membukanya
    if (currentStep === 10) { 
        renderReportContent();
    }
}
function renderAdminWargaTable() {
    let html = '';
    // Hapus tombol sebelumnya jika ada
    let existingButton = document.querySelector('#adminTableWrapper .admin-invoice-button');
    if (existingButton) existingButton.remove();

    // Tampilkan semua data warga, kecuali Admin itu sendiri (id 0)
    const adminViewData = allUsersAndWarga.filter(u => u.id !== 0).sort((a, b) => a.id - b.id);

    adminViewData.forEach(warga => {
        const totalTunggakan = warga.arrears2025 + Math.max(0, TOTAL_MONTHS_YEAR - warga.paid2026);
        const statusPembayaran = totalTunggakan > 0 ? `<span class="status-warning">${totalTunggakan} bln</span>` : `<span class="status-ok">LUNAS</span>`;
        
        html += `
            <tr>
                <td>${warga.id}</td>
                <td class="name-col">${warga.name}</td>
                <td>${warga.block}</td>
                <td>${statusPembayaran}</td>
                <td>
                    <button class="action-button" onclick="showEditUserModal(${warga.id})" style="background-color: var(--neon-color-header); margin-right: 5px; font-size: 0.8em;">
                        Edit Data
                    </button>
                    <button class="action-button" onclick="deleteWargaData(${warga.id})" style="background-color: var(--delete-button); font-size: 0.8em;">
                        Hapus
                    </button>
                </td>
            </tr>
        `;
    });
    adminWargaTableBody.innerHTML = html;
    
    // Tambahkan tombol untuk mengelola Invoice
    const invoiceControlHtml = `
        <div class="admin-invoice-button" style="text-align: right; margin-bottom: 15px;">
            <button class="action-button" onclick="showAdminInvoiceModal()" style="background-color: var(--neon-color-header); color: white; box-shadow: 0 3px 0 var(--neon-shadow); font-size: 0.9em; padding: 10px 15px;">
                üìÑ Kelola Semua Invoice Warga
            </button>
        </div>
    `;
    if (adminTableWrapper) {
         adminTableWrapper.insertAdjacentHTML('afterbegin', invoiceControlHtml);
    }
}

// --- FUNGSI MODAL EDIT WARGA ---

function showEditUserModal(userId) {
    const userToEdit = allUsersAndWarga.find(u => u.id === userId);
    if (!userToEdit) {
        alert('User tidak ditemukan.');
        return;
    }

    // Isi form modal
    document.getElementById('editUserId').value = userToEdit.id;
    document.getElementById('editUserName').value = userToEdit.name;
    document.getElementById('editUserBlock').value = userToEdit.block;
    document.getElementById('editUserRate').value = userToEdit.rate;
    // Data Dinamis yang bisa diubah
    document.getElementById('editArrears2025').value = userToEdit.arrears2025;
    document.getElementById('editPaid2026').value = userToEdit.paid2026;
    // Data Login
    document.getElementById('editUserUsername').value = userToEdit.username;
    document.getElementById('editUserPassword').value = userToEdit.password;
    
    document.getElementById('modalEditUserTitle').textContent = `Edit Data Warga: ${userToEdit.name}`;

    modalEditUser.style.display = 'flex';
    setTimeout(() => { modalEditUser.style.opacity = 1; }, 50);
}

function hideEditUserModal() {
    modalEditUser.style.opacity = 0;
    setTimeout(() => { modalEditUser.style.display = 'none'; }, 300);
}

function saveEditedUser() {
    const id = parseInt(document.getElementById('editUserId').value);
    const name = document.getElementById('editUserName').value.trim();
    const block = document.getElementById('editUserBlock').value.trim();
    const rate = parseInt(document.getElementById('editUserRate').value);
    const arrears2025 = parseInt(document.getElementById('editArrears2025').value);
    const paid2026 = parseInt(document.getElementById('editPaid2026').value);
    const username = document.getElementById('editUserUsername').value.trim().toLowerCase();
    const password = document.getElementById('editUserPassword').value.trim();
    
    if (arrears2025 < 0 || paid2026 < 0 || paid2026 > TOTAL_MONTHS_YEAR) {
         alert("Input Tunggakan/Lunas tidak valid.");
         return;
    }


    const userIndex = allUsersAndWarga.findIndex(u => u.id === id);

    if (userIndex !== -1) {
        allUsersAndWarga[userIndex] = {
            ...allUsersAndWarga[userIndex],
            name: name,
            block: block,
            rate: rate,
            // Data Dinamis
            arrears2025: arrears2025,
            paid2026: Math.min(TOTAL_MONTHS_YEAR, paid2026), 
            // Data Login
            username: username,
            password: password,
        };
        
        // Sinkronisasi data ke user yang sedang login jika datanya sendiri diubah
        if (currentUser && currentUser.id === id) {
            currentUser = allUsersAndWarga[userIndex];
        }
        
        saveUsersData(allUsersAndWarga); 
        
        alert(`Data ${name} (ID: ${id}) berhasil diperbarui.`);
        hideEditUserModal();
        
        // Update tampilan terkait
        renderAdminWargaTable(); 
        
        if (currentStep === 7 && currentUser && currentUser.id === id) { 
            renderPaymentHistory();
        }
        if (currentStep === 6) { 
            allWargaData = allUsersAndWarga.filter(u => u.id !== 0); 
            renderWargaTable();
        }

    } else {
        alert('Gagal menyimpan: User tidak ditemukan.');
    }
}

function addNewWargaFromAdmin() {
    const name = prompt("Masukkan Nama Lengkap:");
    if (!name) return;
    const block = prompt("Masukkan Blok/Nomor (Contoh: E21-25):");
    if (!block) return;
    const rate = prompt("Masukkan Iuran Bulanan (Contoh: 25000):");
    if (!rate || isNaN(parseInt(rate))) return alert('Rate harus angka.');
    const username = prompt("Masukkan Username Login:");
    if (!username) return;
    const password = prompt("Masukkan Password Login:");
    if (!password) return;

    const newWarga = addNewWarga(name, block, parseInt(rate), username, password);
    if (newWarga) {
        renderAdminWargaTable();
    }
}

// ======================================================
// 4.2 FUNGSI ADMIN: KONTROL INVOICE
// ======================================================

function showAdminInvoiceModal() {
    modalAdminInvoice.style.display = 'flex';
    setTimeout(() => { modalAdminInvoice.style.opacity = 1; }, 50);
    renderAdminInvoiceList();
}

function hideAdminInvoiceModal() {
    modalAdminInvoice.style.opacity = 0;
    setTimeout(() => { modalAdminInvoice.style.display = 'none'; }, 300);
}

function renderAdminInvoiceList() {
    let html = '';
    
    // Gabungkan semua invoice dari semua warga (kecuali Admin RT sendiri)
    const allInvoices = allUsersAndWarga
        .filter(u => u.id !== 0) 
        .flatMap(user => 
            (user.invoices || []).map(inv => ({
                ...inv,
                userId: user.id,
                userName: user.name,
                userBlock: user.block
            }))
        );
    
    allInvoices.sort((a, b) => b.id - a.id); // Urutkan terbaru dulu

    allInvoices.slice(0, 50).forEach(inv => { // Batasi 50 invoice terakhir
        html += `
            <tr>
                <td>${inv.invoiceID}</td>
                <td>${inv.userName} (${inv.userBlock})</td>
                <td>${inv.date}</td>
                <td>${formatRupiah(inv.total)}</td>
                <td>
                    <button class="action-button" onclick="alert('Simulasi Edit: ID ${inv.invoiceID}\\nSilakan hapus invoice ini dan gunakan "Edit Data" warga untuk mengubah status tunggakan/lunas.')" style="background-color: #3498db; margin-right: 5px; font-size: 0.8em;">
                        Edit
                    </button>
                    <button class="action-button" onclick="deleteAdminInvoice('${inv.invoiceID}', ${inv.userId})" style="background-color: var(--delete-button); font-size: 0.8em;">
                        Hapus
                    </button>
                </td>
            </tr>
        `;
    });

    adminInvoiceListBody.innerHTML = html;
    
    if (allInvoices.length === 0) {
         adminInvoiceListBody.innerHTML = `<tr><td colspan="5" style="text-align: center; opacity: 0.6;">Tidak ada invoice yang tercatat.</td></tr>`;
    }
}

function deleteAdminInvoice(invoiceID, userId) {
    if (!confirm(`Yakin hapus Invoice ${invoiceID} milik ID ${userId}?\\n(Tindakan ini TIDAK mengembalikan status tunggakan warga. Status tunggakan harus diubah manual melalui "Edit Data" warga tersebut.)`)) return;

    const userIndex = allUsersAndWarga.findIndex(u => u.id === userId);
    if (userIndex === -1) {
        alert('User tidak ditemukan.');
        return;
    }

    const initialCount = allUsersAndWarga[userIndex].invoices.length;
    allUsersAndWarga[userIndex].invoices = allUsersAndWarga[userIndex].invoices.filter(inv => inv.invoiceID !== invoiceID);
    
    if (allUsersAndWarga[userIndex].invoices.length < initialCount) {
        saveUsersData(allUsersAndWarga);
        
        // Perbarui data currentUser jika dia yang sedang login
        if (currentUser && currentUser.id === userId) {
             currentUser = allUsersAndWarga[userIndex]; 
             renderMenu(); // Update badge invoice
             if (currentStep === 9) renderInvoiceList(); 
        }
        
        renderAdminInvoiceList();
        alert(`Invoice ${invoiceID} berhasil dihapus.`);
        
    } else {
        alert('Gagal menghapus invoice.');
    }
}

function addAdminInvoiceManual(invoiceID, userId, total, method, allocation) {
    if (!invoiceID || !userId || !total || !method || !allocation) {
        alert("Semua field (ID, ID Warga, Total, Metode, Alokasi) harus diisi.");
        return;
    }
    
    const userIndex = allUsersAndWarga.findIndex(u => u.id === parseInt(userId));
    if (userIndex === -1) {
        alert('User ID tidak ditemukan.');
        return;
    }
    
    const totalAmount = parseInt(total);

    const newInvoice = {
        id: Date.now(),
        invoiceID: invoiceID,
        date: new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }),
        total: totalAmount,
        method: method,
        allocation: allocation
    };

    if (!allUsersAndWarga[userIndex].invoices) allUsersAndWarga[userIndex].invoices = [];
    allUsersAndWarga[userIndex].invoices.push(newInvoice);
    
    saveUsersData(allUsersAndWarga); 
    
    // Bersihkan form setelah sukses
    document.getElementById('addInvoiceForm').reset();
    
    renderAdminInvoiceList();
    alert(`Invoice ${invoiceID} berhasil ditambahkan ke ${allUsersAndWarga[userIndex].name}.\\n\\nCatatan: Status Tunggakan/Lunas warga tersebut perlu diperbarui secara manual melalui menu "Edit Data" di halaman Admin.`);
}

// ======================================================
// 5. FUNGSI PEMBAYARAN
// ======================================================

function showPaymentPage(step = 1) {
    if (!currentUser) {
        showLoginPage();
        return;
    }
    
    const latestUser = allUsersAndWarga.find(u => u.id === currentUser.id);
    if(latestUser) currentUser = latestUser;


    transitionToPage(paymentPage, step);
    
    paymentStep1.style.display = 'none';
    paymentStep2.style.display = 'none';
    paymentStep3.style.display = 'none';
    paymentStep4.style.display = 'none'; 
    paymentStep5.style.display = 'none'; 
    
    fabBackButton.style.display = (step > 0 && step <= 5) ? 'block' : 'none'; 

    setTimeout(() => {
        if (step === 1) {
            if (paymentStep1.style.display !== 'block') {
                paymentUserName.textContent = currentUser.name;
                paymentUserBlock.textContent = currentUser.block;
                paymentUserRate.textContent = formatRupiah(currentUser.rate);
                
                const arrearsMonths2025 = currentUser.arrears2025;
                const totalArrearsRupiah = arrearsMonths2025 * currentUser.rate;
                
                let tunggakanMessage = '';
                const unpaid2026Months = TOTAL_MONTHS_YEAR - currentUser.paid2026;
                
                if (arrearsMonths2025 > 0) {
                    tunggakanInfo.classList.add('tunggakan-warning-style');
                    tunggakanInfo.classList.remove('tunggakan-lunas-style');
                    tunggakanMessage = `‚ö†Ô∏è PERHATIAN: Anda memiliki ${arrearsMonths2025} bulan tunggakan ${CURRENT_YEAR} (${formatRupiah(totalArrearsRupiah)}). Pembayaran akan dialokasikan untuk melunasi tunggakan tahun ${CURRENT_YEAR} terlebih dahulu.`;
                } else {
                    if (unpaid2026Months > 0) {
                        tunggakanInfo.classList.add('tunggakan-lunas-style');
                        tunggakanInfo.classList.remove('tunggakan-warning-style');
                        tunggakanMessage = `‚úÖ LUNAS ${CURRENT_YEAR}: Anda lunas hingga Desember ${CURRENT_YEAR}. Pembayaran berikutnya dialokasikan untuk iuran mulai ${MONTHS[currentUser.paid2026 % 12]} ${NEXT_YEAR}.`;
                    } else {
                        tunggakanInfo.classList.add('tunggakan-lunas-style');
                        tunggakanInfo.classList.remove('tunggakan-warning-style');
                        tunggakanMessage = `üéâ LUNAS TOTAL: Anda lunas hingga akhir tahun ${NEXT_YEAR}. mantap. Terima kasih!`;
                    }
                }
                tunggakanInfo.innerHTML = tunggakanMessage;

                const minPayment = currentUser.rate; 
                nominalInput.value = nominalInput.value || minPayment; 
                minPaymentText.textContent = formatRupiah(minPayment);
                calculatePayment();
            }
            
            paymentStep1.style.display = 'block';

        } else if (step === 2) {
            if (continueButton.disabled && finalPaymentSummary.total === 0) {
                showPaymentPage(1);
                return;
            }
            
            paymentStep2.style.display = 'block';
            
            finalTotalDisplay.textContent = formatRupiah(finalPaymentSummary.total);
            
            let summaryText = '';
            if (finalPaymentSummary.paidArrears > 0) {
                summaryText += `Pelunasan Tunggakan ${CURRENT_YEAR} (${finalPaymentSummary.paidMonths2025} bln)`;
            }
            if (finalPaymentSummary.paidMonths2026 > 0) {
                 if (summaryText) summaryText += ' + ';
                 summaryText += `Iuran ${NEXT_YEAR} (${finalPaymentSummary.paidMonths2026} bln)`;
            }
            finalPaidSummary.textContent = summaryText || 'Tidak ada alokasi pembayaran.';
            
            document.querySelectorAll('.method-item').forEach(el => el.classList.remove('selected'));

        } else if (step === 3) { // QRIS
            paymentStep3.style.display = 'block';
            qrUserName.textContent = currentUser.name;
            qrUserBlock.textContent = currentUser.block;
            qrTotalDisplay.textContent = formatRupiah(finalPaymentSummary.total);
            qrPaidSummary.textContent = getSummaryText();
            
        } else if (step === 4) { // Transfer Bank
            paymentStep4.style.display = 'block';
            transferUserName.textContent = currentUser.name;
            transferUserBlock.textContent = currentUser.block;
            transferTotalDisplay.textContent = formatRupiah(finalPaymentSummary.total);
            transferPaidSummary.textContent = getSummaryText();
        } else if (step === 5) { // Tunai/E-Wallet (Baru)
            
            if (finalPaymentSummary.total === 0) {
                showPaymentPage(1);
                return;
            }
            
            paymentStep5.style.display = 'block';
            
            const method = selectedMethod === 'cash' ? 'Tunai' : 'E-Wallet (DANA)';
            
            paymentTypeHeader.textContent = method;
            otherUserName.textContent = currentUser.name;
            otherUserBlock.textContent = currentUser.block;
            otherTotalDisplay.textContent = formatRupiah(finalPaymentSummary.total);
            otherPaidSummary.textContent = getSummaryText();
            
            if (selectedMethod === 'cash') {
                 otherInstructionText.innerHTML = `Mohon hubungi Bendahara atau datang secara langsung ke blok E25-09 untuk penyerahan dana sebesar ${formatRupiah(finalPaymentSummary.total)}.`;
                 danaDetails.style.display = 'none';
            } else if (selectedMethod === 'ewallet') {
                 otherInstructionText.innerHTML = `Silakan transfer sejumlah ${formatRupiah(finalPaymentSummary.total)} ke nomor E-Wallet (DANA) di bawah ini.`;
                 danaDetails.style.display = 'block';
            }
        }
    }, 400); 
}

function hidePaymentPage() {
    paymentPage.style.opacity = 0;
    setTimeout(() => {
        paymentPage.style.display = 'none';
        fabBackButton.style.display = 'none'; 
        dashboard.style.display = 'block';
        setTimeout(() => { dashboard.style.opacity = 1; }, 50);
        currentStep = 0;
        renderMenu(); 
    }, 400);
}

function showPaymentFlow(method) {
     selectedMethod = method;
     document.querySelectorAll('.method-item').forEach(el => el.classList.remove('selected'));
     document.querySelector(`.method-item[data-method="${method}"]`).classList.add('selected');

     if (method === 'qris') {
         showPaymentPage(3);
     } else if (method === 'transfer') {
         showPaymentPage(4);
     } else if (method === 'cash' || method === 'ewallet') {
         showPaymentPage(5);
     }
 }


function calculatePayment() {
    let inputAmount = parseInt(nominalInput.value) || 0;
    const rate = currentUser.rate;
    let totalArrears2025 = currentUser.arrears2025 * rate; 
    
    let paidArrears2025 = 0;
    let paidMonths2025Count = 0;
    let amountForIuran2026 = 0;
    let paidMonths2026Count = 0;
    let totalBilled = 0;
    let periodText = ' - ';
    
    let currentRemainingInput = inputAmount;

    // 1. Prioritaskan Tunggakan 2025
    if (totalArrears2025 > 0) {
        if (currentRemainingInput >= totalArrears2025) {
            paidArrears2025 = totalArrears2025;
            currentRemainingInput -= totalArrears2025;
            paidMonths2025Count = currentUser.arrears2025;
        } else {
            paidArrears2025 = currentRemainingInput - (currentRemainingInput % rate);
            paidMonths2025Count = Math.floor(paidArrears2025 / rate);
            currentRemainingInput = currentRemainingInput % rate; 
        }
    }
    
    totalBilled += paidArrears2025;

    // 2. Hitung Iuran Bulanan 2026
    amountForIuran2026 = currentRemainingInput;
    if (amountForIuran2026 > 0) {
        const remainingMonths2026 = TOTAL_MONTHS_YEAR - currentUser.paid2026;
        
        let monthsToPay2026 = Math.floor(amountForIuran2026 / rate);
        
        paidMonths2026Count = Math.min(monthsToPay2026, remainingMonths2026);
        
        const iuran2026Calculated = paidMonths2026Count * rate;
        totalBilled += iuran2026Calculated;
        
        if (paidMonths2026Count > 0) {
            const totalPaidMonthsBefore = currentUser.paid2026;
            
            const startMonthIndex = totalPaidMonthsBefore % 12; 
            const startYearOffset = Math.floor(totalPaidMonthsBefore / 12);
            const startYear = NEXT_YEAR + startYearOffset;
            const startMonth = MONTHS[startMonthIndex];

            const totalPaidMonthsAfter = totalPaidMonthsBefore + paidMonths2026Count;

            const endMonthIndex = (totalPaidMonthsAfter - 1) % 12;
            const endYearOffset = Math.floor((totalPaidMonthsAfter - 1) / 12);
            const endYear = NEXT_YEAR + endYearOffset;
            const endMonth = MONTHS[endMonthIndex];
            
            if (paidMonths2026Count === 1) {
                periodText = `${startMonth} ${startYear}`;
            } else {
                periodText = `${startMonth} ${startYear} s/d ${endMonth} ${endYear}`;
            }
        }
    }
    
    // 3. Update Tampilan
    tunggakanPaid.textContent = formatRupiah(paidArrears2025);
    const totalPaidMonths = paidMonths2025Count + paidMonths2026Count;
    paidMonths.textContent = `${totalPaidMonths} Bulan (${paidMonths2025Count} di ${CURRENT_YEAR}, ${paidMonths2026Count} di ${NEXT_YEAR})`;
    paymentPeriod.textContent = periodText;
    totalPayment.textContent = formatRupiah(totalBilled);
    
    // 4. Update Button State
    const minPaymentRequired = rate;
    if (totalBilled >= minPaymentRequired && totalBilled > 0) {
        continueButton.disabled = false;
        nominalInput.style.borderColor = '#00A878';
    } else {
        continueButton.disabled = true;
         if (inputAmount > 0) {
             nominalInput.style.borderColor = '#FFD700';
         } else {
             nominalInput.style.borderColor = 'transparent';
         }
    }
    
    // 5. Simpan Summary
    finalPaymentSummary = {
        total: totalBilled,
        paidArrears: paidArrears2025,
        paidMonthsCount: totalPaidMonths,
        periodText: periodText,
        paidMonths2025: paidMonths2025Count,
        paidMonths2026: paidMonths2026Count,
        arrearsStartMonths: currentUser.arrears2025,
        paid2026StartMonths: currentUser.paid2026
    };
}

function getSummaryText() {
    let summaryText = '';
    if (finalPaymentSummary.paidArrears > 0) {
        summaryText += `Pelunasan Tunggakan ${CURRENT_YEAR} (${finalPaymentSummary.paidMonths2025} bln)`;
    }
    if (finalPaymentSummary.paidMonths2026 > 0) {
         if (summaryText) summaryText += ' + ';
         summaryText += `Iuran ${NEXT_YEAR} (${finalPaymentSummary.paidMonths2026} bln)`;
    }
    return summaryText || 'Tidak ada alokasi pembayaran.';
}

function createInvoice(methodType) {
    const date = new Date();
    
    const userIndex = allUsersAndWarga.findIndex(u => u.id === currentUser.id);
    if (userIndex === -1) return;
    
    if (!allUsersAndWarga[userIndex].invoices) allUsersAndWarga[userIndex].invoices = []; 
    const invoiceCount = allUsersAndWarga[userIndex].invoices.length + 1;
    
    const invoiceID = `INV-${currentUser.id}-${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}-${invoiceCount.toString().padStart(2, '0')}`;
    
    const allocationText = getSummaryText();
    
    const newInvoice = {
        id: Date.now(),
        invoiceID: invoiceID,
        date: date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }),
        total: finalPaymentSummary.total,
        method: methodType,
        allocation: allocationText
    };
    
    allUsersAndWarga[userIndex].invoices.push(newInvoice);
    
    saveUsersData(allUsersAndWarga); 
}

// --- FUNGSI KONFIRMASI PEMBAYARAN (SIMULASI UPDATE DATA) ---
function simulatePaymentConfirmation(methodType) {
    
    if (finalPaymentSummary.total === 0) {
         alert('Error: Tidak ada transaksi yang diproses. Nominal pembayaran Rp 0.'); 
         return;
    }

    // 1. BUAT INVOICE
    createInvoice(methodType);
    
    // 2. Kirim Pesan WA (DIBUKA DI TAB BARU)
    const total = formatRupiah(finalPaymentSummary.total);
    const summary = getSummaryText();
    const waMessage = `Halo Admin, saya *${currentUser.name}* (${currentUser.block}) telah melakukan pembayaran Kas sebesar *${total}* (${summary}) via **${methodType}**.%0A%0AMohon bantuannya untuk verifikasi pembayaran, lampirkan bukti transfer/screenshot di sini .%0A%0ATerima kasih.`;
    const waUrl = `https://wa.me/${ADMIN_WA_NUMBER}?text=${waMessage}`;
    window.open(waUrl, '_blank');
    
    
    // 3. SIMULASI UPDATE DATA PENGGUNA (Backend Update) - Otomatis Lunas
    
    const newArrears2025 = Math.max(0, currentUser.arrears2025 - finalPaymentSummary.paidMonths2025);
    const newPaid2026 = Math.min(TOTAL_MONTHS_YEAR, currentUser.paid2026 + finalPaymentSummary.paidMonths2026);
    
    const newData = {
        arrears2025: newArrears2025,
        paid2026: newPaid2026
    };
    
    updateUserData(newData); 
    
    // 4. Tambahkan Notifikasi Pembayaran Berhasil
    const paymentNotifMessage = `Pembayaran Kas dari ${currentUser.name} (${currentUser.block}) sebesar ${total} via ${methodType} berhasil.`;
    addNotification('payment', paymentNotifMessage, 'all'); 
    
    // 5. Kembali ke Dashboard
    hidePaymentPage();
    
    // 6. Reset input nominal
    nominalInput.value = '';
    calculatePayment(); 
}

// --- FUNGSI STEP 3 (QRIS) ---
function downloadQR() {
    alert('Gambar QR Code telah berhasil diunduh ke perangkat Anda.');
}

// --- FUNGSI LOGIN/REGISTRASI ---
loginForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const inputUsername = document.getElementById('usernameInput').value.trim().toLowerCase();
    const inputPassword = document.getElementById('passwordInput').value.trim();
    
    const user = allUsersAndWarga.find(u => u.username === inputUsername && u.password === inputPassword);
    
    const loginMessage = document.getElementById('loginMessage');
    
    loginMessage.style.display = 'block';
    
    if (user) {
        currentUser = user; 
        loginMessage.style.color = '#00C49A';
        loginMessage.innerHTML = `Login Berhasil! Selamat datang, **${user.name}**${user.isAdmin ? ' (ADMIN)' : ''}.`;
        
        setTimeout(() => { hideLoginPage(user.name); }, 1000);
    } else {
        loginMessage.style.color = '#FF4444';
        loginMessage.innerHTML = 'Username atau Kata Sandi salah. Silakan coba lagi.';
    }
});

// ======================================================
// 6. INISIALISASI & SPLASH SCREEN LOGIC
// ======================================================

function initializeApp() {
    // Ambil data user yang permanen dan disinkronkan
    allUsersAndWarga = getSavedUsersData();
    // Inisialisasi allWargaData tanpa Admin untuk tampilan publik
    allWargaData = allUsersAndWarga.filter(u => u.id !== 0); 
    
    // Terapkan tema
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') { updateMode(false); } else { updateMode(true); }

    // Tampilkan splash screen, kemudian beralih ke login
    setTimeout(() => {
        loadingPage.classList.add('hidden');
        
        setTimeout(() => {
            loadingPage.style.display = 'none';
            showLoginPage(); 
            
        }, 500); 
        
    }, 2000); 
}

// Panggil inisialisasi aplikasi saat DOM siap
document.addEventListener('DOMContentLoaded', initializeApp);


     </script>



</body>

</html>

