<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Iuran Warga & Pembayaran Kas (Terintegrasi)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ======================================= */
        /* === CSS UMUM & FULL LAYAR === */
        /* ======================================= */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            padding: 0;
            margin: 0;
            text-align: center;
        }
        .container {
            width: 90%;
            min-height: 100vh;
            margin: 0 auto;
            background: white;
            padding: 30px 15px;
            box-shadow: none; 
            position: relative;
        }
        .content-wrapper {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 1.8em;
            color: #ff5722;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        /* ======================================= */
        /* === Search & Result Styling === */
        /* ======================================= */
        #search-form {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        #search-form input[type="text"] {
            flex-grow: 1; 
            max-width: 50%;
            padding: 12px;
            border: 2px solid #ccc;
            border-radius: 8px 0 0 8px;
            font-size: 1em;
        }
        #search-form button {
            width: 100px;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #result-container {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: left;
        }
        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }
        .data-item .lunas { color: #28a745; font-weight: bold; }
        .data-item .belum { color: #dc3545; font-weight: bold; }
        .total-info {
            margin-top: 20px;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 4px;
            text-align: center;
        }
        /* Style untuk pesan lunas */
        #lunas-message {
            padding: 15px;
            margin-top: 20px;
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            font-weight: bold;
            display: none;
        }
        
        /* ======================================= */
        /* === Manual Payment Integration === */
        /* ======================================= */
        #btn-show-manual {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background-color: red;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #btn-show-manual:hover {
            background-color: blue;
        }
        #manual-payment-section {
            margin-top: 25px;
            padding: 20px;
            border: 1px dashed #007bff;
            border-radius: 8px;
            background-color: #f8fafd;
            display: none;
            text-align: center;
        }
        #payment-form-manual input[type="number"],
        #payment-form-manual input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        /* TOMBOL LANJUTKAN PEMBAYARAN */
        #payment-form-manual button {
            width: 100%;
            padding: 15px; 
            margin-top: 25px; 
            margin-bottom: 10px; 
            background-color: #ff5722; 
            color: white;
            border: none;
            border-radius: 8px; 
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em; 
            transition: background-color 0.3s, transform 0.2s;
        }

        #payment-form-manual button:hover {
            background-color: #e64a19; 
            transform: translateY(-1px); 
        }
        
        #payment-result-manual { 
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #28a745;
            background-color: #e6ffed;
            text-align: left;
            display: none;
        }
        
        /* Tombol WA yang disembunyikan/dinonaktifkan */
        #btn-whatsapp-proof {
            margin-top: 15px;
            width: 100%;
            padding: 12px;
            background-color: #ccc; 
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: not-allowed;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #btn-whatsapp-proof.active {
            background-color: #25d366; 
            cursor: pointer;
        }

        /* Style QRIS Image Container */
        .qris-display {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #ccc;
            
        }
        .qris-display img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
        }
        /* Style untuk Checkbox Konfirmasi */
        #confirmation-container {
            margin: 15px 0;
            padding: 10px;
            background-color: #fff3cd; 
            border: 1px solid #ffeeba;
            border-radius: 5px;
            text-align: left;
            display: flex;
            align-items: center;
        }
        #confirmation-container input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.3);
        }

        /* Style Khusus untuk Instruksi Offline */
        .offline-instructions {
            padding: 15px;
            background-color: #fce4ec; 
            border: 1px solid #f8bbd0;
            border-radius: 5px;
            margin-top: 15px;
            color: #880e4f;
            text-align: left;
        }
        
        /* Style untuk Detail Tunggakan */
                #tunggakan-detail {
            font-size: 0.6em;
            text-align: left;
            margin-top: 5px;
            line-height: 1.5;
            color: #6c757d;
        }
        .tunggakan-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        .tunggakan-total {
            border-top: 2px solid #ccc;
            padding-top: 5px;
            margin-top: 5px;
            font-weight: bold;
            color: #dc3545; /* Merah untuk total */
        }



        /* ======================================= */
        /* === KOMPONEN TAMBAHAN === */
        /* ======================================= */
        .reset-button {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 10px 15px;
            background-color: #6c757d; 
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <div class="container" id="container-iuran">
        <div class="content-wrapper">
            <h1>üîç CEK & BAYAR KAS GANG E21-25 </h1>
            <p>silahkan cek data anda dengan memasukan nama / Blok-NO Rumah</p>
            <p style="font-size: 0.9em; color: #888;">Contoh: ROHMAN atau E21-51 </p>

            <form id="search-form">
                <input type="text" 
                id="search-input" 
                placeholder="Gang E21-25" required>
                <button type="submit"><i class="fas fa-search"></i> CARI</button>
            </form>

            <div class="loader" id="loader"></div>

            <div id="result-container" style="display:none;">
                <div id="status-message" class="status-message"></div>

                <div id="content-display">
                    <h3 style="color:#007bff;">Detail Iuran Kas: <span id="user-name"></span></h3>
                    
                    <div id="data-display"></div>

                    <div id="payment-summary">
                        <div class="total-info">
                            Total Belum Bayar: <span id="total-tunggakan">Rp 0</span>
                          
                            <div id="tunggakan-detail">
                                </div>
                        </div>
                      
                    </div>
                    
                    <div id="lunas-message">
                        <i class="fas fa-handshake"></i> Terima kasih, --Anda sudah membayar kas dengan lancar!---
                    </div>
                  
                     <div id="tunggakan-options">
                        <p style="margin-top:15px; font-style:italic;"></p> 

                        <button id="btn-show-manual" onclick="toggleManualPayment()">
                            <i class="fas fa-calendar-check"></i> BAYAR KAS SEKARANG
                        </button>
                    </div>
                </div>
            </div>

            <div id="manual-payment-section">
                <h3>üíµ Pembayaran Kas Gang E21-25</h3>
                <p>Bayar iuran spesifik untuk beberapa bulan sekaligus.</p>
                <hr style="border: 0; border-top: 1px solid #ccc; margin: 10px 0;">
                <p style="font-weight: bold;">Untuk: <span id="manual-user-detail" style="color:#ff5722;"></span></p>
                <p style="font-size: 0.9em; color: #6c757d;">(Iuran per bulan termasuk kas gang, kas RT, dan BSK : Rp 25.000)</p>

                <form id="payment-form-manual">
                    
                    <div class="form-group" style="text-align: left; background-color: #f7e8e8; padding: 10px; border-radius: 5px; border: 1px solid #dc3545;" id="group-tunggakan-2025">
                         <label for="tunggakan-2025-amount" style="font-weight: bold; color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> Tunggakan Tahun 2025</label>
                         <input type="text" id="tunggakan-2025-amount" readonly style="background-color: #fcecec; color: #dc3545; font-weight: bold; margin-bottom: 5px;">
                         <p style="font-style: italic; color: #721c24;">*Pembayaran akan otomatis melunasi Tunggakan 2025 ini terlebih dahulu.</p>
                    </div>

                    <div class="form-group" style="text-align: left; margin-top: 20px;">
                        <label for="manual-amount">Jumlah Pembayaran (Rp) Total Yang Disetor</label>
                        <input type="number" id="manual-amount" name="amount" min="1" step="1" required placeholder="Contoh: 25000" value="">
                        <p style="margin-top:3px; font-style:italic;" > </p>
                    </div>

                    <div class="form-group" style="text-align: left;">
                        <label for="manual-month">Detail Pelunasan</label>
                        <input type="text" id="manual-month" name="month" required readonly placeholder="Diisi otomatis..." style="background-color: #eee;">
                        <p style="margin-top:1px; font-style:italic;" ></p></p>
                    </div>

                    <div class="form-group" style="text-align: left;">
                        <label>Pilih Metode Pembayaran</label>
                        
                        <div class="radio-group">
                            <input type="radio" id="manual-qrcode" name="method" value="QR Code (QRIS)" checked>
                            <label for="manual-qrcode">QR Code (QRIS)</label>

                            <input type="radio" id="manual-banktransfer" name="method" value="Transfer Bank">
                            <label for="manual-banktransfer">Transfer Bank</label>
                            
                            <input type="radio" id="manual-offline" name="method" value="Offline (Tunai)">
                            <label for="manual-offline">Offline (Tunai)</label>
                        </div>
                    </div>

                    <button type="submit"><i class="fas fa-hand-holding-usd"></i>Lanjutkan Pembayaran
                    </button>
                </form>

                <div id="payment-result-manual">
                    <div id="payment-instruction-content"></div>

                    <hr style="margin: 20px 0;">

                    <div id="confirmation-container">
                        <input type="checkbox" id="proof-confirmation" required>
                        <label for="proof-confirmation" style="font-weight: bold; color: #dc3545;">Saya mengkonfirmasi sudah <span id="confirm-action">transfer</span> dan siap mengirimkan bukti via WhatsApp.</label>
                    </div>
                    
                    <button id="btn-whatsapp-proof" disabled>
                        <i class="fab fa-whatsapp"></i> Konfirmasi & Kirim Bukti Pembayaran
                    </button>
                </div>
                <button onclick="toggleManualPayment()" style="margin-top: 15px; padding: 10px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-chevron-left"></i> Kembali ke Data 
                </button>
                
            </div>


        </div>
      
    <script>
        // Data Dummy Sederhana (MODIFIKASI: Menambahkan tunggakan_2025)
        const DUMMY_DATA =
        [
            {
                id: 'E21-51',
                nama: 'ROHMAN',
               tunggakan_2025: 0, // Sudah lunas
                iuran: [
                    { bulan: 'JANUARI',nominal:   25000, status: 'LUNAS'}, // Diubah LUNAS
                    { bulan: 'FEBRUARI',nominal:25000, status: 'BLUM BAYAR'},
                    { bulan: 'MARET',nominal:25000, status: 'BLUM BAYAR'},
                    { bulan: 'APRIL',nominal:     25000, status: 'BLUM BAYAR'}, 
                    { bulan: 'MEI', nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JUNI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JULI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'AGUSTUS',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'SEPTEMBER',nominal: 25000, status: 'BLUM BAYAR'},
                    { bulan: 'OKTOBER',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'NOVEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                    { bulan: 'DESEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                ]
            },
            {
                id: 'E21-48',
                nama: 'NANA RUSMANA',
                tunggakan_2025: 75000, // Ada tunggakan 3 bulan (2025)
                iuran: [
                    { bulan: 'JANUARI',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'FEBRUARI',nominal:25000, status: 'BLUM BAYAR'},
                    { bulan: 'MARET',nominal:25000, status: 'BLUM BAYAR'},
                    { bulan: 'APRIL',nominal:     25000, status: 'BLUM BAYAR'}, 
                    { bulan: 'MEI', nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JUNI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JULI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'AGUSTUS',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'SEPTEMBER',nominal: 25000, status: 'BLUM BAYAR'},
                    { bulan: 'OKTOBER',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'NOVEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                    { bulan: 'DESEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                ]
            },
            {
                id: 'E25-23',
                nama: 'WALUYO',
                tunggakan_2025: 125000, // Ada tunggakan 5 bulan (2025)
                iuran: [
                    { bulan: 'JANUARI',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'FEBRUARI',nominal:25000, status: 'LUNAS'},
                    { bulan: 'MARET',nominal:25000, status: 'BLUM BAYAR'},
                    { bulan: 'APRIL',nominal:     25000, status: 'BLUM BAYAR'}, 
                    { bulan: 'MEI', nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JUNI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JULI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'AGUSTUS',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'SEPTEMBER',nominal: 25000, status: 'BLUM BAYAR'},
                    { bulan: 'OKTOBER',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'NOVEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                    { bulan: 'DESEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                ]
            },
            {
                id: 'E25-22',
                nama: 'BAYU NUR FAIZIN',
                tunggakan_2025: 0,
                iuran: [
                    { bulan: 'JANUARI',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'FEBRUARI',nominal:25000, status: 'LUNAS'},
                    { bulan: 'MARET',nominal:25000, status: 'LUNAS'},
                    { bulan: 'APRIL',nominal:     25000, status: 'LUNAS'}, 
                    { bulan: 'MEI', nominal:      25000, status: 'LUNAS'},
                    { bulan: 'JUNI',nominal:      25000, status: 'LUNAS'},
                    { bulan: 'JULI',nominal:      25000, status: 'LUNAS'},
                    { bulan: 'AGUSTUS',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'SEPTEMBER',nominal: 25000, status: 'LUNAS'},
                    { bulan: 'OKTOBER',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'NOVEMBER',nominal:  25000, status: 'LUNAS'},
                    { bulan: 'DESEMBER',nominal:  25000, status: 'LUNAS'},
                ]
            },
            {
                id: 'E25-26',
                nama: 'HADI',
                tunggakan_2025: 0,
                iuran: [
                    { bulan: 'JANUARI',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'FEBRUARI',nominal:25000, status: 'LUNAS'},
                    { bulan: 'MARET',nominal:25000, status: 'LUNAS'},
                    { bulan: 'APRIL',nominal:     25000, status: 'LUNAS'}, 
                    { bulan: 'MEI', nominal:      25000, status: 'LUNAS'},
                    { bulan: 'JUNI',nominal:      25000, status: 'LUNAS'},
                    { bulan: 'JULI',nominal:      25000, status: 'LUNAS'},
                    { bulan: 'AGUSTUS',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'SEPTEMBER',nominal: 25000, status: 'LUNAS'},
                    { bulan: 'OKTOBER',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'NOVEMBER',nominal:  25000, status: 'LUNAS'},
                    { bulan: 'DESEMBER',nominal:  25000, status: 'LUNAS'},
                ]
            },
            
        ];

        // --- VARIABEL DOM & STATE ---
        const IURAN_PER_BULAN = 25000; 
        const searchForm = document.getElementById('search-form');
        const loader = document.getElementById('loader');
        const resultContainer = document.getElementById('result-container'); 
        const contentDisplay = document.getElementById('content-display');
        const dataDisplay = document.getElementById('data-display');
        const userNameSpan = document.getElementById('user-name');
        const totalTunggakanSpan = document.getElementById('total-tunggakan');
        const statusMessageDiv = document.getElementById('status-message');
        const lunasMessageDiv = document.getElementById('lunas-message');
        const tunggakanOptionsDiv = document.getElementById('tunggakan-options');
        const btnShowManual = document.getElementById('btn-show-manual');
        const manualPaymentSection = document.getElementById('manual-payment-section'); 
        const manualPaymentForm = document.getElementById('payment-form-manual');
        const manualResultDiv = document.getElementById('payment-result-manual');
        const manualUserDetailSpan = document.getElementById('manual-user-detail');
        const manualAmountInput = document.getElementById('manual-amount'); 
        const manualMonthInput = document.getElementById('manual-month'); 
        
        const instructionContentDiv = document.getElementById('payment-instruction-content');
        const proofConfirmationCheckbox = document.getElementById('proof-confirmation');
        const btnWhatsappProof = document.getElementById('btn-whatsapp-proof');
        const confirmActionSpan = document.getElementById('confirm-action'); 
        
        // Elemen baru untuk detail tunggakan
        const tunggakanDetailDiv = document.getElementById('tunggakan-detail');
        
        // Elemen baru untuk Tunggakan 2025 di form manual
        const tunggakan2025Group = document.getElementById('group-tunggakan-2025');
        const tunggakan2025Input = document.getElementById('tunggakan-2025-amount');


        let currentTunggakanAmount = 0; 
        let currentUserId = ''; 
        let currentUserName = ''; 
        let currentTunggakanList = []; 
        
        // --- FUNGSI UTAMA PENCARIAN ---
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault(); 
            const query = document.getElementById('search-input').value.trim().toUpperCase();
            
            loader.style.display = 'block';
            resultContainer.style.display = 'none';
            manualPaymentSection.style.display = 'none'; 
            manualResultDiv.style.display = 'none';
            lunasMessageDiv.style.display = 'none'; 

            currentUserId = '';
            currentUserName = '';
            currentTunggakanList = [];
            
            if(proofConfirmationCheckbox) proofConfirmationCheckbox.checked = false; 
            btnWhatsappProof.disabled = true;
            btnWhatsappProof.classList.remove('active');

            setTimeout(() => {
                loader.style.display = 'none';

                const foundUser = DUMMY_DATA.find(user => 
                    user.id.toUpperCase() === query || user.nama.toUpperCase().includes(query)
                );
                
                if (foundUser) {
                    currentUserId = foundUser.id;
                    currentUserName = foundUser.nama;
                    displayUserData(foundUser);
                } else {
                    displayNotFound(query);
                }
                
                resultContainer.style.display = 'block'; 
            }, 1500); 
        });

        // --- FUNGSI MENAMPILKAN DATA (MODIFIKASI: Menghitung & Menampilkan Tunggakan 2025) ---
        function displayUserData(user) {
            statusMessageDiv.className = 'status-message status-found';
            statusMessageDiv.innerHTML = `‚úÖ Data Warga atas nama: ${user.nama} Ditemukan!`;
            contentDisplay.style.display = 'block';
           

            userNameSpan.textContent = user.nama + ' (' + user.id + ')';
            manualUserDetailSpan.textContent = user.nama + ' (' + user.id + ')'; 

            let htmlContent = '';
            currentTunggakanList = []; // Reset bulan 2026 yang belum bayar
            
            // 1. Tampilkan status LUNAS 
            user.iuran.filter(item => item.status === 'LUNAS').forEach(item => {
                const nominalIDR = item.nominal.toLocaleString('id-ID');
                
                htmlContent += `
                    <div class="data-item">
                        <span><strong>${item.bulan} (2026):</strong></span>
                        <span>Rp ${nominalIDR}</span>
                        <span class="lunas">LUNAS</span>
                    </div>
                `;
            });

            // 2. Kumpulkan bulan yang BLUM BAYAR (untuk 2026)
            user.iuran.filter(item => item.status === 'BLUM BAYAR').forEach(item => {
                currentTunggakanList.push(item.bulan);
            });
            
            // 3. Tampilkan bulan BLUM BAYAR yang pertama saja (jika ada)
            if (currentTunggakanList.length > 0) {
                const firstTunggakanMonth = currentTunggakanList[0];
                const nominalIDR = IURAN_PER_BULAN.toLocaleString('id-ID'); 
                
                htmlContent += `
                    <div class="data-item">
                        <span><strong>${firstTunggakanMonth} (2026):</strong></span>
                        <span>Rp ${nominalIDR}</span>
                        <span class="belum">BELUM BAYAR</span>
                    </div>
                `;
            }
            
            dataDisplay.innerHTML = htmlContent;
            
            // 4. Hitung Total Tunggakan Keseluruhan
            const tunggakan2026 = currentTunggakanList.length * IURAN_PER_BULAN;
            const tunggakan2025 = user.tunggakan_2025 || 0;
            let totalTunggakanSummary = tunggakan2025 + tunggakan2026;
            
            const totalInfoDiv = document.querySelector('.total-info');
            
            // 5. Update Tampilan Summary
            totalTunggakanSpan.textContent = 'Rp ' + totalTunggakanSummary.toLocaleString('id-ID');
            currentTunggakanAmount = totalTunggakanSummary; // Update global state
            
            let detailHtml = '';
            if (tunggakan2025 > 0) {
                detailHtml += `
                    <div class="tunggakan-line">
                        <span>Tunggakan Tahun 2025:</span> 
                        <span>Rp ${tunggakan2025.toLocaleString('id-ID')}</span>
                    </div>
                `;
            } else {
                 detailHtml += `
                    <div class="tunggakan-line">
                        <span>Tunggakan Tahun 2025:</span> 
                        <span>Rp 0 (LUNAS)</span>
                    </div>
                `;
            }
            
            detailHtml += `
                <div class="tunggakan-line">
                    <span>Bayar Periode 2026:</span> 
                    <span>Rp ${tunggakan2026.toLocaleString('id-ID')} (${currentTunggakanList.length} bulan)</span>
                </div>
                <div class="tunggakan-total tunggakan-line">
                    <span>TOTAL KESELURUHAN:</span> 
                    <span>Rp ${totalTunggakanSummary.toLocaleString('id-ID')}</span>
                </div>
            `;
            
            tunggakanDetailDiv.innerHTML = detailHtml;
            
            // 7. Update tampilan Tunggakan 2025 di Form Manual
            if (tunggakan2025 > 0) {
                tunggakan2025Input.value = `Rp ${tunggakan2025.toLocaleString('id-ID')}`;
                tunggakan2025Group.style.display = 'block';
                // Min bayar adalah tunggakan 2025, kecuali jika tunggakan 2026 ada
                manualAmountInput.min = (tunggakan2025 > 0) ? tunggakan2025 : IURAN_PER_BULAN; 
            } else {
                tunggakan2025Input.value = 'Rp 0 (LUNAS)';
                tunggakan2025Group.style.display = 'none';
                manualAmountInput.min = IURAN_PER_BULAN; // Minimal bayar 1 bulan 2026
            }

            
            // 6. Tentukan Tampilan Pilihan Bayar
            if (totalTunggakanSummary > 0) {
                tunggakanOptionsDiv.style.display = 'block'; 
                lunasMessageDiv.style.display = 'none';
                totalInfoDiv.style.backgroundColor = '#ffe8e8';
                totalInfoDiv.style.color = '#dc3545';
                
                // Set default amount untuk pembayaran manual
                if(tunggakan2025 > 0) {
                    manualAmountInput.value = tunggakan2025 + IURAN_PER_BULAN; // Default 1 bulan 2026 + Tunggakan 2025
                } else if (tunggakan2026 > 0) {
                    manualAmountInput.value = IURAN_PER_BULAN;
                }
                manualAmountInput.dispatchEvent(new Event('input')); // Trigger update bulan

            } else {
                // Semua Lunas
                tunggakanOptionsDiv.style.display = 'none'; 
                lunasMessageDiv.style.display = 'block';
                totalTunggakanSpan.textContent = 'Rp 0 (Semua Iuran Lunas!)';
                totalInfoDiv.style.backgroundColor = '#e6ffed';
                totalInfoDiv.style.color = '#1e7e34';
                tunggakanDetailDiv.innerHTML = ''; // Kosongkan detail jika lunas
            }
        }

        // --- Event Listener untuk Input Nominal (MODIFIKASI: Prioritas Tunggakan 2025) ---
        manualAmountInput.addEventListener('input', function() {
            const amount = parseInt(manualAmountInput.value);
            
            const userData = DUMMY_DATA.find(user => user.id === currentUserId);
            if (!userData) return;
            
            // Total tunggakan 2025 yang harus dibayar
            const tunggakan2025 = userData.tunggakan_2025 || 0;
            
            // 1. Validasi Input
            if (isNaN(amount) || amount < 1) {
                manualMonthInput.value = 'Masukkan jumlah pembayaran yang valid.';
                return;
            }
            
            // 2. Prioritas Tunggakan 2025
            let remainingAmount = amount;
            let detailPembayaran = '';
            let isTunggakan2025Paid = false;
            
            if (tunggakan2025 > 0) {
                if (amount >= tunggakan2025) {
                    // Bayar lunas tunggakan 2025
                    remainingAmount -= tunggakan2025;
                    detailPembayaran += `Lunas Tunggakan 2025 (Rp ${tunggakan2025.toLocaleString('id-ID')})`;
                    isTunggakan2025Paid = true;
                } else {
                    // Bayar sebagian tunggakan 2025
                    detailPembayaran += `BAYAR Sebagian Tunggakan 2025 (Rp ${amount.toLocaleString('id-ID')} dari Rp ${tunggakan2025.toLocaleString('id-ID')})`;
                    manualMonthInput.value = detailPembayaran;
                    return;
                }
            } else {
                isTunggakan2025Paid = true; // Sudah lunas dari awal
            }

            // 3. Pelunasan Iuran 2026 (hanya jika tunggakan 2025 sudah lunas atau tidak ada)
            if (isTunggakan2025Paid) {
                const monthsPaidFor2026 = Math.floor(remainingAmount / IURAN_PER_BULAN);
                const excessAmount = remainingAmount % IURAN_PER_BULAN;

                if (monthsPaidFor2026 > 0) {
                    const monthsToPay = currentTunggakanList.slice(0, monthsPaidFor2026);
                    
                    if (monthsToPay.length < monthsPaidFor2026) {
                        // Kelebihan bayar melebihi total bulan 2026 yang tersedia
                        const monthsAvailable = currentTunggakanList.length;
                        
                        detailPembayaran += (detailPembayaran ? ' & ' : '') + 
                                            `Bayar Iuran 2026: ${monthsToPay.length} bulan (${monthsToPay.join(', ')})`;
                        
                        const sisaUang = remainingAmount - (monthsAvailable * IURAN_PER_BULAN);
                        detailPembayaran += ` + KELEBIHAN bayar Rp ${sisaUang.toLocaleString('id-ID')}.`;
                        
                    } else {
                        // Normal: bayar sejumlah bulan 2026
                        detailPembayaran += (detailPembayaran ? ' & ' : '') + 
                                            `Bayar Iuran 2026: ${monthsToPay.length} bulan (${monthsToPay.join(', ')})`;
                    }

                } else if (remainingAmount > 0 && remainingAmount < IURAN_PER_BULAN) {
                    detailPembayaran += (detailPembayaran ? ' & ' : '') + 
                                        `Tidak cukup untuk Iuran 2026. SISA Rp ${remainingAmount.toLocaleString('id-ID')}.`;
                }
                
                // Tampilkan sisa/kelebihan bayar jika ada (kecuali kasus bayar sebagian 2026)
                if (excessAmount > 0 && monthsPaidFor2026 > 0) {
                     // Check if monthsToPay length is equal to monthsPaidFor2026, meaning no excess months, only cash excess
                     if (monthsToPay.length === monthsPaidFor2026) {
                        detailPembayaran += ` + SISA/LEBIH bayar Rp ${excessAmount.toLocaleString('id-ID')}.`;
                     }
                }
            }
            
            manualMonthInput.value = detailPembayaran;
        });
        
        // --- FUNGSI MENAMPILKAN/MENYEMBUNYIKAN FORM MANUAL (tetap sama) ---
        function toggleManualPayment() {
            const isManualVisible = manualPaymentSection.style.display === 'block';

            if (isManualVisible) {
                manualPaymentSection.style.display = 'none';
                resultContainer.style.display = 'block'; 
            } else {
                manualPaymentSection.style.display = 'block';
                resultContainer.style.display = 'none';
                
                // Reset amount input dan trigger update detail saat dibuka
                const userData = DUMMY_DATA.find(user => user.id === currentUserId);
                if (userData) {
                    const tunggakan2025 = userData.tunggakan_2025 || 0;
                    if(tunggakan2025 > 0) {
                        manualAmountInput.value = tunggakan2025 + IURAN_PER_BULAN; 
                    } else if (currentTunggakanList.length > 0) {
                        manualAmountInput.value = IURAN_PER_BULAN;
                    } else {
                        manualAmountInput.value = 0; // Jika sudah lunas semua
                    }
                    manualAmountInput.dispatchEvent(new Event('input'));
                }
            }

            manualResultDiv.style.display = 'none';

            if(proofConfirmationCheckbox) proofConfirmationCheckbox.checked = false; 
            btnWhatsappProof.disabled = true;
            btnWhatsappProof.classList.remove('active');
            confirmActionSpan.textContent = 'transfer'; 
        }
        
        // --- EVENT LISTENER UNTUK PILIHAN METODE PEMBAYARAN (tetap sama) ---
        document.querySelectorAll('#manual-payment-section input[name="method"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value.includes('Offline')) {
                    confirmActionSpan.textContent = 'serahkan uang tunai';
                } else {
                    confirmActionSpan.textContent = 'transfer';
                }
                
                if(proofConfirmationCheckbox) proofConfirmationCheckbox.checked = false;
                btnWhatsappProof.disabled = true;
                btnWhatsappProof.classList.remove('active');
            });
        });


        // --- EVENT LISTENER UNTUK CHECKBOX KONFIRMASI (tetap sama) ---
        proofConfirmationCheckbox.addEventListener('change', function() {
            if (proofConfirmationCheckbox.checked) {
                btnWhatsappProof.disabled = false;
                btnWhatsappProof.classList.add('active');
            } else {
                btnWhatsappProof.disabled = true;
                btnWhatsappProof.classList.remove('active');
            }
        });


        // --- FUNGSI SUBMIT PEMBAYARAN MANUAL (MODIFIKASI: Menggunakan Detail Pelunasan) ---
        manualPaymentForm.addEventListener('submit', function(e) {
            e.preventDefault(); 
            
            const amountInput = parseInt(document.getElementById('manual-amount').value);
            const userData = DUMMY_DATA.find(user => user.id === currentUserId);
            const tunggakan2025 = userData?.tunggakan_2025 || 0;
            const minAmount = (tunggakan2025 > 0) ? tunggakan2025 : IURAN_PER_BULAN;
            
            if (amountInput < minAmount) {
                 alert(`‚ùå Harap masukkan jumlah minimal Rp ${minAmount.toLocaleString('id-ID')}.`);
                 return;
            }
            
            if(proofConfirmationCheckbox) proofConfirmationCheckbox.checked = false; 
            btnWhatsappProof.disabled = true;
            btnWhatsappProof.classList.remove('active');

            const amount = amountInput;
            const detailPembayaran = document.getElementById('manual-month').value; 
            const method = document.querySelector('#manual-payment-section input[name="method"]:checked').value;
            
            // Tentukan bulan 2026 mana saja yang akan dilunasi (untuk update data dummy)
            let monthsToMarkLunas = [];
            const match = detailPembayaran.match(/Iuran 2026: \d+ bulan \((.*?)\)/);
            if (match && match[1]) {
                monthsToMarkLunas = match[1].split(',').map(m => m.trim());
            }

            // Set attribute untuk fungsi WA
            btnWhatsappProof.setAttribute('data-target-months-list', monthsToMarkLunas.join('.')); 
            btnWhatsappProof.setAttribute('data-detail-pembayaran', detailPembayaran); 

            manualResultDiv.style.display = 'block';
            
            const amountIDR = new Intl.NumberFormat('id-ID').format(amount);
            
            let htmlContent = `
                <h3><i class="fas fa-check-circle"></i> Instruksi Pembayaran Dibuat</h3>
                <p><strong>Warga:</strong> ${currentUserName} (${currentUserId})</p>
                <p><strong>Detail Pelunasan:</strong> <span style="font-weight: bold; color:#007bff;">${detailPembayaran}</span></p>
                <p><strong>Metode:</strong> ${method}</p>
                <p><strong>Jumlah:</strong> <span style="font-size: 1.2em; color: #dc3545; font-weight: bold;">Rp ${amountIDR}</span></p>
                <hr style="margin: 10px 0;">
            `;

            if (method === 'QR Code (QRIS)') {
                 htmlContent += `
                    <p style="text-align: center;">Scan QRIS di bawah ini menggunakan aplikasi pembayaran Anda (Dana, GoPay, Mobile Banking, dll.)</p>
                    <div class="qris-display">
                        <img src="qrcode.jpg" alt="QRIS Kas Gang E21/25" class="qrcode-image">
                    </div>
                `;
            } else if (method === 'Transfer Bank') {
                htmlContent += `
                    <div style="text-align: left;">
                        <p style="font-weight: bold; margin-top: 10px;">Pilih Salah Satu Rekening:</p>
                        <p><strong>Bank:</strong> MANDIRI</p>
                        <p><strong>Nomor Rekening:</strong> 1234-567-890</p>
                        <p><strong>Atas Nama:</strong> CANDRA</p>
                        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 10px 0;">
                        <p><strong>Bank:</strong> DANA (Transfer Virtual)</p>
                        <p><strong>Nomor Rekening:</strong> 0857-8125-6570</p>
                        <p><strong>Atas Nama:</strong> CANDRA</p>
                    </div>
                    <p style="color: red; font-weight: bold; margin-top: 15px;">**Penting:** untuk pembayaran dari semua akun bank ke DANA maka pembayaran di tambah 1000 </p>
                `; 
            } else if (method === 'Offline (Tunai)') {
                 htmlContent += `
                    <div class="offline-instructions">
                        <p style="font-weight: bold; font-size: 1.1em;"><i class="fas fa-hand-holding-usd"></i> Instruksi Pembayaran Tunai</p>
                        <p>Silakan serahkan uang tunai sebesar Rp ${amountIDR} langsung kepada:</p>
                        <ul>
                            <li><strong>Petugas:</strong> Bpk. Candra (Bendahara)</li>
                            <li><strong>Alamat:</strong> Rumah E25-09</li>
                            <li><strong>Waktu:</strong> di komfimasi dulu ke bendahara</li>
                        </ul>
                        <p style="font-style: italic;">**Penting:** Pastikan Anda menerima kwitansi atau bukti serah terima dari petugas. Konfirmasi WhatsApp wajib dilakukan setelah serah terima uang.</p>
                    </div>
                `;
            }

            instructionContentDiv.innerHTML = htmlContent;
            
            btnWhatsappProof.setAttribute('data-name', currentUserName);
            btnWhatsappProof.setAttribute('data-id', currentUserId);
            btnWhatsappProof.setAttribute('data-amount', amountIDR);
            btnWhatsappProof.setAttribute('data-month', detailPembayaran); 
            btnWhatsappProof.setAttribute('data-method', method);
            
            btnWhatsappProof.onclick = function() {
                sendProofViaWhatsApp(
                    this.getAttribute('data-name'),
                    this.getAttribute('data-id'),
                    this.getAttribute('data-amount'),
                    this.getAttribute('data-month'),
                    this.getAttribute('data-method'),
                    this.getAttribute('data-target-months-list') 
                );
            };
        });

        // --- FUNGSI WA INTEGRATION (MODIFIKASI: Update Data Dummy & Pesan WA) ---
        function sendProofViaWhatsApp(name, id, amountIDR, detailPembayaran, method, targetMonthsList) {
            
            if (!proofConfirmationCheckbox.checked) {
                 alert('‚ùå Anda harus mencentang konfirmasi pembayaran terlebih dahulu.');
                 return;
            }

            const monthsToMarkLunas = targetMonthsList.split('.').filter(m => m !== ''); // Filter bulan 2026
            const amount = parseInt(amountIDR.replace(/[^0-9]/g, '')); // Bersihkan format IDR

            // 1. UPDATE DUMMY_DATA 
            const userIndex = DUMMY_DATA.findIndex(user => user.id === id);
            if (userIndex !== -1) {
                const userData = DUMMY_DATA[userIndex];
                let totalDibayar = amount;
                
                // Cek pelunasan Tunggakan 2025
                if (userData.tunggakan_2025 > 0) {
                    if (totalDibayar >= userData.tunggakan_2025) {
                        totalDibayar -= userData.tunggakan_2025;
                        userData.tunggakan_2025 = 0; // Lunas Tunggakan 2025
                    } else {
                        userData.tunggakan_2025 -= totalDibayar; // Bayar sebagian
                        totalDibayar = 0;
                    }
                }
                
                // Pelunasan Iuran 2026 (berdasarkan bulan yang teridentifikasi)
                if (totalDibayar >= IURAN_PER_BULAN && monthsToMarkLunas.length > 0) {
                    monthsToMarkLunas.forEach(targetMonth => {
                        const iuranItem = userData.iuran.find(item => item.bulan === targetMonth && item.status === 'BLUM BAYAR');
                        if (iuranItem) {
                            iuranItem.status = 'LUNAS'; // Tandai sebagai sudah dibayar/menunggu verifikasi
                        }
                    });
                }
                
                DUMMY_DATA[userIndex] = userData;
            }

            // 2. RE-RENDER TAMPILAN
            const updatedUser = DUMMY_DATA.find(user => user.id === id);
            if (updatedUser) {
                displayUserData(updatedUser); 
            }
            
            toggleManualPayment();

            // 3. KIRIM PESAN WHATSAPP 
            const phoneNumber = '6285781256570'; 
            
            let paymentActionText = 'bukti transfer';
            if (method === 'Offline (Tunai)') {
                 paymentActionText = 'konfirmasi serah terima uang tunai';
            }
            
            const message = `*Konfirmasi Pembayaran Kas gang E21-25*\n\n` +
                            `Nama: *${name}* (BLOK: ${id})\n` +
                            `Detail Pelunasan: *${detailPembayaran}*\n` + 
                            `Jumlah: *Rp ${amountIDR}*\n` +
                            `Metode: *${method}*\n\n` +
                            `*PENTING:* Kirim ${paymentActionText} di chat ini* untuk diverifikasi.\n\n` +
                            `*Status terkini di aplikasi: Sudah LUNAS (Menunggu Verifikasi).*`;
                            
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappURL, '_blank');
        }


        // --- FUNGSI NOT FOUND (tetap sama) ---
        function displayNotFound(query) {
            statusMessageDiv.className = 'status-message status-not-found';
            statusMessageDiv.innerHTML = `‚ùå Data untuk ${query} Tidak Ditemukan.`;
            contentDisplay.style.display = 'none';
            dataDisplay.innerHTML = '';
            tunggakanOptionsDiv.style.display = 'none';
            lunasMessageDiv.style.display = 'none';
        }

        // --- FUNGSI RESET UNIVERSAL (tetap sama) ---
        function resetContainer(containerId) {
            if (containerId === 'container-iuran') {
                document.getElementById('search-form').reset();
                document.getElementById('search-input').value = '';
                document.getElementById('result-container').style.display = 'none';
                document.getElementById('loader').style.display = 'none';
                manualPaymentSection.style.display = 'none';
                manualResultDiv.style.display = 'none';
                tunggakanOptionsDiv.style.display = 'none';
                lunasMessageDiv.style.display = 'none';
                
                currentTunggakanAmount = 0;
                currentUserId = '';
                currentUserName = '';
                currentTunggakanList = [];
                
                if(proofConfirmationCheckbox) proofConfirmationCheckbox.checked = false; 
                btnWhatsappProof.disabled = true;
                btnWhatsappProof.classList.remove('active');
                
                window.location.reload(); 
            }
        }

        // Panggil event input saat form manual pertama kali dibuka
        manualAmountInput.addEventListener('focus', function() {
            if (manualAmountInput.value === '') {
                const userData = DUMMY_DATA.find(user => user.id === currentUserId);
                if (userData) {
                    const tunggakan2025 = userData.tunggakan_2025 || 0;
                    if(tunggakan2025 > 0) {
                        manualAmountInput.value = tunggakan2025 + IURAN_PER_BULAN; 
                    } else if (currentTunggakanList.length > 0) {
                        manualAmountInput.value = IURAN_PER_BULAN;
                    } else {
                        manualAmountInput.value = 0;
                    }
                }
                manualAmountInput.dispatchEvent(new Event('input'));
            }
        });
    </script>

</body>
</html>
