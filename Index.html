<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Iuran Warga & Pembayaran Kas (Terintegrasi)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* (CSS tetap sama seperti kode sebelumnya) */
        /* ======================================= */
        /* === CSS UMUM & FULL LAYAR === */
        /* ======================================= */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            padding: 0;
            margin: 0;
            text-align: center;
        }
        .container {
            width: 90%;
            min-height: 100vh;
            margin: 0 auto;
            background: white;
            padding: 30px 15px;
            box-shadow: none; 
            position: relative;
        }
        .content-wrapper {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 1.8em;
            color: #ff5722;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        /* ======================================= */
        /* === Search & Result Styling === */
        /* ======================================= */
        #search-form {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        #search-form input[type="text"] {
            flex-grow: 1; 
            max-width: 50%;
            padding: 12px;
            border: 2px solid #ccc;
            border-radius: 8px 0 0 8px;
            font-size: 1em;
        }
        #search-form button {
            width: 100px;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #result-container {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: left;
        }
        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
            /* Mengurangi padding untuk kerapian tampilan default */
        }
        .data-item .lunas { color: #28a745; font-weight: bold; }
        .data-item .belum { color: #dc3545; font-weight: bold; }
        .total-info {
            margin-top: 20px;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 4px;
            text-align: center;
        }
        /* Style untuk pesan lunas */
        #lunas-message {
            padding: 15px;
            margin-top: 20px;
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            font-weight: bold;
            display: none;
        }
        
        /* ======================================= */
        /* === Manual Payment Integration === */
        /* ======================================= */
        #btn-show-manual {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background-color: red;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #btn-show-manual:hover {
            background-color: Blue;
        }
        #manual-payment-section {
            margin-top: 25px;
            padding: 20px;
            border: 1px dashed #007bff;
            border-radius: 8px;
            background-color: #f8fafd;
            display: none;
            text-align: center;
        }
        #payment-form-manual input[type="number"],
        #payment-form-manual input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        /* TOMBOL LANJUTKAN PEMBAYARAN (Perubahan sesuai permintaan) */
        #payment-form-manual button {
            width: 100%;
            padding: 15px; /* Dibuat lebih besar */
            margin-top: 25px; /* Jarak atas lebih besar */
            margin-bottom: 10px; /* Jarak bawah (sesuai permintaan turun ke bawah) */
            background-color: #ff5722; /* Warna lebih menonjol (Orange/Merah terang) */
            color: white;
            border: none;
            border-radius: 8px; /* Border radius lebih besar */
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em; /* Ukuran teks lebih besar */
            transition: background-color 0.3s, transform 0.2s;
        }

        #payment-form-manual button:hover {
            background-color: #e64a19; /* Warna hover sedikit lebih gelap */
            transform: translateY(-1px); /* Efek visual saat di-hover */
        }
        
        /* Style untuk input file agar lebih rapi */
        /* INPUT FILE TELAH DIHAPUS */

        #payment-result-manual { 
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #28a745;
            background-color: #e6ffed;
            text-align: left;
            display: none;
        }
        
        /* Tombol WA yang disembunyikan/dinonaktifkan */
        #btn-whatsapp-proof {
            margin-top: 15px;
            width: 100%;
            padding: 12px;
            background-color: #ccc; /* Warna default nonaktif */
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: not-allowed;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #btn-whatsapp-proof.active {
            background-color: #25d366; /* Warna aktif */
            cursor: pointer;
        }

        /* Style QRIS Image Container */
        .qris-display {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #ccc;
            
        }
        .qris-display img {
            max-width: 90%;
            height: auto;
            border-radius: 5px;
        }
        /* Style untuk Checkbox Konfirmasi */
        #confirmation-container {
            margin: 15px 0;
            padding: 10px;
            background-color: #fff3cd; /* Warna kuning lembut */
            border: 1px solid #ffeeba;
            border-radius: 5px;
            text-align: left;
            display: flex;
            align-items: center;
        }
        #confirmation-container input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.3);
        }

        /* ======================================= */
        /* === KOMPONEN TAMBAHAN === */
        /* ======================================= */
        .reset-button {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 10px 15px;
            background-color: #6c757d; 
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <div class="container" id="container-iuran">
        <div class="content-wrapper">
            <h1>üîç CEK & BAYAR KAS GANG E21-25 </h1>
            <p>silahkan cek data anda dengan memasukan nama / Blok-NO Rumah</p>
            <p style="font-size: 0.9em; color: #888;">Contoh: ROHMAN atau E21-51 </p>

            <form id="search-form">
                <input type="text" 
                id="search-input" 
                placeholder="Gang E21-25" required>
                <button type="submit"><i class="fas fa-search"></i> CARI</button>
            </form>

            <div class="loader" id="loader"></div>

            <div id="result-container" style="display:none;">
                <div id="status-message" class="status-message"></div>

                <div id="content-display">
                    <h3 style="color:#007bff;">Detail Iuran Kas: <span id="user-name"></span></h3>
                    
                    <div id="data-display"></div>

                    <div id="payment-summary">
                        <div class="total-info">
                            Total belum bayar preode 2026: <span id="total-tunggakan">Rp 0</span>
                        </div>
                    </div>
                    
                    <div id="lunas-message">
                        <i class="fas fa-handshake"></i> Terima kasih, --Anda sudah membayar kas dengan lancar!---
                    </div>
                    
                    <div id="tunggakan-options">
                        <p style="margin-top:15px; font-style:italic;">--- Pilihan Pembayaran ---</p>

                        <button id="btn-show-manual" onclick="toggleManualPayment()">
                            <i class="fas fa-calendar-check"></i> BAYAR KAS SEKARANG
                        </button>
                    </div>
                </div>
            </div>

            <div id="manual-payment-section">
                <h3>üíµ Pembayaran kas Gang E21-25</h3>
                <p>Bayar iuran spesifik untuk beberapa bulan sekaligus.</p>
                <hr style="border: 0; border-top: 1px solid #ccc; margin: 10px 0;">
                <p style="font-weight: bold;">Untuk: <span id="manual-user-detail" style="color:#ff5722;"></span></p>
                <p style="font-size: 0.9em; color: #6c757d;">(Iuran per bulan termasuk kas gang, kas RT, dan BSK : Rp 25.000)</p>

                <form id="payment-form-manual">

                    <div class="form-group" style="text-align: left;">
                        <label for="manual-amount">Jumlah Pembayaran (Rp)</label>
                        <input type="number" id="manual-amount" name="amount" min="25000" step="25000" required placeholder="Contoh: 50000 (untuk 2 bulan)" value="">
                        <p style="margin-top:3px; font-style:italic;" >Masukan angka kelipatan Rp 25.000</p>
                    </div>

                    <div class="form-group" style="text-align: left;">
                        <label for="manual-month">Bulan Pembayaran yang Akan Dilunasi</label>
                        <input type="text" id="manual-month" name="month" required readonly placeholder="Diisi otomatis..." style="background-color: #eee;">
                        <p style="margin-top:1px; font-style:italic;" >Ini adalah bulan-bulan yang akan ditandai LUNAS.</p>
                    </div>

                    <div class="form-group" style="text-align: left;">
                        <label>Pilih Metode Pembayaran</label>
                        
                        <div class="radio-group">
                            <input type="radio" id="manual-qrcode" name="method" value="QR Code (QRIS)" checked>
                            <label for="manual-qrcode">QR Code (QRIS)</label>

                            <input type="radio" id="manual-banktransfer" name="method" value="Transfer Bank">
                            <label for="manual-banktransfer">Transfer Bank</label>
                        </div>
                    </div>

                    <button type="submit"><i class="fas fa-hand-holding-usd"></i> Lanjutkan Pembayaran
                    </button>
                </form>

                <div id="payment-result-manual">
                    <div id="payment-instruction-content"></div>

                    <hr style="margin: 20px 0;">

                    <div id="confirmation-container">
                        <input type="checkbox" id="proof-confirmation" required>
                        <label for="proof-confirmation" style="font-weight: bold; color: #dc3545;">Saya mengkonfirmasi sudah transfer dan siap mengirimkan bukti via WhatsApp.</label>
                    </div>
                    
                    <button id="btn-whatsapp-proof" disabled>
                        <i class="fab fa-whatsapp"></i> Konfirmasi & Kirim Bukti Transfer
                    </button>
                </div>
                <button onclick="toggleManualPayment()" style="margin-top: 15px; padding: 10px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-chevron-left"></i> Kembali ke Data 
                </button>
                
            </div>


        </div>
      
    <script>
        // Data Dummy Sederhana
        const DUMMY_DATA = [
            {
                id: 'E21-51',
                nama: 'ROHMAN',
              
                iuran: [
                    { bulan: 'JANUARI',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'FEBRUARI',nominal:  25000, status: 'LUNAS'},
                    { bulan: 'MARET',nominal:     25000, status: 'BLUM BAYAR'},
                    { bulan: 'APRIL',nominal:     25000, status: 'BLUM BAYAR'}, 
                    { bulan: 'MEI', nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JUNI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JULI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'AGUSTUS',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'SEPTEMBER',nominal: 25000, status: 'BLUM BAYAR'},
                    { bulan: 'OKTOBER',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'NOVEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                    { bulan: 'DESEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                ]
            },
            {
                id: 'E21-48',
                nama: 'NANA RUSMANA',
                iuran: [
                    { bulan: 'JANUARI',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'FEBRUARI',nominal:25000, status: 'BLUM BAYAR'},
                    { bulan: 'MARET',nominal:25000, status: 'BLUM BAYAR'},
                    { bulan: 'APRIL',nominal:     25000, status: 'BLUM BAYAR'}, 
                    { bulan: 'MEI', nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JUNI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JULI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'AGUSTUS',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'SEPTEMBER',nominal: 25000, status: 'BLUM BAYAR'},
                    { bulan: 'OKTOBER',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'NOVEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                    { bulan: 'DESEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                ]
            },
            {
                id: 'E25-23',
                nama: 'WALUYO',
                iuran: [
                    { bulan: 'JANUARI',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'FEBRUARI',nominal:25000, status: 'LUNAS'},
                    { bulan: 'MARET',nominal:25000, status: 'LUNAS'},
                    { bulan: 'APRIL',nominal:     25000, status: 'LUNAS'}, 
                    { bulan: 'MEI', nominal:      25000, status: 'LUNAS'},
                    { bulan: 'JUNI',nominal:      25000, status: 'LUNAS'},
                    { bulan: 'JULI',nominal:      25000, status: 'LUNAS'},
                    { bulan: 'AGUSTUS',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'SEPTEMBER',nominal: 25000, status: 'BLUM BAYAR'},
                    { bulan: 'OKTOBER',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'NOVEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                    { bulan: 'DESEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                ]
            },
            {
                id: 'E25-22',
                nama: 'BAYU NUR FAIZIN',
                iuran: [
                    { bulan: 'JANUARI',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'FEBRUARI',nominal:25000, status: 'LUNAS'},
                    { bulan: 'MARET',nominal:25000, status: 'LUNAS'},
                    { bulan: 'APRIL',nominal:     25000, status: 'LUNAS'}, 
                    { bulan: 'MEI', nominal:      25000, status: 'LUNAS'},
                    { bulan: 'JUNI',nominal:      25000, status: 'LUNAS'},
                    { bulan: 'JULI',nominal:      25000, status: 'LUNAS'},
                    { bulan: 'AGUSTUS',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'SEPTEMBER',nominal: 25000, status: 'LUNAS'},
                    { bulan: 'OKTOBER',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'NOVEMBER',nominal:  25000, status: 'LUNAS'},
                    { bulan: 'DESEMBER',nominal:  25000, status: 'LUNAS'},
                ]
            }
        ];

        // --- VARIABEL DOM & STATE ---
        const IURAN_PER_BULAN = 25000; // Konstanta untuk iuran bulanan
        const searchForm = document.getElementById('search-form');
        const loader = document.getElementById('loader');
        const resultContainer = document.getElementById('result-container'); // Kontainer Hasil Pencarian
        const contentDisplay = document.getElementById('content-display');
        const dataDisplay = document.getElementById('data-display');
        const userNameSpan = document.getElementById('user-name');
        const totalTunggakanSpan = document.getElementById('total-tunggakan');
        const statusMessageDiv = document.getElementById('status-message');
        const lunasMessageDiv = document.getElementById('lunas-message');
        const tunggakanOptionsDiv = document.getElementById('tunggakan-options');
        const btnShowManual = document.getElementById('btn-show-manual');
        const manualPaymentSection = document.getElementById('manual-payment-section'); // Kontainer Pembayaran Manual
        const manualPaymentForm = document.getElementById('payment-form-manual');
        const manualResultDiv = document.getElementById('payment-result-manual');
        const manualUserDetailSpan = document.getElementById('manual-user-detail');
        const manualAmountInput = document.getElementById('manual-amount'); // Input Nominal
        const manualMonthInput = document.getElementById('manual-month'); // Input Bulan (Otomatis)
        
        // Elemen DOM Baru untuk Integrasi
        const instructionContentDiv = document.getElementById('payment-instruction-content');
        // MODIFIKASI: proofUploadInput diganti menjadi proofConfirmationCheckbox
        const proofConfirmationCheckbox = document.getElementById('proof-confirmation');
        const btnWhatsappProof = document.getElementById('btn-whatsapp-proof');

        let currentTunggakanAmount = 0; 
        let currentUserId = ''; 
        let currentUserName = ''; 
        let currentTunggakanList = []; // List bulan yang BLUM BAYAR
        
        // --- FUNGSI UTAMA PENCARIAN ---
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault(); 
            const query = document.getElementById('search-input').value.trim().toUpperCase();
            
            loader.style.display = 'block';
            resultContainer.style.display = 'none';
            manualPaymentSection.style.display = 'none'; 
            manualResultDiv.style.display = 'none';
            lunasMessageDiv.style.display = 'none'; 

            // Reset state user & manual payment
            currentUserId = '';
            currentUserName = '';
            currentTunggakanList = [];
            
            // MODIFIKASI: Reset checkbox
            if(proofConfirmationCheckbox) proofConfirmationCheckbox.checked = false; 
            btnWhatsappProof.disabled = true;
            btnWhatsappProof.classList.remove('active');

            setTimeout(() => {
                loader.style.display = 'none';

                const foundUser = DUMMY_DATA.find(user => 
                    user.id.toUpperCase() === query || user.nama.toUpperCase().includes(query)
                );
                
                if (foundUser) {
                    currentUserId = foundUser.id;
                    currentUserName = foundUser.nama;
                    displayUserData(foundUser);
                } else {
                    displayNotFound(query);
                }
                
                resultContainer.style.display = 'block'; 
            }, 1500); 
        });

        // --- FUNGSI MENAMPILKAN DATA (tetap sama) ---
        function displayUserData(user) {
            statusMessageDiv.className = 'status-message status-found';
            statusMessageDiv.innerHTML = `‚úÖ Data Warga atas nama: ${user.nama} Ditemukan!`;
            contentDisplay.style.display = 'block';

            userNameSpan.textContent = user.nama + ' (' + user.id + ')';
            manualUserDetailSpan.textContent = user.nama + ' (' + user.id + ')'; 

            let htmlContent = '';
            currentTunggakanAmount = 0;
            currentTunggakanList = [];
            let foundTunggakan = false; 

            user.iuran.forEach(item => {
                const statusClass = item.status === 'LUNAS' ? 'lunas' : 'belum';
                const statusText = item.status === 'LUNAS' ? 'LUNAS' : 'BELUM BAYAR';
                const nominalIDR = item.nominal.toLocaleString('id-ID');
                
                // Kumpulkan semua bulan BLUM BAYAR
                if (item.status === 'BLUM BAYAR') {
                    currentTunggakanList.push(item.bulan);
                }

                // Tampilkan bulan yang sudah LUNAS
                if (item.status === 'LUNAS') {
                    htmlContent += `
                        <div class="data-item">
                            <span><strong>${item.bulan}:</strong></span>
                            <span>Rp ${nominalIDR}</span>
                            <span class="${statusClass}">${statusText}</span>
                        </div>
                    `;
                }
            });
            
            // Tampilkan bulan BLUM BAYAR yang pertama saja (jika ada)
            if (currentTunggakanList.length > 0) {
                const firstTunggakanMonth = currentTunggakanList[0];
                const nominalIDR = IURAN_PER_BULAN.toLocaleString('id-ID'); // Ambil nominal dari konstanta
                
                htmlContent += `
                    <div class="data-item">
                        <span><strong>${firstTunggakanMonth}:</strong></span>
                        <span>Rp ${nominalIDR}</span>
                        <span class="belum">BELUM BAYAR</span>
                    </div>
                `;
            }
            
            dataDisplay.innerHTML = htmlContent;
            
            // Hitung total tunggakan untuk summary di bawah
            let totalTunggakanSummary = currentTunggakanList.length * IURAN_PER_BULAN;

            totalTunggakanSpan.textContent = 'Rp ' + totalTunggakanSummary.toLocaleString('id-ID');

            const totalInfoDiv = document.querySelector('.total-info');
            
            if (totalTunggakanSummary > 0) {
                // Ada tunggakan
                tunggakanOptionsDiv.style.display = 'block'; 
                lunasMessageDiv.style.display = 'none';
                totalInfoDiv.style.backgroundColor = '#ffe8e8';
                totalInfoDiv.style.color = '#dc3545';
                
                // Set default amount dan month di form pembayaran manual
                if(currentTunggakanList.length > 0) {
                    manualAmountInput.value = IURAN_PER_BULAN; // Default 1 bulan
                    // manualMonthInput akan dihitung otomatis saat ada input
                }

            } else {
                // Semua Lunas
                tunggakanOptionsDiv.style.display = 'none'; 
                lunasMessageDiv.style.display = 'block';
                totalTunggakanSpan.textContent = 'Rp 0 (Semua Iuran Lunas!)';
                totalInfoDiv.style.backgroundColor = '#e6ffed';
                totalInfoDiv.style.color = '#1e7e34';
            }
        }

        // --- Event Listener untuk Input Nominal (tetap sama) ---
        manualAmountInput.addEventListener('input', function() {
            const amount = parseInt(manualAmountInput.value);
            
            if (isNaN(amount) || amount < IURAN_PER_BULAN) {
                manualMonthInput.value = '';
                return;
            }
            
            // Pastikan nominal kelipatan iuran per bulan
            if (amount % IURAN_PER_BULAN !== 0) {
                 manualMonthInput.value = `Jumlah bukan kelipatan Rp ${IURAN_PER_BULAN.toLocaleString('id-ID')}`;
                 return;
            }

            const numMonths = amount / IURAN_PER_BULAN;
            
            // Ambil daftar bulan yang akan dibayar (max sejumlah tunggakan)
            const monthsToPay = currentTunggakanList.slice(0, numMonths);
            
            if (monthsToPay.length < numMonths) {
                 // Nominal kelebihan, beri peringatan
                 const excess = numMonths - monthsToPay.length;
                 manualMonthInput.value = `Maks. tunggakan: ${currentTunggakanList.length} bulan. Kelebihan: ${excess} bulan.`;
                 return;
            }
            
            // Format bulan: JANUARI.FEBRUARI (sesuai permintaan sebelumnya)
            manualMonthInput.value = monthsToPay.join('.');
        });
        
        // --- FUNGSI MENAMPILKAN/MENYEMBUNYIKAN FORM MANUAL ---
        function toggleManualPayment() {
            const isManualVisible = manualPaymentSection.style.display === 'block';

            if (isManualVisible) {
                // Kembali ke hasil pencarian
                manualPaymentSection.style.display = 'none';
                resultContainer.style.display = 'block'; 
            } else {
                // Pindah ke pembayaran manual
                manualPaymentSection.style.display = 'block';
                resultContainer.style.display = 'none';
                
                // Panggil event input sekali untuk mengisi bulan default (1 bulan)
                manualAmountInput.dispatchEvent(new Event('input'));
            }

            manualResultDiv.style.display = 'none';

            // MODIFIKASI: Reset checkbox
            if(proofConfirmationCheckbox) proofConfirmationCheckbox.checked = false; 
            btnWhatsappProof.disabled = true;
            btnWhatsappProof.classList.remove('active');
        }

        // --- EVENT LISTENER UNTUK CHECKBOX KONFIRMASI ---
        proofConfirmationCheckbox.addEventListener('change', function() {
            // Aktifkan tombol WA jika checkbox dicentang
            if (proofConfirmationCheckbox.checked) {
                btnWhatsappProof.disabled = false;
                btnWhatsappProof.classList.add('active');
            } else {
                btnWhatsappProof.disabled = true;
                btnWhatsappProof.classList.remove('active');
            }
        });


        // --- FUNGSI SUBMIT PEMBAYARAN MANUAL ---
        manualPaymentForm.addEventListener('submit', function(e) {
            e.preventDefault(); 
            
            // Validasi bulan terisi (otomatis dari input event)
            if (manualMonthInput.value.includes('kelipatan') || manualMonthInput.value.includes('Maks')) {
                alert('‚ùå Harap koreksi Jumlah Pembayaran. Jumlah harus kelipatan Rp 25.000 dan tidak melebihi total tunggakan.');
                return;
            }
            
            // MODIFIKASI: Reset checkbox (walaupun harusnya sudah false di toggle)
            if(proofConfirmationCheckbox) proofConfirmationCheckbox.checked = false; 
            btnWhatsappProof.disabled = true;
            btnWhatsappProof.classList.remove('active');

            const amount = document.getElementById('manual-amount').value;
            const monthsPaidList = document.getElementById('manual-month').value; // Ambil daftar bulan (Contoh: JANUARI.FEBRUARI)
            const method = document.querySelector('#manual-payment-section input[name="method"]:checked').value;
            
            // Simpan daftar bulan yang dilunasi ke atribut tombol WA
            btnWhatsappProof.setAttribute('data-target-months-list', monthsPaidList);

            manualResultDiv.style.display = 'block';
            
            const amountIDR = new Intl.NumberFormat('id-ID').format(amount);
            
            let htmlContent = `
                <h3><i class="fas fa-check-circle"></i> Instruksi Pembayaran Dibuat</h3>
                <p><strong>Warga:</strong> ${currentUserName} (${currentUserId})</p>
                <p><strong>Untuk Bulan:</strong> <span style="font-weight: bold; color:#007bff;">${monthsPaidList.replace(/\./g, ', ')}</span></p>
                <p><strong>Metode:</strong> ${method}</p>
                <p><strong>Jumlah:</strong> <span style="font-size: 1.2em; color: #dc3545; font-weight: bold;">Rp ${amountIDR}</span></p>
                <hr style="margin: 10px 0;">
            `;

            if (method === 'QR Code (QRIS)') {
                 htmlContent += `
                    <p style="text-align: center;">Scan QRIS di bawah ini menggunakan aplikasi pembayaran Anda (Dana, GoPay, Mobile Banking, dll.)</p>
                    <div class="qris-display">
                        <img src="qrcode.jpg" alt="QRIS Kas Gang E21/25" class="qrcode-image">
                    </div>
                `;
            } else if (method === 'Transfer Bank') {
                htmlContent += `
                    <div style="text-align: left;">
                        <p style="font-weight: bold; margin-top: 10px;">Pilih Salah Satu Rekening:</p>
                        <p><strong>Bank:</strong> MANDIRI</p>
                        <p><strong>Nomor Rekening:</strong> 1234-567-890</p>
                        <p><strong>Atas Nama:</strong> CANDRA</p>
                        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 10px 0;">
                        <p><strong>Bank:</strong> DANA (Transfer Virtual)</p>
                        <p><strong>Nomor Rekening:</strong> 0857-8125-6570</p>
                        <p><strong>Atas Nama:</strong> CANDRA</p>
                    </div>
                    <p style="color: red; font-weight: bold; margin-top: 15px;">**Penting:** untuk pembayaran dari semua akun bank ke DANA maka pembayaran di tambah 1000 </p>
                `; 
            }

            instructionContentDiv.innerHTML = htmlContent;
            
            // Set data pada tombol WA
            btnWhatsappProof.setAttribute('data-name', currentUserName);
            btnWhatsappProof.setAttribute('data-id', currentUserId);
            btnWhatsappProof.setAttribute('data-amount', amountIDR);
            btnWhatsappProof.setAttribute('data-month', monthsPaidList.replace(/\./g, ', ')); // Kirim ke WA dengan koma
            btnWhatsappProof.setAttribute('data-method', method);
            
            // Tambahkan event listener untuk tombol WhatsApp (dilakukan setelah data di set)
            btnWhatsappProof.onclick = function() {
                sendProofViaWhatsApp(
                    this.getAttribute('data-name'),
                    this.getAttribute('data-id'),
                    this.getAttribute('data-amount'),
                    this.getAttribute('data-month'),
                    this.getAttribute('data-method'),
                    this.getAttribute('data-target-months-list') // Kirim daftar bulan target (dengan titik)
                );
            };
        });

        // --- FUNGSI WA INTEGRATION (MODIFIKASI: Menghapus Validasi File) ---
        function sendProofViaWhatsApp(name, id, amountIDR, monthDisplay, method, targetMonthsList) {
            
            // MODIFIKASI: Validasi hanya cek checkbox
            if (!proofConfirmationCheckbox.checked) {
                 alert('‚ùå Anda harus mencentang konfirmasi pembayaran terlebih dahulu.');
                 return;
            }

            const monthsToMarkLunas = targetMonthsList.split('.');

            // 1. UPDATE DUMMY_DATA
            const userIndex = DUMMY_DATA.findIndex(user => user.id === id);
            if (userIndex !== -1) {
                monthsToMarkLunas.forEach(targetMonth => {
                    const iuranItem = DUMMY_DATA[userIndex].iuran.find(item => item.bulan === targetMonth && item.status === 'BLUM BAYAR');
                    if (iuranItem) {
                        iuranItem.status = 'LUNAS'; // Ubah status menjadi LUNAS (Status 'Menunggu Verifikasi')
                    }
                });
            }

            // 2. RE-RENDER TAMPILAN
            const updatedUser = DUMMY_DATA.find(user => user.id === id);
            if (updatedUser) {
                displayUserData(updatedUser); 
            }
            
            // Sembunyikan form pembayaran manual dan tampilkan kembali hasil pencarian
            toggleManualPayment();


            // 3. KIRIM PESAN WHATSAPP (MODIFIKASI: Pesan lebih jelas soal pengiriman bukti manual)
            const phoneNumber = '6285781256570'; 
            const message = `*Konfirmasi Pembayaran Kas gang E21-25*\n\n` +
                            `Nama: *${name}* (ID: ${id})\n` +
                            `Bulan yang dibayar: *${monthDisplay}*\n` +
                            `Jumlah: *Rp ${amountIDR}*\n` +
                            `Metode: *${method}*\n\n` +
                            `*PENTING:*lampirkan bukti transfer di chat ini* untuk diverifikasi.\n\n` +
                            `*Status terkini di aplikasi: ${monthDisplay} sudah LUNAS (Menunggu Verifikasi).*`;
                            
            const whatsappURL = `https://wa.me/${+6285781256570}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappURL, '_blank');
        }


        // --- FUNGSI NOT FOUND (tetap sama) ---
        function displayNotFound(query) {
            statusMessageDiv.className = 'status-message status-not-found';
            statusMessageDiv.innerHTML = `‚ùå Data untuk ${query} Tidak Ditemukan.`;
            contentDisplay.style.display = 'none';
            dataDisplay.innerHTML = '';
            tunggakanOptionsDiv.style.display = 'none';
            lunasMessageDiv.style.display = 'none';
        }

        // --- FUNGSI RESET UNIVERSAL (MODIFIKASI: Reset checkbox) ---
        function resetContainer(containerId) {
            if (containerId === 'container-iuran') {
                document.getElementById('search-form').reset();
                document.getElementById('search-input').value = '';
                document.getElementById('result-container').style.display = 'none';
                document.getElementById('loader').style.display = 'none';
                manualPaymentSection.style.display = 'none';
                manualResultDiv.style.display = 'none';
                tunggakanOptionsDiv.style.display = 'none';
                lunasMessageDiv.style.display = 'none';
                
                // Reset state
                currentTunggakanAmount = 0;
                currentUserId = '';
                currentUserName = '';
                currentTunggakanList = [];
                
                // MODIFIKASI: Reset checkbox
                if(proofConfirmationCheckbox) proofConfirmationCheckbox.checked = false; 
                btnWhatsappProof.disabled = true;
                btnWhatsappProof.classList.remove('active');
                
                // Refresh halaman untuk mereset DUMMY_DATA
                window.location.reload(); 
            }
        }

        // Panggil event input saat form manual pertama kali dibuka (untuk mengisi default 1 bulan/Rp 25.000)
        manualAmountInput.addEventListener('focus', function() {
            if (manualAmountInput.value === '') {
                manualAmountInput.value = IURAN_PER_BULAN;
                manualAmountInput.dispatchEvent(new Event('input'));
            }
        });
    </script>

</body>
</html>
