<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Iuran Warga & Pembayaran Kas (Petugas)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ======================================= */
        /* === CSS UMUM & FULL LAYAR === */
        /* ======================================= */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            padding: 0;
            margin: 0;
            text-align: center;
        }
        .container {
            width: 90%;
            min-height: 100vh;
            margin: 0 auto;
            background: white;
            padding: 30px 15px;
            box-shadow: none; 
            position: relative;
        }
        .content-wrapper {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 1.8em;
            color: #ff5722;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        /* ======================================= */
        /* === LOGIN STYLING (TETAP) === */
        /* ======================================= */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f4f8; 
            padding: 0;
            margin: 0;
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        .login-box h2 {
            color: #007bff;
            margin-bottom: 30px;
        }
        .login-box input[type="text"],
        .login-box input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
        }
        .login-box button {
            width: 100%;
            padding: 12px;
            background-color: #ff5722;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .login-box button:hover {
            background-color: #e64a19;
        }
        #login-message {
            color: #dc3545;
            margin-top: 15px;
            font-weight: bold;
        }

        /* ======================================= */
        /* === Home Menu (TETAP) === */
        /* ======================================= */
        #home-menu {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        #home-menu h2 {
            margin: 0;
            font-size: 1.2em;
        }
        #home-menu button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        #home-menu button:hover {
            background-color: #c82333;
        }
        
        /* ======================================= */
        /* === DASHBOARD PETUGAS (REVISI) === */
        /* ======================================= */
        #admin-dashboard {
            display: none; /* Default hidden */
            text-align: left;
        }
        .saldo-box {
            background-color: #28a745;
            color: white;
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
        }
        .saldo-box h3 {
            margin-top: 0;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        .saldo-running-text {
            white-space: nowrap;
            overflow: hidden;
            box-sizing: border-box;
        }
        .saldo-running-text span {
            display: inline-block;
            padding-left: 100%;
            font-size: 1.7em; 
            font-weight: bold;
            animation: marquee 15s linear infinite;
        }
        @keyframes marquee {
            0%   { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
        .menu-item {
            background-color: #007bff;
            color: white;
            padding: 15px 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, background-color 0.2s;
        }
        .menu-item:hover {
            transform: translateY(-5px);
            background-color: #0056b3;
        }
        .menu-item i {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: block;
        }
        .menu-item p {
            margin: 0;
            font-weight: bold;
            font-size: 1.1em;
        }


        /* ======================================= */
        /* === RESULT STYLING (TETAP) === */
        /* ======================================= */
        #result-container, #instruction-container {
            display: none; /* Pastikan default hidden */
            text-align: left;
        }
        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }
        .data-item .lunas { color: #28a745; font-weight: bold; }
        .data-item .belum { color: #dc3545; font-weight: bold; }
        .total-info {
            margin-top: 20px;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 4px;
            text-align: center;
        }
        #lunas-message {
            padding: 15px;
            margin-top: 20px;
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            font-weight: bold;
            display: none;
        }
        
        /* ======================================= */
        /* === MODIFIKASI TOMBOL BAYAR (BARU) === */
        /* ======================================= */
        #btn-show-manual-from-detail {
            width: 100%;
            padding: 18px 12px; /* Ditingkatkan */
            margin-top: 25px; /* Margin diperlebar */
            background-color: #ff5722;
            color: white;
            border: none;
            border-radius: 10px; /* Lebih Bulat */
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em; /* Font lebih besar */
            letter-spacing: 1px;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 4px 15px rgba(255, 87, 34, 0.4); /* Efek Bayangan */
        }
        #btn-show-manual-from-detail:hover {
            background-color: #e64a19;
            transform: translateY(-3px); /* Efek Naik */
            box-shadow: 0 6px 20px rgba(255, 87, 34, 0.6);
        }

        #manual-payment-section {
            display: none; /* Pastikan default hidden */
            margin-top: 0;
            padding: 20px;
            border: 1px dashed #007bff;
            border-radius: 8px;
            background-color: #f8fafd;
            text-align: center;
        }
        #payment-form-manual input[type="number"],
        #payment-form-manual input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        #payment-form-manual button[type="submit"] {
            width: 100%;
            padding: 15px; 
            margin-top: 25px; 
            margin-bottom: 10px; 
            background-color: #ff5722; 
            color: white;
            border: none;
            border-radius: 8px; 
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em; 
            transition: background-color 0.3s, transform 0.2s;
        }
        #payment-form-manual button[type="submit"]:hover {
            background-color: #e64a19; 
            transform: translateY(-1px); 
        }
        
        /* Instruksi Pembayaran (BARU) */
        #instruction-container { 
            display: none; 
            padding: 20px;
            border: 1px dashed #28a745;
            background-color: #e6ffed;
            text-align: left;
            border-radius: 8px;
        }
        #btn-whatsapp-proof {
            margin-top: 15px;
            width: 100%;
            padding: 12px;
            background-color: #ccc; 
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: not-allowed;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #btn-whatsapp-proof.active {
            background-color: #25d366; 
            cursor: pointer;
        }
        .qris-display {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #ccc;
            
        }
        .qris-display img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
        }
        #confirmation-container {
            margin: 15px 0;
            padding: 10px;
            background-color: #fff3cd; 
            border: 1px solid #ffeeba;
            border-radius: 5px;
            text-align: left;
            display: flex;
            align-items: center;
        }
        #confirmation-container input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.3);
        }
        .offline-instructions {
            padding: 15px;
            background-color: #fce4ec; 
            border: 1px solid #f8bbd0;
            border-radius: 5px;
            margin-top: 15px;
            color: #880e4f;
            text-align: left;
        }
        #tunggakan-detail {
            font-size: 0.9em; 
            text-align: left;
            margin-top: 10px; 
            line-height: 1.8; 
            color: #495057; 
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
        }
        .tunggakan-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        .tunggakan-total {
            border-top: 2px solid #ccc;
            padding-top: 5px;
            margin-top: 5px;
            font-weight: bold;
            color: #dc3545; 
            font-size: 1.1em;
        }
        
        .data-anggota-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .data-anggota-table th, .data-anggota-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
        }
        .data-anggota-table th {
            background-color: #007bff;
            color: white;
        }
        .data-anggota-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        /* ======================================= */
        /* === LAPORAN KAS STYLING (BARU) === */
        /* ======================================= */
        #cash-report-container {
            display: none; /* Default hidden */
            text-align: left;
            margin-top: 20px;
        }
        .report-summary-box {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
            text-align: center;
        }
        .summary-card {
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 30%;
        }
        .summary-card h4 {
            margin: 0 0 10px 0;
            font-size: 1em;
        }
        .summary-card p {
            font-size: 1.5em;
            font-weight: bold;
            margin: 0;
        }
        .card-pemasukan {
            background-color: #e6ffed;
            color: #1e7e34;
            border: 1px solid #c3e6cb;
        }
        .card-pengeluaran {
            background-color: #fcecec;
            color: #dc3545;
            border: 1px solid #f5c6cb;
        }
        .card-saldo {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .cash-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .cash-table th, .cash-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
        }
        .cash-table th {
            background-color: #007bff;
            color: white;
        }
        .cash-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* MODIFIKASI: Tombol Edit/Aksi */
        .edit-button {
            background-color: #007bff; 
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8em;
            transition: background-color 0.2s;
            margin-left: 10px;
        }
        .edit-button:hover {
            background-color: #0056b3;
        }


        /* Tombol Kembali (MODIFIKASI) */
        .btn-back {
            position: absolute;
            bottom: 10px;
            left: 15px;
            padding: 10px 15px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            z-index: 50;
            display: none; /* Default hidden */
        }
        
    </style>
</head>
<body>

    <div id="login-container">
        <div class="login-box">
            <h2><i class="fas fa-user-tag"></i> Login Petugas Kas</h2>
            <form id="login-form">
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit"><i class="fas fa-sign-in-alt"></i> Masuk</button>
            </form>
            <p id="login-message" style="display:none;">Username atau Password salah!</p>
        </div>
    </div>


    <div class="container" id="container-iuran" style="display:none;">
        <div class="content-wrapper">
            
            <div id="home-menu">
                <h2 id="current-user-info"><i class="fas fa-user-shield"></i> Hi, Petugas!</h2>
                <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>

            <h1>üè° APLIKASI KAS GANG E21-25 </h1>
            <div class="loader" id="loader" style="display:none;"></div>
            
            <div id="admin-dashboard">
                <div class="saldo-box">
                    <h3><i class="fas fa-money-check-alt"></i> SISA SALDO KAS TERKINI</h3>
                    <div class="saldo-running-text">
                        <span id="current-saldo-text">Rp 12,345,678. Saldo ini adalah akumulasi dana iuran, kas RT, dan BSK.</span>
                    </div>
                </div>
                
                <h3 style="color:#007bff; margin-top: 30px;"><i class="fas fa-th-large"></i> Menu Utama Petugas</h3>
                <div class="menu-grid">
                    <div class="menu-item" onclick="showDataUser(currentUserId)">
                        <i class="fas fa-id-card-alt"></i>
                        <p>Kartu Iuran Saya</p>
                        <p style="font-size:0.8em; margin-top: 5px;">(Blok: E25-23)</p>
                    </div>
                    <div class="menu-item" onclick="showDataAnggota()">
                        <i class="fas fa-users"></i>
                        <p>Data Anggota Kas</p>
                    </div>
                    <div class="menu-item" id="menu-laporan-kas" onclick="showCashReport()"> 
                        <i class="fas fa-chart-line"></i>
                        <p>Laporan Kas</p>
                    </div>
                </div>

            </div>

            <div id="result-container">
                <div id="status-message" class="status-message"></div>

                <div id="content-display">
                    <h3 style="color:#007bff;"><i class="fas fa-receipt"></i> Detail Iuran Kas: <span id="user-name"></span></h3>
                    
                    <div id="data-display"></div>

                    <div id="payment-summary">
                        <div class="total-info">
                            Total Belum Bayar: <span id="total-tunggakan">Rp 0</span>
                          
                            <div id="tunggakan-detail">
                                </div>
                        </div>
                      
                    </div>
                    
                    <div id="lunas-message">
                        <i class="fas fa-handshake"></i> Terima kasih, Anda sudah membayar kas dengan lancar!
                    </div>
                  
                     <div id="tunggakan-options">
                        <p style="margin-top:15px; font-style:italic;"></p> 

                        <button id="btn-show-manual-from-detail" onclick="showManualPayment(currentUserId)">
                            <i class="fas fa-calendar-check"></i> LANJUTKAN KE PEMBAYARAN
                        </button>
                    </div>
                </div>
            </div>

            <div id="anggota-data-container" style="display:none; text-align:left;">
                 <div id="anggota-table-display"></div>
            </div>

            <div id="manual-payment-section">
                <h3>üíµ Form Pembayaran Kas Gang E21-25</h3>
                <p>Pembayaran untuk iuran spesifik beberapa bulan sekaligus.</p>
                <hr style="border: 0; border-top: 1px solid #ccc; margin: 10px 0;">
                <p style="font-weight: bold;">Untuk: <span id="manual-user-detail" style="color:#ff5722;"></span></p>
                <p style="font-size: 0.9em; color: #6c757d;">(Iuran per bulan termasuk kas gang, kas RT, dan BSK : Rp 25.000)</p>

                <form id="payment-form-manual">
                    
                    <div class="form-group" style="text-align: left; background-color: #f7e8e8; padding: 10px; border-radius: 5px; border: 1px solid #dc3545;" id="group-tunggakan-2025">
                         <label for="tunggakan-2025-amount" style="font-weight: bold; color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> Tunggakan Tahun 2025</label>
                         <input type="text" id="tunggakan-2025-amount" readonly style="background-color: #fcecec; color: #dc3545; font-weight: bold; margin-bottom: 5px;">
                         <p style="font-style: italic; color: #721c24;">*Pembayaran akan otomatis melunasi Tunggakan 2025 ini terlebih dahulu.</p>
                    </div>

                    <div class="form-group" style="text-align: left; margin-top: 20px;">
                        <label for="manual-amount">Jumlah Pembayaran (Rp) Total Yang Disetor</label>
                        <input type="number" id="manual-amount" name="amount" min="1" step="1" required placeholder="Contoh: 25000" value="">
                        <p style="margin-top:1px; font-style:italic;" > </p>
                    </div>

                    <div class="form-group" style="text-align: left;">
                        <label for="manual-month">Detail Pelunasan</label>
                        <input type="text" id="manual-month" name="month" required readonly placeholder="Diisi otomatis..." style="background-color: #eee;">
                        <p style="margin-top:0,5px; font-style:italic;" ></p>
                    </div>

                    <div class="form-group" style="text-align: left;">
                        <label>Pilih Metode Pembayaran</label>
                        
                        <div class="radio-group">
                            <input type="radio" id="manual-qrcode" name="method" value="QR Code (QRIS)" checked>
                            <label for="manual-qrcode">QR Code (QRIS)</label>

                            <input type="radio" id="manual-banktransfer" name="method" value="Transfer Bank">
                            <label for="manual-banktransfer">Transfer Bank</label>
                            
                            <input type="radio" id="manual-offline" name="method" value="Offline (Tunai)">
                            <label for="manual-offline">Offline (Tunai)</label>
                        </div>
                    </div>

                    <button type="submit"><i class="fas fa-file-invoice"></i> Buat Instruksi Pembayaran
                    </button>
                </form>

            </div>
            
            <div id="instruction-container">
                 <div id="payment-instruction-content"></div>

                    <hr style="margin: 20px 0;">

                    <div id="confirmation-container">
                        <input type="checkbox" id="proof-confirmation" required>
                        <label for="proof-confirmation" style="font-weight: bold; color: #dc3545;">Saya mengkonfirmasi sudah <span id="confirm-action">transfer</span> dan siap mengirimkan bukti via WhatsApp.</label>
                    </div>
                    
                    <button id="btn-whatsapp-proof" disabled>
                        <i class="fab fa-whatsapp"></i> Konfirmasi & Kirim Bukti Pembayaran
                    </button>
            </div>
            
            <div id="cash-report-container">
                <h3 style="color:#007bff; margin-top: 10px;"><i class="fas fa-chart-line"></i> Laporan Kas Bulanan 
                    <span id="cash-report-admin-tools">
                        </span>
                </h3>
                <div id="report-content"></div>
            </div>
            <button id="btn-back-to-detail" class="btn-back" onclick="showDataUser(currentUserId)">
                <i class="fas fa-chevron-left"></i> Kembali ke Data Iuran
            </button>
            <button id="btn-back-to-manual-form" class="btn-back" onclick="showManualPayment(currentUserId)">
                <i class="fas fa-chevron-left"></i> Kembali ke Form Pembayaran
            </button>
            <button id="btn-back-to-dashboard" class="btn-back" onclick="showDashboard()">
                <i class="fas fa-chevron-left"></i> Kembali ke Menu Utama
            </button>

        </div>
    </div>
      
    <script>
        // =======================================
        // === KONFIGURASI USER PETUGAS (REVISI) ===
        // =======================================
        const PETUGAS_USERS = [
            // dataId: Blok Warga yang diawasi/menjadi data utama
            { username: 'admin', password: '123', name: 'Admin Utama', dataId: 'E21-25', isAdmin: true }, // Waluyo
            { username: 'Nana', password: '2148', name: 'Nana rusmana', dataId: 'E21-48', isAdmin: false }, // Nana Rusmana
            { username: 'rohman', password: '2151', name: 'Rohman', dataId: 'E21-51', isAdmin: false }, // Rohman
            { username: 'hadi', password: 'lunas', name: 'Hadi', dataId: 'E25-26', isAdmin: false },// Hadi
            { username: 'Aji', password: '2150', name: 'AJI', dataId: 'E21-50', isAdmin: false },// AJI
        ];

        const KAS_SALDO_DUMMY = 12345678; // Saldo kas dummy

        // =======================================
        // === FUNGSI LOGIN & LOGOUT (MODIFIKASI) ===
        // =======================================
        const loginContainer = document.getElementById('login-container');
        const loginForm = document.getElementById('login-form');
        const appContainer = document.getElementById('container-iuran');
        const loginMessage = document.getElementById('login-message');
        const currentUserInfo = document.getElementById('current-user-info');
        
        // Elemen Halaman
        const adminDashboard = document.getElementById('admin-dashboard');
        const resultContainer = document.getElementById('result-container'); 
        const manualPaymentSection = document.getElementById('manual-payment-section');
        const instructionContainer = document.getElementById('instruction-container');
        const anggotaDataContainer = document.getElementById('anggota-data-container');
        const cashReportContainer = document.getElementById('cash-report-container'); 
        const reportContentDiv = document.getElementById('report-content'); 
        const menuLaporanKas = document.getElementById('menu-laporan-kas'); 
        
        // Tombol Kembali
        const btnBackToDetail = document.getElementById('btn-back-to-detail');
        const btnBackToManualForm = document.getElementById('btn-back-to-manual-form');
        const btnBackToDashboard = document.getElementById('btn-back-to-dashboard');
        
        let currentUserId = ''; // ID (Blok) Warga yang sedang login/dilihat datanya
        let currentUserName = ''; 
        let isAdmin = false; // Status Admin

        function checkLoginStatus() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                const user = JSON.parse(loggedInUser);
                currentUserId = user.dataId; // Set ID Warga yang terkait dengan Petugas
                currentUserName = user.name;
                isAdmin = user.isAdmin; // Set status admin
                showApp(user);
            } else {
                showLogin();
            }
        }

        function showApp(user) {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'block';
            currentUserInfo.innerHTML = `<i class="fas fa-user-shield"></i> Hi, ${user.name}${user.isAdmin ? ' (Admin)' : ''}!`;
            showDashboard();
            
            // Menu Laporan Kas visible by default now, as access control is inside showCashReport
        }
        
        // FUNGSI BARU: Kontrol Halaman
        function showPage(pageId) {
            // Sembunyikan semua halaman
            adminDashboard.style.display = 'none';
            resultContainer.style.display = 'none';
            manualPaymentSection.style.display = 'none';
            instructionContainer.style.display = 'none';
            anggotaDataContainer.style.display = 'none';
            cashReportContainer.style.display = 'none'; 
            
            // Sembunyikan semua tombol kembali
            btnBackToDetail.style.display = 'none';
            btnBackToManualForm.style.display = 'none';
            btnBackToDashboard.style.display = 'none';

            if (pageId === 'dashboard') {
                adminDashboard.style.display = 'block';
            } else if (pageId === 'detail') {
                resultContainer.style.display = 'block';
                btnBackToDashboard.style.display = 'block';
            } else if (pageId === 'payment-form') {
                manualPaymentSection.style.display = 'block';
                btnBackToDashboard.style.display = 'block'; // Kembali ke dashboard
            } else if (pageId === 'instruction') {
                instructionContainer.style.display = 'block';
                btnBackToManualForm.style.display = 'block'; // Kembali ke form pembayaran
            } else if (pageId === 'anggota') {
                anggotaDataContainer.style.display = 'block';
                btnBackToDashboard.style.display = 'block'; 
            } else if (pageId === 'report') { 
                cashReportContainer.style.display = 'block';
                btnBackToDashboard.style.display = 'block';
            }
        }
        
        function showDashboard() {
            showPage('dashboard');
            document.getElementById('current-saldo-text').textContent = `Rp ${KAS_SALDO_DUMMY.toLocaleString('id-ID')}. Saldo ini adalah akumulasi dana iuran, kas RT, dan BSK.`;

            // === UPDATE KARTU IURAN SAYA (BARU) ===
            document.querySelector('#admin-dashboard .menu-grid .menu-item:first-child').innerHTML = `
                <i class="fas fa-id-card-alt"></i>
                <p>Kartu Iuran Saya</p>
                <p style="font-size:0.8em; margin-top: 5px;">(Blok: ${currentUserId})</p>
            `;
            // ======================================
        }
        
        function showLogin() {
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
            loginMessage.style.display = 'none';
            loginForm.reset();
            
        }

        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const user = PETUGAS_USERS.find(u => u.username.toLowerCase() === username.toLowerCase() && u.password === password);

            if (user) {
                localStorage.setItem('loggedInUser', JSON.stringify(user));
                currentUserId = user.dataId;
                currentUserName = user.name;
                isAdmin = user.isAdmin;
                showApp(user);
            } else {
                loginMessage.style.display = 'block';
            }
        });

        function logout() {
            localStorage.removeItem('loggedInUser');
            alert('Anda telah logout.');
            showLogin();
        }
        
        // FUNGSI BARU: Pindah ke Tampilan Detail Data Iuran
        function showDataUser(id) {
            const foundUser = DUMMY_DATA.find(user => user.id === id);
            
            showPage('detail');
            document.getElementById('content-display').style.display = 'block'; 

            if (foundUser) {
                displayUserData(foundUser); 
            } else {
                statusMessageDiv.className = 'status-message status-not-found';
                statusMessageDiv.innerHTML = `‚ùå Data Iuran untuk **${id}** Tidak Ditemukan. Hubungi Bendahara.`;
                document.getElementById('content-display').style.display = 'none';
            }
        }
        
        // FUNGSI BARU: Pindah ke Tampilan Pembayaran Manual
        function showManualPayment(id) {
            showPage('payment-form');
            
            // Logic mengisi form payment
            const userData = DUMMY_DATA.find(user => user.id === id);
            if (userData) {
                const tunggakan2025 = userData.tunggakan_2025 || 0;
                
                // Cek tunggakan bulan 2026
                const tunggakan2026List = userData.iuran.filter(item => item.status === 'BLUM BAYAR');
                
                if(tunggakan2025 > 0) {
                    manualAmountInput.value = tunggakan2025 + IURAN_PER_BULAN; 
                } else if (tunggakan2026List.length > 0) {
                    manualAmountInput.value = IURAN_PER_BULAN;
                } else {
                    manualAmountInput.value = 0; 
                }
                manualAmountInput.dispatchEvent(new Event('input')); // Trigger input event
            }
            
            // Reset status konfirmasi
            if(proofConfirmationCheckbox) proofConfirmationCheckbox.checked = false; 
            btnWhatsappProof.disabled = true;
            btnWhatsappProof.classList.remove('active');
            confirmActionSpan.textContent = 'transfer'; 
        }
        
        // FUNGSI BARU: Tampilkan Data Anggota + FUNGSI ADMIN EDIT
        function showDataAnggota() {
            showPage('anggota');
            
            let html = `
                <h3 style="color:#007bff; margin-top: 10px;"><i class="fas fa-users"></i> Data Anggota Kas Gang E21-25
                ${isAdmin ? `<button class="edit-button" onclick="addAnggotaData()" style="background-color: #28a745; margin-left: 10px;"><i class="fas fa-plus-circle"></i> Tambah Anggota</button>` : ''}
                </h3>
                <div id="anggota-table-display">
                    <table class="data-anggota-table">
                        <thead>
                            <tr>
                                <th>BLOK</th>
                                <th>NAMA Warga</th>
                                <th>Tunggakan 2025 (Rp)</th>
                                <th>Status Iuran 2026</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            DUMMY_DATA.forEach(user => {
                const tunggakan2025IDR = user.tunggakan_2025.toLocaleString('id-ID');
                const tunggakan2026Count = user.iuran.filter(i => i.status === 'BLUM BAYAR').length;
                let status2026 = (tunggakan2026Count === 0) ? '<span class="lunas">Lunas</span>' : 
                                 `<span class="belum">${tunggakan2026Count} bulan</span>`;

                // Kontrol tombol Aksi
                let aksiButtons = '‚Äî';
                if (isAdmin) {
                    aksiButtons = `
                       <button class="edit-button" onclick="editAnggotaData('${user.id}')" style="margin-left: 0;"><i class="fas fa-edit"></i> Ubah Status</button>
                       <button class="edit-button" onclick="deleteAnggotaData('${user.id}')" style="background-color: #dc3545;"><i class="fas fa-trash"></i> Hapus</button>
                    `;
                }

                html += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.nama}</td>
                        <td>${tunggakan2025IDR}</td>
                        <td>${status2026}</td>
                        <td>${aksiButtons}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('anggota-data-container').innerHTML = html;
        }
        
        // FUNGSI ADMIN: EDIT DATA ANGGOTA
        function editAnggotaData(userId) {
            if (!isAdmin) {
                alert('Anda tidak memiliki izin untuk mengubah data anggota.');
                return;
            }
            const userIndex = DUMMY_DATA.findIndex(user => user.id === userId);
            if (userIndex === -1) return;

            const user = DUMMY_DATA[userIndex];
            
            let currentMonths = user.iuran.map(i => i.bulan + ": " + i.status).join(', ');
            
            const newTunggakan2025 = prompt(`Edit Tunggakan 2025 (saat ini: Rp ${user.tunggakan_2025.toLocaleString('id-ID')}):`, user.tunggakan_2025);
            
            if (newTunggakan2025 !== null && !isNaN(parseInt(newTunggakan2025))) {
                user.tunggakan_2025 = parseInt(newTunggakan2025);
            }
            
            const newMonthsStatus = prompt(`Edit Status Iuran 2026 (Format: Bulan:LUNAS/BLUM BAYAR, ...)\n\nContoh: JANUARI:LUNAS, FEBRUARI:BLUM BAYAR\n\nStatus saat ini:\n${currentMonths}`, currentMonths);
            
            if (newMonthsStatus !== null) {
                 const monthUpdates = newMonthsStatus.split(',').map(s => s.trim()).filter(s => s.includes(':'));
                 monthUpdates.forEach(update => {
                     const [month, status] = update.split(':').map(s => s.trim().toUpperCase());
                     const iuranItem = user.iuran.find(item => item.bulan === month);
                     if (iuranItem && (status === 'LUNAS' || status === 'BLUM BAYAR')) {
                         iuranItem.status = status;
                     }
                 });
            }
            
            DUMMY_DATA[userIndex] = user;
            alert(`Data untuk ${user.nama} (${userId}) berhasil diperbarui.`);
            showDataAnggota(); // Refresh tampilan
        }
        
        // FUNGSI ADMIN: TAMBAH DATA ANGGOTA BARU (BARU)
        function addAnggotaData() {
            if (!isAdmin) {
                alert('Anda tidak memiliki izin untuk menambah data anggota.');
                return;
            }
            
            const newId = prompt('Masukkan BLOK Warga Baru (Contoh: E25-10):');
            if (!newId) return;
            
            // Cek duplikasi ID
            if (DUMMY_DATA.find(user => user.id === newId.toUpperCase())) {
                alert(`ID Blok ${newId} sudah ada.`);
                return;
            }
            
            const newName = prompt(`Masukkan NAMA Warga untuk BLOK ${newId}:`);
            if (!newName) return;
            
            const defaultIuran = [];
            const months = ['JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
            
            months.forEach(month => {
                defaultIuran.push({ bulan: month, nominal: IURAN_PER_BULAN, status: 'BLUM BAYAR' });
            });

            const newUser = {
                id: newId.toUpperCase(),
                nama: newName.toUpperCase(),
                tunggakan_2025: 0, 
                iuran: defaultIuran
            };
            
            DUMMY_DATA.push(newUser);
            alert(`Anggota ${newName} (${newId}) berhasil ditambahkan.`);
            showDataAnggota(); 
        }
        
        // FUNGSI ADMIN: HAPUS DATA ANGGOTA (BARU)
        function deleteAnggotaData(userId) {
            if (!isAdmin) {
                alert('Anda tidak memiliki izin untuk menghapus data anggota.');
                return;
            }
            
            if (confirm(`Apakah Anda yakin ingin menghapus data anggota dengan BLOK ${userId}? Tindakan ini tidak dapat dibatalkan.`)) {
                const initialLength = DUMMY_DATA.length;
                DUMMY_DATA = DUMMY_DATA.filter(user => user.id !== userId);
                
                if (DUMMY_DATA.length < initialLength) {
                    alert(`Data anggota ${userId} berhasil dihapus.`);
                    showDataAnggota();
                } else {
                    alert(`Data anggota ${userId} tidak ditemukan.`);
                }
            }
        }


        // FUNGSI BARU: Tampilkan Laporan Kas + FUNGSI ADMIN EDIT
        function showCashReport() {
            showPage('report');
            
            // Tampilkan tombol Admin Tools hanya jika user adalah admin
            const adminToolsSpan = document.getElementById('cash-report-admin-tools');
            if (isAdmin) {
                 adminToolsSpan.innerHTML = `<button class="edit-button" onclick="editCashReport()"><i class="fas fa-edit"></i> Ubah Data</button>`;
            } else {
                 adminToolsSpan.innerHTML = '';
                 // Jika bukan admin, kasih pesan warning jika fungsi edit dipanggil
            }
            
            displayCashReport();
        }
        
        function displayCashReport() {
            const data = DUMMY_CASH_REPORT;
            let totalPemasukan = data.pemasukan.reduce((sum, item) => sum + item.nominal, 0);
            let totalPengeluaran = data.pengeluaran.reduce((sum, item) => sum + item.nominal, 0);
            let saldoAkhir = data.saldo_awal + totalPemasukan - totalPengeluaran;

            const formatIDR = (num) => 'Rp ' + num.toLocaleString('id-ID');

            let html = `
                <div class="report-summary-box">
                    <div class="summary-card card-pemasukan">
                        <h4><i class="fas fa-arrow-alt-circle-up"></i> Total Pemasukan</h4>
                        <p>${formatIDR(totalPemasukan)}</p>
                    </div>
                    <div class="summary-card card-pengeluaran">
                        <h4><i class="fas fa-arrow-alt-circle-down"></i> Total Pengeluaran</h4>
                        <p>${formatIDR(totalPengeluaran)}</p>
                    </div>
                    <div class="summary-card card-saldo">
                        <h4><i class="fas fa-balance-scale"></i> Saldo Akhir</h4>
                        <p>${formatIDR(saldoAkhir)}</p>
                    </div>
                </div>

                <h4 style="color:#007bff;"><i class="fas fa-plus-square"></i> Detail Pemasukan</h4>
                <table class="cash-table">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Deskripsi</th>
                            <th>Nominal</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.pemasukan.forEach((item, index) => {
                html += `
                    <tr id="pemasukan-${index}">
                        <td>${item.tanggal}</td>
                        <td>${item.deskripsi}</td>
                        <td style="color:#1e7e34; font-weight:bold;">${formatIDR(item.nominal)}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <h4 style="color:#ff5722; margin-top: 30px;"><i class="fas fa-minus-square"></i> Detail Pengeluaran</h4>
                <table class="cash-table">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Deskripsi</th>
                            <th>Nominal</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.pengeluaran.forEach((item, index) => {
                html += `
                    <tr id="pengeluaran-${index}">
                        <td>${item.tanggal}</td>
                        <td>${item.deskripsi}</td>
                        <td style="color:#dc3545; font-weight:bold;">${formatIDR(item.nominal)}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;

            reportContentDiv.innerHTML = html;
        }

        // FUNGSI ADMIN: EDIT LAPORAN KAS
        function editCashReport() {
            if (!isAdmin) {
                alert('Anda tidak memiliki izin untuk mengubah laporan kas.');
                return;
            }
            
            const action = prompt('Pilih aksi:\n1. Tambah Pemasukan\n2. Tambah Pengeluaran\n3. Edit Saldo Awal\n4. (Aksi Lainnya)', '1');
            
            if (action === '3') {
                const newSaldoAwal = prompt(`Edit Saldo Awal (Saat ini: ${DUMMY_CASH_REPORT.saldo_awal.toLocaleString('id-ID')})`, DUMMY_CASH_REPORT.saldo_awal);
                if (newSaldoAwal !== null && !isNaN(parseInt(newSaldoAwal))) {
                    DUMMY_CASH_REPORT.saldo_awal = parseInt(newSaldoAwal);
                    alert('Saldo Awal berhasil diubah.');
                }
            } else if (action === '1' || action === '2') {
                const type = action === '1' ? 'Pemasukan' : 'Pengeluaran';
                const tanggal = prompt(`Masukkan Tanggal ${type} (YYYY-MM-DD):`);
                if (!tanggal) return;
                const deskripsi = prompt(`Masukkan Deskripsi ${type}:`);
                if (!deskripsi) return;
                const nominal = prompt(`Masukkan Nominal ${type} (Angka):`);
                const nominalInt = parseInt(nominal);
                
                if (tanggal && deskripsi && !isNaN(nominalInt) && nominalInt > 0) {
                    const newItem = {
                        tanggal: tanggal,
                        deskripsi: deskripsi,
                        nominal: nominalInt
                    };
                    
                    if (action === '1') {
                        DUMMY_CASH_REPORT.pemasukan.push(newItem);
                    } else {
                        DUMMY_CASH_REPORT.pengeluaran.push(newItem);
                    }
                    alert(`${type} berhasil ditambahkan.`);
                } else {
                    alert('Input tidak valid.');
                }
            } else {
                alert('Aksi dibatalkan atau tidak valid.');
            }
            
            displayCashReport(); // Refresh tampilan
        }


        // Jalankan pengecekan status login saat halaman dimuat
        document.addEventListener('DOMContentLoaded', checkLoginStatus);


        // =======================================
        // === KODE APLIKASI IURAN (DATA DUMMY TETAP) ===
        // =======================================

        // Data Dummy Sederhana 
        let DUMMY_DATA =
        [
            {
                id: 'E21-51',
                nama: 'ROHMAN',
                tunggakan_2025: 0, 
                iuran: [
                    { bulan: 'JANUARI',nominal:   25000, status: 'LUNAS'}, 
                    { bulan: 'FEBRUARI',nominal:25000, status: 'BLUM BAYAR'},
                    { bulan: 'MARET',nominal:25000, status: 'BLUM BAYAR'},
                    { bulan: 'APRIL',nominal:     25000, status: 'BLUM BAYAR'}, 
                    { bulan: 'MEI', nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JUNI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JULI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'AGUSTUS',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'SEPTEMBER',nominal: 25000, status: 'BLUM BAYAR'},
                    { bulan: 'OKTOBER',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'NOVEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                    { bulan: 'DESEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                ]
            },
            {
                id: 'E21-48',
                nama: 'NANA RUSMANA',
                tunggakan_2025: 75000, 
                iuran: [
                    { bulan: 'JANUARI',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'FEBRUARI',nominal:25000, status: 'BLUM BAYAR'},
                    { bulan: 'MARET',nominal:25000, status: 'BLUM BAYAR'},
                    { bulan: 'APRIL',nominal:     25000, status: 'BLUM BAYAR'}, 
                    { bulan: 'MEI', nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JUNI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JULI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'AGUSTUS',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'SEPTEMBER',nominal: 25000, status: 'BLUM BAYAR'},
                    { bulan: 'OKTOBER',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'NOVEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                    { bulan: 'DESEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                ]
            },
            {
                id: 'E25-23',
                nama: 'WALUYO',
                tunggakan_2025: 125000, 
                iuran: [
                    { bulan: 'JANUARI',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'FEBRUARI',nominal:25000, status: 'LUNAS'},
                    { bulan: 'MARET',nominal:25000, status: 'BLUM BAYAR'},
                    { bulan: 'APRIL',nominal:     25000, status: 'BLUM BAYAR'}, 
                    { bulan: 'MEI', nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JUNI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'JULI',nominal:      25000, status: 'BLUM BAYAR'},
                    { bulan: 'AGUSTUS',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'SEPTEMBER',nominal: 25000, status: 'BLUM BAYAR'},
                    { bulan: 'OKTOBER',nominal:   25000, status: 'BLUM BAYAR'},
                    { bulan: 'NOVEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                    { bulan: 'DESEMBER',nominal:  25000, status: 'BLUM BAYAR'},
                ]
            },
            {
                id: 'E25-22',
                nama: 'BAYU NUR FAIZIN',
                tunggakan_2025: 0,
                iuran: [
                    { bulan: 'JANUARI',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'FEBRUARI',nominal:25000, status: 'LUNAS'},
                    { bulan: 'MARET',nominal:25000, status: 'LUNAS'},
                    { bulan: 'APRIL',nominal:     25000, status: 'LUNAS'}, 
                    { bulan: 'MEI', nominal:      25000, status: 'LUNAS'},
                    { bulan: 'JUNI',nominal:      25000, status: 'LUNAS'},
                    { bulan: 'JULI',nominal:      25000, status: 'LUNAS'},
                    { bulan: 'AGUSTUS',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'SEPTEMBER',nominal: 25000, status: 'LUNAS'},
                    { bulan: 'OKTOBER',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'NOVEMBER',nominal:  25000, status: 'LUNAS'},
                    { bulan: 'DESEMBER',nominal:  25000, status: 'LUNAS'},
                ]
            },
            {
                id: 'E25-26',
                nama: 'HADI',
                tunggakan_2025: 0,
                iuran: [
                    { bulan: 'JANUARI',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'FEBRUARI',nominal:25000, status: 'LUNAS'},
                    { bulan: 'MARET',nominal:25000, status: 'LUNAS'},
                    { bulan: 'APRIL',nominal:     25000, status: 'LUNAS'}, 
                    { bulan: 'MEI', nominal:      25000, status: 'LUNAS'},
                    { bulan: 'JUNI',nominal:      25000, status: 'LUNAS'},
                    { bulan: 'JULI',nominal:      25000, status: 'LUNAS'},
                    { bulan: 'AGUSTUS',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'SEPTEMBER',nominal: 25000, status: 'LUNAS'},
                    { bulan: 'OKTOBER',nominal:   25000, status: 'LUNAS'},
                    { bulan: 'NOVEMBER',nominal:  25000, status: 'LUNAS'},
                    { bulan: 'DESEMBER',nominal:  25000, status: 'LUNAS'},
                ]
            },
            
        ];

        // --- DATA DUMMY LAPORAN KAS (BARU) ---
        const DUMMY_CASH_REPORT = {
            saldo_awal: 11500000, 
            pemasukan: [
                { tanggal: '2026-01-05', deskripsi: 'Iuran Kas Januari (10 warga)', nominal: 250000 },
                { tanggal: '2026-01-12', deskripsi: 'Iuran Kas Januari (15 warga)', nominal: 375000 },
                { tanggal: '2026-01-20', deskripsi: 'Iuran Kas Februari (5 warga)', nominal: 125000 },
            ],
            pengeluaran: [
                { tanggal: '2026-01-15', deskripsi: 'Pembelian lampu jalan E25', nominal: 150000 },
                { tanggal: '2026-01-25', deskripsi: 'Biaya kebersihan bulanan', nominal: 100000 },
            ]
        };
        // ------------------------------------

        // --- VARIABEL DOM & STATE ---
        const IURAN_PER_BULAN = 25000; 
        const dataDisplay = document.getElementById('data-display');
        const userNameSpan = document.getElementById('user-name');
        const totalTunggakanSpan = document.getElementById('total-tunggakan');
        const statusMessageDiv = document.getElementById('status-message');
        const lunasMessageDiv = document.getElementById('lunas-message');
        const tunggakanOptionsDiv = document.getElementById('tunggakan-options');
        const manualPaymentForm = document.getElementById('payment-form-manual');
        const manualUserDetailSpan = document.getElementById('manual-user-detail');
        const manualAmountInput = document.getElementById('manual-amount'); 
        const manualMonthInput = document.getElementById('manual-month'); 
        
        const instructionContentDiv = document.getElementById('payment-instruction-content');
        const proofConfirmationCheckbox = document.getElementById('proof-confirmation');
        const btnWhatsappProof = document.getElementById('btn-whatsapp-proof');
        const confirmActionSpan = document.getElementById('confirm-action'); 
        
        const tunggakanDetailDiv = document.getElementById('tunggakan-detail');
        const tunggakan2025Group = document.getElementById('group-tunggakan-2025');
        const tunggakan2025Input = document.getElementById('tunggakan-2025-amount');


        let currentTunggakanAmount = 0; 
        let currentTunggakanList = []; 
        
        // --- FUNGSI MENAMPILKAN DATA ---
        function displayUserData(user) {
            statusMessageDiv.className = 'status-message status-found';
            statusMessageDiv.innerHTML = `‚úÖ Data Iuran untuk: **${user.nama}** Ditemukan!`;
           

            userNameSpan.textContent = user.nama + ' (' + user.id + ')';
            manualUserDetailSpan.textContent = user.nama + ' (' + user.id + ')'; 

            let htmlContent = '';
            currentTunggakanList = []; 
            
            // 1. Tampilkan status LUNAS 
            user.iuran.filter(item => item.status === 'LUNAS').forEach(item => {
                const nominalIDR = item.nominal.toLocaleString('id-ID');
                
                htmlContent += `
                    <div class="data-item">
                        <span><strong>${item.bulan} (2026):</strong></span>
                        <span>Rp ${nominalIDR}</span>
                        <span class="lunas">LUNAS</span>
                    </div>
                `;
            });

            // 2. Kumpulkan bulan yang BLUM BAYAR (untuk 2026)
            user.iuran.filter(item => item.status === 'BLUM BAYAR').forEach(item => {
                currentTunggakanList.push(item.bulan);
            });
            
            // 3. Tampilkan bulan BLUM BAYAR yang pertama saja (jika ada)
            if (currentTunggakanList.length > 0) {
                const firstTunggakanMonth = currentTunggakanList[0];
                const nominalIDR = IURAN_PER_BULAN.toLocaleString('id-ID'); 
                
                htmlContent += `
                    <div class="data-item">
                        <span><strong>${firstTunggakanMonth} (2026):</strong></span>
                        <span>Rp ${nominalIDR}</span>
                        <span class="belum">BELUM BAYAR (${currentTunggakanList.length} bln lainnya...)</span>
                    </div>
                `;
            }
            
            dataDisplay.innerHTML = htmlContent;
            
            // 4. Hitung Total Tunggakan Keseluruhan
            const tunggakan2026 = currentTunggakanList.length * IURAN_PER_BULAN;
            const tunggakan2025 = user.tunggakan_2025 || 0;
            let totalTunggakanSummary = tunggakan2025 + tunggakan2026;
            
            const totalInfoDiv = document.querySelector('#result-container .total-info');
            
            // 5. Update Tampilan Summary
            totalTunggakanSpan.textContent = 'Rp ' + totalTunggakanSummary.toLocaleString('id-ID');
            currentTunggakanAmount = totalTunggakanSummary; // Update global state
            
            let detailHtml = '';
            if (tunggakan2025 > 0) {
                detailHtml += `
                    <div class="tunggakan-line">
                        <span>Tunggakan Tahun 2025:</span> 
                        <span>Rp ${tunggakan2025.toLocaleString('id-ID')}</span>
                    </div>
                `;
            } else {
                 detailHtml += `
                    <div class="tunggakan-line">
                        <span>Tunggakan Tahun 2025:</span> 
                        <span>Rp 0 (LUNAS)</span>
                    </div>
                `;
            }
            
            detailHtml += `
                <div class="tunggakan-line">
                    <span>Tunggakan Periode 2026:</span> 
                    <span>Rp ${tunggakan2026.toLocaleString('id-ID')} (${currentTunggakanList.length} bulan)</span>
                </div>
                <div class="tunggakan-total tunggakan-line">
                    <span>TOTAL KESELURUHAN:</span> 
                    <span>Rp ${totalTunggakanSummary.toLocaleString('id-ID')}</span>
                </div>
            `;
            
            tunggakanDetailDiv.innerHTML = detailHtml;
            
            // 7. Update tampilan Tunggakan 2025 di Form Manual
            if (tunggakan2025 > 0) {
                tunggakan2025Input.value = `Rp ${tunggakan2025.toLocaleString('id-ID')}`;
                tunggakan2025Group.style.display = 'block';
                manualAmountInput.min = (tunggakan2025 > 0) ? tunggakan2025 : IURAN_PER_BULAN; 
            } else {
                tunggakan2025Input.value = 'Rp 0 (LUNAS)';
                tunggakan2025Group.style.display = 'none';
                manualAmountInput.min = IURAN_PER_BULAN; 
            }

            
            // 6. Tentukan Tampilan Pilihan Bayar
            if (totalTunggakanSummary > 0) {
                tunggakanOptionsDiv.style.display = 'block'; 
                lunasMessageDiv.style.display = 'none';
                totalInfoDiv.style.backgroundColor = '#ffe8e8';
                totalInfoDiv.style.color = '#dc3545';
                
                // Atur nilai default di form pembayaran saat kembali dari detail
                if(tunggakan2025 > 0) {
                    manualAmountInput.value = tunggakan2025 + IURAN_PER_BULAN; 
                } else if (tunggakan2026 > 0) {
                    manualAmountInput.value = IURAN_PER_BULAN;
                }
                manualAmountInput.dispatchEvent(new Event('input')); 

            } else {
                // Semua Lunas
                tunggakanOptionsDiv.style.display = 'none'; 
                lunasMessageDiv.style.display = 'block';
                totalTunggakanSpan.textContent = 'Rp 0 (Semua Iuran Lunas!)';
                totalInfoDiv.style.backgroundColor = '#e6ffed';
                totalInfoDiv.style.color = '#1e7e34';
                tunggakanDetailDiv.innerHTML = ''; 
            }
        }
        
        // --- Event Listener untuk Input Nominal ---
        manualAmountInput.addEventListener('input', function() {
            const amount = parseInt(manualAmountInput.value);
            
            const userData = DUMMY_DATA.find(user => user.id === currentUserId);
            if (!userData) return;
            
            const tunggakan2025 = userData.tunggakan_2025 || 0;
            
            if (isNaN(amount) || amount < 1) {
                manualMonthInput.value = 'Masukkan jumlah pembayaran yang valid.';
                return;
            }
            
            let remainingAmount = amount;
            let detailPembayaran = '';
            let isTunggakan2025Paid = false;
            
            if (tunggakan2025 > 0) {
                if (amount >= tunggakan2025) {
                    remainingAmount -= tunggakan2025;
                    detailPembayaran += `LUNAS Tunggakan 2025 (Rp ${tunggakan2025.toLocaleString('id-ID')})`;
                    isTunggakan2025Paid = true;
                } else {
                    detailPembayaran += `BAYAR Sebagian Tunggakan 2025 (Rp ${amount.toLocaleString('id-ID')} dari Rp ${tunggakan2025.toLocaleString('id-ID')})`;
                    manualMonthInput.value = detailPembayaran;
                    return;
                }
            } else {
                isTunggakan2025Paid = true; 
            }

            if (isTunggakan2025Paid) {
                const monthsPaidFor2026 = Math.floor(remainingAmount / IURAN_PER_BULAN);
                const excessAmount = remainingAmount % IURAN_PER_BULAN;

                const monthsAvailable = currentTunggakanList.length;
                const monthsToPay = currentTunggakanList.slice(0, Math.min(monthsPaidFor2026, monthsAvailable));
                const paidMonthsCount = monthsToPay.length;
                
                if (paidMonthsCount > 0) {
                    detailPembayaran += (detailPembayaran ? ' & ' : '') + 
                                        `LUNAS Iuran 2026: ${paidMonthsCount} bulan (${monthsToPay.join(', ')})`;
                }

                if (remainingAmount > 0 && paidMonthsCount === 0 && monthsAvailable > 0) {
                    detailPembayaran += (detailPembayaran ? ' & ' : '') + 
                                        `BELUM LUNAS Iuran 2026: Rp ${remainingAmount.toLocaleString('id-ID')} (Kekurangan Rp ${(IURAN_PER_BULAN - remainingAmount).toLocaleString('id-ID')}).`;
                }

                if (paidMonthsCount > 0 && monthsPaidFor2026 > monthsAvailable) {
                    const sisaUang = remainingAmount - (monthsAvailable * IURAN_PER_BULAN);
                    detailPembayaran += ` + KELEBIHAN bayar Rp ${sisaUang.toLocaleString('id-ID')} (Sisa Iuran Lunas).`;
                } else if (paidMonthsCount === monthsPaidFor2026 && excessAmount > 0) {
                    detailPembayaran += ` + SISA/LEBIH bayar Rp ${excessAmount.toLocaleString('id-ID')}.`;
                } else if (paidMonthsCount < monthsPaidFor2026) {
                    const sisaBulan = monthsPaidFor2026 - paidMonthsCount;
                    detailPembayaran += ` (Lunas ${paidMonthsCount} bln, SISA ${sisaBulan} bln berikutnya).`;
                }

            }
            
            manualMonthInput.value = detailPembayaran;
        });
        
        // --- FUNGSI LAINNYA ---
        document.querySelectorAll('#manual-payment-section input[name="method"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value.includes('Offline')) {
                    confirmActionSpan.textContent = 'serahkan uang tunai';
                } else {
                    confirmActionSpan.textContent = 'transfer';
                }
                
                if(proofConfirmationCheckbox) proofConfirmationCheckbox.checked = false;
                btnWhatsappProof.disabled = true;
                btnWhatsappProof.classList.remove('active');
            });
        });

        proofConfirmationCheckbox.addEventListener('change', function() {
            if (proofConfirmationCheckbox.checked) {
                btnWhatsappProof.disabled = false;
                btnWhatsappProof.classList.add('active');
            } else {
                btnWhatsappProof.disabled = true;
                btnWhatsappProof.classList.remove('active');
            }
        });

        // Event Listener Form Pembayaran Manual -> Instruksi
        manualPaymentForm.addEventListener('submit', function(e) {
            e.preventDefault(); 
            
            const amountInput = parseInt(document.getElementById('manual-amount').value);
            const userData = DUMMY_DATA.find(user => user.id === currentUserId);
            const tunggakan2025 = userData?.tunggakan_2025 || 0;
            const minAmount = (tunggakan2025 > 0) ? tunggakan2025 : IURAN_PER_BULAN;
            
            if (amountInput < minAmount) {
                 alert(`‚ùå Harap masukkan jumlah minimal Rp ${minAmount.toLocaleString('id-ID')}.`);
                 return;
            }
            
            // Pindah ke Halaman Instruksi
            showPage('instruction');
            
            if(proofConfirmationCheckbox) proofConfirmationCheckbox.checked = false; 
            btnWhatsappProof.disabled = true;
            btnWhatsappProof.classList.remove('active');

            const amount = amountInput;
            const detailPembayaran = document.getElementById('manual-month').value; 
            const method = document.querySelector('#manual-payment-section input[name="method"]:checked').value;
            
            let monthsToMarkLunas = [];
            const match = detailPembayaran.match(/Iuran 2026: \d+ bulan \((.*?)\)/);
            if (match && match[1]) {
                monthsToMarkLunas = match[1].split(',').map(m => m.trim());
            }

            btnWhatsappProof.setAttribute('data-target-months-list', monthsToMarkLunas.join('.')); 
            btnWhatsappProof.setAttribute('data-detail-pembayaran', detailPembayaran); 

            const amountIDR = new Intl.NumberFormat('id-ID').format(amount);
            
            let htmlContent = `
                <h3><i class="fas fa-check-circle"></i> Instruksi Pembayaran Dibuat</h3>
                <p><strong>Warga:</strong> ${userData.nama} (${currentUserId})</p>
                <p><strong>Detail Pelunasan:</strong> <span style="font-weight: bold; color:#007bff;">${detailPembayaran}</span></p>
                <p><strong>Metode:</strong> ${method}</p>
                <p><strong>Jumlah:</strong> <span style="font-size: 1.2em; color: #dc3545; font-weight: bold;">Rp ${amountIDR}</span></p>
                <hr style="margin: 10px 0;">
            `;

            if (method === 'QR Code (QRIS)') {
                 htmlContent += `
                    <p style="text-align: center;">Scan QRIS di bawah ini menggunakan aplikasi pembayaran Anda (Dana, GoPay, Mobile Banking, dll.)</p>
                    <div class="qris-display">
                        [attachment_0](attachment)
                    </div>
                    <a href="qrcode.jpg"
                    download="qrcode.jpg" style="
                        display: block; 
                        width: 100%; 
                        padding: 10px; 
                        margin-top: 10px; 
                        background-color: #28a745; 
                        color: white; 
                        text-decoration: none; 
                        border-radius: 5px; 
                        font-weight: bold;
                    ">
                        <i class="fas fa-download"></i> Download Gambar QRIS
                    </a>
                `;
            } else if (method === 'Transfer Bank') {
                htmlContent += `
                    <div style="text-align: left;">
                        <p style="font-weight: bold; margin-top: 10px;">Pilih Salah Satu Rekening:</p>
                        <p><strong>Bank:</strong> MANDIRI</p>
                        <p><strong>Nomor Rekening:</strong> 1234-567-890</p>
                        <p><strong>Atas Nama:</strong> CANDRA</p>
                        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 10px 0;">
                        <p><strong>Bank:</strong> DANA (Transfer Virtual)</p>
                        <p><strong>Nomor Rekening:</strong> 0857-8125-6570</p>
                        <p><strong>Atas Nama:</strong> CANDRA</p>
                    </div>
                    <p style="color: red; font-weight: bold; margin-top: 15px;">**Penting:** untuk pembayaran dari semua akun bank ke DANA maka pembayaran di tambah 1000 </p>
                `; 
            } else if (method === 'Offline (Tunai)') {
                 htmlContent += `
                    <div class="offline-instructions">
                        <p style="font-weight: bold; font-size: 1.1em;"><i class="fas fa-hand-holding-usd"></i> Instruksi Pembayaran Tunai</p>
                        <p>Silakan serahkan uang tunai sebesar Rp ${amountIDR} langsung kepada:</p>
                        <ul>
                            <li><strong>Petugas:</strong> Bpk. Candra (Bendahara)</li>
                            <li><strong>Alamat:</strong> Rumah E25-09</li>
                            <li><strong>Waktu:</strong> di komfimasi dulu ke bendahara</li>
                        </ul>
                        <p style="font-style: italic;">**Penting:** Pastikan Anda menerima kwitansi atau bukti serah terima dari petugas. Konfirmasi WhatsApp wajib dilakukan setelah serah terima uang.</p>
                    </div>
                `;
            }

            instructionContentDiv.innerHTML = htmlContent;
            
            btnWhatsappProof.setAttribute('data-name', userData.nama);
            btnWhatsappProof.setAttribute('data-id', currentUserId);
            btnWhatsappProof.setAttribute('data-amount', amountIDR);
            btnWhatsappProof.setAttribute('data-month', detailPembayaran); 
            btnWhatsappProof.setAttribute('data-method', method);
            
            btnWhatsappProof.onclick = function() {
                sendProofViaWhatsApp(
                    this.getAttribute('data-name'),
                    this.getAttribute('data-id'),
                    this.getAttribute('data-amount'),
                    this.getAttribute('data-month'),
                    this.getAttribute('data-method'),
                    this.getAttribute('data-target-months-list') 
                );
            };
        });

        function sendProofViaWhatsApp(name, id, amountIDR, detailPembayaran, method, targetMonthsList) {
            
            if (!proofConfirmationCheckbox.checked) {
                 alert('‚ùå Anda harus mencentang konfirmasi pembayaran terlebih dahulu.');
                 return;
            }

            const monthsToMarkLunas = targetMonthsList.split('.').filter(m => m !== ''); 
            const amount = parseInt(amountIDR.replace(/[^0-9]/g, '')); 

            const userIndex = DUMMY_DATA.findIndex(user => user.id === id);
            if (userIndex !== -1) {
                const userData = DUMMY_DATA[userIndex];
                let totalDibayar = amount;
                
                // 1. Lunasi Tunggakan 2025
                if (userData.tunggakan_2025 > 0) {
                    if (totalDibayar >= userData.tunggakan_2025) {
                        totalDibayar -= userData.tunggakan_2025;
                        userData.tunggakan_2025 = 0; 
                    } else {
                        userData.tunggakan_2025 -= totalDibayar; 
                        totalDibayar = 0;
                    }
                }
                
                // 2. Lunasi Bulan 2026
                if (totalDibayar >= IURAN_PER_BULAN && monthsToMarkLunas.length > 0) {
                    monthsToMarkLunas.forEach(targetMonth => {
                        const iuranItem = userData.iuran.find(item => item.bulan === targetMonth && item.status === 'BLUM BAYAR');
                        if (iuranItem) {
                            iuranItem.status = 'LUNAS'; 
                        }
                    });
                }
                
                DUMMY_DATA[userIndex] = userData;
            }

            // Kembali ke Detail Iuran setelah submit
            showDataUser(id); 

            const phoneNumber = '6285781256570'; // Nomor WA Bendahara
            
            let paymentActionText = 'bukti transfer';
            if (method === 'Offline (Tunai)') {
                 paymentActionText = 'konfirmasi serah terima uang tunai';
            }
            
            const message = `*Konfirmasi Pembayaran Kas gang E21-25*\n\n` +
                            `Nama: *${name}* (BLOK: ${id})\n` +
                            `Detail Pelunasan: *${detailPembayaran}*\n` + 
                            `Jumlah: *Rp ${amountIDR}*\n` +
                            `Metode: *${method}*\n\n` +
                            `*PENTING:* Kirim ${paymentActionText} di chat ini* untuk diverifikasi.\n\n` +
                            `*Status terkini di aplikasi: Sudah LUNAS (Menunggu Verifikasi).*`;
                            
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappURL, '_blank');
        }

        // Auto-fill saat form pembayaran difokuskan
        manualAmountInput.addEventListener('focus', function() {
            if (manualAmountInput.value === '' || parseInt(manualAmountInput.value) < IURAN_PER_BULAN) {
                const userData = DUMMY_DATA.find(user => user.id === currentUserId);
                if (userData) {
                    const tunggakan2025 = userData.tunggakan_2025 || 0;
                    const tunggakan2026List = userData.iuran.filter(item => item.status === 'BLUM BAYAR');
                    
                    if(tunggakan2025 > 0) {
                        manualAmountInput.value = tunggakan2025 + IURAN_PER_BULAN; 
                    } else if (tunggakan2026List.length > 0) {
                        manualAmountInput.value = IURAN_PER_BULAN;
                    } else {
                        manualAmountInput.value = 0;
                    }
                }
                manualAmountInput.dispatchEvent(new Event('input'));
            }
        });
    </script>

</body>
</html>
