<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Iuran Warga & Pembayaran Kas (Petugas)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ======================================= */
        /* === CSS UMUM & FULL LAYAR (REVISI) === */
        /* ======================================= */
        /* Target elemen <html> dan <body> untuk menghilangkan margin/padding bawaan */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%; /* Pastikan body mengambil tinggi penuh */
            width: 100%;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            text-align: center;
        }

        /* CONTAINER: Diubah menjadi 100% width untuk layout full-screen/mobile, */
        .container {
            width: 100%; /* Selalu 100% agar tidak ada batas putih di kiri/kanan */
            min-height: 100vh;
            margin: 0 auto;
            background: white; /* Ini akan menjadi warna latar di layar lebar */
            padding: 0; /* Hapus padding di container, pindahkan ke content-wrapper */
            box-shadow: none; 
            position: relative;
        }

        /* CONTENT-WRAPPER: Inilah elemen yang seharusnya membatasi konten dan memiliki box-shadow */
        .content-wrapper {
            max-width: 800px;
            margin: 0 auto; /* Tengah di layar lebar */
            background: white;
            padding: 20px; /* Padding yang mengontrol ruang di dalam konten */
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Tambahan: Responsivitas untuk tampilan seluler pada content-wrapper */
        @media (max-width: 600px) {
            .content-wrapper {
                border-radius: 0; /* Hapus border-radius di layar kecil agar menyatu */
                padding: 15px 10px; /* Padding lebih kecil untuk mobile */
                box-shadow: none; /* Hapus bayangan agar tampak seperti aplikasi native */
            }
        }

        h1 {
            font-size: 1.8em;
            color: #ff5722;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        /* ======================================= */
        /* === LOGIN STYLING (TETAP) === */
        /* ======================================= */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f4f8; 
            padding: 0;
            margin: 0;
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        .login-box h2 {
            color: #007bff;
            margin-bottom: 30px;
        }
        .login-box input[type="text"],
        .login-box input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
        }
        .login-box button {
            width: 100%;
            padding: 12px;
            background-color: #ff5722;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .login-box button:hover {
            background-color: #e64a19;
        }
        #login-message {
            color: #dc3545;
            margin-top: 15px;
            font-weight: bold;
        }

        /* ======================================= */
        /* === Home Menu (TETAP) === */
        /* ======================================= */
        #home-menu {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        #home-menu h2 {
            margin: 0;
            font-size: 1.2em;
        }
        #home-menu button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        #home-menu button:hover {
            background-color: #c82333;
        }
        
        /* ======================================= */
        /* === DASHBOARD PETUGAS (REVISI) === */
        /* ======================================= */
        #admin-dashboard {
            display: none; /* Default hidden */
            text-align: left;
        }
        .saldo-box {
            background-color: #28a745;
            color: white;
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
        }
        .saldo-box h3 {
            margin-top: 0;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        .saldo-running-text {
            white-space: nowrap;
            overflow: hidden;
            box-sizing: border-box;
        }
        .saldo-running-text span {
            display: inline-block;
            padding-left: 100%;
            font-size: 1.7em; 
            font-weight: bold;
            animation: marquee 15s linear infinite;
        }
        @keyframes marquee {
            0%   { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }
        
        .menu-grid {
            display: grid;
            /* REVISI: Mengubah minmax agar lebih responsif di mobile */
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 15px;
            margin-top: 25px;
        }
        
        /* MODIFIKASI: Menu Item 3D */
        .menu-item {
            background-color: #007bff;
            color: white;
            padding: 15px 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            
            /* MODIFIKASI 3D EFFECT START */
            box-shadow: 0 5px #0056b3, 0 8px 15px rgba(0, 0, 0, 0.3); /* Bayangan 3D */
            border-bottom: 5px solid #0056b3;
            transition: transform 0.1s, box-shadow 0.1s, background-color 0.2s;
            /* MODIFIKASI 3D EFFECT END */
        }
        .menu-item:hover {
            background-color: #0056b3;
            transform: translateY(-2px); /* Efek mengangkat sedikit */
            box-shadow: 0 7px #0056b3, 0 10px 20px rgba(0, 0, 0, 0.4);
        }
        .menu-item:active {
            transform: translateY(3px); /* Efek menekan tombol */
            box-shadow: 0 2px #0056b3, 0 5px 10px rgba(0, 0, 0, 0.2);
            border-bottom: 2px solid #0056b3;
        }

        .menu-item i {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: block;
        }
        .menu-item p {
            margin: 0;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        /* ======================================= */
        /* === REVISI: STYLE KHUSUS 'DATA KAS SAYA' === */
        /* ======================================= */
        .menu-item.data-kas-saya i {
            font-size: 2em; /* Perkecil ikon */
            margin-bottom: 5px; /* Perkecil margin bawah ikon */
        }
        .menu-item.data-kas-saya p:first-of-type {
            font-size: 1em; /* Perkecil font nama menu */
            font-weight: bold;
        }
        .menu-item.data-kas-saya p:last-of-type {
            font-size: 0.7em; /* Perkecil font blok */
            margin-top: 3px; /* Perkecil margin atas blok */
            font-weight: normal;
        }


        /* ======================================= */
        /* === RESULT STYLING (REVISI) === */
        /* ======================================= */
        #result-container, #instruction-container {
            display: none; /* Default hidden */
            text-align: left;
        }
        
        /* Hapus style data-item lama */
        .data-item {
            display: none; /* Sembunyikan style lama */
        }

        /* Container utama untuk tampilan seperti tabel */
        #data-display-table {
            width: 100%;
            margin-top: 15px;
            border: 1px solid #ccc; /* Border luar */
            border-radius: 6px;
            overflow: hidden; /* Pastikan border-radius diterapkan */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .data-header, .data-row {
            display: grid;
            /* Kolom: Bulan (40%), Nominal (30%), Status/Ket (30%) */
            grid-template-columns: 40% 30% 30%; 
            text-align: center;
            padding: 10px 5px;
        }

        .data-header {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            border-bottom: 2px solid #0056b3;
        }

        .data-row {
            border-bottom: 1px dashed #e0e0e0;
            background-color: white;
            font-size: 0.95em;
        }

        .data-row:nth-child(even) {
            background-color: #f8fafd; /* Warna selang-seling */
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .data-row > span:first-child {
            text-align: left;
            padding-left: 10px;
            font-weight: 600;
        }

        .data-row .lunas { color: #28a745; font-weight: bold; }
        .data-row .belum { color: #dc3545; font-weight: bold; }
        
        /* END MODIFIKASI: DETAIL IURAN BULANAN */

        .total-info {
            margin-top: 20px;
            padding: 0; /* Dihilangkan padding utama */
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 4px;
            text-align: center;
        }
        #lunas-message {
            padding: 15px;
            margin-top: 20px;
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            font-weight: bold;
            display: none;
        }
        
        /* ======================================= */
        /* === MODIFIKASI TOMBOL BAYAR (BARU) === */
        /* ======================================= */
        #btn-show-manual-from-detail {
            width: 100%;
            padding: 18px 12px; /* Ditingkatkan */
            margin-top: 25px; /* Margin diperlebar */
            background-color: #ff5722;
            color: white;
            border: none;
            border-radius: 10px; /* Lebih Bulat */
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em; /* Font lebih besar */
            letter-spacing: 1px;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 4px 15px rgba(255, 87, 34, 0.4); /* Efek Bayangan */
        }
        #btn-show-manual-from-detail:hover {
            background-color: #e64a19;
            transform: translateY(-3px); /* Efek Naik */
            box-shadow: 0 6px 20px rgba(255, 87, 34, 0.6);
        }

        #manual-payment-section {
            display: none; /* Pastikan default hidden */
            margin-top: 0;
            padding: 20px;
            border: 1px dashed #007bff;
            border-radius: 8px;
            background-color: #f8fafd;
            text-align: center;
        }
        #payment-form-manual input[type="number"],
        #payment-form-manual input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        #payment-form-manual button[type="submit"] {
            width: 100%;
            padding: 15px; 
            margin-top: 25px; 
            margin-bottom: 10px; 
            background-color: #ff5722; 
            color: white;
            border: none;
            border-radius: 8px; 
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em; 
            transition: background-color 0.3s, transform 0.2s;
        }
        #payment-form-manual button[type="submit"]:hover {
            background-color: #e64a19; 
            transform: translateY(-1px); 
        }
        
        /* Instruksi Pembayaran (BARU) */
        #instruction-container { 
            display: none; 
            padding: 20px;
            border: 1px dashed #28a745;
            background-color: #e6ffed;
            text-align: left;
            border-radius: 8px;
        }
        #btn-whatsapp-proof {
            margin-top: 15px;
            width: 100%;
            padding: 12px;
            background-color: #ccc; 
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: not-allowed;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #btn-whatsapp-proof.active {
            background-color: #25d366; 
            cursor: pointer;
        }
        .qris-display {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #ccc;
            
        }
        .qris-display img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
        }
        #confirmation-container {
            margin: 15px 0;
            padding: 10px;
            background-color: #fff3cd; 
            border: 1px solid #ffeeba;
            border-radius: 5px;
            text-align: left;
            display: flex;
            align-items: center;
        }
        #confirmation-container input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.3);
        }
        .offline-instructions {
            padding: 15px;
            background-color: #fce4ec; 
            border: 1px solid #f8bbd0;
            border-radius: 5px;
            margin-top: 15px;
            color: #880e4f;
            text-align: left;
        }
        
        /* STYLE KHUSUS TOTAL TUNGGAKAN (REVISI) */
        #tunggakan-detail {
            font-size: 0.9em; 
            text-align: left;
            line-height: 1.8; 
            color: #495057; 
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #fff;
            margin-top: 15px;
        }
        .tunggakan-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            background-color: #007bff;
            color: white;
            padding: 8px 5px;
            border-radius: 4px 4px 0 0;
            margin: -15px -15px 10px -15px;
            border-bottom: 2px solid #0056b3;
        }
        .tunggakan-header > div {
            flex-basis: 33%;
            text-align: center;
        }
        .tunggakan-header .col-deskripsi {
            text-align: left;
            padding-left: 10px;
        }
        .tunggakan-line {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        .tunggakan-line > span {
            flex-basis: 33%;
            text-align: center;
            font-weight: normal;
        }
        .tunggakan-line .col-deskripsi {
            flex-basis: 50%;
            text-align: left;
            padding-left: 10px;
            font-weight: bold;
        }
        .tunggakan-total {
            border-top: 3px double #007bff;
            padding-top: 10px;
            margin-top: 10px;
            font-weight: bold;
            color: #dc3545; 
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
        }
        .tunggakan-total > span:last-child {
            font-size: 1.2em;
            color: #dc3545;
        }
        /* END STYLE KHUSUS TOTAL TUNGGAKAN */


        
.data-anggota-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
.data-anggota-table th, .data-anggota-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
    font-size: 0.9em;
}
.data-anggota-table th {
    background-color: #007bff;
    color: white;
}
.data-anggota-table tr:nth-child(even) {
    background-color: #f2f2f2;
}

/* --- Tambahan untuk Teks Merah pada Kolom Ketiga (Tunggakan) --- */

/* Mengubah warna teks pada sel data (td) kolom ketiga */
.data-anggota-table td:nth-child(3) {
    color: red; 
    font-weight: bold; /* Opsional */
}

/* Opsional: Jika Anda ingin header (th) kolom ketiga juga berwarna merah */
.data-anggota-table th:nth-child(3) {
    /* Hanya warna teks pada header */
    /* color: red;  */
    /* Atau, jika Anda hanya ingin warna teks di *data* yang merah, hapus bagian ini */
}

        
        /* ======================================= */
        /* === LAPORAN KAS STYLING (REVISI) === */
        /* ======================================= */
        #cash-report-container {
            display: none; /* Default hidden */
            text-align: left;
            margin-top: 20px;
        }
        .report-summary-box {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
            text-align: center;
        }
        .summary-card {
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 45%; /* Diubah agar hanya 2 card */
        }
        .summary-card h4 {
            margin: 0 0 10px 0;
            font-size: 1em;
        }
        .summary-card p {
            font-size: 1.5em;
            font-weight: bold;
            margin: 0;
        }
        .card-pemasukan {
            background-color: #e6ffed;
            color: #1e7e34;
            border: 1px solid #c3e6cb;
        }
        .card-pengeluaran {
            background-color: #fcecec;
            color: #dc3545;
            border: 1px solid #f5c6cb;
        }
        /* .card-saldo dihapus */

        .cash-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .cash-table th, .cash-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
        }
        .cash-table th {
            background-color: #ff5722; /* Diubah warnanya */
            color: white;
        }
        .cash-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* MODIFIKASI: Tombol Edit/Aksi */
        .edit-button {
            background-color: #007bff; 
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8em;
            transition: background-color 0.2s;
            margin-left: 10px;
        }
        .edit-button:hover {
            background-color: #0056b3;
        }


        /* Tombol Kembali (MODIFIKASI) */
        .btn-back {
            position: absolute;
            bottom: 5px;
            left: 5px;
            padding: 5px 10px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            z-index: 50;
            display: none; /* Default hidden */
        }
        
    </style>
</head>
<body>

    <div id="login-container">
        <div class="login-box">
            <h2><i class="fas fa-user-tag"></i> Login Kas gang E21-25</h2>
            <form id="login-form">
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit"><i class="fas fa-sign-in-alt"></i> Masuk</button>
            </form>
            <p id="login-message" style="display:none;">Username atau Password salah!</p>
        </div>
    </div>


    <div class="container" id="container-iuran" style="display:none;">
        <div class="content-wrapper">
            
            <div id="home-menu">
                <h2 id="current-user-info"><i class="fas fa-user-shield"></i> Hi, Petugas!</h2>
                <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>

            <h1>PEMBAYARAB KAS GANG E21-25 </h1>
            <div class="loader" id="loader" style="display:none;"></div>
            
            <div id="admin-dashboard">
                <div class="saldo-box">
                    <h3><i class="fas fa-money-check-alt"></i> SISA SALDO KAS TERKINI</h3>
                    <div class="saldo-running-text">
                        <span id="current-saldo-text">Rp 12,345,678. Saldo ini adalah akumulasi dana iuran, kas RT, dan BSK.</span>
                    </div>
                </div>
                
                <h3 style="color:#007bff; margin-top: 30px;"><i class="fas fa-th-large"></i> Menu Utama Petugas</h3>
                <div class="menu-grid">
                    <div class="menu-item data-kas-saya" onclick="showDataUser(currentUserId)">
                        <i class="fas fa-id-card-alt"></i>
                        <p>Data Kas Saya</p>
                        <p style="font-size:0.8em; margin-top: 5px;">(Blok: E21-25)</p>
                    </div>
                    <div class="menu-item" onclick="showDataAnggota()">
                        <i class="fas fa-users"></i>
                        <p>Data Anggota Kas</p>
                    </div>
                    <div class="menu-item" id="menu-laporan-kas" onclick="showCashReport()"> 
                        <i class="fas fa-chart-line"></i>
                        <p>Laporan Kas</p>
                    </div>
                </div>

            </div>

            <div id="result-container">
                <div id="status-message" class="status-message"></div>

                <div id="content-display">
                    <h3 style="color:#007bff;"><i class="fas fa-receipt"></i> Detail Iuran Kas: <span id="user-name"></span></h3>
                    
                    <div id="data-display"></div>

                    <div id="payment-summary">
                        <div class="total-info">
                            <h4 style="margin-bottom: 5px;">Ringkasan Total Harus Dibayar</h4>
                            <div id="tunggakan-detail">
                                </div>
                          
                            <p style="font-size: 1.1em; margin-top: 15px;">TOTAL BAYAR: <span id="total-tunggakan" style="font-size: 1.4em; color:#ff5722;">Rp 0</span></p>
                        </div>
                      
                    </div>
                    
                    <div id="lunas-message">
                        <i class="fas fa-handshake"></i> Terima kasih, Anda sudah membayar kas dengan lancar!
                    </div>
                  
                     <div id="tunggakan-options">
                        <p style="margin-top:15px; font-style:italic;"></p> 

                        <button id="btn-show-manual-from-detail" onclick="showManualPayment(currentUserId)">
                            <i class="fas fa-calendar-check"></i> LANJUTKAN KE PEMBAYARAN
                        </button>
                    </div>
                </div>
            </div>

            <div id="anggota-data-container" style="display:none; text-align:left;">
                 <div id="anggota-table-display"></div>
            </div>

            <div id="manual-payment-section">
                <h3>ðŸ’µ Form Pembayaran Kas Gang E21-25</h3>
                <p>Pembayaran untuk iuran spesifik beberapa bulan sekaligus.</p>
                <hr style="border: 0; border-top: 1px solid #ccc; margin: 10px 0;">
                <p style="font-weight: bold;">Untuk: <span id="manual-user-detail" style="color:#ff5722;"></span></p>
                <p style="font-size: 0.9em; color: #6c757d;">(Iuran per bulan: <span id="iuran-bulanan-manual"></span>)</p>

                <form id="payment-form-manual">
                    
                    <div class="form-group" style="text-align: left; background-color: #f7e8e8; padding: 10px; border-radius: 5px; border: 1px solid #dc3545;" id="group-tunggakan-2025">
                         <label for="tunggakan-2025-amount" style="font-weight: bold; color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> Tunggakan Tahun 2025</label>
                         <input type="text" id="tunggakan-2025-amount" readonly style="background-color: #fcecec; color: #dc3545; font-weight: bold; margin-bottom: 5px;">
                         <p style="font-style: italic; color: #721c24;">*Pembayaran akan otomatis melunasi Tunggakan 2025 ini terlebih dahulu.</p>
                    </div>

                    <div class="form-group" style="text-align: left; margin-top: 20px;">
                        <label for="manual-amount">Jumlah Pembayaran (Rp) Total Yang Disetor</label>
                        <input type="number" id="manual-amount" name="amount" min="1" step="1" required placeholder="Contoh: 25000" value="">
                        <p style="margin-top:1px; font-style:italic;" > </p>
                    </div>

                    <div class="form-group" style="text-align: left;">
                        <label for="manual-month">Detail Pelunasan</label>
                        <input type="text" id="manual-month" name="month" required readonly placeholder="Diisi otomatis..." style="background-color: #eee;">
                        <p style="margin-top:0,5px; font-style:italic;" ></p>
                    </div>

                    <div class="form-group" style="text-align: left;">
                        <label>Pilih Metode Pembayaran</label>
                        
                        <div class="radio-group">
                            <input type="radio" id="manual-qrcode" name="method" value="QR Code (QRIS)" checked>
                            <label for="manual-qrcode">QR Code (QRIS)</label>

                            <input type="radio" id="manual-banktransfer" name="method" value="Transfer Bank">
                            <label for="manual-banktransfer">Transfer Bank</label>
                            
                            <input type="radio" id="manual-offline" name="method" value="Offline (Tunai)">
                            <label for="manual-offline">Offline (Tunai)</label>
                        </div>
                    </div>

                    <button type="submit"><i class="fas fa-file-invoice"></i> Buat Instruksi Pembayaran
                    </button>
                </form>

            </div>
            
            <div id="instruction-container">
                 <div id="payment-instruction-content"></div>

                    <hr style="margin: 20px 0;">

                    <div id="confirmation-container">
                        <input type="checkbox" id="proof-confirmation" required>
                        <label for="proof-confirmation" style="font-weight: bold; color: #dc3545;">Saya mengkonfirmasi sudah <span id="confirm-action">transfer</span> dan siap mengirimkan bukti via WhatsApp.</label>
                    </div>
                    
                    <button id="btn-whatsapp-proof" disabled>
                        <i class="fab fa-whatsapp"></i> Konfirmasi & Kirim Bukti Pembayaran
                    </button>
            </div>
            
            <div id="cash-report-container">
                <h3 style="color:#007bff; margin-top: 10px;"><i class="fas fa-chart-line"></i> Laporan Kas Bulanan 
                    <span id="cash-report-admin-tools">
                        </span>
                </h3>
                <div id="report-content"></div>
            </div>
            <button id="btn-back-to-detail" class="btn-back" onclick="showDataUser(currentUserId)">
                <i class="fas fa-chevron-left"></i> Kembali
            </button>
            <button id="btn-back-to-manual-form" class="btn-back" onclick="showManualPayment(currentUserId)">
                <i class="fas fa-chevron-left"></i> Kembal
            </button>
            <button id="btn-back-to-dashboard" class="btn-back" onclick="showDashboard()">
                <i class="fas fa-chevron-left"></i> Kembali
            </button>

        </div>
    </div>
      
    <script>
        // =======================================
        // === KONFIGURASI USER PETUGAS (REVISI) ===
        // =======================================
        const PETUGAS_USERS = [
            // dataId: Blok Warga yang diawasi/menjadi data utama
            { username: 'admin', password: '123', name: 'Admin Utama', dataId: 'E25-25', isAdmin: true }, 
            
            // --- DAFTAR PETUGAS BARU ---
  { username: 'novry', password: '2138', name: 'Novry', dataId: 'E21-38', isAdmin: false },
            { username: 'fathur', password: '2139', name: 'Fathur', dataId: 'E21-39', isAdmin: false },
            { username: 'hanif', password: '2141', name: 'Hanif', dataId: 'E21-41', isAdmin: false },
            { username: 'eka adi', password: '2142', name: 'Eka Adi', dataId: 'E21-42', isAdmin: false },
            { username: 'larasati', password: '2143', name: 'Laras', dataId: 'E21-43', isAdmin: false },
            { username: 'rahman', password: '2146', name: 'Rahman', dataId: 'E21-46', isAdmin: false },
            { username: 'rakel', password: '2147', name: 'Rakel', dataId: 'E21-47', isAdmin: false },
            { username: 'hendra', password: '2148', name: 'Hendra', dataId: 'E21-48', isAdmin: false }, 
            { username: 'nana', password: '2149', name: 'Nana rusmana', dataId: 'E21-49', isAdmin: false },
            { username: 'aji', password: '2157', name: 'Aji', dataId: 'E21-57', isAdmin: false },
            { username: 'rohman', password: '2151', name: 'Rohman', dataId: 'E21-51', isAdmin: false },
            { username: 'viko', password: '2153', name: 'Viko', dataId: 'E21-53', isAdmin: false },
            { username: 'hendri', password: '2155', name: 'Hendri', dataId: 'E21-55', isAdmin: false },
            { username: 'riyandi', password: '2156', name: 'Riyandi', dataId: 'E21-56', isAdmin: false },
            { username: 'angga', password: '2160', name: 'Angga', dataId: 'E21-60', isAdmin: false },
            { username: 'iwan', password: '2161', name: 'Iwan', dataId: 'E21-61', isAdmin: false },
            { username: 'mario', password: '2165', name: 'Mario', dataId: 'E21-65', isAdmin: false },
            { username: 'koko', password: '2166', name: 'Koko', dataId: 'E21-66', isAdmin: false },
            { username: 'rico', password: '2167', name: 'Rico', dataId: 'E21-67', isAdmin: false },
            { username: 'irwan', password: '2168', name: 'Irwan', dataId: 'E21-68', isAdmin: false },
            { username: 'toro', password: '2169', name: 'Toro', dataId: 'E21-69', isAdmin: false },
            { username: 'topan', password: '2170', name: 'Topan', dataId: 'E21-70', isAdmin: false },
            { username: 'heri', password: '2171', name: 'Heri', dataId: 'E21-71', isAdmin: false },
            { username: 'bayu ade', password: '2172', name: 'Bayu Ade', dataId: 'E21-72', isAdmin: false },
            { username: 'firly', password: '2173', name: 'Firly', dataId: 'E21-73', isAdmin: false },

    // Data contoh yang Anda berikan (dijadikan sebagai referensi format)

    { 
        username: 'krisna', 
        password: '2503', 
        name: 'KRISNA', 
        dataId: 'E25-03', 
        isAdmin: false 
    },
    { 
        username: 'deny', 
        password: '2508', 
        name: 'DENY', 
        dataId: 'E25-08', 
        isAdmin: false 
    },
    { 
        username: 'chandra', 
        password: '2509', 
        name: 'CHANDRA', 
        dataId: 'E25-09', 
        isAdmin: false 
    },
    { 
        username: 'alfian', 
        password: '2510', 
        name: 'ALFIAN', 
        dataId: 'E25-10', 
        isAdmin: false 
    },
    { 
        username: 'tedi', 
        password: '2511', 
        name: 'TEDI', 
        dataId: 'E25-11', 
        isAdmin: false 
    },
    { 
        username: 'deri', 
        password: '2515', 
        name: 'DERI', 
        dataId: 'E25-15', 
        isAdmin: false 
    },
    { 
        username: 'paulus', 
        password: '2518', 
        name: 'PAULUS', 
        dataId: 'E25-18', 
        isAdmin: false 
    },
    { 
        username: 'dede dwi', 
        password: '2519', 
        name: 'DEDE DWI', 
        dataId: 'E25-19', 
        isAdmin: false 
    },
    { 
        username: 'anang', 
        password: '2520', 
        name: 'ANANG', 
        dataId: 'E25-20', 
        isAdmin: false 
    },
    { 
        username: 'parulian', 
        password: '2521', 
        name: 'PARULIAN', 
        dataId: 'E25-21', 
        isAdmin: false 
    },
    { 
        username: 'bayu nur', 
        password: '2522', 
        name: 'BAYU NUR', 
        dataId: 'E25-22', 
        isAdmin: false 
    },
    { 
        username: 'waluyo', 
        password: '2523', 
        name: 'WALUYO', 
        dataId: 'E25-23', 
        isAdmin: false 
    },
    { 
        username: 'hadi', 
        password: '2527', 
        name: 'HADI', 
        dataId: 'E25-27', 
        isAdmin: false 
    },
    { 
        username: 'pakdeh agung', 
        password: '2528', 
        name: 'Pakdeh Agung', 
        dataId: 'E25-28', 
        isAdmin: false 
    },
    { 
        username: 'budi almawan', 
        password: '2530', 
        name: 'BUDI ALMAWAN', 
        dataId: 'E25-30', 
        isAdmin: false 
    },
    { 
        username: 'bagus', 
        password: '2531', 
        name: 'BAGUS', 
        dataId: 'E25-31', 
        isAdmin: false 
    },
    { 
        username: 'asep', 
        password: '2532', 
        name: 'ASEP', 
        dataId: 'E25-32', 
        isAdmin: false 
    },
    { 
        username: 'dede gunawan', 
        password: '2533', 
        name: 'DEDE GUNAWAN', 
        dataId: 'E25-33', 
        isAdmin: false 
    },
    { 
        username: 'kardan', 
        password: '2535', 
        name: 'KARDAN', 
        dataId: 'E25-35', 
        isAdmin: false 
    },
    { 
        username: 'rendy', 
        password: '2536', 
        name: 'RENDY', 
        dataId: 'E25-36', 
        isAdmin: false 
    },
    { 
        username: 'vera', 
        password: '2537', 
        name: 'VERA', 
        dataId: 'E25-37', 
        isAdmin: false 
    }


        ];

        const KAS_SALDO_DUMMY = 3500000; // Saldo kas dummy

        // =======================================
        // === FUNGSI LOGIN & LOGOUT (MODIFIKASI) ===
        // =======================================
        const loginContainer = document.getElementById('login-container');
        const loginForm = document.getElementById('login-form');
        const appContainer = document.getElementById('container-iuran');
        const loginMessage = document.getElementById('login-message');
        const currentUserInfo = document.getElementById('current-user-info');
        
        // Elemen Halaman
        const adminDashboard = document.getElementById('admin-dashboard');
        const resultContainer = document.getElementById('result-container'); 
        const manualPaymentSection = document.getElementById('manual-payment-section');
        const instructionContainer = document.getElementById('instruction-container');
        const anggotaDataContainer = document.getElementById('anggota-data-container');
        const cashReportContainer = document.getElementById('cash-report-container'); 
        const reportContentDiv = document.getElementById('report-content'); 
        const menuLaporanKas = document.getElementById('menu-laporan-kas'); 
        const iuranBulananManual = document.getElementById('iuran-bulanan-manual');

        
        // Tombol Kembali
        const btnBackToDetail = document.getElementById('btn-back-to-detail');
        const btnBackToManualForm = document.getElementById('btn-back-to-manual-form');
        const btnBackToDashboard = document.getElementById('btn-back-to-dashboard');
        
        let currentUserId = ''; // ID (Blok) Warga yang sedang login/dilihat datanya
        let currentUserName = ''; 
        let isAdmin = false; // Status Admin

        function checkLoginStatus() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                const user = JSON.parse(loggedInUser);
                currentUserId = user.dataId; // Set ID Warga yang terkait dengan Petugas
                currentUserName = user.name;
                isAdmin = user.isAdmin; // Set status admin
                showApp(user);
            } else {
                showLogin();
            }
        }

        function showApp(user) {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'block';
            // MODIFIKASI: Mengubah teks dari 'Hi' menjadi 'Selamat Datang'
            currentUserInfo.innerHTML = `<i class="fas fa-user-shield"></i> Selamat Datang, ${user.name}${user.isAdmin ? ' (Admin)' : ''}!`;
            showDashboard();
            
            // Menu Laporan Kas visible by default now, as access control is inside showCashReport
        }
        
        // FUNGSI BARU: Kontrol Halaman
        function showPage(pageId) {
            // Sembunyikan semua halaman
            adminDashboard.style.display = 'none';
            resultContainer.style.display = 'none';
            manualPaymentSection.style.display = 'none';
            instructionContainer.style.display = 'none';
            anggotaDataContainer.style.display = 'none';
            cashReportContainer.style.display = 'none'; 
            
            // Sembunyikan semua tombol kembali
            btnBackToDetail.style.display = 'none';
            btnBackToManualForm.style.display = 'none';
            btnBackToDashboard.style.display = 'none';

            if (pageId === 'dashboard') {
                adminDashboard.style.display = 'block';
            } else if (pageId === 'detail') {
                resultContainer.style.display = 'block';
                btnBackToDashboard.style.display = 'block';
            } else if (pageId === 'payment-form') {
                manualPaymentSection.style.display = 'block';
                btnBackToDashboard.style.display = 'block'; // Kembali ke dashboard
            } else if (pageId === 'instruction') {
                instructionContainer.style.display = 'block';
                btnBackToManualForm.style.display = 'block'; // Kembali ke form pembayaran
            } else if (pageId === 'anggota') {
                anggotaDataContainer.style.display = 'block';
                btnBackToDashboard.style.display = 'block'; 
            } else if (pageId === 'report') { 
                cashReportContainer.style.display = 'block';
                btnBackToDashboard.style.display = 'block';
            }
        }
        
        function showDashboard() {
            showPage('dashboard');
            document.getElementById('current-saldo-text').textContent = `Rp ${KAS_SALDO_DUMMY.toLocaleString('id-ID')}. Saldo kas gnag E21-25 saat ini.`;

            // === UPDATE KARTU IURAN SAYA (BARU) ===
            document.querySelector('#admin-dashboard .menu-grid .menu-item:first-child').innerHTML = `
                <i class="fas fa-id-card-alt"></i>
                <p>Data Kas Saya</p>
                <p style="font-size:0.7em; margin-top: 3px;">(Blok: ${currentUserId})</p>
            `;
            // ======================================
        }
        
        function showLogin() {
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
            loginMessage.style.display = 'none';
            loginForm.reset();
            
        }

        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const user = PETUGAS_USERS.find(u => u.username.toLowerCase() === username.toLowerCase() && u.password === password);

            if (user) {
                localStorage.setItem('loggedInUser', JSON.stringify(user));
                currentUserId = user.dataId;
                currentUserName = user.name;
                isAdmin = user.isAdmin;
                showApp(user);
            } else {
                loginMessage.style.display = 'block';
            }
        });

        function logout() {
            localStorage.removeItem('loggedInUser');
            alert('Anda telah logout.');
            showLogin();
        }
        
        // FUNGSI BARU: Pindah ke Tampilan Detail Data Iuran
        function showDataUser(id) {
            const foundUser = DUMMY_DATA.find(user => user.id === id);
            
            showPage('detail');
            document.getElementById('content-display').style.display = 'block'; 

            if (foundUser) {
                displayUserData(foundUser); 
            } else {
                statusMessageDiv.className = 'status-message status-not-found';
                statusMessageDiv.innerHTML = `âŒ Data Iuran untuk **${id}** Tidak Ditemukan. Hubungi Bendahara.`;
                document.getElementById('content-display').style.display = 'none';
            }
        }
        
        // FUNGSI BARU: Pindah ke Tampilan Pembayaran Manual
        function showManualPayment(id) {
            showPage('payment-form');
            
            const userData = DUMMY_DATA.find(user => user.id === id);
            if (!userData) return;
            
            // Tentukan iuran bulanan yang benar
            const iuranBulanan = userData.iuran_bulanan || IURAN_NORMAL;
            iuranBulananManual.textContent = `Rp ${iuranBulanan.toLocaleString('id-ID')}`;

            // Logic mengisi form payment
            const tunggakan2025 = userData.tunggakan_2025 || 0;
            const tunggakan2026List = userData.iuran.filter(item => item.status === 'BLUM BAYAR');
            
            if(tunggakan2025 > 0) {
                // Default bayar tunggakan 2025 + 1 bulan 2026
                manualAmountInput.value = tunggakan2025 + iuranBulanan; 
            } else if (tunggakan2026List.length > 0) {
                // Default bayar 1 bulan 2026
                manualAmountInput.value = iuranBulanan;
            } else {
                manualAmountInput.value = 0; 
            }
            manualAmountInput.dispatchEvent(new Event('input')); // Trigger input event
            
            // Atur minimal input berdasarkan tunggakan 2025
            manualAmountInput.min = (tunggakan2025 > 0) ? tunggakan2025 : iuranBulanan;

            // Reset status konfirmasi
            if(proofConfirmationCheckbox) proofConfirmationCheckbox.checked = false; 
            btnWhatsappProof.disabled = true;
            btnWhatsappProof.classList.remove('active');
            confirmActionSpan.textContent = 'transfer'; 
        }
        
        // FUNGSI BARU: Tampilkan Data Anggota + FUNGSI ADMIN EDIT
        function showDataAnggota() {
            showPage('anggota');
            
            let html = `
                <h3 style="color:#007bff; margin-top: 10px;"><i class="fas fa-users"></i> Data Anggota Kas Gang E21-25
                ${isAdmin ? `<button class="edit-button" onclick="addAnggotaData()" style="background-color: #28a745; margin-left: 10px;"><i class="fas fa-plus-circle"></i> Tambah Anggota</button>` : ''}
                </h3>
                <div id="anggota-table-display">
                    <table class="data-anggota-table">
                        <thead>
                            <tr>
                                <th>BLOK</th>
                                <th>NAMA Warga</th>
                                <th>Tunggakan 2025 (Rp)</th>
                                <th>Status Iuran 2026</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            DUMMY_DATA.forEach(user => {
                const tunggakan2025IDR = user.tunggakan_2025.toLocaleString('id-ID');
                const tunggakan2026Count = user.iuran.filter(i => i.status === 'BLUM BAYAR').length;
                let status2026 = (tunggakan2026Count === 0) ? '<span class="lunas">Lunas</span>' : 
                                 `<span class="belum">${tunggakan2026Count} bulan</span>`;

                // Kontrol tombol Aksi
                let aksiButtons = 'â€”';
                if (isAdmin) {
                    aksiButtons = `
                       <button class="edit-button" onclick="editAnggotaData('${user.id}')" style="margin-left: 0;"><i class="fas fa-edit"></i> Ubah Status</button>
                       <button class="edit-button" onclick="deleteAnggotaData('${user.id}')" style="background-color: #dc3545;"><i class="fas fa-trash"></i> Hapus</button>
                    `;
                }

                html += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.nama}</td>
                        <td>${tunggakan2025IDR}</td>
                        <td>${status2026}</td>
                        <td>${aksiButtons}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('anggota-data-container').innerHTML = html;
        }
        
        // FUNGSI ADMIN: EDIT DATA ANGGOTA
        function editAnggotaData(userId) {
            if (!isAdmin) {
                alert('Anda tidak memiliki izin untuk mengubah data anggota.');
                return;
            }
            const userIndex = DUMMY_DATA.findIndex(user => user.id === userId);
            if (userIndex === -1) return;

            const user = DUMMY_DATA[userIndex];
            
            let currentMonths = user.iuran.map(i => i.bulan + ": " + i.status).join(', ');
            
            const newTunggakan2025 = prompt(`Edit Tunggakan 2025 (saat ini: Rp ${user.tunggakan_2025.toLocaleString('id-ID')}):`, user.tunggakan_2025);
            
            if (newTunggakan2025 !== null && !isNaN(parseInt(newTunggakan2025))) {
                user.tunggakan_2025 = parseInt(newTunggakan2025);
            }
            
            const newMonthsStatus = prompt(`Edit Status Iuran 2026 (Format: Bulan:LUNAS/BLUM BAYAR, ...)\n\nContoh: JANUARI:LUNAS, FEBRUARI:BLUM BAYAR\n\nStatus saat ini:\n${currentMonths}`, currentMonths);
            
            if (newMonthsStatus !== null) {
                 const monthUpdates = newMonthsStatus.split(',').map(s => s.trim()).filter(s => s.includes(':'));
                 monthUpdates.forEach(update => {
                     const [month, status] = update.split(':').map(s => s.trim().toUpperCase());
                     const iuranItem = user.iuran.find(item => item.bulan === month);
                     if (iuranItem && (status === 'LUNAS' || status === 'BLUM BAYAR')) {
                         iuranItem.status = status;
                     }
                 });
            }
            
            DUMMY_DATA[userIndex] = user;
            alert(`Data untuk ${user.nama} (${userId}) berhasil diperbarui.`);
            showDataAnggota(); // Refresh tampilan
        }
        
        // FUNGSI ADMIN: TAMBAH DATA ANGGOTA BARU (BARU)
        function addAnggotaData() {
            if (!isAdmin) {
                alert('Anda tidak memiliki izin untuk menambah data anggota.');
                return;
            }
            
            const newId = prompt('Masukkan BLOK Warga Baru (Contoh: E25-10):');
            if (!newId) return;
            
            // Cek duplikasi ID
            if (DUMMY_DATA.find(user => user.id === newId.toUpperCase())) {
                alert(`ID Blok ${newId} sudah ada.`);
                return;
            }
            
            const newName = prompt(`Masukkan NAMA Warga untuk BLOK ${newId}:`);
            if (!newName) return;
            
            const iuranNominal = confirm("Apakah warga ini mendapat subsidi Rp 10.000 (Iuran Rp 15.000)?") ? IURAN_SUBSIDI : IURAN_NORMAL;
            const defaultIuran = createIuranData(0, iuranNominal);

            const newUser = {
                id: newId.toUpperCase(),
                nama: newName.toUpperCase(),
                tunggakan_2025: 0, 
                iuran: defaultIuran,
                iuran_bulanan: iuranNominal,
                subsidi: (iuranNominal === IURAN_SUBSIDI)
            };
            
            DUMMY_DATA.push(newUser);
            alert(`Anggota ${newName} (${newId}) berhasil ditambahkan.`);
            showDataAnggota(); 
        }
        
        // FUNGSI ADMIN: HAPUS DATA ANGGOTA (BARU)
        function deleteAnggotaData(userId) {
            if (!isAdmin) {
                alert('Anda tidak memiliki izin untuk menghapus data anggota.');
                return;
            }
            
            if (confirm(`Apakah Anda yakin ingin menghapus data anggota dengan BLOK ${userId}? Tindakan ini tidak dapat dibatalkan.`)) {
                const initialLength = DUMMY_DATA.length;
                DUMMY_DATA = DUMMY_DATA.filter(user => user.id !== userId);
                
                if (DUMMY_DATA.length < initialLength) {
                    alert(`Data anggota ${userId} berhasil dihapus.`);
                    showDataAnggota();
                } else {
                    alert(`Data anggota ${userId} tidak ditemukan.`);
                }
            }
        }


        // FUNGSI BARU: Tampilkan Laporan Kas + FUNGSI ADMIN EDIT
        function showCashReport() {
            showPage('report');
            
            // Tampilkan tombol Admin Tools hanya jika user adalah admin
            const adminToolsSpan = document.getElementById('cash-report-admin-tools');
            if (isAdmin) {
                 adminToolsSpan.innerHTML = `<button class="edit-button" onclick="editCashReport()"><i class="fas fa-edit"></i> Ubah Data</button>`;
            } else {
                 adminToolsSpan.innerHTML = '';
                 // Jika bukan admin, kasih pesan warning jika fungsi edit dipanggil
            }
            
            displayCashReport();
        }
        
        function displayCashReport() {
            const data = DUMMY_CASH_REPORT;
            let totalPemasukan = data.pemasukan.reduce((sum, item) => sum + item.nominal, 0);
            let totalPengeluaran = data.pengeluaran.reduce((sum, item) => sum + item.nominal, 0);
            
            const formatIDR = (num) => 'Rp ' + num.toLocaleString('id-ID');

            let html = `
                <div class="report-summary-box">
                    <div class="summary-card card-pemasukan">
                        <h4><i class="fas fa-arrow-alt-circle-up"></i> Total Pemasukan</h4>
                        <p>${formatIDR(totalPemasukan)}</p>
                    </div>
                    <div class="summary-card card-pengeluaran">
                        <h4><i class="fas fa-arrow-alt-circle-down"></i> Total Pengeluaran</h4>
                        <p>${formatIDR(totalPengeluaran)}</p>
                    </div>
                </div>
                
                <h4 style="color:#ff5722; margin-top: 30px;"><i class="fas fa-minus-square"></i> Rincian Pengeluaran Bulan Ini</h4>
                <table class="cash-table">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Deskripsi</th>
                            <th>Nominal</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Hanya menampilkan PENGELUARAN
            data.pengeluaran.forEach((item, index) => {
                html += `
                    <tr id="pengeluaran-${index}">
                        <td>${item.tanggal}</td>
                        <td>${item.deskripsi}</td>
                        <td style="color:#dc3545; font-weight:bold;">${formatIDR(item.nominal)}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;

            reportContentDiv.innerHTML = html;
        }

        // FUNGSI ADMIN: EDIT LAPORAN KAS
        function editCashReport() {
            if (!isAdmin) {
                alert('Anda tidak memiliki izin untuk mengubah laporan kas.');
                return;
            }
            
            const action = prompt('Pilih aksi:\n1. Tambah Pemasukan\n2. Tambah Pengeluaran\n3. Edit Saldo Awal\n4. (Aksi Lainnya)', '1');
            
            if (action === '3') {
                const newSaldoAwal = prompt(`Edit Saldo Awal (Saat ini: ${DUMMY_CASH_REPORT.saldo_awal.toLocaleString('id-ID')})`, DUMMY_CASH_REPORT.saldo_awal);
                if (newSaldoAwal !== null && !isNaN(parseInt(newSaldoAwal))) {
                    DUMMY_CASH_REPORT.saldo_awal = parseInt(newSaldoAwal);
                    alert('Saldo Awal berhasil diubah.');
                }
            } else if (action === '1' || action === '2') {
                const type = action === '1' ? 'Pemasukan' : 'Pengeluaran';
                const tanggal = prompt(`Masukkan Tanggal ${type} (YYYY-MM-DD):`);
                if (!tanggal) return;
                const deskripsi = prompt(`Masukkan Deskripsi ${type}:`);
                if (!deskripsi) return;
                const nominal = prompt(`Masukkan Nominal ${type} (Angka):`);
                const nominalInt = parseInt(nominal);
                
                if (tanggal && deskripsi && !isNaN(nominalInt) && nominalInt > 0) {
                    const newItem = {
                        tanggal: tanggal,
                        deskripsi: deskripsi,
                        nominal: nominalInt
                    };
                    
                    if (action === '1') {
                        DUMMY_CASH_REPORT.pemasukan.push(newItem);
                    } else {
                        DUMMY_CASH_REPORT.pengeluaran.push(newItem);
                    }
                    alert(`${type} berhasil ditambahkan.`);
                } else {
                    alert('Input tidak valid.');
                }
            } else {
                alert('Aksi dibatalkan atau tidak valid.');
            }
            
            displayCashReport(); // Refresh tampilan
        }


        // Jalankan pengecekan status login saat halaman dimuat
        document.addEventListener('DOMContentLoaded', checkLoginStatus);


        // =======================================
        // === KODE APLIKASI IURAN (DATA DUMMY BARU) ===
        // =======================================

        const IURAN_NORMAL = 25000; 
        const SUBSIDI_AMOUNT = 15000; 
        const IURAN_SUBSIDI = IURAN_NORMAL - SUBSIDI_AMOUNT; // 15000

        /**
         * Fungsi pembantu untuk membuat data iuran 12 bulan
         * @param {number} paidMonthsCount - Jumlah bulan yang akan disetel LUNAS (0-12)
         * @param {number} nominal - Nominal iuran per bulan (misalnya IURAN_NORMAL atau IURAN_SUBSIDI)
         * @returns {Array} Array objek iuran untuk 12 bulan
         */
        function createIuranData(paidMonthsCount = 0, nominal = IURAN_NORMAL) {
            const months = ['JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
            
            return months.map((month, index) => {
                let status = (index < paidMonthsCount) ? 'LUNAS' : 'BLUM BAYAR';
                
                // Memastikan status 'BLUM BAYAR' jika paidMonthsCount di luar range yang diharapkan
                if (paidMonthsCount < 0 || paidMonthsCount > 12) {
                     status = 'BLUM BAYAR';
                }
                
                return { 
                    bulan: month, 
                    nominal: nominal, 
                    status: status 
                };
            });
        }

        // Data Dummy Sederhana 
        let DUMMY_DATA =
        [
 // GANG E21 (Iuran Normal: 25000)
    { 
    id: 'E21-38', 
    nama: 'NOVRY', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-39', 
    nama: 'FATHUR', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-41', 
    nama: 'HANIF', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-42', 
    nama: 'EKA ADI', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-43', 
    nama: 'LARASATI', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-46', 
    nama: 'RAHMAN', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-47', 
    nama: 'RAKEL', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-48', 
    nama: 'HENDRA', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-49', 
    nama: 'NANA', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-57', 
    nama: 'AJI', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-51', 
    nama: 'ROHMAN', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-53', 
    nama: 'VIKO', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-55', 
    nama: 'HENDRI', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-56', 
    nama: 'RIYANDI', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-60', 
    nama: 'ANGGA', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-61', 
    nama: 'IWAN', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-65', 
    nama: 'MARIO', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-66', 
    nama: 'KOKO', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-67', 
    nama: 'RICO', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-68', 
    nama: 'IRWAN', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-69', 
    nama: 'TORO', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-70', 
    nama: 'TOPAN', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-71', 
    nama: 'HERI', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-72', 
    nama: 'BAYU ADE', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E21-73', 
    nama: 'FIRLY', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },


    // GANG E25 (Iuran Normal: 25000)
    { id: 'E25-03',
    nama: 'KRISNA',
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    
    { id: 'E25-08',
    nama: 'DENY',
    tunggakan_2025: 0,
    iuran: createIuranData(0, IURAN_NORMAL) },
    
    { id: 'E25-09', 
    nama: 'CHANDRA', 
    tunggakan_2025: 0,
    iuran: createIuranData(0, IURAN_NORMAL) },
    
    { id: 'E25-10', 
    nama: 'ALFIAN', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) },

    // Warga Subsidi (Iuran Subsidi: 15000)
    { 
        id: 'E25-11',
        nama: 'TEDI',
        tunggakan_2025: 0, 
        iuran: createIuranData(0, IURAN_SUBSIDI), 
        subsidi: true, 
        iuran_bulanan: IURAN_SUBSIDI
    },
    { 
    id: 'E25-32', 
    nama: 'ASEP', 
tunggakan_2025: 0, 
        iuran: createIuranData(0, IURAN_SUBSIDI), 
        subsidi: true, 
        iuran_bulanan: IURAN_SUBSIDI
    },
    

// GANG E25 (Iuran Normal: 25000)
    { 
    id: 'E25-15', 
    nama: 'DERI', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E25-18', 
    nama: 'PAULUS', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E25-19', 
    nama: 'DEDE DWI', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E25-20', 
    nama: 'ANANG', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E25-21', 
    nama: 'PARULIAN', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E25-22', 
    nama: 'BAYU NUR', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E25-23', 
    nama: 'WALUYO', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E25-27', 
    nama: 'HADI', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E25-28', 
    nama: 'Pakdeh Agung', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E25-30', 
    nama: 'BUDI ALMAWAN', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E25-31', 
    nama: 'BAGUS', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E25-33', 
    nama: 'DEDE GUNAWAN', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E25-35', 
    nama: 'KARDAN', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E25-36', 
    nama: 'RENDY', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    },
    { 
    id: 'E25-37', 
    nama: 'VERA', 
    tunggakan_2025: 0, 
    iuran: createIuranData(0, IURAN_NORMAL) 
    }
        ]



        // --- DATA DUMMY LAPORAN KAS (TETAP) ---
        const DUMMY_CASH_REPORT = {
            saldo_awal: 5000000, 
            pemasukan: [
                { tanggal: '2026-01-05', deskripsi: 'Iuran Kas Januari (10 warga)', nominal: 250000 },
                { tanggal: '2026-01-12', deskripsi: 'Iuran Kas Januari (15 warga)', nominal: 375000 },
                { tanggal: '2026-01-20', deskripsi: 'Iuran Kas Februari (5 warga)', nominal: 125000 },
            ],
            pengeluaran: [
                { tanggal: '2026-01-15', 
                 deskripsi: 'Pembelian lampu jalan E25',
                 nominal: 150000 },
                
                { tanggal: '2026-01-25', 
                 deskripsi: 'Biaya kebersihan bulanan', 
                 nominal: 100000 },
            ]
        };
        // ------------------------------------

        // --- VARIABEL DOM & STATE ---
        const dataDisplay = document.getElementById('data-display');
        const userNameSpan = document.getElementById('user-name');
        const totalTunggakanSpan = document.getElementById('total-tunggakan');
        const statusMessageDiv = document.getElementById('status-message');
        const lunasMessageDiv = document.getElementById('lunas-message');
        const tunggakanOptionsDiv = document.getElementById('tunggakan-options');
        const manualPaymentForm = document.getElementById('payment-form-manual');
        const manualUserDetailSpan = document.getElementById('manual-user-detail');
        const manualAmountInput = document.getElementById('manual-amount'); 
        const manualMonthInput = document.getElementById('manual-month'); 
        
        const instructionContentDiv = document.getElementById('payment-instruction-content');
        const proofConfirmationCheckbox = document.getElementById('proof-confirmation');
        const btnWhatsappProof = document.getElementById('btn-whatsapp-proof');
        const confirmActionSpan = document.getElementById('confirm-action'); 
        
        const tunggakanDetailDiv = document.getElementById('tunggakan-detail');
        const tunggakan2025Group = document.getElementById('group-tunggakan-2025');
        const tunggakan2025Input = document.getElementById('tunggakan-2025-amount');
        const totalInfoDiv = document.querySelector('.total-info'); 

        let currentTunggakanAmount = 0; 
        let currentTunggakanList = []; 
        
        // ===============================================
        // === FUNGSI MENAMPILKAN DATA (LOGIKA BARU) ===
        // ===============================================
        function displayUserData(user) {
            statusMessageDiv.className = 'status-message status-found';
            statusMessageDiv.innerHTML = `âœ… Data Iuran Atas nma: ${user.nama} Ditemukan! (Blok: ${user.id})`;

            userNameSpan.textContent = user.nama + ' (' + user.id + ')';
            manualUserDetailSpan.textContent = user.nama + ' (' + user.id + ')'; 
            
            // Dapatkan nominal iuran bulanan yang benar
            const userIuranBulanan = user.iuran_bulanan || IURAN_NORMAL;

            currentTunggakanList = []; 
            
            // Hitung Total Tunggakan Keseluruhan
            const tunggakan2025 = user.tunggakan_2025 || 0;
            
            // Pisahkan bulan yang LUNAS dan BLUM BAYAR
            const paidMonths = user.iuran.filter(item => item.status === 'LUNAS');
            const unpaidMonths = user.iuran.filter(item => item.status === 'BLUM BAYAR');
            
            // Ambil bulan pertama yang belum bayar
            const firstUnpaidMonth = unpaidMonths.length > 0 ? unpaidMonths[0] : null;
            
            // Sisa bulan yang belum bayar (selain yang pertama)
            const otherUnpaidMonths = unpaidMonths.slice(1);
            
            let totalTunggakan2026 = unpaidMonths.reduce((sum, item) => {
                currentTunggakanList.push(item.bulan);
                // Pastikan nominal yang dipakai untuk perhitungan adalah nominal pada item iuran (bisa jadi subsidi)
                return sum + item.nominal; 
            }, 0);
            
            let totalTunggakanSummary = tunggakan2025 + totalTunggakan2026;

            // --- LOGIKA TAMPILAN BULAN ---
            let htmlContent = `
                <div id="data-display-table">
                    <div class="data-header">
                        <span>Bulan (2026)</span>
                        <span>Nominal</span>
                        <span>Keterangan</span>
                    </div>
            `;
            
            // 1. Tampilkan Bulan yang LUNAS
            paidMonths.forEach(item => {
                const nominalIDR = item.nominal.toLocaleString('id-ID');
                htmlContent += `
                    <div class="data-row">
                        <span>${item.bulan}</span>
                        <span>Rp ${nominalIDR}</span>
                        <span class="lunas">LUNAS</span>
                    </div>
                `;
            });
            
            // 2. Tampilkan 1 Bulan Pertama yang BELUM BAYAR (jika ada)
            if (firstUnpaidMonth) {
                const nominalIDR = firstUnpaidMonth.nominal.toLocaleString('id-ID');
                htmlContent += `
                    <div class="data-row">
                        <span>${firstUnpaidMonth.bulan}</span>
                        <span>Rp ${nominalIDR}</span>
                        <span class="belum">BELUM BAYAR</span>
                    </div>
                `;
            }
            
            // 3. Tambahkan DIV untuk bulan-bulan yang disembunyikan (jika ada)
            if (otherUnpaidMonths.length > 0) {
                htmlContent += `
                    <div id="hidden-unpaid-months" style="display:none;">
                `;
                
                otherUnpaidMonths.forEach(item => {
                    const nominalIDR = item.nominal.toLocaleString('id-ID');
                    htmlContent += `
                        <div class="data-row">
                            <span>${item.bulan}</span>
                            <span>Rp ${nominalIDR}</span>
                            <span class="belum">BELUM BAYAR</span>
                        </div>
                    `;
                });
                
                htmlContent += `</div>`; // Tutup #hidden-unpaid-months

                // Tombol untuk menampilkan/menyembunyikan sisa tunggakan
                htmlContent += `
                    <div style="text-align: center; margin-top: 10px;">
                        <button id="btn-toggle-tunggakan" onclick="toggleUnpaidMonths()" style="
                            padding: 8px 15px;
                            background-color: #ff5722;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            font-weight: bold;
                            font-size: 0.9em;
                            transition: background-color 0.2s;
                        ">
                            <i class="fas fa-eye-slash"></i> Tampilkan ${otherUnpaidMonths.length} Tunggakan Lainnya
                        </button>
                    </div>
                `;
            }
            
            htmlContent += `</div>`; // Tutup #data-display-table
            
            dataDisplay.innerHTML = htmlContent;
            
            // 2. Update Tampilan Summary
            totalTunggakanSpan.textContent = 'Rp ' + totalTunggakanSummary.toLocaleString('id-ID');
            currentTunggakanAmount = totalTunggakanSummary; // Update global state
            
            // --- LOGIC TAMPILAN DETAIL TUNGGAKAN (FORMAT EXCEL) ---
            let detailHtml = `
                <div class="tunggakan-header">
                    <div class="col-deskripsi">Keterangan</div>
                    <div>Jumlah Bulan / Item</div>
                    <div>Nominal</div>
                </div>
            `;
            
            if (tunggakan2025 > 0) {
                detailHtml += `
                    <div class="tunggakan-line">
                        <span class="col-deskripsi">Tunggakan Tahun 2025</span>
                        <span>1 Item</span>
                        <span>Rp ${tunggakan2025.toLocaleString('id-ID')}</span>
                    </div>
                `;
            } else {
                 detailHtml += `
                    <div class="tunggakan-line">
                        <span class="col-deskripsi">Tunggakan Tahun 2025</span>
                        <span>Lunas</span>
                        <span>Rp 0</span>
                    </div>
                `;
            }
            
            detailHtml += `
                <div class="tunggakan-line">
                    <span class="col-deskripsi">Iuran Periode 2026</span>
                    <span>${currentTunggakanList.length} Bulan</span>
                    <span>Rp ${totalTunggakan2026.toLocaleString('id-ID')}</span>
                </div>
                <div class="tunggakan-line" style="border-bottom: none;">
                    <span class="col-deskripsi" style="font-style: italic; font-size: 0.9em; color: #6c757d; font-weight: normal;">Bayar per bulan Rp ${userIuranBulanan.toLocaleString('id-ID')}</span>
                    <span></span>
                    <span></span>
                </div>
                <div class="tunggakan-total">
                    <span>GRAND TOTAL HARUS DIBAYAR:</span> 
                    <span>Rp ${totalTunggakanSummary.toLocaleString('id-ID')}</span>
                </div>
            `;
            
            tunggakanDetailDiv.innerHTML = detailHtml;
            // -------------------------------------------------------------
            
            // 4. Update tampilan Tunggakan 2025 di Form Manual
            if (tunggakan2025 > 0) {
                tunggakan2025Input.value = `Rp ${tunggakan2025.toLocaleString('id-ID')}`;
                tunggakan2025Group.style.display = 'block';
                manualAmountInput.min = (tunggakan2025 > 0) ? tunggakan2025 : userIuranBulanan; 
            } else {
                tunggakan2025Input.value = 'Rp 0 (LUNAS)';
                tunggakan2025Group.style.display = 'none';
                manualAmountInput.min = userIuranBulanan; 
            }
            
            // Update iuran bulanan di form manual
            iuranBulananManual.textContent = `Rp ${userIuranBulanan.toLocaleString('id-ID')}`;
            
            // 5. Tentukan Tampilan Pilihan Bayar
            if (totalTunggakanSummary > 0) {
                tunggakanOptionsDiv.style.display = 'block'; 
                lunasMessageDiv.style.display = 'none';
                totalInfoDiv.style.backgroundColor = '#fff'; 
                totalInfoDiv.style.color = '#333';
                
                // Atur nilai default di form pembayaran saat kembali dari detail
                if(tunggakan2025 > 0) {
                    manualAmountInput.value = tunggakan2025 + userIuranBulanan; 
                } else if (totalTunggakan2026 > 0) {
                    manualAmountInput.value = userIuranBulanan;
                } else {
                    manualAmountInput.value = 0;
                }
                manualAmountInput.dispatchEvent(new Event('input')); 

            } else {
                // Semua Lunas
                tunggakanOptionsDiv.style.display = 'none'; 
                lunasMessageDiv.style.display = 'block';
                totalTunggakanSpan.textContent = 'Rp 0 (Semua Iuran Lunas!)';
                totalInfoDiv.style.backgroundColor = '#e6ffed';
                totalInfoDiv.style.color = '#1e7e34';
                tunggakanDetailDiv.innerHTML = ''; 
            }
        }
        
        // ===============================================
        // === FUNGSI BARU UNTUK TOGGLE TUNGGAKAN (BARU) ===
        // ===============================================
        function toggleUnpaidMonths() {
            const hiddenDiv = document.getElementById('hidden-unpaid-months');
            const toggleButton = document.getElementById('btn-toggle-tunggakan');
            
            if (!hiddenDiv || !toggleButton) return;

            if (hiddenDiv.style.display === 'none') {
                hiddenDiv.style.display = 'block';
                toggleButton.innerHTML = '<i class="fas fa-eye"></i> Sembunyikan Tunggakan Lainnya';
                toggleButton.style.backgroundColor = '#6c757d'; // Warna abu-abu saat terbuka
            } else {
                hiddenDiv.style.display = 'none';
                const otherUnpaidCount = hiddenDiv.children.length; 
                toggleButton.innerHTML = `<i class="fas fa-eye-slash"></i> Tampilkan ${otherUnpaidCount} Tunggakan Lainnya`;
                toggleButton.style.backgroundColor = '#ff5722'; // Warna oranye saat tertutup
            }
        }

        
        // --- Event Listener untuk Input Nominal ---
        manualAmountInput.addEventListener('input', function() {
            const amount = parseInt(manualAmountInput.value);
            
            const userData = DUMMY_DATA.find(user => user.id === currentUserId);
            if (!userData) {
                manualMonthInput.value = 'Data pengguna tidak ditemukan.';
                return;
            }
            
            const tunggakan2025 = userData.tunggakan_2025 || 0;
            const userIuranBulanan = userData.iuran_bulanan || IURAN_NORMAL;

            if (isNaN(amount) || amount < 1) {
                manualMonthInput.value = 'Masukkan jumlah pembayaran yang valid.';
                return;
            }
            
            let remainingAmount = amount;
            let detailPembayaran = '';
            let isTunggakan2025Paid = false;
            
            if (tunggakan2025 > 0) {
                if (amount >= tunggakan2025) {
                    remainingAmount -= tunggakan2025;
                    detailPembayaran += `LUNAS Tunggakan 2025 (Rp ${tunggakan2025.toLocaleString('id-ID')})`;
                    isTunggakan2025Paid = true;
                } else {
                    detailPembayaran += `BAYAR Sebagian Tunggakan 2025 (Rp ${amount.toLocaleString('id-ID')} dari Rp ${tunggakan2025.toLocaleString('id-ID')})`;
                    manualMonthInput.value = detailPembayaran;
                    return;
                }
            } else {
                isTunggakan2025Paid = true; 
            }

            if (isTunggakan2025Paid) {
                // Berapa bulan 2026 yang bisa dilunasi dengan sisa uang
                const monthsPaidFor2026 = Math.floor(remainingAmount / userIuranBulanan);
                const excessAmount = remainingAmount % userIuranBulanan;

                const monthsAvailable = currentTunggakanList.length;
                const monthsToPay = currentTunggakanList.slice(0, Math.min(monthsPaidFor2026, monthsAvailable));
                const paidMonthsCount = monthsToPay.length;
                
                if (paidMonthsCount > 0) {
                    detailPembayaran += (detailPembayaran ? ' & ' : '') + 
                                        `LUNAS Iuran 2026: ${paidMonthsCount} bulan (${monthsToPay.join(', ')}).`;
                }

                if (paidMonthsCount === 0 && monthsAvailable > 0 && remainingAmount > 0) {
                    detailPembayaran += (detailPembayaran ? ' & ' : '') + 
                                        `BELUM LUNAS Iuran 2026: Rp ${remainingAmount.toLocaleString('id-ID')} (Kekurangan Rp ${(userIuranBulanan - remainingAmount).toLocaleString('id-ID')}).`;
                }
                 
                if (paidMonthsCount > 0 && monthsPaidFor2026 > monthsAvailable) {
                    const sisaUang = remainingAmount - (monthsAvailable * userIuranBulanan);
                    detailPembayaran += ` + KELEBIHAN bayar Rp ${sisaUang.toLocaleString('id-ID')} (Sisa Iuran Lunas).`;
                } else if (paidMonthsCount > 0 && paidMonthsCount === monthsPaidFor2026 && excessAmount > 0) {
                    detailPembayaran += ` + SISA/LEBIH bayar Rp ${excessAmount.toLocaleString('id-ID')}.`;
                } else if (paidMonthsCount < monthsPaidFor2026 && monthsAvailable === paidMonthsCount) {
                    // Semua bulan tunggakan terbayar, tapi ada kelebihan yang tidak mencapai 1 bulan penuh berikutnya
                    detailPembayaran += ` + SISA/LEBIH bayar Rp ${remainingAmount.toLocaleString('id-ID')}.`;
                } else if (paidMonthsCount < monthsPaidFor2026) {
                    const sisaBulan = monthsPaidFor2026 - paidMonthsCount;
                    detailPembayaran += ` (Lunas ${paidMonthsCount} bln, SISA ${sisaBulan} bln berikutnya).`;
                }

            }
            
            manualMonthInput.value = detailPembayaran;
        });
        
        // --- FUNGSI LAINNYA ---
        document.querySelectorAll('#manual-payment-section input[name="method"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value.includes('Offline')) {
                    confirmActionSpan.textContent = 'serahkan uang tunai';
                } else {
                    confirmActionSpan.textContent = 'transfer';
                }
                
                if(proofConfirmationCheckbox) proofConfirmationCheckbox.checked = false;
                btnWhatsappProof.disabled = true;
                btnWhatsappProof.classList.remove('active');
            });
        });

        proofConfirmationCheckbox.addEventListener('change', function() {
            if (proofConfirmationCheckbox.checked) {
                btnWhatsappProof.disabled = false;
                btnWhatsappProof.classList.add('active');
            } else {
                btnWhatsappProof.disabled = true;
                btnWhatsappProof.classList.remove('active');
            }
        });

        // Event Listener Form Pembayaran Manual -> Instruksi
        manualPaymentForm.addEventListener('submit', function(e) {
            e.preventDefault(); 
            
            const amountInput = parseInt(document.getElementById('manual-amount').value);
            const userData = DUMMY_DATA.find(user => user.id === currentUserId);
            const tunggakan2025 = userData?.tunggakan_2025 || 0;
            const userIuranBulanan = userData.iuran_bulanan || IURAN_NORMAL;
            const minAmount = (tunggakan2025 > 0) ? tunggakan2025 : userIuranBulanan;
            
            if (amountInput < minAmount) {
                 alert(`âŒ Harap masukkan jumlah minimal Rp ${minAmount.toLocaleString('id-ID')}.`);
                 return;
            }
            
            // Pindah ke Halaman Instruksi
            showPage('instruction');
            
            if(proofConfirmationCheckbox) proofConfirmationCheckbox.checked = false; 
            btnWhatsappProof.disabled = true;
            btnWhatsappProof.classList.remove('active');

            const amount = amountInput;
            const detailPembayaran = document.getElementById('manual-month').value; 
            const method = document.querySelector('#manual-payment-section input[name="method"]:checked').value;
            
            let monthsToMarkLunas = [];
            // Ambil daftar bulan yang dilunasi
            const match = detailPembayaran.match(/Iuran 2026: \d+ bulan \((.*?)\)\./);
            if (match && match[1]) {
                monthsToMarkLunas = match[1].split(',').map(m => m.trim());
            }

            btnWhatsappProof.setAttribute('data-target-months-list', monthsToMarkLunas.join('.')); 
            btnWhatsappProof.setAttribute('data-detail-pembayaran', detailPembayaran); 

            const amountIDR = new Intl.NumberFormat('id-ID').format(amount);
            
            let htmlContent = `
                <h3><i class="fas fa-check-circle"></i> Instruksi Pembayaran Dibuat</h3>
                <p><strong>Warga:</strong> ${userData.nama} (${currentUserId})</p>
                <p><strong>Detail Pelunasan:</strong> <span style="font-weight: bold; color:#007bff;">${detailPembayaran}</span></p>
                <p><strong>Metode:</strong> ${method}</p>
                <p><strong>Jumlah:</strong> <span style="font-size: 1.2em; color: #dc3545; font-weight: bold;">Rp ${amountIDR}</span></p>
                <hr style="margin: 10px 0;">
            `;

            if (method === 'QR Code (QRIS)') {
                 htmlContent += `
                    <p style="text-align: center;">Scan QRIS di bawah ini menggunakan aplikasi pembayaran Anda (Dana, GoPay, Mobile Banking, dll.)</p>
                    <div class="qris-display">
                        <img src="qrcode.jpg" alt="QRIS Kas Gang E21/25" class="qrcode-image">
                    </div>
 <a href="qrcode.jpg" download="QRIS_Kas_Gang_E21-25.jpg" style="
                display: block; 
                width: 100%; 
                padding: 10px; 
                margin-top: 10px; 
                background-color: #28a745; 
                color: white; 
                text-decoration: none; 
                border-radius: 5px; 
                font-weight: bold;
            ">
                <i class="fas fa-download"></i> Download Gambar QRIS
            </a>
            
                `;
            } else if (method === 'Transfer Bank') {
                htmlContent += `
                    <div style="text-align: left;">
                        <p style="font-weight: bold; margin-top: 10px;">Pilih Salah Satu Rekening:</p>
                        <p><strong>Bank:</strong> MANDIRI</p>
                        <p><strong>Nomor Rekening:</strong> 1234-567-890</p>
                        <p><strong>Atas Nama:</strong> CANDRA</p>
                        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 10px 0;">
                        <p><strong>Bank:</strong> DANA (Transfer Virtual)</p>
                        <p><strong>Nomor Rekening:</strong> 0857-8125-6570</p>
                        <p><strong>Atas Nama:</strong> CANDRA</p>
                    </div>
                    <p style="color: red; font-weight: bold; margin-top: 15px;">**Penting:** untuk pembayaran dari semua akun bank ke DANA maka pembayaran di tambah 1000 </p>
                `; 
            } else if (method === 'Offline (Tunai)') {
                 htmlContent += `
                    <div class="offline-instructions">
                        <p style="font-weight: bold; font-size: 1.1em;"><i class="fas fa-hand-holding-usd"></i> Instruksi Pembayaran Tunai</p>
                        <p>Silakan serahkan uang tunai sebesar Rp ${amountIDR} langsung kepada:</p>
                        <ul>
                            <li><strong>Petugas:</strong> Bpk. Candra (Bendahara)</li>
                            <li><strong>Alamat:</strong> Rumah E25-09</li>
                            <li><strong>Waktu:</strong> di komfimasi dulu ke bendahara</li>
                        </ul>
                        <p style="font-style: italic;">**Penting:** Pastikan Anda menerima kwitansi atau bukti serah terima dari petugas. Konfirmasi WhatsApp wajib dilakukan setelah serah terima uang.</p>
                    </div>
                `;
            }

            instructionContentDiv.innerHTML = htmlContent;
            
            btnWhatsappProof.setAttribute('data-name', userData.nama);
            btnWhatsappProof.setAttribute('data-id', currentUserId);
            btnWhatsappProof.setAttribute('data-amount', amountIDR);
            btnWhatsappProof.setAttribute('data-month', detailPembayaran); 
            btnWhatsappProof.setAttribute('data-method', method);
            
            btnWhatsappProof.onclick = function() {
                sendProofViaWhatsApp(
                    this.getAttribute('data-name'),
                    this.getAttribute('data-id'),
                    this.getAttribute('data-amount'),
                    this.getAttribute('data-month'),
                    this.getAttribute('data-method'),
                    this.getAttribute('data-target-months-list') 
                );
            };
        });

        function sendProofViaWhatsApp(name, id, amountIDR, detailPembayaran, method, targetMonthsList) {
            
            if (!proofConfirmationCheckbox.checked) {
                 alert('âŒ Anda harus mencentang konfirmasi pembayaran terlebih dahulu.');
                 return;
            }

            const monthsToMarkLunas = targetMonthsList.split('.').filter(m => m !== ''); 
            const amount = parseInt(amountIDR.replace(/[^0-9]/g, '')); 

            const userIndex = DUMMY_DATA.findIndex(user => user.id === id);
            if (userIndex !== -1) {
                const userData = DUMMY_DATA[userIndex];
                const userIuranBulanan = userData.iuran_bulanan || IURAN_NORMAL;
                let totalDibayar = amount;
                
                // 1. Lunasi Tunggakan 2025
                if (userData.tunggakan_2025 > 0) {
                    if (totalDibayar >= userData.tunggakan_2025) {
                        totalDibayar -= userData.tunggakan_2025;
                        userData.tunggakan_2025 = 0; 
                    } else {
                        userData.tunggakan_2025 -= totalDibayar; 
                        totalDibayar = 0;
                    }
                }
                
                // 2. Lunasi Bulan 2026
                if (totalDibayar >= userIuranBulanan && monthsToMarkLunas.length > 0) {
                    monthsToMarkLunas.forEach(targetMonth => {
                        const iuranItem = userData.iuran.find(item => item.bulan === targetMonth && item.status === 'BLUM BAYAR');
                        // Hanya tandai LUNAS jika nominal di item iuran sesuai dengan nominal yang seharusnya dibayar
                        if (iuranItem && iuranItem.nominal === userIuranBulanan) {
                            iuranItem.status = 'LUNAS'; 
                        }
                    });
                }
                
                DUMMY_DATA[userIndex] = userData;
            }

            // Kembali ke Detail Iuran setelah submit
            showDataUser(id); 

            const phoneNumber = '6285781256570'; // Nomor WA Bendahara
            
            let paymentActionText = 'bukti transfer';
            if (method === 'Offline (Tunai)') {
                 paymentActionText = 'konfirmasi serah terima uang tunai';
            }
            
            const message = `*Konfirmasi Pembayaran Kas gang E21-25*\n\n` +
                            `Nama: *${name}* (BLOK: ${id})\n` +
                            `Detail Pelunasan: *${detailPembayaran}*\n` + 
                            `Jumlah: *Rp ${amountIDR}*\n` +
                            `Metode: *${method}*\n\n` +
                            `*PENTING:* Kirim ${paymentActionText} di chat ini* untuk diverifikasi.\n\n` +
                            `*Status terkini di aplikasi: Sudah LUNAS (Menunggu Verifikasi).*`;
                            
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappURL, '_blank');
        }

        // Auto-fill saat form pembayaran difokuskan
        manualAmountInput.addEventListener('focus', function() {
            const userData = DUMMY_DATA.find(user => user.id === currentUserId);
            if (!userData) return;
            
            const userIuranBulanan = userData.iuran_bulanan || IURAN_NORMAL;

            if (manualAmountInput.value === '' || parseInt(manualAmountInput.value) < userIuranBulanan) {
                
                const tunggakan2025 = userData.tunggakan_2025 || 0;
                const tunggakan2026List = userData.iuran.filter(item => item.status === 'BLUM BAYAR');
                
                if(tunggakan2025 > 0) {
                    manualAmountInput.value = tunggakan2025 + userIuranBulanan; 
                } else if (tunggakan2026List.length > 0) {
                    manualAmountInput.value = userIuranBulanan;
                } else {
                    manualAmountInput.value = 0;
                }
                manualAmountInput.dispatchEvent(new Event('input'));
            }
        });
    </script>

</body>
</html>
